{"snapshots":{"C:/Users/Hrushikesh/AndroidStudioProjects/SampleGCS/app/src/main/java/com/example/aerogcsclone/uimain/GcsMap.kt":{"filePath":"C:/Users/Hrushikesh/AndroidStudioProjects/SampleGCS/app/src/main/java/com/example/aerogcsclone/uimain/GcsMap.kt","baseContent":"package com.example.aerogcsclone.uimain\n\nimport androidx.compose.foundation.layout.fillMaxSize\nimport androidx.compose.runtime.*\nimport androidx.compose.ui.Modifier\nimport com.example.aerogcsclone.Telemetry.TelemetryState\nimport com.google.android.gms.maps.CameraUpdateFactory\nimport com.google.android.gms.maps.model.LatLng\nimport com.google.maps.android.compose.*\n\n@Composable\nfun GcsMap(telemetryState: TelemetryState) {\n    var points by remember { mutableStateOf(listOf<LatLng>()) }\n    var polygonClosed by remember { mutableStateOf(false) }\n\n    val cameraPositionState = rememberCameraPositionState()\n\n    // Update camera when telemetry changes (live location)\n    LaunchedEffect(telemetryState.latitude, telemetryState.longitude) {\n        val lat = telemetryState.latitude\n        val lon = telemetryState.longitude\n        if (lat != null && lon != null) {\n            val newPosition = LatLng(lat, lon)\n            cameraPositionState.animate(\n                update = CameraUpdateFactory.newLatLngZoom(newPosition, 16f),\n                durationMs = 1000\n            )\n        }\n    }\n\n    GoogleMap(\n        modifier = Modifier.fillMaxSize(),\n        cameraPositionState = cameraPositionState,\n        onMapClick = { latLng ->\n            if (!polygonClosed) {\n                points = points + latLng\n            }\n        }\n    ) {\n        // Live drone marker\n        val lat = telemetryState.latitude\n        val lon = telemetryState.longitude\n        if (lat != null && lon != null) {\n            Marker(\n                state = MarkerState(position = LatLng(lat, lon)),\n                title = \"Drone Location\"\n            )\n        }\n\n        // User-drawn markers\n        points.forEachIndexed { index, point ->\n            Marker(\n                state = MarkerState(position = point),\n                title = \"Marker ${index + 1}\",\n                onClick = {\n                    if (points.size > 1 && !polygonClosed) {\n                        val last = points.last()\n\n                        if (point == points.first() && points.size > 2) {\n                            points = points + point\n                            polygonClosed = true\n                        } else if (point != last) {\n                            points = points + point\n                        }\n                    }\n                    true\n                }\n            )\n        }\n\n        // Draw polyline (open or closed)\n        if (points.size > 1) {\n            Polyline(\n                points = points,\n                width = 4f\n            )\n        }\n    }\n}\n","baseTimestamp":1757909204070,"deltas":[{"timestamp":1757914278117,"changes":[{"type":"DELETE","lineNumber":11,"oldContent":"fun GcsMap(telemetryState: TelemetryState) {"},{"type":"DELETE","lineNumber":12,"oldContent":"    var points by remember { mutableStateOf(listOf<LatLng>()) }"},{"type":"INSERT","lineNumber":11,"content":"fun GcsMap("},{"type":"INSERT","lineNumber":12,"content":"    telemetryState: TelemetryState,"},{"type":"INSERT","lineNumber":13,"content":"    points: List<LatLng> = emptyList(),"},{"type":"INSERT","lineNumber":14,"content":"    onMapClick: (LatLng) -> Unit = {}"},{"type":"INSERT","lineNumber":15,"content":") {"},{"type":"INSERT","lineNumber":16,"content":"    var internalPoints by remember { mutableStateOf(points) }"},{"type":"INSERT","lineNumber":34,"content":"    // Keep internalPoints in sync when parent points change"},{"type":"INSERT","lineNumber":35,"content":"    LaunchedEffect(points) {"},{"type":"INSERT","lineNumber":36,"content":"        internalPoints = points"},{"type":"INSERT","lineNumber":37,"content":"    }"},{"type":"INSERT","lineNumber":38,"content":""},{"type":"DELETE","lineNumber":35,"oldContent":"                points = points + latLng"},{"type":"INSERT","lineNumber":44,"content":"                // Notify parent"},{"type":"INSERT","lineNumber":45,"content":"                onMapClick(latLng)"},{"type":"INSERT","lineNumber":46,"content":"                // update internal copy for immediate UI feedback"},{"type":"INSERT","lineNumber":47,"content":"                internalPoints = internalPoints + latLng"},{"type":"DELETE","lineNumber":50,"oldContent":"        points.forEachIndexed { index, point ->"},{"type":"INSERT","lineNumber":62,"content":"        internalPoints.forEachIndexed { index, point ->"},{"type":"DELETE","lineNumber":54,"oldContent":"                onClick = {"},{"type":"DELETE","lineNumber":55,"oldContent":"                    if (points.size > 1 && !polygonClosed) {"},{"type":"DELETE","lineNumber":56,"oldContent":"                        val last = points.last()"},{"type":"DELETE","lineNumber":57,"oldContent":""},{"type":"DELETE","lineNumber":58,"oldContent":"                        if (point == points.first() && points.size > 2) {"},{"type":"DELETE","lineNumber":59,"oldContent":"                            points = points + point"},{"type":"DELETE","lineNumber":60,"oldContent":"                            polygonClosed = true"},{"type":"DELETE","lineNumber":61,"oldContent":"                        } else if (point != last) {"},{"type":"DELETE","lineNumber":62,"oldContent":"                            points = points + point"},{"type":"DELETE","lineNumber":63,"oldContent":"                        }"},{"type":"DELETE","lineNumber":64,"oldContent":"                    }"},{"type":"DELETE","lineNumber":65,"oldContent":"                    true"},{"type":"DELETE","lineNumber":66,"oldContent":"                }"},{"type":"MODIFY","lineNumber":70,"content":"        if (internalPoints.size > 1) {","oldContent":"        if (points.size > 1) {"},{"type":"MODIFY","lineNumber":72,"content":"                points = internalPoints,","oldContent":"                points = points,"}]},{"timestamp":1757915700671,"changes":[{"type":"DELETE","lineNumber":11,"oldContent":"fun GcsMap("},{"type":"DELETE","lineNumber":12,"oldContent":"    telemetryState: TelemetryState,"},{"type":"DELETE","lineNumber":13,"oldContent":"    points: List<LatLng> = emptyList(),"},{"type":"INSERT","lineNumber":11,"content":"fun GcsMap(telemetryState: TelemetryState) {"},{"type":"INSERT","lineNumber":12,"content":"    var points by remember { mutableStateOf(listOf<LatLng>()) }"},{"type":"DELETE","lineNumber":15,"oldContent":"    onMapClick: (LatLng) -> Unit = {}"},{"type":"DELETE","lineNumber":17,"oldContent":") {"},{"type":"DELETE","lineNumber":19,"oldContent":"    var internalPoints by remember { mutableStateOf(points) }"},{"type":"DELETE","lineNumber":38,"oldContent":"    // Keep internalPoints in sync when parent points change"},{"type":"DELETE","lineNumber":40,"oldContent":"    LaunchedEffect(points) {"},{"type":"DELETE","lineNumber":41,"oldContent":"        internalPoints = points"},{"type":"INSERT","lineNumber":35,"content":"                points = points + latLng"},{"type":"DELETE","lineNumber":43,"oldContent":"    }"},{"type":"DELETE","lineNumber":45,"oldContent":""},{"type":"DELETE","lineNumber":52,"oldContent":"                // Notify parent"},{"type":"DELETE","lineNumber":54,"oldContent":"                onMapClick(latLng)"},{"type":"DELETE","lineNumber":56,"oldContent":"                // update internal copy for immediate UI feedback"},{"type":"DELETE","lineNumber":58,"oldContent":"                internalPoints = internalPoints + latLng"},{"type":"INSERT","lineNumber":50,"content":"        points.forEachIndexed { index, point ->"},{"type":"DELETE","lineNumber":65,"oldContent":"        internalPoints.forEachIndexed { index, point ->"},{"type":"INSERT","lineNumber":54,"content":"                onClick = {"},{"type":"INSERT","lineNumber":55,"content":"                    if (points.size > 1 && !polygonClosed) {"},{"type":"INSERT","lineNumber":56,"content":"                        val last = points.last()"},{"type":"INSERT","lineNumber":57,"content":""},{"type":"INSERT","lineNumber":58,"content":"                        if (point == points.first() && points.size > 2) {"},{"type":"INSERT","lineNumber":59,"content":"                            points = points + point"},{"type":"INSERT","lineNumber":60,"content":"                            polygonClosed = true"},{"type":"INSERT","lineNumber":61,"content":"                        } else if (point != last) {"},{"type":"INSERT","lineNumber":62,"content":"                            points = points + point"},{"type":"INSERT","lineNumber":63,"content":"                        }"},{"type":"INSERT","lineNumber":64,"content":"                    }"},{"type":"INSERT","lineNumber":65,"content":"                    true"},{"type":"INSERT","lineNumber":66,"content":"                }"},{"type":"DELETE","lineNumber":69,"oldContent":"        if (internalPoints.size > 1) {"},{"type":"INSERT","lineNumber":70,"content":"        // Draw polyline (open or closed)"},{"type":"DELETE","lineNumber":71,"oldContent":"                points = internalPoints,"},{"type":"INSERT","lineNumber":72,"content":"            Polyline("}]},{"timestamp":1757915709340,"changes":[{"type":"MODIFY","lineNumber":11,"content":"fun GcsMap(","oldContent":"fun GcsMap(telemetryState: TelemetryState) {"},{"type":"INSERT","lineNumber":12,"content":"    telemetryState: TelemetryState,"},{"type":"INSERT","lineNumber":13,"content":"    mapType: MapType"},{"type":"INSERT","lineNumber":14,"content":") {"},{"type":"DELETE","lineNumber":31,"oldContent":"                points = points + latLng"},{"type":"INSERT","lineNumber":36,"content":"        properties = MapProperties(mapType = mapType), // ✅ Map type applied"},{"type":"INSERT","lineNumber":39,"content":"                points = points + latLng"},{"type":"DELETE","lineNumber":42,"oldContent":"        points.forEachIndexed { index, point ->"},{"type":"INSERT","lineNumber":49,"content":"                title = \"Drone Location\""},{"type":"INSERT","lineNumber":50,"content":"            )"},{"type":"INSERT","lineNumber":51,"content":"        }"},{"type":"INSERT","lineNumber":52,"content":""},{"type":"INSERT","lineNumber":53,"content":"        // User-drawn markers"},{"type":"INSERT","lineNumber":54,"content":"        points.forEachIndexed { index, point ->"},{"type":"INSERT","lineNumber":55,"content":"            Marker("},{"type":"INSERT","lineNumber":56,"content":"                state = MarkerState(position = point),"},{"type":"INSERT","lineNumber":57,"content":"                title = \"Marker ${index + 1}\","},{"type":"DELETE","lineNumber":48,"oldContent":"                title = \"Drone Location\""},{"type":"DELETE","lineNumber":51,"oldContent":"            )"},{"type":"DELETE","lineNumber":54,"oldContent":"        }"},{"type":"DELETE","lineNumber":56,"oldContent":""},{"type":"DELETE","lineNumber":58,"oldContent":"        // User-drawn markers"},{"type":"DELETE","lineNumber":60,"oldContent":"            Marker("},{"type":"DELETE","lineNumber":62,"oldContent":"                state = MarkerState(position = point),"},{"type":"DELETE","lineNumber":64,"oldContent":"                title = \"Marker ${index + 1}\","},{"type":"DELETE","lineNumber":79,"oldContent":""}]},{"timestamp":1757915781162,"changes":[{"type":"MODIFY","lineNumber":13,"content":"<<<<<<< Updated upstream","oldContent":"    var points by remember { mutableStateOf(listOf<LatLng>()) }"},{"type":"MODIFY","lineNumber":16,"content":"    var points by remember { mutableStateOf(listOf<LatLng>()) }","oldContent":"    var polygonClosed by remember { mutableStateOf(false) }"},{"type":"INSERT","lineNumber":17,"content":"======="},{"type":"INSERT","lineNumber":18,"content":"    points: List<LatLng> = emptyList(),"},{"type":"INSERT","lineNumber":19,"content":"    onMapClick: (LatLng) -> Unit = {}"},{"type":"INSERT","lineNumber":20,"content":") {"},{"type":"INSERT","lineNumber":21,"content":"    var internalPoints by remember { mutableStateOf(points) }"},{"type":"INSERT","lineNumber":22,"content":">>>>>>> Stashed changes"},{"type":"INSERT","lineNumber":23,"content":"    var polygonClosed by remember { mutableStateOf(false) }"},{"type":"INSERT","lineNumber":40,"content":"    // Keep internalPoints in sync when parent points change"},{"type":"INSERT","lineNumber":41,"content":"    LaunchedEffect(points) {"},{"type":"INSERT","lineNumber":42,"content":"        internalPoints = points"},{"type":"INSERT","lineNumber":43,"content":"    }"},{"type":"INSERT","lineNumber":44,"content":""},{"type":"INSERT","lineNumber":48,"content":"        properties = MapProperties(mapType = mapType), // ✅ Map type applied"},{"type":"DELETE","lineNumber":38,"oldContent":"        properties = MapProperties(mapType = mapType), // ✅ Map type applied"},{"type":"INSERT","lineNumber":51,"content":"                // Notify parent"},{"type":"INSERT","lineNumber":52,"content":"                onMapClick(latLng)"},{"type":"INSERT","lineNumber":53,"content":"                // update internal copy for immediate UI feedback"},{"type":"INSERT","lineNumber":54,"content":"                internalPoints = internalPoints + latLng"},{"type":"DELETE","lineNumber":42,"oldContent":"                points = points + latLng"},{"type":"DELETE","lineNumber":49,"oldContent":"                onClick = {"},{"type":"DELETE","lineNumber":50,"oldContent":"                    if (points.size > 1 && !polygonClosed) {"},{"type":"DELETE","lineNumber":52,"oldContent":"                        val last = points.last()"},{"type":"DELETE","lineNumber":54,"oldContent":""},{"type":"DELETE","lineNumber":57,"oldContent":"                        if (point == points.first() && points.size > 2) {"},{"type":"DELETE","lineNumber":59,"oldContent":"                            points = points + point"},{"type":"DELETE","lineNumber":60,"oldContent":"        points.forEachIndexed { index, point ->"},{"type":"INSERT","lineNumber":69,"content":"        internalPoints.forEachIndexed { index, point ->"},{"type":"DELETE","lineNumber":62,"oldContent":"                            polygonClosed = true"},{"type":"DELETE","lineNumber":65,"oldContent":"                        } else if (point != last) {"},{"type":"DELETE","lineNumber":66,"oldContent":"                            points = points + point"},{"type":"DELETE","lineNumber":67,"oldContent":"                        }"},{"type":"DELETE","lineNumber":68,"oldContent":"                    }"},{"type":"DELETE","lineNumber":69,"oldContent":"                    true"},{"type":"DELETE","lineNumber":70,"oldContent":"                }"},{"type":"DELETE","lineNumber":75,"oldContent":"        if (points.size > 1) {"},{"type":"INSERT","lineNumber":77,"content":"        if (internalPoints.size > 1) {"},{"type":"DELETE","lineNumber":77,"oldContent":"                points = points,"},{"type":"INSERT","lineNumber":79,"content":"                points = internalPoints,"}]},{"timestamp":1757915853667,"changes":[{"type":"DELETE","lineNumber":11,"oldContent":"fun GcsMap("},{"type":"DELETE","lineNumber":12,"oldContent":"    telemetryState: TelemetryState,"},{"type":"DELETE","lineNumber":13,"oldContent":"<<<<<<< Updated upstream"},{"type":"DELETE","lineNumber":14,"oldContent":"    mapType: MapType"},{"type":"DELETE","lineNumber":15,"oldContent":"    var polygonClosed by remember { mutableStateOf(false) }"},{"type":"INSERT","lineNumber":11,"content":"fun GcsMap(telemetryState: TelemetryState) {"},{"type":"DELETE","lineNumber":17,"oldContent":"======="},{"type":"INSERT","lineNumber":13,"content":"    var polygonClosed by remember { mutableStateOf(false) }"},{"type":"DELETE","lineNumber":19,"oldContent":"    points: List<LatLng> = emptyList(),"},{"type":"DELETE","lineNumber":21,"oldContent":"    onMapClick: (LatLng) -> Unit = {}"},{"type":"DELETE","lineNumber":23,"oldContent":") {"},{"type":"DELETE","lineNumber":25,"oldContent":"    var internalPoints by remember { mutableStateOf(points) }"},{"type":"DELETE","lineNumber":27,"oldContent":">>>>>>> Stashed changes"},{"type":"DELETE","lineNumber":29,"oldContent":"    var polygonClosed by remember { mutableStateOf(false) }"},{"type":"INSERT","lineNumber":35,"content":"                points = points + latLng"},{"type":"DELETE","lineNumber":46,"oldContent":"    // Keep internalPoints in sync when parent points change"},{"type":"DELETE","lineNumber":48,"oldContent":"    LaunchedEffect(points) {"},{"type":"DELETE","lineNumber":50,"oldContent":"        internalPoints = points"},{"type":"DELETE","lineNumber":51,"oldContent":"    }"},{"type":"DELETE","lineNumber":53,"oldContent":""},{"type":"DELETE","lineNumber":58,"oldContent":"        properties = MapProperties(mapType = mapType), // ✅ Map type applied"},{"type":"DELETE","lineNumber":60,"oldContent":"                // Notify parent"},{"type":"DELETE","lineNumber":62,"oldContent":"                onMapClick(latLng)"},{"type":"DELETE","lineNumber":63,"oldContent":"                // update internal copy for immediate UI feedback"},{"type":"DELETE","lineNumber":65,"oldContent":"                internalPoints = internalPoints + latLng"},{"type":"INSERT","lineNumber":50,"content":"        points.forEachIndexed { index, point ->"},{"type":"DELETE","lineNumber":72,"oldContent":"        internalPoints.forEachIndexed { index, point ->"},{"type":"INSERT","lineNumber":54,"content":"                onClick = {"},{"type":"INSERT","lineNumber":55,"content":"                    if (points.size > 1 && !polygonClosed) {"},{"type":"INSERT","lineNumber":56,"content":"                        val last = points.last()"},{"type":"INSERT","lineNumber":57,"content":""},{"type":"INSERT","lineNumber":58,"content":"                        if (point == points.first() && points.size > 2) {"},{"type":"INSERT","lineNumber":59,"content":"                            points = points + point"},{"type":"INSERT","lineNumber":60,"content":"                            polygonClosed = true"},{"type":"INSERT","lineNumber":61,"content":"                        } else if (point != last) {"},{"type":"INSERT","lineNumber":62,"content":"                            points = points + point"},{"type":"INSERT","lineNumber":63,"content":"                        }"},{"type":"INSERT","lineNumber":64,"content":"                    }"},{"type":"INSERT","lineNumber":65,"content":"                    true"},{"type":"INSERT","lineNumber":66,"content":"                }"},{"type":"INSERT","lineNumber":71,"content":"        if (points.size > 1) {"},{"type":"DELETE","lineNumber":78,"oldContent":"        if (internalPoints.size > 1) {"},{"type":"INSERT","lineNumber":73,"content":"                points = points,"},{"type":"DELETE","lineNumber":80,"oldContent":"                points = internalPoints,"},{"type":"INSERT","lineNumber":79,"content":""}]}]},"C:/Users/Hrushikesh/AndroidStudioProjects/SampleGCS/app/src/main/java/com/example/aerogcsclone/Telemetry/SharedViewModel.kt":{"filePath":"C:/Users/Hrushikesh/AndroidStudioProjects/SampleGCS/app/src/main/java/com/example/aerogcsclone/Telemetry/SharedViewModel.kt","baseContent":"package com.example.aerogcsclone.Telemetry\n\nimport androidx.compose.runtime.getValue\nimport androidx.compose.runtime.mutableStateOf\nimport androidx.compose.runtime.setValue\nimport androidx.lifecycle.ViewModel\nimport androidx.lifecycle.viewModelScope\nimport kotlinx.coroutines.flow.Flow\nimport kotlinx.coroutines.flow.StateFlow\nimport kotlinx.coroutines.flow.combine\nimport kotlinx.coroutines.launch\n\nclass SharedViewModel : ViewModel() {\n\n    var ipAddress by mutableStateOf(\"10.0.2.2\")\n    var port by mutableStateOf(\"5762\")\n\n    private var repo: MavlinkTelemetryRepository? = null\n\n    private val _telemetryState = mutableStateOf(TelemetryState())\n    val telemetryState: StateFlow<TelemetryState> = _telemetryState\n\n    val isConnected: Flow<ERROR> = telemetryState.combine(repo?.state) { state, repoState ->\n        state.connected || repoState?.connected == true\n    }\n\n\n    fun connect() {\n        viewModelScope.launch {\n            val portInt = port.toIntOrNull()\n            if (portInt != null) {\n                val newRepo = MavlinkTelemetryRepository(ipAddress, portInt)\n                repo = newRepo\n                newRepo.start()\n                newRepo.state.collect {\n                    _telemetryState.value = it\n                }\n            }\n        }\n    }\n}\n","baseTimestamp":1757400233339,"deltas":[{"timestamp":1757400239338,"changes":[{"type":"DELETE","lineNumber":7,"oldContent":"import kotlinx.coroutines.flow.Flow"},{"type":"MODIFY","lineNumber":21,"content":"    val isConnected: StateFlow<Boolean> = telemetryState.combine(repo?.state) { state, repoState ->","oldContent":"    val isConnected: Flow<ERROR> = telemetryState.combine(repo?.state) { state, repoState ->"}]},{"timestamp":1757400258744,"changes":[{"type":"INSERT","lineNumber":20,"content":""},{"type":"DELETE","lineNumber":21,"oldContent":"    val isConnected: Flow<ERROR> = telemetryState.combine(repo?.state) { state, repoState ->"},{"type":"MODIFY","lineNumber":23,"content":"    } as StateFlow<Boolean>","oldContent":"    }"}]},{"timestamp":1757400271889,"changes":[{"type":"MODIFY","lineNumber":19,"content":"    val telemetryState: StateFlow<TelemetryState> = _telemetryState as StateFlow<TelemetryState>","oldContent":"    val telemetryState: StateFlow<TelemetryState> = _telemetryState"}]},{"timestamp":1757400277822,"changes":[{"type":"INSERT","lineNumber":7,"content":"import kotlinx.coroutines.flow.Flow"},{"type":"MODIFY","lineNumber":22,"content":"    val isConnected: StateFlow<Boolean> = telemetryState.combine(repo?.state as Flow<T2>) { state, repoState ->","oldContent":"    val isConnected: StateFlow<Boolean> = telemetryState.combine(repo?.state) { state, repoState ->"}]},{"timestamp":1757400285451,"changes":[{"type":"DELETE","lineNumber":7,"oldContent":"import kotlinx.coroutines.flow.Flow"},{"type":"MODIFY","lineNumber":19,"content":"    val telemetryState: StateFlow<TelemetryState> = _telemetryState","oldContent":"    val telemetryState: StateFlow<TelemetryState> = _telemetryState as StateFlow<TelemetryState>"},{"type":"DELETE","lineNumber":23,"oldContent":"    val isConnected: StateFlow<Boolean> = telemetryState.combine(repo?.state as Flow<T2>) { state, repoState ->"},{"type":"INSERT","lineNumber":22,"content":"        state.connected || repoState?.connected == true"}]},{"timestamp":1757411797636,"changes":[{"type":"DELETE","lineNumber":7,"oldContent":"import kotlinx.coroutines.flow.StateFlow"},{"type":"MODIFY","lineNumber":7,"content":"import kotlinx.coroutines.flow.*","oldContent":"import kotlinx.coroutines.flow.combine"},{"type":"DELETE","lineNumber":18,"oldContent":"    val telemetryState: StateFlow<TelemetryState> = _telemetryState"},{"type":"DELETE","lineNumber":19,"oldContent":"    val telemetryState: StateFlow<TelemetryState> = _telemetryState as StateFlow<TelemetryState>"},{"type":"INSERT","lineNumber":17,"content":"    private val _telemetryState = MutableStateFlow(TelemetryState())"},{"type":"INSERT","lineNumber":18,"content":"    val telemetryState: StateFlow<TelemetryState> = _telemetryState.asStateFlow()"},{"type":"DELETE","lineNumber":21,"oldContent":"        state.connected || repoState?.connected == true"},{"type":"DELETE","lineNumber":22,"oldContent":"    val isConnected: StateFlow<Boolean> = telemetryState.combine(repo?.state) { state, repoState ->"},{"type":"DELETE","lineNumber":23,"oldContent":"    } as StateFlow<Boolean>"},{"type":"INSERT","lineNumber":20,"content":"    val isConnected: StateFlow<Boolean> = telemetryState"},{"type":"INSERT","lineNumber":21,"content":"        .map { it.connected }"},{"type":"INSERT","lineNumber":22,"content":"        .stateIn(viewModelScope, SharingStarted.WhileSubscribed(5000), false)"},{"type":"DELETE","lineNumber":25,"oldContent":""}]},{"timestamp":1757657536151,"changes":[{"type":"MODIFY","lineNumber":17,"content":"    private val _telemetryState = MutableStateFlow(TelemetryState())","oldContent":"    private val _telemetryState = MutableStateFlow(TelemetryState())"},{"type":"MODIFY","lineNumber":20,"content":"    val isConnected: StateFlow<Boolean> = telemetryState","oldContent":"    val isConnected: StateFlow<Boolean> = telemetryState"},{"type":"INSERT","lineNumber":37,"content":""},{"type":"INSERT","lineNumber":38,"content":"    fun arm() {"},{"type":"INSERT","lineNumber":39,"content":"        viewModelScope.launch {"},{"type":"INSERT","lineNumber":40,"content":"            repo?.arm()"},{"type":"INSERT","lineNumber":41,"content":"        }"},{"type":"INSERT","lineNumber":42,"content":"    }"}]},{"timestamp":1757909141732,"changes":[{"type":"INSERT","lineNumber":7,"content":"import com.example.aerogcsclone.uimain.Geometry"},{"type":"INSERT","lineNumber":8,"content":"import com.google.android.gms.maps.model.LatLng"},{"type":"INSERT","lineNumber":14,"content":"    var waypoints by mutableStateOf(listOf<LatLng>())"},{"type":"INSERT","lineNumber":15,"content":"        private set"},{"type":"INSERT","lineNumber":16,"content":""},{"type":"INSERT","lineNumber":17,"content":"    fun addWaypoint(latLng: LatLng) {"},{"type":"INSERT","lineNumber":18,"content":"        waypoints = waypoints + latLng"},{"type":"INSERT","lineNumber":19,"content":"    }"},{"type":"INSERT","lineNumber":20,"content":""},{"type":"INSERT","lineNumber":25,"content":""},{"type":"DELETE","lineNumber":17,"oldContent":"    private val _telemetryState = MutableStateFlow(TelemetryState())"},{"type":"INSERT","lineNumber":28,"content":""},{"type":"DELETE","lineNumber":20,"oldContent":"    val isConnected: StateFlow<Boolean> = telemetryState"},{"type":"DELETE","lineNumber":38,"oldContent":"}"},{"type":"INSERT","lineNumber":48,"content":"        viewModelScope.launch {"},{"type":"INSERT","lineNumber":49,"content":"            repo?.arm()"},{"type":"INSERT","lineNumber":50,"content":"        }"},{"type":"INSERT","lineNumber":51,"content":"    }"},{"type":"INSERT","lineNumber":53,"content":"    fun loadMission() {"},{"type":"INSERT","lineNumber":55,"content":"            repo?.loadMission(waypoints)"},{"type":"INSERT","lineNumber":56,"content":"        }"},{"type":"DELETE","lineNumber":43,"oldContent":"            repo?.arm()"},{"type":"INSERT","lineNumber":58,"content":""},{"type":"INSERT","lineNumber":59,"content":"    fun startMission() {"},{"type":"INSERT","lineNumber":60,"content":"        viewModelScope.launch {"},{"type":"INSERT","lineNumber":61,"content":"            repo?.startMission()"},{"type":"INSERT","lineNumber":63,"content":"    }"},{"type":"INSERT","lineNumber":64,"content":""},{"type":"INSERT","lineNumber":65,"content":"    fun resetMissionLoaded() {"},{"type":"INSERT","lineNumber":66,"content":"        // This is not ideal, we should be updating the state in the repo"},{"type":"INSERT","lineNumber":67,"content":"        // and have it flow up, but for now this will do."},{"type":"INSERT","lineNumber":68,"content":"        _telemetryState.update { it.copy(missionLoaded = false) }"},{"type":"INSERT","lineNumber":69,"content":"    }"},{"type":"INSERT","lineNumber":70,"content":""},{"type":"INSERT","lineNumber":71,"content":"    fun deleteLastWaypoint() {"},{"type":"INSERT","lineNumber":72,"content":"        if (waypoints.isNotEmpty()) {"},{"type":"INSERT","lineNumber":73,"content":"            waypoints = waypoints.dropLast(1)"},{"type":"INSERT","lineNumber":74,"content":"        }"},{"type":"INSERT","lineNumber":75,"content":"    }"},{"type":"INSERT","lineNumber":76,"content":""},{"type":"INSERT","lineNumber":77,"content":"    fun clearAllWaypoints() {"},{"type":"INSERT","lineNumber":78,"content":"        waypoints = emptyList()"},{"type":"INSERT","lineNumber":79,"content":"    }"},{"type":"INSERT","lineNumber":80,"content":"}"},{"type":"INSERT","lineNumber":81,"content":""}]},{"timestamp":1757912368628,"changes":[{"type":"DELETE","lineNumber":7,"oldContent":"import com.example.aerogcsclone.uimain.Geometry"},{"type":"DELETE","lineNumber":9,"oldContent":"import com.google.android.gms.maps.model.LatLng"},{"type":"DELETE","lineNumber":16,"oldContent":"    var waypoints by mutableStateOf(listOf<LatLng>())"},{"type":"DELETE","lineNumber":18,"oldContent":"        private set"},{"type":"DELETE","lineNumber":22,"oldContent":"    fun addWaypoint(latLng: LatLng) {"},{"type":"DELETE","lineNumber":23,"oldContent":"        waypoints = waypoints + latLng"},{"type":"DELETE","lineNumber":25,"oldContent":"    }"},{"type":"DELETE","lineNumber":26,"oldContent":"    val isConnected: StateFlow<Boolean> = telemetryState"},{"type":"INSERT","lineNumber":20,"content":"    val isConnected: StateFlow<Boolean> = telemetryState"},{"type":"DELETE","lineNumber":31,"oldContent":"    fun connect() {"},{"type":"INSERT","lineNumber":24,"content":"    var missionUploaded by mutableStateOf(false)"},{"type":"INSERT","lineNumber":26,"content":"    fun connect() {"},{"type":"DELETE","lineNumber":36,"oldContent":""},{"type":"DELETE","lineNumber":48,"oldContent":""},{"type":"DELETE","lineNumber":50,"oldContent":"    }"},{"type":"INSERT","lineNumber":42,"content":"            repo?.arm()"},{"type":"DELETE","lineNumber":52,"oldContent":""},{"type":"DELETE","lineNumber":53,"oldContent":"}"},{"type":"INSERT","lineNumber":45,"content":""},{"type":"INSERT","lineNumber":46,"content":"    fun uploadMission(missionItems: List<MissionItemInt>, onResult: (Boolean, String?) -> Unit = { _, _ -> }) {"},{"type":"DELETE","lineNumber":56,"oldContent":"        waypoints = emptyList()"},{"type":"DELETE","lineNumber":57,"oldContent":"            repo?.arm()"},{"type":"DELETE","lineNumber":58,"oldContent":"    fun clearAllWaypoints() {"},{"type":"INSERT","lineNumber":48,"content":"            try {"},{"type":"INSERT","lineNumber":49,"content":"                repo?.uploadMission(missionItems)"},{"type":"INSERT","lineNumber":50,"content":"                missionUploaded = true"},{"type":"INSERT","lineNumber":51,"content":"                onResult(true, null)"},{"type":"INSERT","lineNumber":52,"content":"            } catch (e: Exception) {"},{"type":"INSERT","lineNumber":53,"content":"                missionUploaded = false"},{"type":"INSERT","lineNumber":54,"content":"                onResult(false, e.message)"},{"type":"INSERT","lineNumber":55,"content":"            }"},{"type":"DELETE","lineNumber":60,"oldContent":""},{"type":"DELETE","lineNumber":62,"oldContent":"    }"},{"type":"DELETE","lineNumber":63,"oldContent":"        }"},{"type":"DELETE","lineNumber":64,"oldContent":"    fun loadMission() {"},{"type":"DELETE","lineNumber":65,"oldContent":"            waypoints = waypoints.dropLast(1)"},{"type":"DELETE","lineNumber":66,"oldContent":"        if (waypoints.isNotEmpty()) {"},{"type":"DELETE","lineNumber":67,"oldContent":"            repo?.loadMission(waypoints)"},{"type":"DELETE","lineNumber":68,"oldContent":"    fun deleteLastWaypoint() {"},{"type":"DELETE","lineNumber":69,"oldContent":"        }"},{"type":"DELETE","lineNumber":71,"oldContent":"    }"},{"type":"DELETE","lineNumber":72,"oldContent":""},{"type":"DELETE","lineNumber":73,"oldContent":"        _telemetryState.update { it.copy(missionLoaded = false) }"},{"type":"DELETE","lineNumber":74,"oldContent":"    fun startMission() {"},{"type":"DELETE","lineNumber":75,"oldContent":"        // and have it flow up, but for now this will do."},{"type":"INSERT","lineNumber":59,"content":"    fun startMission(onResult: (Boolean, String?) -> Unit = { _, _ -> }) {"},{"type":"DELETE","lineNumber":77,"oldContent":"        // This is not ideal, we should be updating the state in the repo"},{"type":"DELETE","lineNumber":78,"oldContent":"            repo?.startMission()"},{"type":"DELETE","lineNumber":79,"oldContent":"    fun resetMissionLoaded() {"},{"type":"DELETE","lineNumber":80,"oldContent":""},{"type":"INSERT","lineNumber":61,"content":"            try {"},{"type":"INSERT","lineNumber":62,"content":"                repo?.startMission()"},{"type":"INSERT","lineNumber":63,"content":"                onResult(true, null)"},{"type":"INSERT","lineNumber":64,"content":"            } catch (e: Exception) {"},{"type":"INSERT","lineNumber":65,"content":"                onResult(false, e.message)"},{"type":"INSERT","lineNumber":66,"content":"            }"},{"type":"INSERT","lineNumber":67,"content":"        }"},{"type":"INSERT","lineNumber":69,"content":"}"},{"type":"INSERT","lineNumber":70,"content":""}]},{"timestamp":1757912432497,"changes":[{"type":"INSERT","lineNumber":7,"content":"import com.example.aerogcsclone.Telemetry.MissionItemInt"},{"type":"DELETE","lineNumber":16,"oldContent":"    val isConnected: StateFlow<Boolean> = telemetryState"},{"type":"DELETE","lineNumber":19,"oldContent":"    var missionUploaded by mutableStateOf(false)"},{"type":"MODIFY","lineNumber":21,"content":"    val isConnected: StateFlow<Boolean> = telemetryState","oldContent":"    fun connect() {"},{"type":"INSERT","lineNumber":25,"content":"    var missionUploaded by mutableStateOf(false)"},{"type":"INSERT","lineNumber":27,"content":"    fun connect() {"},{"type":"DELETE","lineNumber":35,"oldContent":"            repo?.arm()"},{"type":"DELETE","lineNumber":39,"oldContent":""},{"type":"DELETE","lineNumber":41,"oldContent":"    fun uploadMission(missionItems: List<MissionItemInt>, onResult: (Boolean, String?) -> Unit = { _, _ -> }) {"},{"type":"INSERT","lineNumber":42,"content":"        viewModelScope.launch {"},{"type":"INSERT","lineNumber":43,"content":"            repo?.arm()"},{"type":"INSERT","lineNumber":44,"content":"        }"},{"type":"INSERT","lineNumber":45,"content":"    }"},{"type":"INSERT","lineNumber":46,"content":""},{"type":"INSERT","lineNumber":47,"content":"    fun uploadMission(missionItems: List<MissionItemInt>, onResult: (Boolean, String?) -> Unit = { _, _ -> }) {"},{"type":"INSERT","lineNumber":48,"content":"        viewModelScope.launch {"},{"type":"DELETE","lineNumber":46,"oldContent":"        viewModelScope.launch {"},{"type":"DELETE","lineNumber":49,"oldContent":"        }"},{"type":"DELETE","lineNumber":53,"oldContent":"    }"},{"type":"DELETE","lineNumber":55,"oldContent":"        viewModelScope.launch {"},{"type":"DELETE","lineNumber":56,"oldContent":"    fun startMission(onResult: (Boolean, String?) -> Unit = { _, _ -> }) {"},{"type":"DELETE","lineNumber":58,"oldContent":"            try {"},{"type":"INSERT","lineNumber":59,"content":""},{"type":"INSERT","lineNumber":60,"content":"    fun startMission(onResult: (Boolean, String?) -> Unit = { _, _ -> }) {"},{"type":"INSERT","lineNumber":61,"content":"        viewModelScope.launch {"},{"type":"INSERT","lineNumber":62,"content":"            try {"},{"type":"INSERT","lineNumber":69,"content":"    }"},{"type":"DELETE","lineNumber":68,"oldContent":""},{"type":"DELETE","lineNumber":69,"oldContent":"        viewModelScope.launch {"},{"type":"DELETE","lineNumber":70,"oldContent":"    }"}]},{"timestamp":1757912527357,"changes":[{"type":"INSERT","lineNumber":7,"content":"import com.divpundir.mavlink.definitions.common.MissionItemInt"},{"type":"DELETE","lineNumber":20,"oldContent":"    val isConnected: StateFlow<Boolean> = telemetryState"},{"type":"INSERT","lineNumber":22,"content":"    val isConnected: StateFlow<Boolean> = telemetryState"},{"type":"INSERT","lineNumber":25,"content":""},{"type":"DELETE","lineNumber":26,"oldContent":""},{"type":"DELETE","lineNumber":40,"oldContent":"        viewModelScope.launch {"},{"type":"DELETE","lineNumber":42,"oldContent":"            repo?.arm()"},{"type":"INSERT","lineNumber":43,"content":"        viewModelScope.launch {"},{"type":"INSERT","lineNumber":44,"content":"            repo?.arm()"},{"type":"DELETE","lineNumber":45,"oldContent":"            try {"},{"type":"DELETE","lineNumber":47,"oldContent":"                repo?.uploadMission(missionItems)"},{"type":"MODIFY","lineNumber":50,"content":"            try {","oldContent":"                missionUploaded = true"},{"type":"INSERT","lineNumber":51,"content":"                repo?.uploadMission(missionItems)"},{"type":"INSERT","lineNumber":52,"content":"                missionUploaded = true"},{"type":"DELETE","lineNumber":58,"oldContent":""},{"type":"INSERT","lineNumber":60,"content":""},{"type":"DELETE","lineNumber":61,"oldContent":"                repo?.startMission()"},{"type":"DELETE","lineNumber":63,"oldContent":"                onResult(true, null)"},{"type":"INSERT","lineNumber":64,"content":"                repo?.startMission()"},{"type":"INSERT","lineNumber":65,"content":"                onResult(true, null)"},{"type":"INSERT","lineNumber":70,"content":"    }"},{"type":"DELETE","lineNumber":71,"oldContent":"    }"}]},{"timestamp":1757912534883,"changes":[{"type":"MODIFY","lineNumber":8,"content":"//import com.example.aerogcsclone.Telemetry.MissionItemInt","oldContent":"import com.example.aerogcsclone.Telemetry.MissionItemInt"},{"type":"INSERT","lineNumber":25,"content":""},{"type":"DELETE","lineNumber":27,"oldContent":""},{"type":"MODIFY","lineNumber":43,"content":"        viewModelScope.launch {","oldContent":"        viewModelScope.launch {"},{"type":"INSERT","lineNumber":49,"content":"        viewModelScope.launch {"},{"type":"DELETE","lineNumber":51,"oldContent":"        viewModelScope.launch {"},{"type":"MODIFY","lineNumber":64,"content":"                repo?.startMission()","oldContent":"                repo?.startMission()"},{"type":"MODIFY","lineNumber":71,"content":"}","oldContent":"}"}]},{"timestamp":1757913228531,"changes":[{"type":"INSERT","lineNumber":42,"content":"    fun arm() {"},{"type":"DELETE","lineNumber":43,"oldContent":"        viewModelScope.launch {"},{"type":"DELETE","lineNumber":51,"oldContent":"                repo?.uploadMission(missionItems)"},{"type":"DELETE","lineNumber":52,"oldContent":"                missionUploaded = true"},{"type":"DELETE","lineNumber":53,"oldContent":"                onResult(true, null)"},{"type":"INSERT","lineNumber":51,"content":"                val success = repo?.uploadMissionWithAck(missionItems) ?: false"},{"type":"INSERT","lineNumber":52,"content":"                missionUploaded = success"},{"type":"INSERT","lineNumber":53,"content":"                if (success) {"},{"type":"INSERT","lineNumber":54,"content":"                    onResult(true, null)"},{"type":"INSERT","lineNumber":55,"content":"                } else {"},{"type":"INSERT","lineNumber":56,"content":"                    onResult(false, \"Mission upload failed or timed out\")"},{"type":"INSERT","lineNumber":57,"content":"                }"},{"type":"INSERT","lineNumber":67,"content":"            try {"},{"type":"DELETE","lineNumber":64,"oldContent":"                repo?.startMission()"},{"type":"INSERT","lineNumber":74,"content":"    }"},{"type":"DELETE","lineNumber":71,"oldContent":"}"}]},{"timestamp":1757915308318,"changes":[{"type":"INSERT","lineNumber":27,"content":"    var lastUploadedCount by mutableStateOf(0)"},{"type":"INSERT","lineNumber":55,"content":"                    lastUploadedCount = missionItems.size"},{"type":"DELETE","lineNumber":55,"oldContent":"            } catch (e: Exception) {"},{"type":"MODIFY","lineNumber":58,"content":"                    lastUploadedCount = 0","oldContent":"                missionUploaded = false"},{"type":"DELETE","lineNumber":59,"oldContent":"                onResult(false, e.message)"},{"type":"INSERT","lineNumber":61,"content":"            } catch (e: Exception) {"},{"type":"INSERT","lineNumber":62,"content":"                missionUploaded = false"},{"type":"INSERT","lineNumber":63,"content":"                lastUploadedCount = 0"},{"type":"INSERT","lineNumber":64,"content":"                onResult(false, e.message)"},{"type":"DELETE","lineNumber":67,"oldContent":"                repo?.startMission()"},{"type":"INSERT","lineNumber":71,"content":"            try {"},{"type":"INSERT","lineNumber":72,"content":"                val last = if (lastUploadedCount > 0) lastUploadedCount - 1 else 0"},{"type":"INSERT","lineNumber":73,"content":"                repo?.startMission(0, last)"},{"type":"DELETE","lineNumber":70,"oldContent":"            try {"},{"type":"INSERT","lineNumber":79,"content":"    }"},{"type":"DELETE","lineNumber":76,"oldContent":"    }"}]},{"timestamp":1757915700671,"changes":[{"type":"DELETE","lineNumber":7,"oldContent":"import com.divpundir.mavlink.definitions.common.MissionItemInt"},{"type":"DELETE","lineNumber":8,"oldContent":"//import com.example.aerogcsclone.Telemetry.MissionItemInt"},{"type":"DELETE","lineNumber":26,"oldContent":"    var missionUploaded by mutableStateOf(false)"},{"type":"DELETE","lineNumber":27,"oldContent":"    var lastUploadedCount by mutableStateOf(0)"},{"type":"DELETE","lineNumber":28,"oldContent":""},{"type":"DELETE","lineNumber":48,"oldContent":""},{"type":"DELETE","lineNumber":49,"oldContent":"    fun uploadMission(missionItems: List<MissionItemInt>, onResult: (Boolean, String?) -> Unit = { _, _ -> }) {"},{"type":"DELETE","lineNumber":50,"oldContent":"        viewModelScope.launch {"},{"type":"DELETE","lineNumber":51,"oldContent":"            try {"},{"type":"DELETE","lineNumber":52,"oldContent":"                val success = repo?.uploadMissionWithAck(missionItems) ?: false"},{"type":"DELETE","lineNumber":53,"oldContent":"                missionUploaded = success"},{"type":"DELETE","lineNumber":54,"oldContent":"                if (success) {"},{"type":"DELETE","lineNumber":55,"oldContent":"                    onResult(true, null)"},{"type":"DELETE","lineNumber":56,"oldContent":"                    lastUploadedCount = missionItems.size"},{"type":"DELETE","lineNumber":57,"oldContent":"                } else {"},{"type":"DELETE","lineNumber":58,"oldContent":"                missionUploaded = false"},{"type":"DELETE","lineNumber":59,"oldContent":"                    lastUploadedCount = 0"},{"type":"DELETE","lineNumber":60,"oldContent":"                }"},{"type":"DELETE","lineNumber":61,"oldContent":"            } catch (e: Exception) {"},{"type":"DELETE","lineNumber":62,"oldContent":"            }"},{"type":"DELETE","lineNumber":63,"oldContent":"                missionUploaded = false"},{"type":"DELETE","lineNumber":64,"oldContent":"        }"},{"type":"DELETE","lineNumber":65,"oldContent":"                lastUploadedCount = 0"},{"type":"DELETE","lineNumber":66,"oldContent":"    }"},{"type":"DELETE","lineNumber":67,"oldContent":"                onResult(false, e.message)"},{"type":"DELETE","lineNumber":68,"oldContent":""},{"type":"DELETE","lineNumber":69,"oldContent":"    fun startMission(onResult: (Boolean, String?) -> Unit = { _, _ -> }) {"},{"type":"DELETE","lineNumber":70,"oldContent":"        viewModelScope.launch {"},{"type":"DELETE","lineNumber":71,"oldContent":"                onResult(true, null)"},{"type":"DELETE","lineNumber":72,"oldContent":"            } catch (e: Exception) {"},{"type":"DELETE","lineNumber":73,"oldContent":"            try {"},{"type":"DELETE","lineNumber":74,"oldContent":"                onResult(false, e.message)"},{"type":"DELETE","lineNumber":75,"oldContent":"                val last = if (lastUploadedCount > 0) lastUploadedCount - 1 else 0"},{"type":"DELETE","lineNumber":76,"oldContent":"            }"},{"type":"DELETE","lineNumber":77,"oldContent":"                repo?.startMission(0, last)"},{"type":"DELETE","lineNumber":78,"oldContent":"        }"},{"type":"DELETE","lineNumber":81,"oldContent":"    }"}]},{"timestamp":1757915781162,"changes":[{"type":"INSERT","lineNumber":7,"content":"import com.divpundir.mavlink.definitions.common.MissionItemInt"},{"type":"INSERT","lineNumber":8,"content":"//import com.example.aerogcsclone.Telemetry.MissionItemInt"},{"type":"INSERT","lineNumber":26,"content":"    var missionUploaded by mutableStateOf(false)"},{"type":"INSERT","lineNumber":27,"content":"    var lastUploadedCount by mutableStateOf(0)"},{"type":"INSERT","lineNumber":28,"content":""},{"type":"INSERT","lineNumber":48,"content":""},{"type":"INSERT","lineNumber":49,"content":"    fun uploadMission(missionItems: List<MissionItemInt>, onResult: (Boolean, String?) -> Unit = { _, _ -> }) {"},{"type":"INSERT","lineNumber":50,"content":"        viewModelScope.launch {"},{"type":"INSERT","lineNumber":51,"content":"            try {"},{"type":"INSERT","lineNumber":52,"content":"                val success = repo?.uploadMissionWithAck(missionItems) ?: false"},{"type":"INSERT","lineNumber":53,"content":"                missionUploaded = success"},{"type":"INSERT","lineNumber":54,"content":"                if (success) {"},{"type":"INSERT","lineNumber":55,"content":"                    lastUploadedCount = missionItems.size"},{"type":"INSERT","lineNumber":56,"content":"                    onResult(true, null)"},{"type":"INSERT","lineNumber":57,"content":"                } else {"},{"type":"INSERT","lineNumber":58,"content":"                    lastUploadedCount = 0"},{"type":"INSERT","lineNumber":59,"content":"                    onResult(false, \"Mission upload failed or timed out\")"},{"type":"INSERT","lineNumber":60,"content":"                }"},{"type":"INSERT","lineNumber":61,"content":"            } catch (e: Exception) {"},{"type":"INSERT","lineNumber":62,"content":"                missionUploaded = false"},{"type":"INSERT","lineNumber":63,"content":"                lastUploadedCount = 0"},{"type":"INSERT","lineNumber":64,"content":"                onResult(false, e.message)"},{"type":"INSERT","lineNumber":65,"content":"            }"},{"type":"INSERT","lineNumber":66,"content":"        }"},{"type":"INSERT","lineNumber":67,"content":"    }"},{"type":"INSERT","lineNumber":68,"content":""},{"type":"INSERT","lineNumber":69,"content":"    fun startMission(onResult: (Boolean, String?) -> Unit = { _, _ -> }) {"},{"type":"INSERT","lineNumber":70,"content":"        viewModelScope.launch {"},{"type":"INSERT","lineNumber":71,"content":"            try {"},{"type":"INSERT","lineNumber":72,"content":"                val last = if (lastUploadedCount > 0) lastUploadedCount - 1 else 0"},{"type":"INSERT","lineNumber":73,"content":"                repo?.startMission(0, last)"},{"type":"INSERT","lineNumber":74,"content":"                onResult(true, null)"},{"type":"INSERT","lineNumber":75,"content":"            } catch (e: Exception) {"},{"type":"INSERT","lineNumber":76,"content":"                onResult(false, e.message)"},{"type":"INSERT","lineNumber":77,"content":"            }"},{"type":"INSERT","lineNumber":78,"content":"        }"},{"type":"INSERT","lineNumber":79,"content":"    }"}]},{"timestamp":1757927170437,"changes":[{"type":"INSERT","lineNumber":2,"content":"import android.util.Log"},{"type":"DELETE","lineNumber":8,"oldContent":"import kotlinx.coroutines.flow.*"},{"type":"INSERT","lineNumber":10,"content":"import kotlinx.coroutines.flow.*"},{"type":"INSERT","lineNumber":27,"content":"    var missionUploaded by mutableStateOf(false)"},{"type":"INSERT","lineNumber":28,"content":"    var lastUploadedCount by mutableStateOf(0)"},{"type":"INSERT","lineNumber":29,"content":""},{"type":"DELETE","lineNumber":28,"oldContent":"    var missionUploaded by mutableStateOf(false)"},{"type":"DELETE","lineNumber":30,"oldContent":"    var lastUploadedCount by mutableStateOf(0)"},{"type":"DELETE","lineNumber":32,"oldContent":""},{"type":"DELETE","lineNumber":48,"oldContent":"}"},{"type":"DELETE","lineNumber":50,"oldContent":"    }"},{"type":"DELETE","lineNumber":51,"oldContent":"        }"},{"type":"DELETE","lineNumber":52,"oldContent":"            }"},{"type":"DELETE","lineNumber":53,"oldContent":""},{"type":"DELETE","lineNumber":54,"oldContent":"                onResult(false, e.message)"},{"type":"DELETE","lineNumber":56,"oldContent":"            } catch (e: Exception) {"},{"type":"DELETE","lineNumber":58,"oldContent":"                onResult(true, null)"},{"type":"DELETE","lineNumber":60,"oldContent":"                repo?.startMission(0, last)"},{"type":"INSERT","lineNumber":53,"content":"                Log.i(\"SharedVM\", \"Request to upload mission with ${missionItems.size} items\")"},{"type":"INSERT","lineNumber":54,"content":""},{"type":"INSERT","lineNumber":55,"content":"                if (repo == null) {"},{"type":"INSERT","lineNumber":56,"content":"                    Log.w(\"SharedVM\", \"No repo available, cannot upload mission\")"},{"type":"INSERT","lineNumber":57,"content":"                    missionUploaded = false"},{"type":"INSERT","lineNumber":58,"content":"                    lastUploadedCount = 0"},{"type":"INSERT","lineNumber":59,"content":"                    onResult(false, \"Not connected to vehicle\")"},{"type":"INSERT","lineNumber":60,"content":"                    return@launch"},{"type":"INSERT","lineNumber":61,"content":"                }"},{"type":"INSERT","lineNumber":62,"content":""},{"type":"INSERT","lineNumber":63,"content":"                if (!_telemetryState.value.fcuDetected) {"},{"type":"INSERT","lineNumber":64,"content":"                    Log.w(\"SharedVM\", \"FCU not detected, aborting mission upload\")"},{"type":"INSERT","lineNumber":65,"content":"                    missionUploaded = false"},{"type":"INSERT","lineNumber":66,"content":"                    lastUploadedCount = 0"},{"type":"INSERT","lineNumber":67,"content":"                    onResult(false, \"FCU not detected, please connect to vehicle first\")"},{"type":"INSERT","lineNumber":68,"content":"                    return@launch"},{"type":"INSERT","lineNumber":69,"content":"                }"},{"type":"INSERT","lineNumber":70,"content":""},{"type":"INSERT","lineNumber":71,"content":"                Log.i(\"SharedVM\", \"Starting mission upload to FCU...\")"},{"type":"DELETE","lineNumber":62,"oldContent":"                val last = if (lastUploadedCount > 0) lastUploadedCount - 1 else 0"},{"type":"DELETE","lineNumber":64,"oldContent":"            try {"},{"type":"DELETE","lineNumber":66,"oldContent":"        viewModelScope.launch {"},{"type":"DELETE","lineNumber":68,"oldContent":"    fun startMission(onResult: (Boolean, String?) -> Unit = { _, _ -> }) {"},{"type":"INSERT","lineNumber":76,"content":"                    Log.i(\"SharedVM\", \"Mission upload succeeded (${missionItems.size})\")"},{"type":"DELETE","lineNumber":70,"oldContent":""},{"type":"DELETE","lineNumber":72,"oldContent":"    }"},{"type":"DELETE","lineNumber":74,"oldContent":"        }"},{"type":"INSERT","lineNumber":80,"content":"                    Log.e(\"SharedVM\", \"Mission upload failed or timed out\")"},{"type":"DELETE","lineNumber":76,"oldContent":"            }"},{"type":"DELETE","lineNumber":78,"oldContent":"                onResult(false, e.message)"},{"type":"DELETE","lineNumber":80,"oldContent":"                lastUploadedCount = 0"},{"type":"INSERT","lineNumber":85,"content":"                lastUploadedCount = 0"},{"type":"INSERT","lineNumber":86,"content":"                Log.e(\"SharedVM\", \"Exception during mission upload\", e)"},{"type":"INSERT","lineNumber":87,"content":"                onResult(false, e.message)"},{"type":"INSERT","lineNumber":88,"content":"            }"},{"type":"INSERT","lineNumber":89,"content":"        }"},{"type":"INSERT","lineNumber":90,"content":"    }"},{"type":"INSERT","lineNumber":91,"content":""},{"type":"INSERT","lineNumber":92,"content":"    fun startMission(onResult: (Boolean, String?) -> Unit = { _, _ -> }) {"},{"type":"INSERT","lineNumber":93,"content":"        viewModelScope.launch {"},{"type":"INSERT","lineNumber":94,"content":"            try {"},{"type":"INSERT","lineNumber":95,"content":"                if (repo == null) {"},{"type":"INSERT","lineNumber":96,"content":"                    Log.w(\"SharedVM\", \"No repo available, cannot start mission\")"},{"type":"INSERT","lineNumber":97,"content":"                    onResult(false, \"Not connected to vehicle\")"},{"type":"INSERT","lineNumber":98,"content":"                    return@launch"},{"type":"INSERT","lineNumber":99,"content":"                }"},{"type":"INSERT","lineNumber":100,"content":""},{"type":"INSERT","lineNumber":101,"content":"                if (!_telemetryState.value.fcuDetected) {"},{"type":"INSERT","lineNumber":102,"content":"                    Log.w(\"SharedVM\", \"FCU not detected, cannot start mission\")"},{"type":"INSERT","lineNumber":103,"content":"                    onResult(false, \"FCU not detected\")"},{"type":"INSERT","lineNumber":104,"content":"                    return@launch"},{"type":"INSERT","lineNumber":105,"content":"                }"},{"type":"INSERT","lineNumber":106,"content":""},{"type":"INSERT","lineNumber":107,"content":"                val last = if (lastUploadedCount > 0) lastUploadedCount - 1 else 0"},{"type":"INSERT","lineNumber":108,"content":"                Log.i(\"SharedVM\", \"Sending start mission with first=0 last=$last\")"},{"type":"INSERT","lineNumber":109,"content":"                repo?.startMission(0, last)"},{"type":"INSERT","lineNumber":110,"content":"                onResult(true, null)"},{"type":"INSERT","lineNumber":111,"content":"            } catch (e: Exception) {"},{"type":"INSERT","lineNumber":112,"content":"                Log.e(\"SharedVM\", \"Failed to start mission\", e)"},{"type":"INSERT","lineNumber":113,"content":"                onResult(false, e.message)"},{"type":"INSERT","lineNumber":114,"content":"            }"},{"type":"INSERT","lineNumber":115,"content":"        }"},{"type":"INSERT","lineNumber":116,"content":"    }"},{"type":"INSERT","lineNumber":117,"content":"}"},{"type":"INSERT","lineNumber":118,"content":""}]},{"timestamp":1757927529141,"changes":[{"type":"DELETE","lineNumber":27,"oldContent":"    fun connect() {"},{"type":"DELETE","lineNumber":29,"oldContent":"        viewModelScope.launch {"},{"type":"INSERT","lineNumber":30,"content":"    fun connect() {"},{"type":"INSERT","lineNumber":31,"content":"        viewModelScope.launch {"},{"type":"INSERT","lineNumber":50,"content":"    fun uploadMission(missionItems: List<MissionItemInt>, onResult: (Boolean, String?) -> Unit = { _, _ -> }) {"},{"type":"INSERT","lineNumber":51,"content":"        viewModelScope.launch {"},{"type":"INSERT","lineNumber":52,"content":"            try {"},{"type":"DELETE","lineNumber":53,"oldContent":"    fun uploadMission(missionItems: List<MissionItemInt>, onResult: (Boolean, String?) -> Unit = { _, _ -> }) {"},{"type":"DELETE","lineNumber":56,"oldContent":"        viewModelScope.launch {"},{"type":"DELETE","lineNumber":59,"oldContent":"            try {"},{"type":"DELETE","lineNumber":62,"oldContent":"                val success = repo?.uploadMissionWithAck(missionItems) ?: false"},{"type":"DELETE","lineNumber":65,"oldContent":"                missionUploaded = success"},{"type":"DELETE","lineNumber":68,"oldContent":"                if (success) {"},{"type":"DELETE","lineNumber":71,"oldContent":"                    lastUploadedCount = missionItems.size"},{"type":"DELETE","lineNumber":74,"oldContent":"                    onResult(true, null)"},{"type":"INSERT","lineNumber":72,"content":"                val success = repo?.uploadMissionWithAck(missionItems) ?: false"},{"type":"INSERT","lineNumber":73,"content":"                missionUploaded = success"},{"type":"INSERT","lineNumber":74,"content":"                if (success) {"},{"type":"INSERT","lineNumber":75,"content":"                    lastUploadedCount = missionItems.size"},{"type":"INSERT","lineNumber":76,"content":"                    Log.i(\"SharedVM\", \"Mission upload succeeded (${missionItems.size})\")"},{"type":"INSERT","lineNumber":77,"content":"                    onResult(true, null)"},{"type":"INSERT","lineNumber":80,"content":"                    Log.e(\"SharedVM\", \"Mission upload failed or timed out\")"},{"type":"DELETE","lineNumber":80,"oldContent":"                    Log.i(\"SharedVM\", \"Mission upload succeeded (${missionItems.size})\")"},{"type":"DELETE","lineNumber":83,"oldContent":"                    Log.e(\"SharedVM\", \"Mission upload failed or timed out\")"},{"type":"DELETE","lineNumber":85,"oldContent":""},{"type":"DELETE","lineNumber":86,"oldContent":"}"},{"type":"DELETE","lineNumber":87,"oldContent":"    }"},{"type":"DELETE","lineNumber":89,"oldContent":"        }"},{"type":"DELETE","lineNumber":91,"oldContent":"            }"},{"type":"DELETE","lineNumber":93,"oldContent":"                onResult(false, e.message)"},{"type":"DELETE","lineNumber":95,"oldContent":"                Log.e(\"SharedVM\", \"Failed to start mission\", e)"},{"type":"DELETE","lineNumber":97,"oldContent":"            } catch (e: Exception) {"},{"type":"DELETE","lineNumber":99,"oldContent":"                onResult(true, null)"},{"type":"DELETE","lineNumber":101,"oldContent":"                repo?.startMission(0, last)"},{"type":"DELETE","lineNumber":103,"oldContent":"                Log.i(\"SharedVM\", \"Sending start mission with first=0 last=$last\")"},{"type":"DELETE","lineNumber":105,"oldContent":"                val last = if (lastUploadedCount > 0) lastUploadedCount - 1 else 0"},{"type":"DELETE","lineNumber":107,"oldContent":""},{"type":"DELETE","lineNumber":109,"oldContent":"                }"},{"type":"DELETE","lineNumber":111,"oldContent":"                    return@launch"},{"type":"DELETE","lineNumber":113,"oldContent":"                    onResult(false, \"FCU not detected\")"},{"type":"DELETE","lineNumber":115,"oldContent":"                    Log.w(\"SharedVM\", \"FCU not detected, cannot start mission\")"},{"type":"INSERT","lineNumber":100,"content":""},{"type":"INSERT","lineNumber":102,"content":"                    Log.w(\"SharedVM\", \"FCU not detected, cannot start mission\")"},{"type":"INSERT","lineNumber":103,"content":"                    onResult(false, \"FCU not detected\")"},{"type":"INSERT","lineNumber":104,"content":"                    return@launch"},{"type":"INSERT","lineNumber":105,"content":"                }"},{"type":"INSERT","lineNumber":107,"content":"                val last = if (lastUploadedCount > 0) lastUploadedCount - 1 else 0"},{"type":"INSERT","lineNumber":108,"content":"                Log.i(\"SharedVM\", \"Sending start mission with first=0 last=$last\")"},{"type":"INSERT","lineNumber":109,"content":"                repo?.startMission(0, last)"},{"type":"INSERT","lineNumber":110,"content":"                onResult(true, null)"},{"type":"INSERT","lineNumber":111,"content":"            } catch (e: Exception) {"},{"type":"INSERT","lineNumber":112,"content":"                Log.e(\"SharedVM\", \"Failed to start mission\", e)"},{"type":"INSERT","lineNumber":113,"content":"                onResult(false, e.message)"},{"type":"INSERT","lineNumber":114,"content":"            }"},{"type":"INSERT","lineNumber":115,"content":"        }"},{"type":"INSERT","lineNumber":116,"content":"    }"},{"type":"INSERT","lineNumber":117,"content":""},{"type":"INSERT","lineNumber":118,"content":"    // New helper to request mission from FCU and log its items for debugging"},{"type":"INSERT","lineNumber":119,"content":"    fun readMissionFromFcu() {"},{"type":"INSERT","lineNumber":120,"content":"        viewModelScope.launch {"},{"type":"INSERT","lineNumber":121,"content":"            if (repo == null) {"},{"type":"INSERT","lineNumber":122,"content":"                Log.w(\"SharedVM\", \"No repo available, cannot request mission readback\")"},{"type":"INSERT","lineNumber":123,"content":"                return@launch"},{"type":"INSERT","lineNumber":124,"content":"            }"},{"type":"INSERT","lineNumber":125,"content":"            try {"},{"type":"INSERT","lineNumber":126,"content":"                repo?.requestMissionAndLog()"},{"type":"INSERT","lineNumber":127,"content":"            } catch (e: Exception) {"},{"type":"INSERT","lineNumber":128,"content":"                Log.e(\"SharedVM\", \"Exception during mission readback\", e)"},{"type":"INSERT","lineNumber":129,"content":"            }"},{"type":"INSERT","lineNumber":130,"content":"        }"},{"type":"INSERT","lineNumber":131,"content":"    }"},{"type":"INSERT","lineNumber":132,"content":"}"},{"type":"INSERT","lineNumber":133,"content":""}]},{"timestamp":1757928544496,"changes":[{"type":"DELETE","lineNumber":28,"oldContent":"    fun connect() {"},{"type":"MODIFY","lineNumber":30,"content":"    fun connect() {","oldContent":"        viewModelScope.launch {"},{"type":"INSERT","lineNumber":31,"content":"        viewModelScope.launch {"},{"type":"DELETE","lineNumber":51,"oldContent":"                Log.i(\"SharedVM\", \"Request to upload mission with ${missionItems.size} items\")"},{"type":"MODIFY","lineNumber":53,"content":"                Log.i(\"SharedVM\", \"Request to upload mission with ${missionItems.size} items\")","oldContent":""},{"type":"INSERT","lineNumber":54,"content":""},{"type":"DELETE","lineNumber":68,"oldContent":"                val success = repo?.uploadMissionWithAck(missionItems) ?: false"},{"type":"MODIFY","lineNumber":70,"content":"","oldContent":"                missionUploaded = success"},{"type":"INSERT","lineNumber":71,"content":"                Log.i(\"SharedVM\", \"Starting mission upload to FCU...\")"},{"type":"INSERT","lineNumber":72,"content":"                val success = repo?.uploadMissionWithAck(missionItems) ?: false"},{"type":"INSERT","lineNumber":73,"content":"                missionUploaded = success"},{"type":"DELETE","lineNumber":74,"oldContent":""},{"type":"DELETE","lineNumber":76,"oldContent":"                Log.i(\"SharedVM\", \"Starting mission upload to FCU...\")"},{"type":"MODIFY","lineNumber":81,"content":"                    onResult(false, \"Mission upload failed or timed out\")","oldContent":"                    onResult(false, \"Mission upload failed or timed out\")"},{"type":"INSERT","lineNumber":92,"content":"    fun startMission(onResult: (Boolean, String?) -> Unit = { _, _ -> }) {"},{"type":"INSERT","lineNumber":93,"content":"        viewModelScope.launch {"},{"type":"INSERT","lineNumber":94,"content":"            try {"},{"type":"INSERT","lineNumber":95,"content":"                if (repo == null) {"},{"type":"INSERT","lineNumber":96,"content":"                    Log.w(\"SharedVM\", \"No repo available, cannot start mission\")"},{"type":"INSERT","lineNumber":97,"content":"                    onResult(false, \"Not connected to vehicle\")"},{"type":"INSERT","lineNumber":98,"content":"                    return@launch"},{"type":"INSERT","lineNumber":99,"content":"                }"},{"type":"INSERT","lineNumber":101,"content":"                if (!_telemetryState.value.fcuDetected) {"},{"type":"DELETE","lineNumber":94,"oldContent":"    fun startMission(onResult: (Boolean, String?) -> Unit = { _, _ -> }) {"},{"type":"DELETE","lineNumber":97,"oldContent":"        viewModelScope.launch {"},{"type":"DELETE","lineNumber":99,"oldContent":"            try {"},{"type":"INSERT","lineNumber":106,"content":""},{"type":"DELETE","lineNumber":102,"oldContent":"                if (repo == null) {"},{"type":"DELETE","lineNumber":103,"oldContent":"                repo?.startMission(0, last)"},{"type":"DELETE","lineNumber":104,"oldContent":"                onResult(true, null)"},{"type":"DELETE","lineNumber":105,"oldContent":"                    Log.w(\"SharedVM\", \"No repo available, cannot start mission\")"},{"type":"INSERT","lineNumber":109,"content":"                val result = repo?.startMission(0, last) ?: false"},{"type":"INSERT","lineNumber":110,"content":"                if (result) {"},{"type":"INSERT","lineNumber":111,"content":"                    Log.i(\"SharedVM\", \"Mission start acknowledged by FCU\")"},{"type":"INSERT","lineNumber":112,"content":"                    onResult(true, null)"},{"type":"INSERT","lineNumber":113,"content":"                } else {"},{"type":"INSERT","lineNumber":114,"content":"                    Log.e(\"SharedVM\", \"Mission start failed or not acknowledged\")"},{"type":"INSERT","lineNumber":115,"content":"                    onResult(false, \"Mission start failed or not acknowledged\")"},{"type":"INSERT","lineNumber":116,"content":"                }"},{"type":"DELETE","lineNumber":108,"oldContent":"                    onResult(false, \"Not connected to vehicle\")"},{"type":"DELETE","lineNumber":111,"oldContent":"                    return@launch"},{"type":"DELETE","lineNumber":114,"oldContent":"                }"},{"type":"DELETE","lineNumber":116,"oldContent":"                if (!_telemetryState.value.fcuDetected) {"},{"type":"DELETE","lineNumber":118,"oldContent":""},{"type":"DELETE","lineNumber":120,"oldContent":""},{"type":"DELETE","lineNumber":122,"oldContent":"}"},{"type":"DELETE","lineNumber":124,"oldContent":"    }"},{"type":"DELETE","lineNumber":126,"oldContent":"        }"},{"type":"DELETE","lineNumber":129,"oldContent":"            }"},{"type":"DELETE","lineNumber":130,"oldContent":"                Log.e(\"SharedVM\", \"Exception during mission readback\", e)"},{"type":"MODIFY","lineNumber":133,"content":"            } catch (e: Exception) {","oldContent":"            } catch (e: Exception) {"},{"type":"INSERT","lineNumber":134,"content":"                Log.e(\"SharedVM\", \"Exception during mission readback\", e)"},{"type":"INSERT","lineNumber":135,"content":"            }"},{"type":"INSERT","lineNumber":136,"content":"        }"},{"type":"INSERT","lineNumber":137,"content":"    }"},{"type":"INSERT","lineNumber":138,"content":"}"},{"type":"INSERT","lineNumber":139,"content":""}]},{"timestamp":1757931448005,"changes":[{"type":"INSERT","lineNumber":12,"content":"import kotlinx.coroutines.delay"},{"type":"INSERT","lineNumber":30,"content":""},{"type":"DELETE","lineNumber":31,"oldContent":""},{"type":"INSERT","lineNumber":53,"content":"            try {"},{"type":"DELETE","lineNumber":54,"oldContent":"            try {"},{"type":"INSERT","lineNumber":70,"content":"                }"},{"type":"DELETE","lineNumber":71,"oldContent":"                }"},{"type":"DELETE","lineNumber":73,"oldContent":"                if (success) {"},{"type":"INSERT","lineNumber":75,"content":"                if (success) {"},{"type":"INSERT","lineNumber":81,"content":"                    Log.e(\"SharedVM\", \"Mission upload failed or timed out\")"},{"type":"DELETE","lineNumber":81,"oldContent":"                    onResult(false, \"Mission upload failed or timed out\")"},{"type":"DELETE","lineNumber":93,"oldContent":""},{"type":"DELETE","lineNumber":95,"oldContent":"                    Log.w(\"SharedVM\", \"FCU not detected, cannot start mission\")"},{"type":"DELETE","lineNumber":98,"oldContent":"                    onResult(false, \"FCU not detected\")"},{"type":"DELETE","lineNumber":100,"oldContent":"                    return@launch"},{"type":"INSERT","lineNumber":101,"content":""},{"type":"INSERT","lineNumber":102,"content":"                if (!_telemetryState.value.fcuDetected) {"},{"type":"INSERT","lineNumber":103,"content":"                    Log.w(\"SharedVM\", \"FCU not detected, cannot start mission\")"},{"type":"INSERT","lineNumber":104,"content":"                    onResult(false, \"FCU not detected\")"},{"type":"INSERT","lineNumber":105,"content":"                    return@launch"},{"type":"INSERT","lineNumber":107,"content":""},{"type":"INSERT","lineNumber":108,"content":"                // Ensure vehicle is armed; if not, attempt to arm and wait briefly"},{"type":"INSERT","lineNumber":109,"content":"                if (!_telemetryState.value.armed) {"},{"type":"INSERT","lineNumber":110,"content":"                    Log.i(\"SharedVM\", \"Vehicle not armed - attempting to arm\")"},{"type":"INSERT","lineNumber":111,"content":"                    repo?.arm()"},{"type":"INSERT","lineNumber":112,"content":"                    // wait up to 5s for telemetry to report armed"},{"type":"INSERT","lineNumber":113,"content":"                    val armTimeout = 5000L"},{"type":"INSERT","lineNumber":114,"content":"                    val start = System.currentTimeMillis()"},{"type":"INSERT","lineNumber":115,"content":"                    while (!_telemetryState.value.armed && System.currentTimeMillis() - start < armTimeout) {"},{"type":"INSERT","lineNumber":116,"content":"                        delay(250)"},{"type":"INSERT","lineNumber":117,"content":"                    }"},{"type":"INSERT","lineNumber":118,"content":"                    if (!_telemetryState.value.armed) {"},{"type":"INSERT","lineNumber":119,"content":"                        Log.w(\"SharedVM\", \"Vehicle did not arm within timeout\")"},{"type":"INSERT","lineNumber":120,"content":"                        onResult(false, \"Vehicle did not arm\")"},{"type":"INSERT","lineNumber":121,"content":"                        return@launch"},{"type":"INSERT","lineNumber":122,"content":"                    }"},{"type":"INSERT","lineNumber":123,"content":"                    Log.i(\"SharedVM\", \"Vehicle armed\")"},{"type":"INSERT","lineNumber":124,"content":"                }"},{"type":"INSERT","lineNumber":125,"content":""},{"type":"INSERT","lineNumber":126,"content":"                // Ensure vehicle mode is AUTO (some FCs require AUTO mode to execute mission)"},{"type":"INSERT","lineNumber":127,"content":"                val desiredModeLabel = \"Auto\""},{"type":"INSERT","lineNumber":128,"content":"                if (_telemetryState.value.mode?.contains(\"Auto\", ignoreCase = true) != true) {"},{"type":"INSERT","lineNumber":129,"content":"                    Log.i(\"SharedVM\", \"Switching vehicle mode to AUTO\")"},{"type":"INSERT","lineNumber":130,"content":"                    // attempt to set mode; changeMode expects numeric mode value"},{"type":"INSERT","lineNumber":131,"content":"                    repo?.changeMode(MavMode.AUTO)"},{"type":"INSERT","lineNumber":132,"content":"                    // wait up to 4s for mode change"},{"type":"INSERT","lineNumber":133,"content":"                    val modeTimeout = 4000L"},{"type":"INSERT","lineNumber":134,"content":"                    val mstart = System.currentTimeMillis()"},{"type":"INSERT","lineNumber":135,"content":"                    while (_telemetryState.value.mode?.contains(\"Auto\", ignoreCase = true) != true && System.currentTimeMillis() - mstart < modeTimeout) {"},{"type":"INSERT","lineNumber":136,"content":"                        delay(250)"},{"type":"INSERT","lineNumber":137,"content":"                    }"},{"type":"INSERT","lineNumber":138,"content":"                    if (_telemetryState.value.mode?.contains(\"Auto\", ignoreCase = true) != true) {"},{"type":"INSERT","lineNumber":139,"content":"                        Log.w(\"SharedVM\", \"Vehicle did not switch to AUTO mode within timeout\")"},{"type":"INSERT","lineNumber":140,"content":"                        // not a hard failure; proceed to send mission start but warn"},{"type":"INSERT","lineNumber":141,"content":"                    } else {"},{"type":"INSERT","lineNumber":142,"content":"                        Log.i(\"SharedVM\", \"Vehicle mode is now AUTO\")"},{"type":"INSERT","lineNumber":143,"content":"                    }"},{"type":"INSERT","lineNumber":144,"content":"                }"},{"type":"INSERT","lineNumber":145,"content":""},{"type":"DELETE","lineNumber":106,"oldContent":"                if (!_telemetryState.value.fcuDetected) {"},{"type":"DELETE","lineNumber":108,"oldContent":""},{"type":"DELETE","lineNumber":109,"oldContent":"            } catch (e: Exception) {"},{"type":"DELETE","lineNumber":110,"oldContent":"                Log.e(\"SharedVM\", \"Failed to start mission\", e)"},{"type":"DELETE","lineNumber":112,"oldContent":"                onResult(false, e.message)"},{"type":"DELETE","lineNumber":114,"oldContent":"            }"},{"type":"DELETE","lineNumber":117,"oldContent":"        }"},{"type":"DELETE","lineNumber":119,"oldContent":"    }"},{"type":"DELETE","lineNumber":122,"oldContent":""},{"type":"INSERT","lineNumber":156,"content":"            } catch (e: Exception) {"},{"type":"INSERT","lineNumber":157,"content":"                Log.e(\"SharedVM\", \"Failed to start mission\", e)"},{"type":"INSERT","lineNumber":158,"content":"                onResult(false, e.message)"},{"type":"INSERT","lineNumber":159,"content":"            }"},{"type":"INSERT","lineNumber":160,"content":"        }"},{"type":"INSERT","lineNumber":161,"content":"    }"},{"type":"INSERT","lineNumber":162,"content":""},{"type":"INSERT","lineNumber":171,"content":"                repo?.requestMissionAndLog()"},{"type":"DELETE","lineNumber":133,"oldContent":"            } catch (e: Exception) {"},{"type":"DELETE","lineNumber":135,"oldContent":""},{"type":"DELETE","lineNumber":137,"oldContent":"}"},{"type":"INSERT","lineNumber":177,"content":"}"},{"type":"INSERT","lineNumber":178,"content":""}]}]},"C:/Users/Hrushikesh/AndroidStudioProjects/SampleGCS/app/src/main/java/com/example/aerogcsclone/uimain/MainPage.kt":{"filePath":"C:/Users/Hrushikesh/AndroidStudioProjects/SampleGCS/app/src/main/java/com/example/aerogcsclone/uimain/MainPage.kt","baseContent":"package com.example.aerogcsclone.uimain\n\nimport androidx.compose.foundation.background\nimport androidx.compose.foundation.layout.*\nimport androidx.compose.foundation.shape.RoundedCornerShape\nimport androidx.compose.material.icons.Icons\nimport androidx.compose.material.icons.filled.*\nimport androidx.compose.material3.*\nimport androidx.compose.runtime.Composable\nimport androidx.compose.runtime.collectAsState\nimport androidx.compose.runtime.getValue\nimport androidx.compose.ui.Alignment\nimport androidx.compose.ui.Modifier\nimport androidx.compose.ui.graphics.Color\nimport androidx.compose.ui.unit.dp\nimport androidx.navigation.NavHostController\nimport com.example.aerogcsclone.Telemetry.SharedViewModel\nimport com.example.aerogcsclone.Telemetry.TelemetryState\nimport com.example.aerogcsclone.authentication.AuthViewModel\n\n@Composable\nfun MainPage(\n    telemetryViewModel: SharedViewModel,\n    authViewModel: AuthViewModel,\n    navController: NavHostController\n) {\n    val telemetryState by telemetryViewModel.telemetryState.collectAsState()\n\n    Column(\n        modifier = Modifier\n            .fillMaxSize()\n            .background(MaterialTheme.colorScheme.background)\n    ) {\n        // ✅ Corrected TopNavBar call\n        TopNavBar(\n            telemetryState = telemetryState,\n            authViewModel = authViewModel,\n            navController = navController\n        )\n\n        Box(\n            modifier = Modifier\n                .weight(1f)\n                .fillMaxWidth()\n        ) {\n            // ✅ Pass telemetryState to GcsMap\n//\n            GcsMap(telemetryState = telemetryState)\n\n\n\n            StatusPanel(\n                modifier = Modifier\n                    .align(Alignment.BottomStart)\n                    .padding(12.dp),\n                telemetryState = telemetryState\n            )\n\n            FloatingButtons(\n                modifier = Modifier\n                    .align(Alignment.CenterEnd)\n                    .padding(12.dp)\n            )\n        }\n    }\n}\n\n@Composable\nfun StatusPanel(\n    modifier: Modifier = Modifier,\n    telemetryState: TelemetryState\n) {\n    Surface(\n        modifier = modifier\n            .width(500.dp)\n            .height(120.dp),\n        color = Color.Black.copy(alpha = 0.6f),\n        shape = RoundedCornerShape(8.dp)\n    ) {\n        Column(\n            modifier = Modifier.padding(10.dp),\n            verticalArrangement = Arrangement.spacedBy(8.dp)\n        ) {\n            Row(\n                horizontalArrangement = Arrangement.SpaceBetween,\n                modifier = Modifier.fillMaxWidth()\n            ) {\n                Text(\"Alt: ${telemetryState.altitudeRelative ?: \"N/A\"}\", color = Color.White)\n                Text(\"Speed: ${telemetryState.groundspeed ?: \"N/A\"}\", color = Color.White)\n                Text(\"Area: N/A\", color = Color.White)\n                Text(\"Flow: N/A\", color = Color.White)\n            }\n            Spacer(modifier = Modifier.height(8.dp))\n            Row(\n                horizontalArrangement = Arrangement.SpaceBetween,\n                modifier = Modifier.fillMaxWidth()\n            ) {\n                Text(\"Obs Alt: N/A\", color = Color.White)\n                Text(\"Time: N/A\", color = Color.White)\n                Text(\"Distance: N/A\", color = Color.White)\n                Text(\"Consumed: N/A\", color = Color.White)\n            }\n        }\n    }\n}\n\n@Composable\nfun FloatingButtons(modifier: Modifier = Modifier) {\n    Column(\n        modifier = modifier,\n        verticalArrangement = Arrangement.spacedBy(12.dp),\n        horizontalAlignment = Alignment.CenterHorizontally\n    ) {\n        FloatingActionButton(onClick = { }, containerColor = Color.Black.copy(alpha = 0.7f)) {\n            Icon(Icons.Default.PlayArrow, contentDescription = \"Start\", tint = Color.White)\n        }\n        FloatingActionButton(onClick = { }, containerColor = Color.Black.copy(alpha = 0.7f)) {\n            Icon(Icons.Default.Settings, contentDescription = \"Settings\", tint = Color.White)\n        }\n        FloatingActionButton(onClick = { }, containerColor = Color.Black.copy(alpha = 0.7f)) {\n            Icon(Icons.Default.Refresh, contentDescription = \"Refresh\", tint = Color.White)\n        }\n        FloatingActionButton(onClick = { }, containerColor = Color.Black.copy(alpha = 0.7f)) {\n            Icon(Icons.Default.Map, contentDescription = \"Map Options\", tint = Color.White)\n        }\n    }\n}","baseTimestamp":1757909204070,"deltas":[{"timestamp":1757912402740,"changes":[{"type":"INSERT","lineNumber":2,"content":"import android.widget.Toast"},{"type":"INSERT","lineNumber":15,"content":"import androidx.compose.ui.platform.LocalContext"},{"type":"INSERT","lineNumber":29,"content":"    val context = LocalContext.current"},{"type":"INSERT","lineNumber":30,"content":"    val missionUploaded = telemetryViewModel.missionUploaded"},{"type":"DELETE","lineNumber":48,"oldContent":""},{"type":"DELETE","lineNumber":49,"oldContent":""},{"type":"DELETE","lineNumber":50,"oldContent":""},{"type":"INSERT","lineNumber":64,"content":""},{"type":"INSERT","lineNumber":65,"content":"            // Start Mission button"},{"type":"INSERT","lineNumber":66,"content":"            Button("},{"type":"INSERT","lineNumber":67,"content":"                onClick = {"},{"type":"INSERT","lineNumber":68,"content":"                    telemetryViewModel.startMission { success, error ->"},{"type":"INSERT","lineNumber":69,"content":"                        if (success) {"},{"type":"INSERT","lineNumber":70,"content":"                            Toast.makeText(context, \"Mission started\", Toast.LENGTH_SHORT).show()"},{"type":"INSERT","lineNumber":71,"content":"                        } else {"},{"type":"INSERT","lineNumber":72,"content":"                            Toast.makeText(context, error ?: \"Mission start failed\", Toast.LENGTH_SHORT).show()"},{"type":"INSERT","lineNumber":73,"content":"                        }"},{"type":"INSERT","lineNumber":74,"content":"                    }"},{"type":"INSERT","lineNumber":75,"content":"                },"},{"type":"INSERT","lineNumber":76,"content":"                enabled = missionUploaded,"},{"type":"INSERT","lineNumber":77,"content":"                modifier = Modifier"},{"type":"INSERT","lineNumber":78,"content":"                    .align(Alignment.BottomEnd)"},{"type":"INSERT","lineNumber":79,"content":"                    .padding(24.dp)"},{"type":"INSERT","lineNumber":80,"content":"            ) {"},{"type":"INSERT","lineNumber":81,"content":"                Text(\"Start Mission\")"},{"type":"INSERT","lineNumber":82,"content":"            }"}]},{"timestamp":1757915700671,"changes":[{"type":"DELETE","lineNumber":2,"oldContent":"import android.widget.Toast"},{"type":"DELETE","lineNumber":16,"oldContent":"import androidx.compose.ui.platform.LocalContext"},{"type":"DELETE","lineNumber":31,"oldContent":"    val context = LocalContext.current"},{"type":"DELETE","lineNumber":33,"oldContent":"    val missionUploaded = telemetryViewModel.missionUploaded"},{"type":"INSERT","lineNumber":48,"content":""},{"type":"INSERT","lineNumber":49,"content":""},{"type":"INSERT","lineNumber":50,"content":""},{"type":"DELETE","lineNumber":65,"oldContent":""},{"type":"DELETE","lineNumber":67,"oldContent":"            // Start Mission button"},{"type":"DELETE","lineNumber":69,"oldContent":"            Button("},{"type":"DELETE","lineNumber":71,"oldContent":"                onClick = {"},{"type":"DELETE","lineNumber":73,"oldContent":"                    telemetryViewModel.startMission { success, error ->"},{"type":"DELETE","lineNumber":75,"oldContent":"                        if (success) {"},{"type":"DELETE","lineNumber":77,"oldContent":"                            Toast.makeText(context, \"Mission started\", Toast.LENGTH_SHORT).show()"},{"type":"DELETE","lineNumber":79,"oldContent":"                        } else {"},{"type":"DELETE","lineNumber":81,"oldContent":"                            Toast.makeText(context, error ?: \"Mission start failed\", Toast.LENGTH_SHORT).show()"},{"type":"DELETE","lineNumber":83,"oldContent":"                        }"},{"type":"DELETE","lineNumber":85,"oldContent":"                    }"},{"type":"DELETE","lineNumber":87,"oldContent":"                },"},{"type":"DELETE","lineNumber":89,"oldContent":"                enabled = missionUploaded,"},{"type":"DELETE","lineNumber":91,"oldContent":"                modifier = Modifier"},{"type":"DELETE","lineNumber":93,"oldContent":"                    .align(Alignment.BottomEnd)"},{"type":"DELETE","lineNumber":95,"oldContent":"                    .padding(24.dp)"},{"type":"DELETE","lineNumber":97,"oldContent":"            ) {"},{"type":"DELETE","lineNumber":99,"oldContent":"                Text(\"Start Mission\")"},{"type":"DELETE","lineNumber":101,"oldContent":"            }"}]},{"timestamp":1757915709355,"changes":[{"type":"DELETE","lineNumber":8,"oldContent":"import androidx.compose.runtime.Composable"},{"type":"DELETE","lineNumber":9,"oldContent":"import androidx.compose.runtime.collectAsState"},{"type":"DELETE","lineNumber":10,"oldContent":"import androidx.compose.runtime.getValue"},{"type":"INSERT","lineNumber":8,"content":"import androidx.compose.runtime.*"},{"type":"INSERT","lineNumber":17,"content":"import com.google.maps.android.compose.MapType"},{"type":"INSERT","lineNumber":27,"content":"    // 🔑 Map type state"},{"type":"INSERT","lineNumber":28,"content":"    var mapType by remember { mutableStateOf(MapType.NORMAL) }"},{"type":"INSERT","lineNumber":29,"content":""},{"type":"DELETE","lineNumber":33,"oldContent":"        // ✅ Corrected TopNavBar call"},{"type":"DELETE","lineNumber":44,"oldContent":""},{"type":"INSERT","lineNumber":46,"content":"            // ✅ Pass telemetryState and mapType to GcsMap"},{"type":"INSERT","lineNumber":47,"content":"            GcsMap("},{"type":"INSERT","lineNumber":48,"content":"                telemetryState = telemetryState,"},{"type":"INSERT","lineNumber":49,"content":"                mapType = mapType"},{"type":"INSERT","lineNumber":50,"content":"            )"},{"type":"DELETE","lineNumber":47,"oldContent":"            // ✅ Pass telemetryState to GcsMap"},{"type":"DELETE","lineNumber":48,"oldContent":""},{"type":"DELETE","lineNumber":49,"oldContent":"//"},{"type":"DELETE","lineNumber":50,"oldContent":"            GcsMap(telemetryState = telemetryState)"},{"type":"MODIFY","lineNumber":62,"content":"                    .padding(12.dp),","oldContent":"                    .padding(12.dp)"},{"type":"INSERT","lineNumber":63,"content":"                onToggleMapType = {"},{"type":"INSERT","lineNumber":64,"content":"                    mapType = if (mapType == MapType.NORMAL) MapType.SATELLITE else MapType.NORMAL"},{"type":"INSERT","lineNumber":65,"content":"                }"},{"type":"DELETE","lineNumber":107,"oldContent":"fun FloatingButtons(modifier: Modifier = Modifier) {"},{"type":"INSERT","lineNumber":111,"content":"fun FloatingButtons("},{"type":"INSERT","lineNumber":112,"content":"    modifier: Modifier = Modifier,"},{"type":"INSERT","lineNumber":113,"content":"    onToggleMapType: () -> Unit"},{"type":"INSERT","lineNumber":114,"content":") {"},{"type":"DELETE","lineNumber":122,"oldContent":"        FloatingActionButton(onClick = { }, containerColor = Color.Black.copy(alpha = 0.7f)) {"},{"type":"INSERT","lineNumber":129,"content":"        FloatingActionButton("},{"type":"INSERT","lineNumber":130,"content":"            onClick = { onToggleMapType() },"},{"type":"INSERT","lineNumber":131,"content":"            containerColor = Color.Black.copy(alpha = 0.7f)"},{"type":"INSERT","lineNumber":132,"content":"        ) {"}]},{"timestamp":1757915781162,"changes":[{"type":"INSERT","lineNumber":2,"content":"import android.widget.Toast"},{"type":"INSERT","lineNumber":13,"content":"import androidx.compose.ui.platform.LocalContext"},{"type":"DELETE","lineNumber":15,"oldContent":"import com.google.maps.android.compose.MapType"},{"type":"INSERT","lineNumber":19,"content":"import com.google.maps.android.compose.MapType"},{"type":"DELETE","lineNumber":26,"oldContent":"    // 🔑 Map type state"},{"type":"INSERT","lineNumber":28,"content":"    val context = LocalContext.current"},{"type":"INSERT","lineNumber":29,"content":"    val missionUploaded = telemetryViewModel.missionUploaded"},{"type":"INSERT","lineNumber":31,"content":"    // 🔑 Map type state"},{"type":"DELETE","lineNumber":29,"oldContent":"    Column("},{"type":"INSERT","lineNumber":34,"content":"    Column("},{"type":"INSERT","lineNumber":50,"content":"<<<<<<< Updated upstream"},{"type":"DELETE","lineNumber":47,"oldContent":""},{"type":"INSERT","lineNumber":56,"content":""},{"type":"INSERT","lineNumber":57,"content":"======="},{"type":"INSERT","lineNumber":58,"content":"            // ✅ Pass telemetryState to GcsMap"},{"type":"INSERT","lineNumber":59,"content":"//"},{"type":"INSERT","lineNumber":60,"content":"            GcsMap(telemetryState = telemetryState)"},{"type":"INSERT","lineNumber":61,"content":">>>>>>> Stashed changes"},{"type":"DELETE","lineNumber":62,"oldContent":"                    .padding(12.dp)"},{"type":"DELETE","lineNumber":65,"oldContent":"        }"},{"type":"DELETE","lineNumber":67,"oldContent":"    }"},{"type":"INSERT","lineNumber":76,"content":"            )"},{"type":"INSERT","lineNumber":77,"content":""},{"type":"INSERT","lineNumber":78,"content":"            // Start Mission button"},{"type":"INSERT","lineNumber":79,"content":"            Button("},{"type":"INSERT","lineNumber":80,"content":"                onClick = {"},{"type":"INSERT","lineNumber":81,"content":"                    telemetryViewModel.startMission { success, error ->"},{"type":"INSERT","lineNumber":82,"content":"                        if (success) {"},{"type":"INSERT","lineNumber":83,"content":"                            Toast.makeText(context, \"Mission started\", Toast.LENGTH_SHORT).show()"},{"type":"INSERT","lineNumber":84,"content":"                        } else {"},{"type":"INSERT","lineNumber":85,"content":"                            Toast.makeText(context, error ?: \"Mission start failed\", Toast.LENGTH_SHORT).show()"},{"type":"INSERT","lineNumber":86,"content":"                        }"},{"type":"INSERT","lineNumber":87,"content":"                    }"},{"type":"INSERT","lineNumber":88,"content":"                },"},{"type":"INSERT","lineNumber":89,"content":"                enabled = missionUploaded,"},{"type":"INSERT","lineNumber":90,"content":"                modifier = Modifier"},{"type":"INSERT","lineNumber":91,"content":"                    .align(Alignment.BottomEnd)"},{"type":"INSERT","lineNumber":92,"content":"                    .padding(24.dp)"},{"type":"INSERT","lineNumber":93,"content":"            ) {"},{"type":"INSERT","lineNumber":94,"content":"                Text(\"Start Mission\")"},{"type":"INSERT","lineNumber":95,"content":"            }"},{"type":"INSERT","lineNumber":96,"content":"        }"},{"type":"INSERT","lineNumber":97,"content":"    }"},{"type":"INSERT","lineNumber":140,"content":"fun FloatingButtons("},{"type":"INSERT","lineNumber":141,"content":"    modifier: Modifier = Modifier,"},{"type":"INSERT","lineNumber":142,"content":"    onToggleMapType: () -> Unit"},{"type":"INSERT","lineNumber":143,"content":") {"},{"type":"DELETE","lineNumber":114,"oldContent":"fun FloatingButtons("},{"type":"DELETE","lineNumber":116,"oldContent":"    modifier: Modifier = Modifier,"},{"type":"DELETE","lineNumber":118,"oldContent":"    onToggleMapType: () -> Unit"},{"type":"DELETE","lineNumber":120,"oldContent":") {"},{"type":"INSERT","lineNumber":158,"content":"        FloatingActionButton("},{"type":"INSERT","lineNumber":159,"content":"            onClick = { onToggleMapType() },"},{"type":"INSERT","lineNumber":160,"content":"            containerColor = Color.Black.copy(alpha = 0.7f)"},{"type":"INSERT","lineNumber":161,"content":"        ) {"},{"type":"DELETE","lineNumber":133,"oldContent":"        ) {"},{"type":"DELETE","lineNumber":134,"oldContent":"            containerColor = Color.Black.copy(alpha = 0.7f)"},{"type":"DELETE","lineNumber":135,"oldContent":"        FloatingActionButton("},{"type":"DELETE","lineNumber":136,"oldContent":"            onClick = { onToggleMapType() },"}]},{"timestamp":1757915821259,"changes":[{"type":"DELETE","lineNumber":2,"oldContent":"import android.widget.Toast"},{"type":"MODIFY","lineNumber":8,"content":"import androidx.compose.runtime.Composable","oldContent":"import androidx.compose.runtime.*"},{"type":"INSERT","lineNumber":9,"content":"import androidx.compose.runtime.collectAsState"},{"type":"INSERT","lineNumber":10,"content":"import androidx.compose.runtime.getValue"},{"type":"DELETE","lineNumber":14,"oldContent":"import androidx.compose.ui.platform.LocalContext"},{"type":"DELETE","lineNumber":20,"oldContent":"import com.google.maps.android.compose.MapType"},{"type":"DELETE","lineNumber":29,"oldContent":"    val context = LocalContext.current"},{"type":"DELETE","lineNumber":30,"oldContent":"    var mapType by remember { mutableStateOf(MapType.NORMAL) }"},{"type":"DELETE","lineNumber":31,"oldContent":"    val missionUploaded = telemetryViewModel.missionUploaded"},{"type":"DELETE","lineNumber":32,"oldContent":""},{"type":"DELETE","lineNumber":33,"oldContent":"    // 🔑 Map type state"},{"type":"INSERT","lineNumber":28,"content":"    Column("},{"type":"DELETE","lineNumber":37,"oldContent":"    Column("},{"type":"INSERT","lineNumber":33,"content":"        // ✅ Corrected TopNavBar call"},{"type":"DELETE","lineNumber":50,"oldContent":"            // ✅ Pass telemetryState and mapType to GcsMap"},{"type":"DELETE","lineNumber":51,"oldContent":"            GcsMap("},{"type":"DELETE","lineNumber":52,"oldContent":"                telemetryState = telemetryState,"},{"type":"DELETE","lineNumber":53,"oldContent":"<<<<<<< Updated upstream"},{"type":"DELETE","lineNumber":54,"oldContent":"                mapType = mapType"},{"type":"DELETE","lineNumber":55,"oldContent":"            )"},{"type":"INSERT","lineNumber":45,"content":"            // ✅ Pass telemetryState to GcsMap"},{"type":"INSERT","lineNumber":46,"content":"//"},{"type":"INSERT","lineNumber":47,"content":"            GcsMap(telemetryState = telemetryState)"},{"type":"INSERT","lineNumber":48,"content":""},{"type":"INSERT","lineNumber":49,"content":""},{"type":"INSERT","lineNumber":50,"content":""},{"type":"DELETE","lineNumber":60,"oldContent":""},{"type":"DELETE","lineNumber":62,"oldContent":"======="},{"type":"DELETE","lineNumber":64,"oldContent":"            // ✅ Pass telemetryState to GcsMap"},{"type":"DELETE","lineNumber":66,"oldContent":"//"},{"type":"DELETE","lineNumber":68,"oldContent":"            GcsMap(telemetryState = telemetryState)"},{"type":"DELETE","lineNumber":70,"oldContent":">>>>>>> Stashed changes"},{"type":"DELETE","lineNumber":72,"oldContent":"                    .padding(12.dp),"},{"type":"DELETE","lineNumber":73,"oldContent":"                onToggleMapType = {"},{"type":"DELETE","lineNumber":74,"oldContent":"                    mapType = if (mapType == MapType.NORMAL) MapType.SATELLITE else MapType.NORMAL"},{"type":"DELETE","lineNumber":75,"oldContent":"                }"},{"type":"INSERT","lineNumber":61,"content":"                    .padding(12.dp)"},{"type":"INSERT","lineNumber":62,"content":"            )"},{"type":"INSERT","lineNumber":63,"content":"        }"},{"type":"INSERT","lineNumber":64,"content":"    }"},{"type":"DELETE","lineNumber":83,"oldContent":"            )"},{"type":"DELETE","lineNumber":85,"oldContent":""},{"type":"DELETE","lineNumber":87,"oldContent":"            // Start Mission button"},{"type":"DELETE","lineNumber":89,"oldContent":"            Button("},{"type":"DELETE","lineNumber":91,"oldContent":"                onClick = {"},{"type":"DELETE","lineNumber":93,"oldContent":"                    telemetryViewModel.startMission { success, error ->"},{"type":"DELETE","lineNumber":95,"oldContent":"                        if (success) {"},{"type":"DELETE","lineNumber":97,"oldContent":"                            Toast.makeText(context, \"Mission started\", Toast.LENGTH_SHORT).show()"},{"type":"DELETE","lineNumber":99,"oldContent":"                        } else {"},{"type":"DELETE","lineNumber":101,"oldContent":"                            Toast.makeText(context, error ?: \"Mission start failed\", Toast.LENGTH_SHORT).show()"},{"type":"DELETE","lineNumber":103,"oldContent":"                        }"},{"type":"DELETE","lineNumber":105,"oldContent":"                    }"},{"type":"DELETE","lineNumber":107,"oldContent":"                },"},{"type":"DELETE","lineNumber":109,"oldContent":"                enabled = missionUploaded,"},{"type":"DELETE","lineNumber":111,"oldContent":"                modifier = Modifier"},{"type":"DELETE","lineNumber":113,"oldContent":"                    .align(Alignment.BottomEnd)"},{"type":"DELETE","lineNumber":115,"oldContent":"                    .padding(24.dp)"},{"type":"DELETE","lineNumber":117,"oldContent":"            ) {"},{"type":"DELETE","lineNumber":119,"oldContent":"                Text(\"Start Mission\")"},{"type":"DELETE","lineNumber":122,"oldContent":"            }"},{"type":"DELETE","lineNumber":123,"oldContent":"        }"},{"type":"DELETE","lineNumber":125,"oldContent":"    }"},{"type":"INSERT","lineNumber":107,"content":"fun FloatingButtons(modifier: Modifier = Modifier) {"},{"type":"INSERT","lineNumber":122,"content":"        FloatingActionButton(onClick = { }, containerColor = Color.Black.copy(alpha = 0.7f)) {"},{"type":"DELETE","lineNumber":158,"oldContent":"        ) {"},{"type":"DELETE","lineNumber":159,"oldContent":"            containerColor = Color.Black.copy(alpha = 0.7f)"},{"type":"DELETE","lineNumber":160,"oldContent":"            onClick = { onToggleMapType() },"},{"type":"DELETE","lineNumber":161,"oldContent":"fun FloatingButtons("},{"type":"DELETE","lineNumber":162,"oldContent":"        FloatingActionButton("},{"type":"DELETE","lineNumber":163,"oldContent":"    modifier: Modifier = Modifier,"},{"type":"DELETE","lineNumber":164,"oldContent":") {"},{"type":"DELETE","lineNumber":165,"oldContent":"    onToggleMapType: () -> Unit"}]}]},"C:/Users/Hrushikesh/AndroidStudioProjects/SampleGCS/app/src/main/java/com/example/aerogcsclone/uimain/PlanScreen.kt":{"filePath":"C:/Users/Hrushikesh/AndroidStudioProjects/SampleGCS/app/src/main/java/com/example/aerogcsclone/uimain/PlanScreen.kt","baseContent":"package com.example.aerogcsclone.uimain\n\nimport androidx.compose.foundation.layout.Column\nimport androidx.compose.foundation.layout.fillMaxSize\nimport androidx.compose.foundation.layout.padding\nimport androidx.compose.material3.FloatingActionButton\nimport androidx.compose.material3.Scaffold\nimport androidx.compose.material3.Text\nimport androidx.compose.runtime.Composable\nimport androidx.compose.runtime.collectAsState\nimport androidx.compose.runtime.getValue\nimport androidx.compose.ui.Modifier\nimport androidx.navigation.NavHostController\nimport com.example.aerogcsclone.Telemetry.SharedViewModel\nimport com.example.aerogcsclone.authentication.AuthViewModel\n\n@Composable\nfun PlanScreen(\n    telemetryViewModel: SharedViewModel,\n    authViewModel: AuthViewModel,\n    navController: NavHostController\n) {\n    val telemetryState by telemetryViewModel.telemetryState.collectAsState()\n\n    Scaffold(\n        floatingActionButton = {\n            FloatingActionButton(onClick = { /* TODO */ }) {\n                Text(\"Create Plan\")\n            }\n        }\n    ) { paddingValues ->\n        Column(\n            modifier = Modifier\n                .fillMaxSize()\n                .padding(paddingValues)\n        ) {\n            TopNavBar(\n                telemetryState = telemetryState,\n                authViewModel = authViewModel,\n                navController = navController\n            )\n            GcsMap(telemetryState = telemetryState)\n        }\n    }\n}","baseTimestamp":1757650088623,"deltas":[{"timestamp":1757913843381,"changes":[{"type":"INSERT","lineNumber":32,"content":") {"},{"type":"DELETE","lineNumber":33,"oldContent":"    val telemetryState by telemetryViewModel.telemetryState.collectAsState()"},{"type":"INSERT","lineNumber":145,"content":"                        onClick = { /* TODO: handle Change Mode action */ },"},{"type":"DELETE","lineNumber":146,"oldContent":"                        modifier = Modifier.size(56.dp)"},{"type":"INSERT","lineNumber":159,"content":"                                navController.navigate(Screen.Main.route) {"},{"type":"DELETE","lineNumber":160,"oldContent":"                                    popUpTo(Screen.Plan.route) { inclusive = true }"},{"type":"INSERT","lineNumber":166,"content":"                                    Toast.LENGTH_SHORT"},{"type":"INSERT","lineNumber":167,"content":"                                ).show()"},{"type":"DELETE","lineNumber":168,"oldContent":"                                    Toast.LENGTH_SHORT"},{"type":"DELETE","lineNumber":171,"oldContent":"                                ).show()"},{"type":"DELETE","lineNumber":177,"oldContent":"                "},{"type":"DELETE","lineNumber":178,"oldContent":"                // Show waypoints for user feedback"},{"type":"INSERT","lineNumber":177,"content":"                }"},{"type":"INSERT","lineNumber":178,"content":"            }"},{"type":"INSERT","lineNumber":179,"content":"            "},{"type":"INSERT","lineNumber":181,"content":"                // Show waypoints for user feedback"},{"type":"DELETE","lineNumber":181,"oldContent":"                    waypoints.forEachIndexed { idx, wp ->"},{"type":"INSERT","lineNumber":184,"content":"                    waypoints.forEachIndexed { idx, wp ->"}]},{"timestamp":1757913860371,"changes":[{"type":"MODIFY","lineNumber":168,"content":"                            }","oldContent":"                            }"},{"type":"DELETE","lineNumber":178,"oldContent":"            }"},{"type":"MODIFY","lineNumber":181,"content":"                Column(modifier = Modifier.padding(16.dp)) {","oldContent":"                Column(modifier = Modifier.padding(16.dp)) {"},{"type":"MODIFY","lineNumber":184,"content":"                        Text(\"#${idx + 1}: Lat=${wp.x / 1e7}, Lon=${wp.y / 1e7}, Alt=${wp.z}\")","oldContent":"                        Text(\"#${idx + 1}: Lat=${wp.x / 1e7}, Lon=${wp.y / 1e7}, Alt=${wp.z}\")"}]},{"timestamp":1757913867598,"changes":[{"type":"INSERT","lineNumber":167,"content":"                                ).show()"},{"type":"DELETE","lineNumber":168,"oldContent":"                            }"},{"type":"MODIFY","lineNumber":181,"content":"                Column(modifier = Modifier.padding(16.dp)) {","oldContent":"                Column(modifier = Modifier.padding(16.dp)) {"},{"type":"MODIFY","lineNumber":184,"content":"                        Text(\"#${idx + 1}: Lat=${wp.x / 1e7}, Lon=${wp.y / 1e7}, Alt=${wp.z}\")","oldContent":"                        Text(\"#${idx + 1}: Lat=${wp.x / 1e7}, Lon=${wp.y / 1e7}, Alt=${wp.z}\")"}]},{"timestamp":1757913872038,"changes":[{"type":"INSERT","lineNumber":180,"content":"                // Show waypoints for user feedback"},{"type":"DELETE","lineNumber":181,"oldContent":"                Column(modifier = Modifier.padding(16.dp)) {"},{"type":"INSERT","lineNumber":183,"content":"                    waypoints.forEachIndexed { idx, wp ->"},{"type":"DELETE","lineNumber":184,"oldContent":"                        Text(\"#${idx + 1}: Lat=${wp.x / 1e7}, Lon=${wp.y / 1e7}, Alt=${wp.z}\")"},{"type":"DELETE","lineNumber":190,"oldContent":"}"},{"type":"INSERT","lineNumber":191,"content":""}]},{"timestamp":1757913880438,"changes":[{"type":"MODIFY","lineNumber":6,"content":"import androidx.compose.material3.*","oldContent":"import androidx.compose.foundation.layout.fillMaxSize"},{"type":"MODIFY","lineNumber":8,"content":"import androidx.compose.runtime.*","oldContent":"import androidx.compose.material3.FloatingActionButton"},{"type":"DELETE","lineNumber":10,"oldContent":"import androidx.compose.material3.Text"},{"type":"DELETE","lineNumber":11,"oldContent":"import androidx.compose.ui.unit.dp"},{"type":"DELETE","lineNumber":12,"oldContent":"import androidx.compose.runtime.Composable"},{"type":"DELETE","lineNumber":13,"oldContent":"import androidx.compose.runtime.collectAsState"},{"type":"INSERT","lineNumber":11,"content":"import androidx.compose.ui.unit.dp"},{"type":"INSERT","lineNumber":12,"content":"import androidx.navigation.NavHostController"},{"type":"INSERT","lineNumber":13,"content":"import com.example.aerogcsclone.Telemetry.SharedViewModel"},{"type":"INSERT","lineNumber":14,"content":"import com.example.aerogcsclone.authentication.AuthViewModel"},{"type":"INSERT","lineNumber":98,"content":"                            .size(56.dp)"},{"type":"INSERT","lineNumber":99,"content":"                    ) {"},{"type":"INSERT","lineNumber":100,"content":"                        Icon(Icons.Default.ClearAll, contentDescription = \"Clear Plan\")"},{"type":"INSERT","lineNumber":101,"content":"                    }"},{"type":"DELETE","lineNumber":99,"oldContent":"                    Text(\"Upload Mission\")"},{"type":"DELETE","lineNumber":100,"oldContent":"                        .fillMaxWidth()"},{"type":"DELETE","lineNumber":101,"oldContent":"                        .padding(top = 16.dp)"},{"type":"DELETE","lineNumber":102,"oldContent":"                    },"},{"type":"MODIFY","lineNumber":103,"content":"","oldContent":"                        }"},{"type":"DELETE","lineNumber":152,"oldContent":"                                    popUpTo(Screen.Plan.route) { inclusive = true }"},{"type":"DELETE","lineNumber":153,"oldContent":"                                Toast.makeText(context, \"Mission uploaded\", Toast.LENGTH_SHORT).show()"},{"type":"INSERT","lineNumber":152,"content":"                // Upload Mission button"},{"type":"INSERT","lineNumber":153,"content":"                Button("},{"type":"MODIFY","lineNumber":172,"content":"                    modifier = Modifier","oldContent":"                // Show waypoints for user feedback"},{"type":"INSERT","lineNumber":173,"content":"                        .padding(top = 16.dp)"},{"type":"INSERT","lineNumber":174,"content":"                        .fillMaxWidth()"},{"type":"INSERT","lineNumber":175,"content":"                ) {"},{"type":"DELETE","lineNumber":174,"oldContent":"                    enabled = waypoints.isNotEmpty(),"},{"type":"DELETE","lineNumber":175,"oldContent":"                            } else {"},{"type":"DELETE","lineNumber":176,"oldContent":"                    Text(\"Upload Mission (${waypoints.size})\")"},{"type":"INSERT","lineNumber":190,"content":"}"},{"type":"DELETE","lineNumber":191,"oldContent":""}]},{"timestamp":1757913894119,"changes":[{"type":"INSERT","lineNumber":10,"content":"import androidx.compose.ui.Modifier"},{"type":"DELETE","lineNumber":14,"oldContent":"import androidx.compose.runtime.getValue"},{"type":"DELETE","lineNumber":19,"oldContent":""},{"type":"DELETE","lineNumber":20,"oldContent":"@Composable"},{"type":"DELETE","lineNumber":21,"oldContent":"    telemetryViewModel: SharedViewModel,"},{"type":"INSERT","lineNumber":19,"content":"import androidx.compose.material.icons.filled.Delete"},{"type":"INSERT","lineNumber":20,"content":"import androidx.compose.material.icons.filled.ClearAll"},{"type":"INSERT","lineNumber":21,"content":"import androidx.compose.material.icons.filled.Menu"},{"type":"MODIFY","lineNumber":35,"content":"","oldContent":"        Column("},{"type":"MODIFY","lineNumber":79,"content":"                    ) {","oldContent":"                        telemetryViewModel.uploadMission(sampleMissionItems) { success, error ->"},{"type":"MODIFY","lineNumber":97,"content":"                            .padding(bottom = 12.dp)","oldContent":""},{"type":"DELETE","lineNumber":99,"oldContent":"                navController = navController"},{"type":"INSERT","lineNumber":102,"content":"                }"},{"type":"DELETE","lineNumber":117,"oldContent":"                }"},{"type":"DELETE","lineNumber":118,"oldContent":"                ) {"},{"type":"DELETE","lineNumber":119,"oldContent":"                        .padding(top = 16.dp)"},{"type":"DELETE","lineNumber":120,"oldContent":"                    modifier = Modifier"},{"type":"DELETE","lineNumber":121,"oldContent":"                        }"},{"type":"DELETE","lineNumber":122,"oldContent":"                                Toast.makeText(context, error ?: \"Mission upload failed\", Toast.LENGTH_SHORT).show()"},{"type":"DELETE","lineNumber":123,"oldContent":"                    FloatingActionButton("},{"type":"DELETE","lineNumber":124,"oldContent":"                    verticalArrangement = Arrangement.spacedBy(12.dp)"},{"type":"DELETE","lineNumber":125,"oldContent":"                        .align(Alignment.TopStart)"},{"type":"DELETE","lineNumber":126,"oldContent":"                Column("},{"type":"INSERT","lineNumber":117,"content":"                .padding(paddingValues)"},{"type":"INSERT","lineNumber":118,"content":"        ) {"},{"type":"INSERT","lineNumber":119,"content":"            // Top navigation bar"},{"type":"INSERT","lineNumber":120,"content":"            TopNavBar("},{"type":"INSERT","lineNumber":121,"content":"                telemetryState = telemetryState,"},{"type":"INSERT","lineNumber":122,"content":"                authViewModel = authViewModel,"},{"type":"INSERT","lineNumber":123,"content":"                navController = navController"},{"type":"INSERT","lineNumber":124,"content":"            )"},{"type":"INSERT","lineNumber":125,"content":""},{"type":"INSERT","lineNumber":126,"content":"            Box(modifier = Modifier.fillMaxSize()) {"},{"type":"DELETE","lineNumber":134,"oldContent":"                            if (success) {"},{"type":"DELETE","lineNumber":135,"oldContent":"                        telemetryViewModel.uploadMission(sampleMissionItems) { success, error ->"},{"type":"INSERT","lineNumber":134,"content":"                        .padding(start = 16.dp, top = 72.dp), // push below TopNavBar"},{"type":"INSERT","lineNumber":135,"content":"                    verticalArrangement = Arrangement.spacedBy(12.dp)"},{"type":"INSERT","lineNumber":136,"content":"                ) {"},{"type":"INSERT","lineNumber":137,"content":"                    FloatingActionButton("},{"type":"DELETE","lineNumber":137,"oldContent":"                    modifier = Modifier"},{"type":"DELETE","lineNumber":138,"oldContent":"                    },"},{"type":"DELETE","lineNumber":174,"oldContent":"                    Text(\"Upload Mission (${waypoints.size})\")"},{"type":"DELETE","lineNumber":177,"oldContent":"                }"},{"type":"INSERT","lineNumber":176,"content":"                    Text(\"Upload Mission (${waypoints.size})\")"},{"type":"INSERT","lineNumber":177,"content":"                };"},{"type":"INSERT","lineNumber":178,"content":"                "},{"type":"DELETE","lineNumber":185,"oldContent":""},{"type":"INSERT","lineNumber":186,"content":"                    }"},{"type":"INSERT","lineNumber":187,"content":"                }"},{"type":"INSERT","lineNumber":188,"content":"            }"},{"type":"INSERT","lineNumber":189,"content":"        }"},{"type":"DELETE","lineNumber":187,"oldContent":""},{"type":"DELETE","lineNumber":188,"oldContent":""},{"type":"INSERT","lineNumber":192,"content":""}]},{"timestamp":1757913896538,"changes":[{"type":"MODIFY","lineNumber":3,"content":"import android.widget.Toast","oldContent":"import androidx.compose.foundation.layout.Column"},{"type":"MODIFY","lineNumber":15,"content":"import androidx.compose.material.icons.Icons","oldContent":"import com.example.aerogcsclone.authentication.AuthViewModel"},{"type":"INSERT","lineNumber":25,"content":"import com.example.aerogcsclone.navigation.Screen"},{"type":"DELETE","lineNumber":26,"oldContent":""},{"type":"MODIFY","lineNumber":34,"content":"    val context = LocalContext.current","oldContent":"                .fillMaxSize()"},{"type":"MODIFY","lineNumber":36,"content":"    // Example mission items (replace with actual user input)","oldContent":"        ) {"},{"type":"MODIFY","lineNumber":102,"content":"                }","oldContent":"                }"},{"type":"DELETE","lineNumber":106,"oldContent":"                                }"},{"type":"DELETE","lineNumber":107,"oldContent":"                                    popUpTo(Screen.Plan.route) { inclusive = true }"},{"type":"DELETE","lineNumber":108,"oldContent":"                                Toast.makeText(context, \"Mission uploaded\", Toast.LENGTH_SHORT).show()"},{"type":"DELETE","lineNumber":109,"oldContent":"                            if (success) {"},{"type":"INSERT","lineNumber":106,"content":"                    onClick = { showPlanActions = !showPlanActions },"},{"type":"INSERT","lineNumber":107,"content":"                    modifier = Modifier.size(56.dp)"},{"type":"INSERT","lineNumber":108,"content":"                ) {"},{"type":"INSERT","lineNumber":109,"content":"                    Icon(Icons.Default.Menu, contentDescription = \"Create Plan\")"},{"type":"DELETE","lineNumber":127,"oldContent":"                    }"},{"type":"DELETE","lineNumber":128,"oldContent":"                    waypoints.forEachIndexed { idx, wp ->"},{"type":"DELETE","lineNumber":129,"oldContent":"                Column(modifier = Modifier.padding(16.dp)) {"},{"type":"INSERT","lineNumber":127,"content":"                // Map background"},{"type":"INSERT","lineNumber":128,"content":"                GcsMap(telemetryState = telemetryState)"},{"type":"INSERT","lineNumber":129,"content":""},{"type":"DELETE","lineNumber":137,"oldContent":"                            } else {"},{"type":"INSERT","lineNumber":138,"content":"                        onClick = { telemetryViewModel.arm() },"},{"type":"MODIFY","lineNumber":176,"content":"                    Text(\"Upload Mission (${waypoints.size})\")","oldContent":"                    Text(\"Upload Mission (${waypoints.size})\")"},{"type":"DELETE","lineNumber":178,"oldContent":"                "},{"type":"MODIFY","lineNumber":188,"content":"        }","oldContent":"}"},{"type":"INSERT","lineNumber":189,"content":"    }"},{"type":"INSERT","lineNumber":190,"content":"}"},{"type":"INSERT","lineNumber":191,"content":""}]},{"timestamp":1757913901156,"changes":[{"type":"DELETE","lineNumber":17,"oldContent":"import com.example.aerogcsclone.authentication.AuthViewModel"},{"type":"DELETE","lineNumber":18,"oldContent":""},{"type":"INSERT","lineNumber":17,"content":"import androidx.compose.material.icons.filled.FlightTakeoff"},{"type":"INSERT","lineNumber":18,"content":"import androidx.compose.material.icons.filled.Add"},{"type":"MODIFY","lineNumber":23,"content":"import com.divpundir.mavlink.definitions.common.MissionItemInt","oldContent":"    navController: NavHostController"},{"type":"MODIFY","lineNumber":27,"content":"@Composable","oldContent":"    Scaffold("},{"type":"MODIFY","lineNumber":40,"content":"    var showPlanActions by remember { mutableStateOf(false) }","oldContent":"        ) {"},{"type":"INSERT","lineNumber":101,"content":"                    }"},{"type":"DELETE","lineNumber":102,"oldContent":"                }"},{"type":"DELETE","lineNumber":104,"oldContent":"                    waypoints.forEachIndexed { idx, wp ->"},{"type":"DELETE","lineNumber":105,"oldContent":"                    Text(\"Waypoints:\", style = MaterialTheme.typography.titleMedium)"},{"type":"INSERT","lineNumber":104,"content":"                // Main Create Plan button"},{"type":"INSERT","lineNumber":105,"content":"                FloatingActionButton("},{"type":"DELETE","lineNumber":110,"oldContent":"                    enabled = waypoints.isNotEmpty(),"},{"type":"MODIFY","lineNumber":110,"content":"                }","oldContent":"                                }"},{"type":"INSERT","lineNumber":111,"content":"            }"},{"type":"DELETE","lineNumber":113,"oldContent":"                                    popUpTo(Screen.Plan.route) { inclusive = true }"},{"type":"DELETE","lineNumber":114,"oldContent":"                        telemetryViewModel.uploadMission(waypoints) { success, error ->"},{"type":"DELETE","lineNumber":115,"oldContent":"                Column("},{"type":"DELETE","lineNumber":116,"oldContent":"                // Left-side floating buttons (below TopNavBar)"},{"type":"INSERT","lineNumber":113,"content":"    ) { paddingValues ->"},{"type":"INSERT","lineNumber":114,"content":"        Column("},{"type":"INSERT","lineNumber":115,"content":"            modifier = Modifier"},{"type":"INSERT","lineNumber":116,"content":"                .fillMaxSize()"},{"type":"MODIFY","lineNumber":138,"content":"                        onClick = { telemetryViewModel.arm() },","oldContent":"                        onClick = { telemetryViewModel.arm() },"},{"type":"MODIFY","lineNumber":161,"content":"                                }","oldContent":""},{"type":"INSERT","lineNumber":175,"content":"                ) {"},{"type":"DELETE","lineNumber":176,"oldContent":"                    Text(\"Upload Mission (${waypoints.size})\")"},{"type":"MODIFY","lineNumber":179,"content":"","oldContent":"            "},{"type":"MODIFY","lineNumber":182,"content":"                    Text(\"Waypoints:\", style = MaterialTheme.typography.titleMedium)","oldContent":""},{"type":"MODIFY","lineNumber":184,"content":"                        Text(\"#${idx + 1}: Lat=${wp.x / 1e7}, Lon=${wp.y / 1e7}, Alt=${wp.z}\")","oldContent":"}"},{"type":"INSERT","lineNumber":186,"content":"                }"},{"type":"INSERT","lineNumber":187,"content":"            }"},{"type":"DELETE","lineNumber":187,"oldContent":"        }"},{"type":"DELETE","lineNumber":189,"oldContent":""},{"type":"INSERT","lineNumber":191,"content":""}]},{"timestamp":1757913954843,"changes":[{"type":"MODIFY","lineNumber":16,"content":"import androidx.compose.material.icons.filled.Build","oldContent":"import com.example.aerogcsclone.authentication.AuthViewModel"},{"type":"MODIFY","lineNumber":22,"content":"import androidx.compose.ui.platform.LocalContext","oldContent":"    navController: NavHostController"},{"type":"MODIFY","lineNumber":41,"content":"","oldContent":"                authViewModel = authViewModel,"},{"type":"MODIFY","lineNumber":111,"content":"            }","oldContent":"                    enabled = waypoints.isNotEmpty(),"},{"type":"INSERT","lineNumber":137,"content":"                    FloatingActionButton("},{"type":"DELETE","lineNumber":138,"oldContent":"                        onClick = { telemetryViewModel.arm() },"},{"type":"DELETE","lineNumber":177,"oldContent":"                };"},{"type":"DELETE","lineNumber":178,"oldContent":"            "},{"type":"INSERT","lineNumber":177,"content":"                }"},{"type":"DELETE","lineNumber":181,"oldContent":""},{"type":"INSERT","lineNumber":180,"content":"                Column(modifier = Modifier.padding(16.dp)) {"},{"type":"DELETE","lineNumber":183,"oldContent":""},{"type":"INSERT","lineNumber":182,"content":"                    waypoints.forEachIndexed { idx, wp ->"},{"type":"MODIFY","lineNumber":187,"content":"        }","oldContent":"                }"},{"type":"DELETE","lineNumber":190,"oldContent":""},{"type":"INSERT","lineNumber":189,"content":"}"}]},{"timestamp":1757914008068,"changes":[{"type":"MODIFY","lineNumber":24,"content":"//import com.example.aerogcsclone.Telemetry.MissionItemInt","oldContent":"    val telemetryState by telemetryViewModel.telemetryState.collectAsState()"},{"type":"DELETE","lineNumber":38,"oldContent":"        ) {"},{"type":"DELETE","lineNumber":39,"oldContent":"                telemetryState = telemetryState,"},{"type":"INSERT","lineNumber":38,"content":""},{"type":"INSERT","lineNumber":39,"content":"    // State to toggle plan action buttons"},{"type":"DELETE","lineNumber":51,"oldContent":"            frame = 3u, // MAV_FRAME_GLOBAL_RELATIVE_ALT_INT"},{"type":"DELETE","lineNumber":52,"oldContent":"            command = 16u, // MAV_CMD_NAV_WAYPOINT"},{"type":"INSERT","lineNumber":51,"content":"            frame = com.divpundir.mavlink.api.MavEnumValue.of(com.divpundir.mavlink.definitions.common.MavFrame.GLOBAL_RELATIVE_ALT_INT),"},{"type":"INSERT","lineNumber":52,"content":"            command = com.divpundir.mavlink.api.MavEnumValue.of(com.divpundir.mavlink.definitions.common.MavCmd.NAV_WAYPOINT), // MAV_CMD_NAV_WAYPOINT"},{"type":"DELETE","lineNumber":179,"oldContent":"                Column(modifier = Modifier.padding(16.dp)) {"},{"type":"DELETE","lineNumber":181,"oldContent":"                    waypoints.forEachIndexed { idx, wp ->"},{"type":"INSERT","lineNumber":180,"content":"                Column(modifier = Modifier.padding(16.dp)) {"},{"type":"INSERT","lineNumber":182,"content":"                    waypoints.forEachIndexed { idx, wp ->"},{"type":"DELETE","lineNumber":186,"oldContent":"        }"},{"type":"MODIFY","lineNumber":187,"content":"        }","oldContent":"}"},{"type":"INSERT","lineNumber":189,"content":"}"}]},{"timestamp":1757914035561,"changes":[{"type":"DELETE","lineNumber":42,"oldContent":"            )"},{"type":"DELETE","lineNumber":43,"oldContent":"        }"},{"type":"DELETE","lineNumber":44,"oldContent":"}"},{"type":"DELETE","lineNumber":45,"oldContent":"                    }"},{"type":"DELETE","lineNumber":46,"oldContent":"                    waypoints.forEachIndexed { idx, wp ->"},{"type":"DELETE","lineNumber":47,"oldContent":"                Column(modifier = Modifier.padding(16.dp)) {"},{"type":"INSERT","lineNumber":42,"content":"    // Mutable list to store waypoints"},{"type":"INSERT","lineNumber":43,"content":"    val waypoints = remember { mutableStateListOf<MissionItemInt>() }"},{"type":"DELETE","lineNumber":49,"oldContent":"                    enabled = waypoints.isNotEmpty(),"},{"type":"DELETE","lineNumber":50,"oldContent":"                                }"},{"type":"INSERT","lineNumber":45,"content":"    // Helper to create a dummy waypoint (replace with real input logic)"},{"type":"INSERT","lineNumber":46,"content":"    fun createDummyWaypoint(seq: Int): MissionItemInt {"},{"type":"INSERT","lineNumber":47,"content":"        return MissionItemInt("},{"type":"INSERT","lineNumber":48,"content":"            targetSystem = telemetryState.fcuDetected.let { if (it) 1u else 0u }, // Use 1u for demo"},{"type":"INSERT","lineNumber":49,"content":"            targetComponent = 0u,"},{"type":"INSERT","lineNumber":50,"content":"            seq = seq.toUShort(),"},{"type":"MODIFY","lineNumber":53,"content":"            current = if (seq == 0) 1u else 0u,","oldContent":"        }"},{"type":"DELETE","lineNumber":76,"oldContent":"                Column(modifier = Modifier.padding(16.dp)) {"},{"type":"DELETE","lineNumber":77,"oldContent":"                // Show waypoints for user feedback"},{"type":"DELETE","lineNumber":78,"oldContent":"                    Text(\"Upload Mission (${waypoints.size})\")"},{"type":"INSERT","lineNumber":76,"content":"                        modifier = Modifier"},{"type":"INSERT","lineNumber":77,"content":"                            .padding(bottom = 12.dp)"},{"type":"INSERT","lineNumber":78,"content":"                            .size(56.dp)"},{"type":"DELETE","lineNumber":81,"oldContent":"                        telemetryViewModel.uploadMission(waypoints) { success, error ->"},{"type":"DELETE","lineNumber":82,"oldContent":"                Column("},{"type":"DELETE","lineNumber":83,"oldContent":"        }"},{"type":"INSERT","lineNumber":81,"content":"                    }"},{"type":"INSERT","lineNumber":82,"content":""},{"type":"INSERT","lineNumber":83,"content":"                    FloatingActionButton("},{"type":"MODIFY","lineNumber":85,"content":"                            if (waypoints.isNotEmpty()) waypoints.removeAt(waypoints.lastIndex)","oldContent":"                            if (waypoints.isNotEmpty()) waypoints.removeLast()"},{"type":"DELETE","lineNumber":92,"oldContent":"        }"},{"type":"DELETE","lineNumber":93,"oldContent":"            }"},{"type":"DELETE","lineNumber":96,"oldContent":"                    Text(\"Upload Mission (${waypoints.size})\")"},{"type":"INSERT","lineNumber":94,"content":"                    FloatingActionButton("},{"type":"INSERT","lineNumber":95,"content":"                        onClick = { waypoints.clear() },"},{"type":"INSERT","lineNumber":96,"content":"                        modifier = Modifier"},{"type":"MODIFY","lineNumber":130,"content":"                // Left-side floating buttons (below TopNavBar)","oldContent":"                                Toast.makeText(context, \"Mission uploaded\", Toast.LENGTH_SHORT).show()"},{"type":"DELETE","lineNumber":132,"oldContent":"                            if (success) {"},{"type":"DELETE","lineNumber":133,"oldContent":"                    Text(\"Waypoints:\", style = MaterialTheme.typography.titleMedium)"},{"type":"INSERT","lineNumber":132,"content":"                    modifier = Modifier"},{"type":"INSERT","lineNumber":133,"content":"                        .align(Alignment.TopStart)"},{"type":"DELETE","lineNumber":147,"oldContent":"                    Text(\"Waypoints:\", style = MaterialTheme.typography.titleMedium)"},{"type":"DELETE","lineNumber":148,"oldContent":""},{"type":"DELETE","lineNumber":149,"oldContent":"            }"},{"type":"INSERT","lineNumber":147,"content":"                    ) {"},{"type":"INSERT","lineNumber":148,"content":"                        Icon(Icons.Default.Build, contentDescription = \"Change Mode\")"},{"type":"INSERT","lineNumber":149,"content":"                    }"},{"type":"MODIFY","lineNumber":151,"content":"","oldContent":"                                ).show()"},{"type":"DELETE","lineNumber":155,"oldContent":"                                    context,"},{"type":"DELETE","lineNumber":156,"oldContent":"                                navController.navigate(Screen.Main.route) {"},{"type":"INSERT","lineNumber":155,"content":"                        telemetryViewModel.uploadMission(waypoints) { success, error ->"},{"type":"INSERT","lineNumber":156,"content":"                            if (success) {"},{"type":"MODIFY","lineNumber":158,"content":"                                    .show()","oldContent":"                    Text(\"Waypoints:\", style = MaterialTheme.typography.titleMedium)"},{"type":"MODIFY","lineNumber":160,"content":"                                    popUpTo(Screen.Plan.route) { inclusive = true }","oldContent":""},{"type":"DELETE","lineNumber":162,"oldContent":"                    },"},{"type":"DELETE","lineNumber":163,"oldContent":"                        }"},{"type":"DELETE","lineNumber":164,"oldContent":"                    waypoints.forEachIndexed { idx, wp ->"},{"type":"DELETE","lineNumber":165,"oldContent":"                // Show waypoints for user feedback"},{"type":"INSERT","lineNumber":162,"content":"                            } else {"},{"type":"INSERT","lineNumber":163,"content":"                                Toast.makeText("},{"type":"INSERT","lineNumber":164,"content":"                                    context,"},{"type":"INSERT","lineNumber":165,"content":"                                    error ?: \"Mission upload failed\","},{"type":"DELETE","lineNumber":168,"oldContent":"            "},{"type":"DELETE","lineNumber":169,"oldContent":"            }"},{"type":"DELETE","lineNumber":170,"oldContent":""},{"type":"DELETE","lineNumber":171,"oldContent":"                    waypoints.forEachIndexed { idx, wp ->"},{"type":"INSERT","lineNumber":168,"content":"                            }"},{"type":"INSERT","lineNumber":169,"content":"                        }"},{"type":"INSERT","lineNumber":170,"content":"                    },"},{"type":"INSERT","lineNumber":171,"content":"                    enabled = waypoints.isNotEmpty(),"},{"type":"INSERT","lineNumber":179,"content":"                // Show waypoints for user feedback"},{"type":"DELETE","lineNumber":180,"oldContent":"                    }"},{"type":"MODIFY","lineNumber":182,"content":"                    waypoints.forEachIndexed { idx, wp ->","oldContent":"                    waypoints.forEachIndexed { idx, wp ->"},{"type":"MODIFY","lineNumber":184,"content":"                    }","oldContent":"            }"},{"type":"INSERT","lineNumber":186,"content":"            }"},{"type":"INSERT","lineNumber":188,"content":"    }"},{"type":"INSERT","lineNumber":189,"content":"}"}]},{"timestamp":1757914323829,"changes":[{"type":"DELETE","lineNumber":23,"oldContent":"import com.divpundir.mavlink.definitions.common.MissionItemInt"},{"type":"DELETE","lineNumber":24,"oldContent":"//import com.example.aerogcsclone.Telemetry.MissionItemInt"},{"type":"DELETE","lineNumber":25,"oldContent":"import com.example.aerogcsclone.navigation.Screen"},{"type":"DELETE","lineNumber":26,"oldContent":"        floatingActionButton = {"},{"type":"INSERT","lineNumber":23,"content":"import com.google.android.gms.maps.model.LatLng"},{"type":"INSERT","lineNumber":24,"content":"import com.divpundir.mavlink.api.MavEnumValue"},{"type":"INSERT","lineNumber":25,"content":"import com.divpundir.mavlink.definitions.common.MavFrame"},{"type":"INSERT","lineNumber":26,"content":"import com.divpundir.mavlink.definitions.common.MavCmd"},{"type":"INSERT","lineNumber":27,"content":""},{"type":"DELETE","lineNumber":36,"oldContent":"    // Example mission items (replace with actual user input)"},{"type":"DELETE","lineNumber":37,"oldContent":"    val sampleMissionItems = listOf<MissionItemInt>() // TODO: Populate with real waypoints"},{"type":"DELETE","lineNumber":38,"oldContent":""},{"type":"DELETE","lineNumber":42,"oldContent":"    // Mutable list to store waypoints"},{"type":"DELETE","lineNumber":43,"oldContent":"    val waypoints = remember { mutableStateListOf<MissionItemInt>() }"},{"type":"DELETE","lineNumber":44,"oldContent":"    // Helper to create a dummy waypoint (replace with real input logic)"},{"type":"DELETE","lineNumber":45,"oldContent":"    fun createDummyWaypoint(seq: Int): MissionItemInt {"},{"type":"DELETE","lineNumber":46,"oldContent":"        return MissionItemInt("},{"type":"DELETE","lineNumber":47,"oldContent":"            targetSystem = telemetryState.fcuDetected.let { if (it) 1u else 0u }, // Use 1u for demo"},{"type":"DELETE","lineNumber":48,"oldContent":"                    Text(\"Upload Mission (${waypoints.size})\")"},{"type":"INSERT","lineNumber":40,"content":"    // Mutable list to store map points (LatLng) and mission items"},{"type":"INSERT","lineNumber":41,"content":"    val points = remember { mutableStateListOf<LatLng>() }"},{"type":"INSERT","lineNumber":42,"content":"    val waypoints = remember { mutableStateListOf<com.divpundir.mavlink.definitions.common.MissionItemInt>() }"},{"type":"INSERT","lineNumber":43,"content":""},{"type":"INSERT","lineNumber":44,"content":"    // Handler when user taps on map: add marker and corresponding mission item"},{"type":"INSERT","lineNumber":45,"content":"    val onMapClick: (LatLng) -> Unit = { latLng ->"},{"type":"INSERT","lineNumber":46,"content":"        points.add(latLng)"},{"type":"INSERT","lineNumber":47,"content":"        // build MissionItemInt"},{"type":"INSERT","lineNumber":48,"content":"        val seq = waypoints.size"},{"type":"INSERT","lineNumber":49,"content":"        val missionItem = com.divpundir.mavlink.definitions.common.MissionItemInt("},{"type":"INSERT","lineNumber":50,"content":"            targetSystem = 0u,"},{"type":"DELETE","lineNumber":51,"oldContent":"            frame = com.divpundir.mavlink.api.MavEnumValue.of(com.divpundir.mavlink.definitions.common.MavFrame.GLOBAL_RELATIVE_ALT_INT),"},{"type":"DELETE","lineNumber":52,"oldContent":"            command = com.divpundir.mavlink.api.MavEnumValue.of(com.divpundir.mavlink.definitions.common.MavCmd.NAV_WAYPOINT), // MAV_CMD_NAV_WAYPOINT"},{"type":"MODIFY","lineNumber":53,"content":"            frame = MavEnumValue.of(MavFrame.GLOBAL_RELATIVE_ALT_INT),","oldContent":"            current = if (seq == 0) 1u else 0u,"},{"type":"INSERT","lineNumber":54,"content":"            command = MavEnumValue.of(MavCmd.NAV_WAYPOINT),"},{"type":"INSERT","lineNumber":55,"content":"            current = 0u,"},{"type":"DELETE","lineNumber":55,"oldContent":"            param1 = 0f, // Hold time"},{"type":"DELETE","lineNumber":56,"oldContent":"            param2 = 0f, // Acceptance radius"},{"type":"DELETE","lineNumber":57,"oldContent":"            param3 = 0f, // Pass radius"},{"type":"DELETE","lineNumber":58,"oldContent":"            param4 = 0f, // Yaw"},{"type":"DELETE","lineNumber":59,"oldContent":"            x = (19.0760 * 1e7).toInt(), // Example lat"},{"type":"DELETE","lineNumber":60,"oldContent":"            y = (72.8777 * 1e7).toInt(), // Example lon"},{"type":"DELETE","lineNumber":61,"oldContent":"            z = 10f // Example alt"},{"type":"INSERT","lineNumber":57,"content":"            param1 = 0f,"},{"type":"INSERT","lineNumber":58,"content":"            param2 = 0f,"},{"type":"INSERT","lineNumber":59,"content":"            param3 = 0f,"},{"type":"INSERT","lineNumber":60,"content":"            param4 = 0f,"},{"type":"INSERT","lineNumber":61,"content":"            x = (latLng.latitude * 1e7).toInt(),"},{"type":"INSERT","lineNumber":62,"content":"            y = (latLng.longitude * 1e7).toInt(),"},{"type":"INSERT","lineNumber":63,"content":"            z = 10f"},{"type":"INSERT","lineNumber":65,"content":"        waypoints.add(missionItem)"},{"type":"DELETE","lineNumber":68,"oldContent":"                    ) {"},{"type":"DELETE","lineNumber":69,"oldContent":"                            .padding(bottom = 12.dp)"},{"type":"DELETE","lineNumber":70,"oldContent":"                        Icon(Icons.Default.Add, contentDescription = \"Add Waypoints\")"},{"type":"DELETE","lineNumber":71,"oldContent":"        }"},{"type":"DELETE","lineNumber":72,"oldContent":"            }"},{"type":"DELETE","lineNumber":73,"oldContent":"                }"},{"type":"DELETE","lineNumber":74,"oldContent":"                    }"},{"type":"DELETE","lineNumber":75,"oldContent":"                        Text(\"#${idx + 1}: Lat=${wp.x / 1e7}, Lon=${wp.y / 1e7}, Alt=${wp.z}\")"},{"type":"INSERT","lineNumber":71,"content":"                horizontalAlignment = Alignment.End"},{"type":"INSERT","lineNumber":72,"content":"            ) {"},{"type":"INSERT","lineNumber":73,"content":"                // Extra buttons shown above \"Create Plan\""},{"type":"INSERT","lineNumber":74,"content":"                if (showPlanActions) {"},{"type":"INSERT","lineNumber":75,"content":"                    FloatingActionButton("},{"type":"INSERT","lineNumber":76,"content":"                        onClick = {"},{"type":"INSERT","lineNumber":77,"content":"                            if (waypoints.isNotEmpty()) {"},{"type":"INSERT","lineNumber":78,"content":"                                waypoints.removeAt(waypoints.lastIndex)"},{"type":"INSERT","lineNumber":79,"content":"                                points.removeAt(points.lastIndex)"},{"type":"INSERT","lineNumber":80,"content":"                            }"},{"type":"INSERT","lineNumber":81,"content":"                        },"},{"type":"DELETE","lineNumber":80,"oldContent":"                        Icon(Icons.Default.Add, contentDescription = \"Add Waypoints\")"},{"type":"INSERT","lineNumber":86,"content":"                        Icon(Icons.Default.Delete, contentDescription = \"Delete Waypoints\")"},{"type":"DELETE","lineNumber":84,"oldContent":"                        onClick = {"},{"type":"DELETE","lineNumber":85,"oldContent":"                            if (waypoints.isNotEmpty()) waypoints.removeAt(waypoints.lastIndex)"},{"type":"DELETE","lineNumber":86,"oldContent":"}"},{"type":"DELETE","lineNumber":87,"oldContent":"    }"},{"type":"DELETE","lineNumber":88,"oldContent":"                            .padding(bottom = 12.dp)"},{"type":"DELETE","lineNumber":89,"oldContent":"                            .size(56.dp)"},{"type":"DELETE","lineNumber":90,"oldContent":"                    ) {"},{"type":"DELETE","lineNumber":91,"oldContent":"                        Icon(Icons.Default.Delete, contentDescription = \"Delete Waypoints\")"},{"type":"DELETE","lineNumber":92,"oldContent":"                    FloatingActionButton("},{"type":"DELETE","lineNumber":93,"oldContent":"                        telemetryViewModel.uploadMission(waypoints) { success, error ->"},{"type":"DELETE","lineNumber":94,"oldContent":"                        onClick = { waypoints.clear() },"},{"type":"DELETE","lineNumber":95,"oldContent":"                Column("},{"type":"INSERT","lineNumber":90,"content":"                        onClick = { waypoints.clear(); points.clear() },"},{"type":"DELETE","lineNumber":112,"oldContent":"                    Text(\"Waypoints:\", style = MaterialTheme.typography.titleMedium)"},{"type":"INSERT","lineNumber":107,"content":"        }"},{"type":"DELETE","lineNumber":127,"oldContent":"                // Map background"},{"type":"DELETE","lineNumber":128,"oldContent":"                GcsMap(telemetryState = telemetryState)"},{"type":"INSERT","lineNumber":122,"content":"                // Map background - pass points and onMapClick callback"},{"type":"INSERT","lineNumber":123,"content":"                GcsMap(telemetryState = telemetryState, points = points, onMapClick = onMapClick)"},{"type":"DELETE","lineNumber":131,"oldContent":"                    ) {"},{"type":"INSERT","lineNumber":126,"content":"                Column("},{"type":"DELETE","lineNumber":139,"oldContent":"                                    Toast.LENGTH_SHORT"},{"type":"INSERT","lineNumber":134,"content":"                        modifier = Modifier.size(56.dp)"},{"type":"DELETE","lineNumber":144,"oldContent":"                                    .show()"},{"type":"INSERT","lineNumber":139,"content":"                    FloatingActionButton("},{"type":"DELETE","lineNumber":150,"oldContent":"                    },"},{"type":"INSERT","lineNumber":145,"content":"                }"},{"type":"DELETE","lineNumber":154,"oldContent":"                // Show waypoints for user feedback"},{"type":"INSERT","lineNumber":149,"content":"                    onClick = {"},{"type":"DELETE","lineNumber":157,"oldContent":"                }"},{"type":"INSERT","lineNumber":152,"content":"                                Toast.makeText(context, \"Mission uploaded\", Toast.LENGTH_SHORT)"},{"type":"DELETE","lineNumber":166,"oldContent":"                ) {"},{"type":"DELETE","lineNumber":167,"oldContent":"                        .fillMaxWidth()"},{"type":"INSERT","lineNumber":161,"content":"                                    Toast.LENGTH_SHORT"},{"type":"INSERT","lineNumber":162,"content":"                                ).show()"},{"type":"DELETE","lineNumber":172,"oldContent":"                }"},{"type":"DELETE","lineNumber":173,"oldContent":"                    }"},{"type":"DELETE","lineNumber":174,"oldContent":"                };"},{"type":"INSERT","lineNumber":167,"content":"                    modifier = Modifier"},{"type":"INSERT","lineNumber":168,"content":"                        .padding(top = 16.dp)"},{"type":"INSERT","lineNumber":169,"content":"                        .fillMaxWidth()"},{"type":"INSERT","lineNumber":176,"content":"                    Text(\"Waypoints:\", style = MaterialTheme.typography.titleMedium)"},{"type":"DELETE","lineNumber":182,"oldContent":"                    waypoints.forEachIndexed { idx, wp ->"},{"type":"DELETE","lineNumber":183,"oldContent":"}"},{"type":"INSERT","lineNumber":178,"content":"                        Text(\"#${idx + 1}: Lat=${wp.x / 1e7}, Lon=${wp.y / 1e7}, Alt=${wp.z}\")"},{"type":"INSERT","lineNumber":180,"content":"                }"},{"type":"INSERT","lineNumber":182,"content":"        }"},{"type":"INSERT","lineNumber":183,"content":"    }"},{"type":"INSERT","lineNumber":184,"content":"}"}]},{"timestamp":1757914366169,"changes":[{"type":"INSERT","lineNumber":27,"content":"import com.example.aerogcsclone.navigation.Screen"},{"type":"DELETE","lineNumber":38,"oldContent":"    // Mutable list to store map points (LatLng) and mission items"},{"type":"DELETE","lineNumber":40,"oldContent":"    val points = remember { mutableStateListOf<LatLng>() }"},{"type":"INSERT","lineNumber":41,"content":"    // Mutable list to store map points (LatLng) and mission items"},{"type":"INSERT","lineNumber":42,"content":"    val points = remember { mutableStateListOf<LatLng>() }"},{"type":"DELETE","lineNumber":50,"oldContent":"            targetComponent = 0u,"},{"type":"INSERT","lineNumber":52,"content":"            targetComponent = 0u,"},{"type":"DELETE","lineNumber":55,"oldContent":"            autocontinue = 1u,"},{"type":"INSERT","lineNumber":57,"content":"            autocontinue = 1u,"},{"type":"DELETE","lineNumber":63,"oldContent":"            Column("},{"type":"DELETE","lineNumber":65,"oldContent":"        floatingActionButton = {"},{"type":"DELETE","lineNumber":66,"oldContent":""},{"type":"INSERT","lineNumber":65,"content":"        )"},{"type":"INSERT","lineNumber":67,"content":"    }"},{"type":"INSERT","lineNumber":68,"content":""},{"type":"DELETE","lineNumber":77,"oldContent":"                        modifier = Modifier"},{"type":"DELETE","lineNumber":79,"oldContent":"                            .padding(bottom = 12.dp)"},{"type":"DELETE","lineNumber":81,"oldContent":"                            .size(56.dp)"},{"type":"MODIFY","lineNumber":83,"content":"                        modifier = Modifier","oldContent":"                    ) {"},{"type":"INSERT","lineNumber":84,"content":"                            .padding(bottom = 12.dp)"},{"type":"INSERT","lineNumber":85,"content":"                            .size(56.dp)"},{"type":"INSERT","lineNumber":86,"content":"                    ) {"},{"type":"INSERT","lineNumber":87,"content":"                        Icon(Icons.Default.Delete, contentDescription = \"Delete Waypoints\")"},{"type":"DELETE","lineNumber":89,"oldContent":"                        Icon(Icons.Default.Delete, contentDescription = \"Delete Waypoints\")"},{"type":"DELETE","lineNumber":102,"oldContent":"        }"},{"type":"INSERT","lineNumber":108,"content":"        }"},{"type":"DELETE","lineNumber":117,"oldContent":"                // Map background - pass points and onMapClick callback"},{"type":"DELETE","lineNumber":119,"oldContent":"                GcsMap(telemetryState = telemetryState, points = points, onMapClick = onMapClick)"},{"type":"MODIFY","lineNumber":123,"content":"                // Map background - pass points and onMapClick callback","oldContent":"                Column("},{"type":"INSERT","lineNumber":124,"content":"                GcsMap(telemetryState = telemetryState, points = points, onMapClick = onMapClick)"},{"type":"INSERT","lineNumber":127,"content":"                Column("},{"type":"DELETE","lineNumber":129,"oldContent":"                        modifier = Modifier.size(56.dp)"},{"type":"INSERT","lineNumber":135,"content":"                        modifier = Modifier.size(56.dp)"},{"type":"INSERT","lineNumber":136,"content":"                    ) {"},{"type":"INSERT","lineNumber":137,"content":"                        Icon(Icons.Default.FlightTakeoff, contentDescription = \"Arm\")"},{"type":"INSERT","lineNumber":138,"content":"                    }"},{"type":"INSERT","lineNumber":139,"content":""},{"type":"DELETE","lineNumber":136,"oldContent":"            "},{"type":"DELETE","lineNumber":137,"oldContent":"            }"},{"type":"DELETE","lineNumber":138,"oldContent":"                }"},{"type":"DELETE","lineNumber":139,"oldContent":"                                ).show()"},{"type":"DELETE","lineNumber":140,"oldContent":"                }"},{"type":"MODIFY","lineNumber":142,"content":"                        modifier = Modifier.size(56.dp)","oldContent":"                                navController.navigate(Screen.Main.route) {"},{"type":"DELETE","lineNumber":145,"oldContent":"                    onClick = {"},{"type":"INSERT","lineNumber":146,"content":"                }"},{"type":"DELETE","lineNumber":148,"oldContent":"                                Toast.makeText(context, \"Mission uploaded\", Toast.LENGTH_SHORT)"},{"type":"INSERT","lineNumber":150,"content":"                    onClick = {"},{"type":"INSERT","lineNumber":153,"content":"                                Toast.makeText(context, \"Mission uploaded\", Toast.LENGTH_SHORT)"},{"type":"DELETE","lineNumber":154,"oldContent":"                    }"},{"type":"INSERT","lineNumber":155,"content":"                                navController.navigate(Screen.Main.route) {"},{"type":"DELETE","lineNumber":156,"oldContent":"                                    Toast.LENGTH_SHORT"},{"type":"DELETE","lineNumber":158,"oldContent":"                                ).show()"},{"type":"DELETE","lineNumber":163,"oldContent":"                    modifier = Modifier"},{"type":"DELETE","lineNumber":164,"oldContent":"                        .padding(top = 16.dp)"},{"type":"INSERT","lineNumber":162,"content":"                                    Toast.LENGTH_SHORT"},{"type":"INSERT","lineNumber":163,"content":"                                ).show()"},{"type":"DELETE","lineNumber":166,"oldContent":"                        .fillMaxWidth()"},{"type":"DELETE","lineNumber":170,"oldContent":"                    waypoints.forEachIndexed { idx, wp ->"},{"type":"DELETE","lineNumber":171,"oldContent":"                    Text(\"Waypoints:\", style = MaterialTheme.typography.titleMedium)"},{"type":"INSERT","lineNumber":168,"content":"                    modifier = Modifier"},{"type":"INSERT","lineNumber":169,"content":"                        .padding(top = 16.dp)"},{"type":"INSERT","lineNumber":170,"content":"                        .fillMaxWidth()"},{"type":"INSERT","lineNumber":171,"content":"                ) {"},{"type":"INSERT","lineNumber":172,"content":"                    Text(\"Upload Mission (${waypoints.size})\")"},{"type":"INSERT","lineNumber":173,"content":"                }"},{"type":"INSERT","lineNumber":174,"content":""},{"type":"INSERT","lineNumber":175,"content":"                // Show waypoints for user feedback"},{"type":"DELETE","lineNumber":173,"oldContent":"}"},{"type":"INSERT","lineNumber":177,"content":"                    Text(\"Waypoints:\", style = MaterialTheme.typography.titleMedium)"},{"type":"INSERT","lineNumber":178,"content":"                    waypoints.forEachIndexed { idx, wp ->"},{"type":"DELETE","lineNumber":175,"oldContent":"    }"},{"type":"DELETE","lineNumber":176,"oldContent":"                // Show waypoints for user feedback"},{"type":"INSERT","lineNumber":180,"content":"                    }"},{"type":"DELETE","lineNumber":179,"oldContent":"}"},{"type":"INSERT","lineNumber":184,"content":"    }"},{"type":"INSERT","lineNumber":185,"content":"}"}]},{"timestamp":1757914694128,"changes":[{"type":"DELETE","lineNumber":2,"oldContent":"import android.os.Build"},{"type":"DELETE","lineNumber":4,"oldContent":"import androidx.annotation.RequiresApi"},{"type":"MODIFY","lineNumber":39,"content":"    // Mutable list to store map points (LatLng) and mission items","oldContent":"    // Mutable list to store map points (LatLng) and mission items"},{"type":"DELETE","lineNumber":54,"oldContent":"            frame = MavEnumValue.of(MavFrame.GLOBAL_RELATIVE_ALT_INT),"},{"type":"DELETE","lineNumber":55,"oldContent":"            command = MavEnumValue.of(MavCmd.NAV_WAYPOINT),"},{"type":"INSERT","lineNumber":52,"content":"            frame = 3u, // GLOBAL_RELATIVE_ALT_INT"},{"type":"INSERT","lineNumber":53,"content":"            command = 16u, // MAV_CMD_NAV_WAYPOINT"},{"type":"MODIFY","lineNumber":65,"content":"    }","oldContent":"    }"},{"type":"INSERT","lineNumber":79,"content":"                            }"},{"type":"INSERT","lineNumber":80,"content":"                        },"},{"type":"DELETE","lineNumber":83,"oldContent":"                            }"},{"type":"DELETE","lineNumber":85,"oldContent":"                        },"},{"type":"MODIFY","lineNumber":86,"content":"                    }","oldContent":"                    }"},{"type":"INSERT","lineNumber":120,"content":"            Box(modifier = Modifier.fillMaxSize()) {"},{"type":"DELETE","lineNumber":124,"oldContent":"            Box(modifier = Modifier.fillMaxSize()) {"},{"type":"DELETE","lineNumber":136,"oldContent":"                    FloatingActionButton("},{"type":"DELETE","lineNumber":141,"oldContent":"        }"},{"type":"INSERT","lineNumber":138,"content":"                    FloatingActionButton("},{"type":"INSERT","lineNumber":139,"content":"                        onClick = { /* TODO: handle Change Mode action */ },"},{"type":"MODIFY","lineNumber":144,"content":"                }","oldContent":"                }"},{"type":"DELETE","lineNumber":148,"oldContent":""},{"type":"INSERT","lineNumber":146,"content":"                // Upload Mission button"},{"type":"INSERT","lineNumber":147,"content":"                Button("},{"type":"DELETE","lineNumber":150,"oldContent":"}"},{"type":"DELETE","lineNumber":157,"oldContent":"                Column(modifier = Modifier.padding(16.dp)) {"},{"type":"INSERT","lineNumber":155,"content":"                                }"},{"type":"MODIFY","lineNumber":160,"content":"                                    Toast.LENGTH_SHORT","oldContent":"                                    Toast.LENGTH_SHORT"},{"type":"DELETE","lineNumber":166,"oldContent":"                    modifier = Modifier"},{"type":"INSERT","lineNumber":165,"content":"                    enabled = waypoints.isNotEmpty(),"},{"type":"INSERT","lineNumber":166,"content":"                    modifier = Modifier"},{"type":"DELETE","lineNumber":169,"oldContent":"}"},{"type":"DELETE","lineNumber":173,"oldContent":"}"},{"type":"DELETE","lineNumber":176,"oldContent":"                    }"},{"type":"INSERT","lineNumber":174,"content":"                Column(modifier = Modifier.padding(16.dp)) {"},{"type":"INSERT","lineNumber":175,"content":"                    Text(\"Waypoints:\", style = MaterialTheme.typography.titleMedium)"},{"type":"INSERT","lineNumber":176,"content":"                    waypoints.forEachIndexed { idx, wp ->"},{"type":"INSERT","lineNumber":177,"content":"                        Text(\"#${idx + 1}: Lat=${wp.x / 1e7}, Lon=${wp.y / 1e7}, Alt=${wp.z}\")"},{"type":"INSERT","lineNumber":178,"content":"                    }"},{"type":"INSERT","lineNumber":179,"content":"                }"},{"type":"INSERT","lineNumber":180,"content":"            }"},{"type":"INSERT","lineNumber":181,"content":"        }"},{"type":"INSERT","lineNumber":182,"content":"    }"},{"type":"INSERT","lineNumber":183,"content":"}"}]},{"timestamp":1757914866576,"changes":[{"type":"DELETE","lineNumber":37,"oldContent":"    // Mutable list to store map points (LatLng) and mission items"},{"type":"DELETE","lineNumber":38,"oldContent":"    // Mutable list to store map points (LatLng) and mission items"},{"type":"INSERT","lineNumber":37,"content":"    var showPlanActions by remember { mutableStateOf(false) }"},{"type":"INSERT","lineNumber":39,"content":"    // Mutable list to store map points (LatLng) and mission items"},{"type":"DELETE","lineNumber":50,"oldContent":"            frame = 3u, // GLOBAL_RELATIVE_ALT_INT"},{"type":"MODIFY","lineNumber":52,"content":"            frame = MavEnumValue.of(MavFrame.GLOBAL_RELATIVE_ALT_INT),","oldContent":"            command = 16u, // MAV_CMD_NAV_WAYPOINT"},{"type":"INSERT","lineNumber":53,"content":"            command = MavEnumValue.of(MavCmd.NAV_WAYPOINT),"},{"type":"DELETE","lineNumber":63,"oldContent":"    }"},{"type":"DELETE","lineNumber":64,"oldContent":"    }"},{"type":"INSERT","lineNumber":63,"content":"        )"},{"type":"INSERT","lineNumber":65,"content":"    }"},{"type":"DELETE","lineNumber":77,"oldContent":"                            }"},{"type":"MODIFY","lineNumber":79,"content":"                            }","oldContent":"                        },"},{"type":"INSERT","lineNumber":80,"content":"                        },"},{"type":"DELETE","lineNumber":84,"oldContent":"                    }"},{"type":"DELETE","lineNumber":85,"oldContent":"                    }"},{"type":"INSERT","lineNumber":84,"content":"                    ) {"},{"type":"INSERT","lineNumber":86,"content":"                    }"},{"type":"DELETE","lineNumber":118,"oldContent":"            Box(modifier = Modifier.fillMaxSize()) {"},{"type":"INSERT","lineNumber":120,"content":"            Box(modifier = Modifier.fillMaxSize()) {"},{"type":"DELETE","lineNumber":135,"oldContent":"                    FloatingActionButton("},{"type":"DELETE","lineNumber":137,"oldContent":"                        onClick = { /* TODO: handle Change Mode action */ },"},{"type":"INSERT","lineNumber":138,"content":"                    FloatingActionButton("},{"type":"INSERT","lineNumber":139,"content":"                        onClick = { /* TODO: handle Change Mode action */ },"},{"type":"INSERT","lineNumber":142,"content":"                        Icon(Icons.Default.Build, contentDescription = \"Change Mode\")"},{"type":"INSERT","lineNumber":143,"content":"                    }"},{"type":"DELETE","lineNumber":143,"oldContent":"                }"},{"type":"INSERT","lineNumber":145,"content":""},{"type":"DELETE","lineNumber":145,"oldContent":"                    }"},{"type":"DELETE","lineNumber":147,"oldContent":""},{"type":"DELETE","lineNumber":153,"oldContent":"                                }"},{"type":"INSERT","lineNumber":155,"content":"                                }"},{"type":"MODIFY","lineNumber":157,"content":"                                Toast.makeText(","oldContent":"}"},{"type":"INSERT","lineNumber":158,"content":"                                    context,"},{"type":"INSERT","lineNumber":159,"content":"                                    error ?: \"Mission upload failed\","},{"type":"DELETE","lineNumber":159,"oldContent":"                                    Toast.LENGTH_SHORT"},{"type":"DELETE","lineNumber":160,"oldContent":"        }"},{"type":"MODIFY","lineNumber":162,"content":"                            }","oldContent":"                    Text(\"Waypoints:\", style = MaterialTheme.typography.titleMedium)"},{"type":"INSERT","lineNumber":163,"content":"                        }"},{"type":"INSERT","lineNumber":164,"content":"                    },"},{"type":"DELETE","lineNumber":164,"oldContent":"}"},{"type":"DELETE","lineNumber":166,"oldContent":"    }"},{"type":"DELETE","lineNumber":171,"oldContent":"                Column(modifier = Modifier.padding(16.dp)) {"},{"type":"INSERT","lineNumber":172,"content":""},{"type":"INSERT","lineNumber":173,"content":"                // Show waypoints for user feedback"},{"type":"INSERT","lineNumber":174,"content":"                Column(modifier = Modifier.padding(16.dp)) {"},{"type":"DELETE","lineNumber":174,"oldContent":"}"},{"type":"DELETE","lineNumber":177,"oldContent":"        }"},{"type":"MODIFY","lineNumber":180,"content":"            }","oldContent":"            }"},{"type":"INSERT","lineNumber":181,"content":"        }"},{"type":"INSERT","lineNumber":182,"content":"    }"},{"type":"INSERT","lineNumber":183,"content":"}"}]},{"timestamp":1757914889686,"changes":[{"type":"DELETE","lineNumber":16,"oldContent":"import androidx.compose.material.icons.filled.Add"},{"type":"MODIFY","lineNumber":38,"content":"    // Mutable list to store map points (LatLng) and mission items","oldContent":"    // Mutable list to store map points (LatLng) and mission items"},{"type":"INSERT","lineNumber":50,"content":"            seq = seq.toUShort(),"},{"type":"DELETE","lineNumber":53,"oldContent":"            seq = seq.toUShort(),"},{"type":"MODIFY","lineNumber":64,"content":"    }","oldContent":"    }"},{"type":"DELETE","lineNumber":67,"oldContent":"                    }"},{"type":"DELETE","lineNumber":68,"oldContent":"                    ) {"},{"type":"DELETE","lineNumber":69,"oldContent":"                        onClick = { /* TODO: handle Change Mode action */ },"},{"type":"INSERT","lineNumber":66,"content":"    Scaffold("},{"type":"INSERT","lineNumber":67,"content":"        floatingActionButton = {"},{"type":"INSERT","lineNumber":68,"content":"            Column("},{"type":"INSERT","lineNumber":77,"content":"                                points.removeAt(points.lastIndex)"},{"type":"DELETE","lineNumber":80,"oldContent":"                                points.removeAt(points.lastIndex)"},{"type":"MODIFY","lineNumber":85,"content":"                    }","oldContent":"                    }"},{"type":"MODIFY","lineNumber":119,"content":"            Box(modifier = Modifier.fillMaxSize()) {","oldContent":"            Box(modifier = Modifier.fillMaxSize()) {"},{"type":"DELETE","lineNumber":128,"oldContent":"}"},{"type":"DELETE","lineNumber":129,"oldContent":"                    waypoints.forEachIndexed { idx, wp ->"},{"type":"DELETE","lineNumber":130,"oldContent":"                Column(modifier = Modifier.padding(16.dp)) {"},{"type":"INSERT","lineNumber":127,"content":"                        .padding(start = 16.dp, top = 72.dp), // push below TopNavBar"},{"type":"INSERT","lineNumber":128,"content":"                    verticalArrangement = Arrangement.spacedBy(12.dp)"},{"type":"INSERT","lineNumber":129,"content":"                ) {"},{"type":"DELETE","lineNumber":132,"oldContent":"                }"},{"type":"INSERT","lineNumber":131,"content":"                        onClick = { telemetryViewModel.arm() },"},{"type":"DELETE","lineNumber":136,"oldContent":"                    FloatingActionButton("},{"type":"DELETE","lineNumber":138,"oldContent":"                        onClick = { /* TODO: handle Change Mode action */ },"},{"type":"INSERT","lineNumber":137,"content":"                    FloatingActionButton("},{"type":"INSERT","lineNumber":138,"content":"                        onClick = { /* TODO: handle Change Mode action */ },"},{"type":"DELETE","lineNumber":143,"oldContent":"                }"},{"type":"DELETE","lineNumber":145,"oldContent":"                // Upload Mission button"},{"type":"INSERT","lineNumber":143,"content":"                }"},{"type":"INSERT","lineNumber":145,"content":"                // Upload Mission button"},{"type":"DELETE","lineNumber":150,"oldContent":"}"},{"type":"INSERT","lineNumber":149,"content":"                            if (success) {"},{"type":"DELETE","lineNumber":152,"oldContent":"        }"},{"type":"INSERT","lineNumber":151,"content":"                                    .show()"},{"type":"INSERT","lineNumber":153,"content":"                                    popUpTo(Screen.Plan.route) { inclusive = true }"},{"type":"DELETE","lineNumber":155,"oldContent":"                        Text(\"#${idx + 1}: Lat=${wp.x / 1e7}, Lon=${wp.y / 1e7}, Alt=${wp.z}\")"},{"type":"DELETE","lineNumber":156,"oldContent":"                        .fillMaxWidth()"},{"type":"INSERT","lineNumber":155,"content":"                            } else {"},{"type":"MODIFY","lineNumber":159,"content":"                                    Toast.LENGTH_SHORT","oldContent":"                                    Toast.LENGTH_SHORT"},{"type":"MODIFY","lineNumber":164,"content":"                    enabled = waypoints.isNotEmpty(),","oldContent":"                    enabled = waypoints.isNotEmpty(),"},{"type":"DELETE","lineNumber":170,"oldContent":"}"},{"type":"INSERT","lineNumber":169,"content":"                    Text(\"Upload Mission (${waypoints.size})\")"},{"type":"INSERT","lineNumber":170,"content":"                }"},{"type":"DELETE","lineNumber":172,"oldContent":"        }"},{"type":"MODIFY","lineNumber":174,"content":"                    Text(\"Waypoints:\", style = MaterialTheme.typography.titleMedium)","oldContent":"                    Text(\"Waypoints:\", style = MaterialTheme.typography.titleMedium)"},{"type":"DELETE","lineNumber":178,"oldContent":"}"},{"type":"DELETE","lineNumber":179,"oldContent":"    }"},{"type":"INSERT","lineNumber":177,"content":"                    }"},{"type":"INSERT","lineNumber":178,"content":"                }"},{"type":"INSERT","lineNumber":180,"content":"        }"},{"type":"INSERT","lineNumber":181,"content":"    }"},{"type":"INSERT","lineNumber":182,"content":"}"}]},{"timestamp":1757915700674,"changes":[{"type":"DELETE","lineNumber":2,"oldContent":"import android.widget.Toast"},{"type":"INSERT","lineNumber":15,"content":"import androidx.compose.material.icons.filled.Add"},{"type":"DELETE","lineNumber":19,"oldContent":"import androidx.compose.ui.platform.LocalContext"},{"type":"DELETE","lineNumber":20,"oldContent":"import com.google.android.gms.maps.model.LatLng"},{"type":"DELETE","lineNumber":21,"oldContent":"import com.divpundir.mavlink.api.MavEnumValue"},{"type":"DELETE","lineNumber":22,"oldContent":"import com.divpundir.mavlink.definitions.common.MavFrame"},{"type":"DELETE","lineNumber":23,"oldContent":"import com.divpundir.mavlink.definitions.common.MavCmd"},{"type":"DELETE","lineNumber":24,"oldContent":"import com.example.aerogcsclone.navigation.Screen"},{"type":"DELETE","lineNumber":33,"oldContent":"    val context = LocalContext.current"},{"type":"DELETE","lineNumber":37,"oldContent":"    // Mutable list to store map points (LatLng) and mission items"},{"type":"DELETE","lineNumber":39,"oldContent":"    val points = remember { mutableStateListOf<LatLng>() }"},{"type":"DELETE","lineNumber":40,"oldContent":"    val waypoints = remember { mutableStateListOf<com.divpundir.mavlink.definitions.common.MissionItemInt>() }"},{"type":"DELETE","lineNumber":41,"oldContent":""},{"type":"DELETE","lineNumber":42,"oldContent":"    // Handler when user taps on map: add marker and corresponding mission item"},{"type":"DELETE","lineNumber":43,"oldContent":"    val onMapClick: (LatLng) -> Unit = { latLng ->"},{"type":"DELETE","lineNumber":44,"oldContent":"        points.add(latLng)"},{"type":"DELETE","lineNumber":45,"oldContent":"        // build MissionItemInt"},{"type":"DELETE","lineNumber":46,"oldContent":"        val seq = waypoints.size"},{"type":"DELETE","lineNumber":47,"oldContent":"        val missionItem = com.divpundir.mavlink.definitions.common.MissionItemInt("},{"type":"DELETE","lineNumber":48,"oldContent":"            targetSystem = 0u,"},{"type":"DELETE","lineNumber":49,"oldContent":"            seq = seq.toUShort(),"},{"type":"DELETE","lineNumber":50,"oldContent":"            targetComponent = 0u,"},{"type":"DELETE","lineNumber":51,"oldContent":"            frame = MavEnumValue.of(MavFrame.GLOBAL_RELATIVE_ALT_INT),"},{"type":"DELETE","lineNumber":52,"oldContent":"            command = MavEnumValue.of(MavCmd.NAV_WAYPOINT),"},{"type":"DELETE","lineNumber":53,"oldContent":"            current = 0u,"},{"type":"DELETE","lineNumber":54,"oldContent":"            autocontinue = 1u,"},{"type":"DELETE","lineNumber":55,"oldContent":"            param1 = 0f,"},{"type":"DELETE","lineNumber":56,"oldContent":"            param2 = 0f,"},{"type":"DELETE","lineNumber":57,"oldContent":"            param3 = 0f,"},{"type":"DELETE","lineNumber":58,"oldContent":"            param4 = 0f,"},{"type":"DELETE","lineNumber":59,"oldContent":"            x = (latLng.latitude * 1e7).toInt(),"},{"type":"DELETE","lineNumber":60,"oldContent":"            y = (latLng.longitude * 1e7).toInt(),"},{"type":"DELETE","lineNumber":61,"oldContent":"            z = 10f"},{"type":"DELETE","lineNumber":62,"oldContent":"        )"},{"type":"DELETE","lineNumber":63,"oldContent":"    }"},{"type":"DELETE","lineNumber":64,"oldContent":"        waypoints.add(missionItem)"},{"type":"DELETE","lineNumber":66,"oldContent":""},{"type":"DELETE","lineNumber":74,"oldContent":"                        onClick = {"},{"type":"DELETE","lineNumber":75,"oldContent":"                            if (waypoints.isNotEmpty()) {"},{"type":"DELETE","lineNumber":76,"oldContent":"                                points.removeAt(points.lastIndex)"},{"type":"DELETE","lineNumber":77,"oldContent":"                                waypoints.removeAt(waypoints.lastIndex)"},{"type":"DELETE","lineNumber":78,"oldContent":"                            }"},{"type":"DELETE","lineNumber":79,"oldContent":"                        },"},{"type":"INSERT","lineNumber":39,"content":"                        onClick = { /* TODO: Add Waypoints */ },"},{"type":"INSERT","lineNumber":44,"content":"                        Icon(Icons.Default.Add, contentDescription = \"Add Waypoints\")"},{"type":"INSERT","lineNumber":46,"content":""},{"type":"INSERT","lineNumber":47,"content":"                    FloatingActionButton("},{"type":"INSERT","lineNumber":48,"content":"                        onClick = { /* TODO: Delete Waypoints */ },"},{"type":"INSERT","lineNumber":49,"content":"                        modifier = Modifier"},{"type":"INSERT","lineNumber":50,"content":"                            .padding(bottom = 12.dp)"},{"type":"INSERT","lineNumber":51,"content":"                            .size(56.dp)"},{"type":"INSERT","lineNumber":52,"content":"                    ) {"},{"type":"INSERT","lineNumber":54,"content":"                    }"},{"type":"DELETE","lineNumber":88,"oldContent":"                        onClick = { waypoints.clear(); points.clear() },"},{"type":"INSERT","lineNumber":57,"content":"                        onClick = { /* TODO: Clear Plan */ },"},{"type":"INSERT","lineNumber":83,"content":"                telemetryState = telemetryState,"},{"type":"INSERT","lineNumber":84,"content":"                authViewModel = authViewModel,"},{"type":"INSERT","lineNumber":85,"content":"                navController = navController"},{"type":"INSERT","lineNumber":86,"content":"            )"},{"type":"DELETE","lineNumber":115,"oldContent":"}"},{"type":"DELETE","lineNumber":116,"oldContent":"    }"},{"type":"DELETE","lineNumber":117,"oldContent":"                        onClick = { telemetryViewModel.arm() },"},{"type":"INSERT","lineNumber":89,"content":"                // Map background"},{"type":"INSERT","lineNumber":90,"content":"                GcsMap(telemetryState = telemetryState)"},{"type":"DELETE","lineNumber":120,"oldContent":"                // Map background - pass points and onMapClick callback"},{"type":"DELETE","lineNumber":121,"oldContent":"                GcsMap(telemetryState = telemetryState, points = points, onMapClick = onMapClick)"},{"type":"DELETE","lineNumber":122,"oldContent":"            }"},{"type":"DELETE","lineNumber":126,"oldContent":"                        .padding(start = 16.dp, top = 72.dp), // push below TopNavBar"},{"type":"INSERT","lineNumber":96,"content":"                        .padding(start = 16.dp, top = 72.dp), // push below TopNavBar"},{"type":"INSERT","lineNumber":99,"content":"                    FloatingActionButton("},{"type":"DELETE","lineNumber":131,"oldContent":"}"},{"type":"DELETE","lineNumber":135,"oldContent":"                    FloatingActionButton("},{"type":"DELETE","lineNumber":137,"oldContent":"                        onClick = { /* TODO: handle Change Mode action */ },"},{"type":"INSERT","lineNumber":106,"content":"                    FloatingActionButton("},{"type":"INSERT","lineNumber":107,"content":"                        onClick = { /* TODO: handle Change Mode action */ },"},{"type":"DELETE","lineNumber":142,"oldContent":"                }"},{"type":"DELETE","lineNumber":144,"oldContent":"                // Upload Mission button"},{"type":"DELETE","lineNumber":145,"oldContent":""},{"type":"DELETE","lineNumber":146,"oldContent":"                Button("},{"type":"DELETE","lineNumber":147,"oldContent":"                    onClick = {"},{"type":"DELETE","lineNumber":148,"oldContent":"                            if (success) {"},{"type":"DELETE","lineNumber":149,"oldContent":"    }"},{"type":"DELETE","lineNumber":150,"oldContent":"                                    .show()"},{"type":"DELETE","lineNumber":151,"oldContent":"                                Toast.makeText(context, \"Mission uploaded\", Toast.LENGTH_SHORT)"},{"type":"DELETE","lineNumber":152,"oldContent":"                                    popUpTo(Screen.Plan.route) { inclusive = true }"},{"type":"DELETE","lineNumber":153,"oldContent":"                                navController.navigate(Screen.Main.route) {"},{"type":"DELETE","lineNumber":154,"oldContent":"                                }"},{"type":"DELETE","lineNumber":155,"oldContent":"                            } else {"},{"type":"DELETE","lineNumber":156,"oldContent":"                                Toast.makeText("},{"type":"DELETE","lineNumber":157,"oldContent":"                                    context,"},{"type":"DELETE","lineNumber":158,"oldContent":"                                    Toast.LENGTH_SHORT"},{"type":"DELETE","lineNumber":159,"oldContent":"                                    error ?: \"Mission upload failed\","},{"type":"DELETE","lineNumber":160,"oldContent":"                                ).show()"},{"type":"DELETE","lineNumber":161,"oldContent":"                            }"},{"type":"DELETE","lineNumber":162,"oldContent":"                        }"},{"type":"DELETE","lineNumber":163,"oldContent":"                    enabled = waypoints.isNotEmpty(),"},{"type":"DELETE","lineNumber":164,"oldContent":"                    },"},{"type":"DELETE","lineNumber":165,"oldContent":"                    modifier = Modifier"},{"type":"DELETE","lineNumber":166,"oldContent":"                        .padding(top = 16.dp)"},{"type":"DELETE","lineNumber":167,"oldContent":"                        .fillMaxWidth()"},{"type":"DELETE","lineNumber":168,"oldContent":"                    Text(\"Upload Mission (${waypoints.size})\")"},{"type":"DELETE","lineNumber":169,"oldContent":"}"},{"type":"DELETE","lineNumber":171,"oldContent":""},{"type":"DELETE","lineNumber":172,"oldContent":"                // Show waypoints for user feedback"},{"type":"DELETE","lineNumber":173,"oldContent":"                    Text(\"Waypoints:\", style = MaterialTheme.typography.titleMedium)"},{"type":"DELETE","lineNumber":174,"oldContent":"                Column(modifier = Modifier.padding(16.dp)) {"},{"type":"DELETE","lineNumber":175,"oldContent":"                    waypoints.forEachIndexed { idx, wp ->"},{"type":"DELETE","lineNumber":176,"oldContent":"                    }"},{"type":"DELETE","lineNumber":177,"oldContent":"                        Text(\"#${idx + 1}: Lat=${wp.x / 1e7}, Lon=${wp.y / 1e7}, Alt=${wp.z}\")"},{"type":"DELETE","lineNumber":178,"oldContent":"                }"},{"type":"INSERT","lineNumber":113,"content":"            }"},{"type":"DELETE","lineNumber":180,"oldContent":"}"},{"type":"INSERT","lineNumber":116,"content":"}"},{"type":"INSERT","lineNumber":117,"content":""}]},{"timestamp":1757915709360,"changes":[{"type":"DELETE","lineNumber":13,"oldContent":"import androidx.compose.material.icons.filled.Build"},{"type":"DELETE","lineNumber":14,"oldContent":"import androidx.compose.material.icons.filled.Add"},{"type":"DELETE","lineNumber":15,"oldContent":"import androidx.compose.material.icons.filled.FlightTakeoff"},{"type":"DELETE","lineNumber":16,"oldContent":"import androidx.compose.material.icons.filled.Delete"},{"type":"DELETE","lineNumber":17,"oldContent":"import androidx.compose.material.icons.filled.ClearAll"},{"type":"DELETE","lineNumber":18,"oldContent":"import androidx.compose.material.icons.filled.Menu"},{"type":"INSERT","lineNumber":13,"content":"import androidx.compose.material.icons.filled.*"},{"type":"INSERT","lineNumber":14,"content":"import com.google.maps.android.compose.MapType"},{"type":"DELETE","lineNumber":31,"oldContent":"                        onClick = { /* TODO: Add Waypoints */ },"},{"type":"DELETE","lineNumber":32,"oldContent":"                        Icon(Icons.Default.Add, contentDescription = \"Add Waypoints\")"},{"type":"INSERT","lineNumber":27,"content":"    // ✅ Map type state (same as in MainPage)"},{"type":"INSERT","lineNumber":28,"content":"    var mapType by remember { mutableStateOf(MapType.NORMAL) }"},{"type":"DELETE","lineNumber":34,"oldContent":"                    FloatingActionButton("},{"type":"DELETE","lineNumber":35,"oldContent":"                        onClick = { /* TODO: Delete Waypoints */ },"},{"type":"DELETE","lineNumber":36,"oldContent":"                        modifier = Modifier"},{"type":"DELETE","lineNumber":37,"oldContent":"                            .padding(bottom = 12.dp)"},{"type":"DELETE","lineNumber":38,"oldContent":"                            .size(56.dp)"},{"type":"DELETE","lineNumber":39,"oldContent":"                    ) {"},{"type":"DELETE","lineNumber":40,"oldContent":"                    }"},{"type":"DELETE","lineNumber":41,"oldContent":"                        onClick = { /* TODO: Clear Plan */ },"},{"type":"INSERT","lineNumber":38,"content":"                        onClick = { /* TODO: Add Waypoints */ },"},{"type":"DELETE","lineNumber":53,"oldContent":"                telemetryState = telemetryState,"},{"type":"DELETE","lineNumber":55,"oldContent":"                authViewModel = authViewModel,"},{"type":"INSERT","lineNumber":43,"content":"                        Icon(Icons.Default.Add, contentDescription = \"Add Waypoints\")"},{"type":"DELETE","lineNumber":57,"oldContent":"                navController = navController"},{"type":"DELETE","lineNumber":58,"oldContent":"                        Icon(Icons.Default.Delete, contentDescription = \"Delete Waypoints\")"},{"type":"DELETE","lineNumber":59,"oldContent":"            )"},{"type":"DELETE","lineNumber":62,"oldContent":"                // Map background"},{"type":"INSERT","lineNumber":47,"content":"                        onClick = { /* TODO: Delete Waypoints */ },"},{"type":"DELETE","lineNumber":64,"oldContent":"                GcsMap(telemetryState = telemetryState)"},{"type":"INSERT","lineNumber":52,"content":"                        Icon(Icons.Default.Delete, contentDescription = \"Delete Waypoints\")"},{"type":"INSERT","lineNumber":53,"content":"                    }"},{"type":"INSERT","lineNumber":55,"content":"                    FloatingActionButton("},{"type":"INSERT","lineNumber":56,"content":"                        onClick = { /* TODO: Clear Plan */ },"},{"type":"INSERT","lineNumber":57,"content":"                        modifier = Modifier"},{"type":"INSERT","lineNumber":58,"content":"                            .padding(bottom = 12.dp)"},{"type":"INSERT","lineNumber":59,"content":"                            .size(56.dp)"},{"type":"INSERT","lineNumber":60,"content":"                    ) {"},{"type":"INSERT","lineNumber":61,"content":"                        Icon(Icons.Default.ClearAll, contentDescription = \"Clear Plan\")"},{"type":"DELETE","lineNumber":71,"oldContent":"                        .padding(start = 16.dp, top = 72.dp), // push below TopNavBar"},{"type":"DELETE","lineNumber":72,"oldContent":"            }"},{"type":"INSERT","lineNumber":64,"content":""},{"type":"DELETE","lineNumber":75,"oldContent":"                    FloatingActionButton("},{"type":"DELETE","lineNumber":83,"oldContent":"                    FloatingActionButton("},{"type":"DELETE","lineNumber":85,"oldContent":"                        onClick = { /* TODO: handle Change Mode action */ },"},{"type":"DELETE","lineNumber":92,"oldContent":"            }"},{"type":"INSERT","lineNumber":81,"content":"            TopNavBar("},{"type":"INSERT","lineNumber":82,"content":"                telemetryState = telemetryState,"},{"type":"INSERT","lineNumber":83,"content":"                authViewModel = authViewModel,"},{"type":"INSERT","lineNumber":84,"content":"                navController = navController"},{"type":"INSERT","lineNumber":85,"content":"            )"},{"type":"DELETE","lineNumber":94,"oldContent":"}"},{"type":"DELETE","lineNumber":95,"oldContent":"}"},{"type":"DELETE","lineNumber":96,"oldContent":""},{"type":"DELETE","lineNumber":98,"oldContent":"                GcsMap(telemetryState = telemetryState)"},{"type":"INSERT","lineNumber":88,"content":"                // ✅ Pass selected mapType to GcsMap"},{"type":"INSERT","lineNumber":89,"content":"                GcsMap(telemetryState = telemetryState, mapType = mapType)"},{"type":"INSERT","lineNumber":90,"content":""},{"type":"INSERT","lineNumber":95,"content":"                        .padding(start = 16.dp, top = 72.dp), // push below TopNavBar"},{"type":"INSERT","lineNumber":98,"content":"                    // ✅ Map toggle button ABOVE Arm button"},{"type":"INSERT","lineNumber":99,"content":"                    FloatingActionButton("},{"type":"INSERT","lineNumber":100,"content":"                        onClick = {"},{"type":"INSERT","lineNumber":101,"content":"                            mapType = if (mapType == MapType.NORMAL) MapType.SATELLITE else MapType.NORMAL"},{"type":"INSERT","lineNumber":102,"content":"                        },"},{"type":"INSERT","lineNumber":103,"content":"                        modifier = Modifier.size(56.dp)"},{"type":"INSERT","lineNumber":104,"content":"                    ) {"},{"type":"INSERT","lineNumber":105,"content":"                        Icon(Icons.Default.Map, contentDescription = \"Toggle Map Type\")"},{"type":"INSERT","lineNumber":106,"content":"                    }"},{"type":"INSERT","lineNumber":107,"content":""},{"type":"INSERT","lineNumber":108,"content":"                    FloatingActionButton("},{"type":"INSERT","lineNumber":115,"content":"                    FloatingActionButton("},{"type":"INSERT","lineNumber":116,"content":"                        onClick = { /* TODO: handle Change Mode action */ },"},{"type":"INSERT","lineNumber":122,"content":"            }"},{"type":"INSERT","lineNumber":124,"content":"    }"},{"type":"INSERT","lineNumber":125,"content":"}"},{"type":"INSERT","lineNumber":126,"content":""}]},{"timestamp":1757915781167,"changes":[{"type":"MODIFY","lineNumber":2,"content":"import android.widget.Toast","oldContent":"import androidx.compose.material3.FloatingActionButton"},{"type":"INSERT","lineNumber":3,"content":"import androidx.compose.foundation.layout.*"},{"type":"MODIFY","lineNumber":7,"content":"import androidx.compose.ui.Alignment","oldContent":"import androidx.compose.runtime.collectAsState"},{"type":"INSERT","lineNumber":14,"content":"<<<<<<< Updated upstream"},{"type":"INSERT","lineNumber":17,"content":"======="},{"type":"INSERT","lineNumber":18,"content":"import androidx.compose.material.icons.filled.Build"},{"type":"INSERT","lineNumber":19,"content":"import androidx.compose.material.icons.filled.FlightTakeoff"},{"type":"INSERT","lineNumber":20,"content":"import androidx.compose.material.icons.filled.Delete"},{"type":"INSERT","lineNumber":21,"content":"import androidx.compose.material.icons.filled.ClearAll"},{"type":"INSERT","lineNumber":22,"content":"import androidx.compose.material.icons.filled.Menu"},{"type":"INSERT","lineNumber":23,"content":"import androidx.compose.ui.platform.LocalContext"},{"type":"INSERT","lineNumber":24,"content":"import com.google.android.gms.maps.model.LatLng"},{"type":"INSERT","lineNumber":25,"content":"import com.divpundir.mavlink.api.MavEnumValue"},{"type":"INSERT","lineNumber":26,"content":"import com.divpundir.mavlink.definitions.common.MavFrame"},{"type":"INSERT","lineNumber":27,"content":"import com.divpundir.mavlink.definitions.common.MavCmd"},{"type":"INSERT","lineNumber":28,"content":"import com.example.aerogcsclone.navigation.Screen"},{"type":"INSERT","lineNumber":29,"content":">>>>>>> Stashed changes"},{"type":"DELETE","lineNumber":18,"oldContent":"        }"},{"type":"DELETE","lineNumber":19,"oldContent":"        Column("},{"type":"DELETE","lineNumber":20,"oldContent":"            modifier = Modifier"},{"type":"INSERT","lineNumber":33,"content":"    telemetryViewModel: SharedViewModel,"},{"type":"INSERT","lineNumber":34,"content":"    authViewModel: AuthViewModel,"},{"type":"INSERT","lineNumber":35,"content":"    navController: NavHostController"},{"type":"DELETE","lineNumber":23,"oldContent":"    // ✅ Map type state (same as in MainPage)"},{"type":"INSERT","lineNumber":38,"content":"    val context = LocalContext.current"},{"type":"DELETE","lineNumber":25,"oldContent":"    var mapType by remember { mutableStateOf(MapType.NORMAL) }"},{"type":"INSERT","lineNumber":43,"content":"<<<<<<< Updated upstream"},{"type":"INSERT","lineNumber":44,"content":"    // ✅ Map type state (same as in MainPage)"},{"type":"INSERT","lineNumber":45,"content":"    var mapType by remember { mutableStateOf(MapType.NORMAL) }"},{"type":"INSERT","lineNumber":46,"content":"======="},{"type":"INSERT","lineNumber":47,"content":"    // Mutable list to store map points (LatLng) and mission items"},{"type":"INSERT","lineNumber":48,"content":"    val points = remember { mutableStateListOf<LatLng>() }"},{"type":"INSERT","lineNumber":49,"content":"    val waypoints = remember { mutableStateListOf<com.divpundir.mavlink.definitions.common.MissionItemInt>() }"},{"type":"DELETE","lineNumber":30,"oldContent":"                        onClick = { /* TODO: Add Waypoints */ },"},{"type":"INSERT","lineNumber":51,"content":"    // Handler when user taps on map: add marker and corresponding mission item"},{"type":"INSERT","lineNumber":52,"content":"    val onMapClick: (LatLng) -> Unit = { latLng ->"},{"type":"INSERT","lineNumber":53,"content":"        points.add(latLng)"},{"type":"INSERT","lineNumber":54,"content":"        // build MissionItemInt"},{"type":"INSERT","lineNumber":55,"content":"        val seq = waypoints.size"},{"type":"INSERT","lineNumber":56,"content":"        val missionItem = com.divpundir.mavlink.definitions.common.MissionItemInt("},{"type":"INSERT","lineNumber":57,"content":"            targetSystem = 0u,"},{"type":"INSERT","lineNumber":58,"content":"            targetComponent = 0u,"},{"type":"INSERT","lineNumber":59,"content":"            seq = seq.toUShort(),"},{"type":"INSERT","lineNumber":60,"content":"            frame = MavEnumValue.of(MavFrame.GLOBAL_RELATIVE_ALT_INT),"},{"type":"INSERT","lineNumber":61,"content":"            command = MavEnumValue.of(MavCmd.NAV_WAYPOINT),"},{"type":"INSERT","lineNumber":62,"content":"            current = 0u,"},{"type":"INSERT","lineNumber":63,"content":"            autocontinue = 1u,"},{"type":"INSERT","lineNumber":64,"content":"            param1 = 0f,"},{"type":"INSERT","lineNumber":65,"content":"            param2 = 0f,"},{"type":"INSERT","lineNumber":66,"content":"            param3 = 0f,"},{"type":"INSERT","lineNumber":67,"content":"            param4 = 0f,"},{"type":"INSERT","lineNumber":68,"content":"            x = (latLng.latitude * 1e7).toInt(),"},{"type":"INSERT","lineNumber":69,"content":"            y = (latLng.longitude * 1e7).toInt(),"},{"type":"INSERT","lineNumber":70,"content":"            z = 10f"},{"type":"INSERT","lineNumber":71,"content":"        )"},{"type":"INSERT","lineNumber":72,"content":"        waypoints.add(missionItem)"},{"type":"INSERT","lineNumber":73,"content":"    }"},{"type":"INSERT","lineNumber":74,"content":">>>>>>> Stashed changes"},{"type":"INSERT","lineNumber":75,"content":""},{"type":"DELETE","lineNumber":32,"oldContent":"                        Icon(Icons.Default.Add, contentDescription = \"Add Waypoints\")"},{"type":"DELETE","lineNumber":37,"oldContent":"                        onClick = { /* TODO: Delete Waypoints */ },"},{"type":"INSERT","lineNumber":84,"content":"                        onClick = {"},{"type":"INSERT","lineNumber":85,"content":"                            if (waypoints.isNotEmpty()) {"},{"type":"INSERT","lineNumber":86,"content":"                                waypoints.removeAt(waypoints.lastIndex)"},{"type":"INSERT","lineNumber":87,"content":"                                points.removeAt(points.lastIndex)"},{"type":"INSERT","lineNumber":88,"content":"                            }"},{"type":"INSERT","lineNumber":89,"content":"                        },"},{"type":"DELETE","lineNumber":43,"oldContent":"                        Icon(Icons.Default.Delete, contentDescription = \"Delete Waypoints\")"},{"type":"DELETE","lineNumber":45,"oldContent":"                    }"},{"type":"DELETE","lineNumber":47,"oldContent":"                    FloatingActionButton("},{"type":"DELETE","lineNumber":48,"oldContent":"                        onClick = { /* TODO: Clear Plan */ },"},{"type":"INSERT","lineNumber":94,"content":"                        Icon(Icons.Default.Delete, contentDescription = \"Delete Waypoints\")"},{"type":"INSERT","lineNumber":96,"content":""},{"type":"INSERT","lineNumber":97,"content":"                    FloatingActionButton("},{"type":"INSERT","lineNumber":98,"content":"                        onClick = { waypoints.clear(); points.clear() },"},{"type":"DELETE","lineNumber":54,"oldContent":""},{"type":"DELETE","lineNumber":56,"oldContent":"                    FloatingActionButton("},{"type":"DELETE","lineNumber":57,"oldContent":"                        modifier = Modifier"},{"type":"DELETE","lineNumber":58,"oldContent":""},{"type":"DELETE","lineNumber":59,"oldContent":"                            .padding(bottom = 12.dp)"},{"type":"DELETE","lineNumber":60,"oldContent":"                };"},{"type":"DELETE","lineNumber":61,"oldContent":"                    FloatingActionButton("},{"type":"DELETE","lineNumber":62,"oldContent":"                ) {"},{"type":"INSERT","lineNumber":106,"content":""},{"type":"DELETE","lineNumber":72,"oldContent":"            TopNavBar("},{"type":"DELETE","lineNumber":74,"oldContent":"                telemetryState = telemetryState,"},{"type":"DELETE","lineNumber":76,"oldContent":"                authViewModel = authViewModel,"},{"type":"DELETE","lineNumber":77,"oldContent":"                navController = navController"},{"type":"DELETE","lineNumber":79,"oldContent":"            )"},{"type":"DELETE","lineNumber":82,"oldContent":"                // ✅ Pass selected mapType to GcsMap"},{"type":"INSERT","lineNumber":120,"content":"                .padding(paddingValues)"},{"type":"INSERT","lineNumber":121,"content":"        ) {"},{"type":"INSERT","lineNumber":122,"content":"            // Top navigation bar"},{"type":"INSERT","lineNumber":123,"content":"            TopNavBar("},{"type":"INSERT","lineNumber":124,"content":"                telemetryState = telemetryState,"},{"type":"INSERT","lineNumber":125,"content":"                authViewModel = authViewModel,"},{"type":"INSERT","lineNumber":126,"content":"                navController = navController"},{"type":"INSERT","lineNumber":127,"content":"            )"},{"type":"INSERT","lineNumber":128,"content":""},{"type":"INSERT","lineNumber":129,"content":"            Box(modifier = Modifier.fillMaxSize()) {"},{"type":"INSERT","lineNumber":130,"content":"<<<<<<< Updated upstream"},{"type":"INSERT","lineNumber":131,"content":"                // ✅ Pass selected mapType to GcsMap"},{"type":"DELETE","lineNumber":85,"oldContent":"                        onClick = { telemetryViewModel.arm() },"},{"type":"INSERT","lineNumber":133,"content":"======="},{"type":"INSERT","lineNumber":134,"content":"                // Map background - pass points and onMapClick callback"},{"type":"INSERT","lineNumber":135,"content":"                GcsMap(telemetryState = telemetryState, points = points, onMapClick = onMapClick)"},{"type":"INSERT","lineNumber":136,"content":">>>>>>> Stashed changes"},{"type":"DELETE","lineNumber":87,"oldContent":""},{"type":"DELETE","lineNumber":88,"oldContent":"                GcsMap(telemetryState = telemetryState)"},{"type":"DELETE","lineNumber":89,"oldContent":"                // Map background"},{"type":"INSERT","lineNumber":138,"content":"                // Left-side floating buttons (below TopNavBar)"},{"type":"INSERT","lineNumber":139,"content":"                Column("},{"type":"INSERT","lineNumber":140,"content":"                    modifier = Modifier"},{"type":"INSERT","lineNumber":141,"content":"                        .align(Alignment.TopStart)"},{"type":"DELETE","lineNumber":91,"oldContent":"            Box(modifier = Modifier.fillMaxSize()) {"},{"type":"INSERT","lineNumber":143,"content":"                    verticalArrangement = Arrangement.spacedBy(12.dp)"},{"type":"INSERT","lineNumber":144,"content":"                ) {"},{"type":"DELETE","lineNumber":94,"oldContent":"                // Left-side floating buttons (below TopNavBar)"},{"type":"DELETE","lineNumber":96,"oldContent":"                Column("},{"type":"DELETE","lineNumber":98,"oldContent":"                    modifier = Modifier"},{"type":"DELETE","lineNumber":100,"oldContent":"                        .align(Alignment.TopStart)"},{"type":"DELETE","lineNumber":102,"oldContent":"                    verticalArrangement = Arrangement.spacedBy(12.dp)"},{"type":"DELETE","lineNumber":104,"oldContent":"                ) {"},{"type":"DELETE","lineNumber":106,"oldContent":"                        onClick = { telemetryViewModel.arm() },"},{"type":"DELETE","lineNumber":108,"oldContent":"                        modifier = Modifier.size(56.dp)"},{"type":"DELETE","lineNumber":110,"oldContent":"                    ) {"},{"type":"INSERT","lineNumber":156,"content":"                        onClick = { telemetryViewModel.arm() },"},{"type":"INSERT","lineNumber":157,"content":"                        modifier = Modifier.size(56.dp)"},{"type":"INSERT","lineNumber":158,"content":"                    ) {"},{"type":"INSERT","lineNumber":162,"content":"                    FloatingActionButton("},{"type":"INSERT","lineNumber":163,"content":"                        onClick = { /* TODO: handle Change Mode action */ },"},{"type":"DELETE","lineNumber":119,"oldContent":"                    FloatingActionButton("},{"type":"DELETE","lineNumber":121,"oldContent":"                        onClick = { /* TODO: handle Change Mode action */ },"},{"type":"DELETE","lineNumber":123,"oldContent":"}"},{"type":"DELETE","lineNumber":124,"oldContent":"    }"},{"type":"INSERT","lineNumber":170,"content":"                // Upload Mission button"},{"type":"INSERT","lineNumber":171,"content":"                Button("},{"type":"INSERT","lineNumber":172,"content":"                    onClick = {"},{"type":"INSERT","lineNumber":173,"content":"                        telemetryViewModel.uploadMission(waypoints) { success, error ->"},{"type":"INSERT","lineNumber":174,"content":"                            if (success) {"},{"type":"INSERT","lineNumber":175,"content":"                                Toast.makeText(context, \"Mission uploaded\", Toast.LENGTH_SHORT)"},{"type":"INSERT","lineNumber":176,"content":"                                    .show()"},{"type":"INSERT","lineNumber":177,"content":"                                navController.navigate(Screen.Main.route) {"},{"type":"INSERT","lineNumber":178,"content":"                                    popUpTo(Screen.Plan.route) { inclusive = true }"},{"type":"INSERT","lineNumber":179,"content":"                                }"},{"type":"INSERT","lineNumber":180,"content":"                            } else {"},{"type":"INSERT","lineNumber":181,"content":"                                Toast.makeText("},{"type":"INSERT","lineNumber":182,"content":"                                    context,"},{"type":"INSERT","lineNumber":183,"content":"                                    error ?: \"Mission upload failed\","},{"type":"INSERT","lineNumber":184,"content":"                                    Toast.LENGTH_SHORT"},{"type":"INSERT","lineNumber":185,"content":"                                ).show()"},{"type":"INSERT","lineNumber":186,"content":"                            }"},{"type":"INSERT","lineNumber":187,"content":"                        }"},{"type":"INSERT","lineNumber":188,"content":"                    },"},{"type":"INSERT","lineNumber":189,"content":"                    enabled = waypoints.isNotEmpty(),"},{"type":"INSERT","lineNumber":190,"content":"                    modifier = Modifier"},{"type":"INSERT","lineNumber":191,"content":"                        .padding(top = 16.dp)"},{"type":"INSERT","lineNumber":192,"content":"                        .fillMaxWidth()"},{"type":"INSERT","lineNumber":193,"content":"                ) {"},{"type":"INSERT","lineNumber":194,"content":"                    Text(\"Upload Mission (${waypoints.size})\")"},{"type":"INSERT","lineNumber":195,"content":"                }"},{"type":"INSERT","lineNumber":196,"content":""},{"type":"INSERT","lineNumber":197,"content":"                // Show waypoints for user feedback"},{"type":"INSERT","lineNumber":198,"content":"                Column(modifier = Modifier.padding(16.dp)) {"},{"type":"INSERT","lineNumber":199,"content":"                    Text(\"Waypoints:\", style = MaterialTheme.typography.titleMedium)"},{"type":"INSERT","lineNumber":200,"content":"                    waypoints.forEachIndexed { idx, wp ->"},{"type":"INSERT","lineNumber":201,"content":"                        Text(\"#${idx + 1}: Lat=${wp.x / 1e7}, Lon=${wp.y / 1e7}, Alt=${wp.z}\")"},{"type":"INSERT","lineNumber":202,"content":"                    }"},{"type":"INSERT","lineNumber":203,"content":"                }"},{"type":"INSERT","lineNumber":205,"content":"        }"},{"type":"INSERT","lineNumber":206,"content":"    }"},{"type":"INSERT","lineNumber":207,"content":"}"}]},{"timestamp":1757915832887,"changes":[{"type":"DELETE","lineNumber":2,"oldContent":"import android.widget.Toast"},{"type":"MODIFY","lineNumber":7,"content":"import androidx.compose.ui.Modifier","oldContent":"import androidx.compose.runtime.collectAsState"},{"type":"DELETE","lineNumber":14,"oldContent":"import androidx.compose.material.icons.filled.*"},{"type":"DELETE","lineNumber":15,"oldContent":"<<<<<<< Updated upstream"},{"type":"DELETE","lineNumber":16,"oldContent":"import com.google.maps.android.compose.MapType"},{"type":"DELETE","lineNumber":17,"oldContent":""},{"type":"DELETE","lineNumber":18,"oldContent":"@Composable"},{"type":"DELETE","lineNumber":19,"oldContent":"======="},{"type":"DELETE","lineNumber":20,"oldContent":"            }"},{"type":"INSERT","lineNumber":15,"content":"import androidx.compose.material.icons.filled.Add"},{"type":"DELETE","lineNumber":25,"oldContent":") {"},{"type":"DELETE","lineNumber":27,"oldContent":"            modifier = Modifier"},{"type":"DELETE","lineNumber":28,"oldContent":"import androidx.compose.ui.platform.LocalContext"},{"type":"DELETE","lineNumber":29,"oldContent":"import com.google.android.gms.maps.model.LatLng"},{"type":"DELETE","lineNumber":31,"oldContent":"import com.divpundir.mavlink.api.MavEnumValue"},{"type":"DELETE","lineNumber":32,"oldContent":"import com.divpundir.mavlink.definitions.common.MavFrame"},{"type":"INSERT","lineNumber":20,"content":"@Composable"},{"type":"INSERT","lineNumber":21,"content":"fun PlanScreen("},{"type":"INSERT","lineNumber":22,"content":"    telemetryViewModel: SharedViewModel,"},{"type":"INSERT","lineNumber":23,"content":"    authViewModel: AuthViewModel,"},{"type":"INSERT","lineNumber":24,"content":"    navController: NavHostController"},{"type":"INSERT","lineNumber":25,"content":") {"},{"type":"INSERT","lineNumber":26,"content":"    val telemetryState by telemetryViewModel.telemetryState.collectAsState()"},{"type":"INSERT","lineNumber":27,"content":""},{"type":"DELETE","lineNumber":34,"oldContent":"import com.divpundir.mavlink.definitions.common.MavCmd"},{"type":"DELETE","lineNumber":36,"oldContent":"import com.example.aerogcsclone.navigation.Screen"},{"type":"DELETE","lineNumber":38,"oldContent":">>>>>>> Stashed changes"},{"type":"DELETE","lineNumber":39,"oldContent":""},{"type":"DELETE","lineNumber":41,"oldContent":"    telemetryViewModel: SharedViewModel,"},{"type":"DELETE","lineNumber":43,"oldContent":"    authViewModel: AuthViewModel,"},{"type":"DELETE","lineNumber":45,"oldContent":"    navController: NavHostController"},{"type":"DELETE","lineNumber":48,"oldContent":"    val context = LocalContext.current"},{"type":"INSERT","lineNumber":39,"content":"                        onClick = { /* TODO: Add Waypoints */ },"},{"type":"DELETE","lineNumber":54,"oldContent":"<<<<<<< Updated upstream"},{"type":"DELETE","lineNumber":55,"oldContent":"    // ✅ Map type state (same as in MainPage)"},{"type":"DELETE","lineNumber":57,"oldContent":"    var mapType by remember { mutableStateOf(MapType.NORMAL) }"},{"type":"DELETE","lineNumber":58,"oldContent":"======="},{"type":"DELETE","lineNumber":60,"oldContent":"    // Mutable list to store map points (LatLng) and mission items"},{"type":"DELETE","lineNumber":61,"oldContent":"    val points = remember { mutableStateListOf<LatLng>() }"},{"type":"DELETE","lineNumber":62,"oldContent":"    val waypoints = remember { mutableStateListOf<com.divpundir.mavlink.definitions.common.MissionItemInt>() }"},{"type":"INSERT","lineNumber":44,"content":"                        Icon(Icons.Default.Add, contentDescription = \"Add Waypoints\")"},{"type":"INSERT","lineNumber":46,"content":""},{"type":"INSERT","lineNumber":47,"content":"                    FloatingActionButton("},{"type":"INSERT","lineNumber":48,"content":"                        onClick = { /* TODO: Delete Waypoints */ },"},{"type":"DELETE","lineNumber":65,"oldContent":"    // Handler when user taps on map: add marker and corresponding mission item"},{"type":"DELETE","lineNumber":67,"oldContent":"    val onMapClick: (LatLng) -> Unit = { latLng ->"},{"type":"DELETE","lineNumber":69,"oldContent":"        points.add(latLng)"},{"type":"DELETE","lineNumber":71,"oldContent":"        // build MissionItemInt"},{"type":"DELETE","lineNumber":72,"oldContent":"        val seq = waypoints.size"},{"type":"INSERT","lineNumber":53,"content":"                        Icon(Icons.Default.Delete, contentDescription = \"Delete Waypoints\")"},{"type":"INSERT","lineNumber":54,"content":"                    }"},{"type":"INSERT","lineNumber":55,"content":""},{"type":"INSERT","lineNumber":56,"content":"                    FloatingActionButton("},{"type":"INSERT","lineNumber":57,"content":"                        onClick = { /* TODO: Clear Plan */ },"},{"type":"INSERT","lineNumber":58,"content":"                        modifier = Modifier"},{"type":"INSERT","lineNumber":59,"content":"                            .padding(bottom = 12.dp)"},{"type":"INSERT","lineNumber":60,"content":"                            .size(56.dp)"},{"type":"INSERT","lineNumber":61,"content":"                    ) {"},{"type":"DELETE","lineNumber":74,"oldContent":"        val missionItem = com.divpundir.mavlink.definitions.common.MissionItemInt("},{"type":"DELETE","lineNumber":75,"oldContent":"            targetSystem = 0u,"},{"type":"DELETE","lineNumber":76,"oldContent":"            targetComponent = 0u,"},{"type":"DELETE","lineNumber":77,"oldContent":"            seq = seq.toUShort(),"},{"type":"DELETE","lineNumber":78,"oldContent":"            frame = MavEnumValue.of(MavFrame.GLOBAL_RELATIVE_ALT_INT),"},{"type":"DELETE","lineNumber":79,"oldContent":"            command = MavEnumValue.of(MavCmd.NAV_WAYPOINT),"},{"type":"DELETE","lineNumber":80,"oldContent":"            current = 0u,"},{"type":"DELETE","lineNumber":81,"oldContent":"            autocontinue = 1u,"},{"type":"DELETE","lineNumber":83,"oldContent":"            param1 = 0f,"},{"type":"DELETE","lineNumber":84,"oldContent":"                        onClick = { telemetryViewModel.arm() },"},{"type":"DELETE","lineNumber":85,"oldContent":"            param2 = 0f,"},{"type":"INSERT","lineNumber":64,"content":"                }"},{"type":"INSERT","lineNumber":65,"content":""},{"type":"DELETE","lineNumber":87,"oldContent":"            param3 = 0f,"},{"type":"DELETE","lineNumber":89,"oldContent":"            param4 = 0f,"},{"type":"DELETE","lineNumber":91,"oldContent":"            x = (latLng.latitude * 1e7).toInt(),"},{"type":"DELETE","lineNumber":93,"oldContent":"            y = (latLng.longitude * 1e7).toInt(),"},{"type":"DELETE","lineNumber":94,"oldContent":""},{"type":"DELETE","lineNumber":95,"oldContent":"            z = 10f"},{"type":"DELETE","lineNumber":96,"oldContent":"            }"},{"type":"DELETE","lineNumber":97,"oldContent":"        )"},{"type":"INSERT","lineNumber":70,"content":"                ) {"},{"type":"INSERT","lineNumber":71,"content":"                    Icon(Icons.Default.Menu, contentDescription = \"Create Plan\")"},{"type":"DELETE","lineNumber":99,"oldContent":"        waypoints.add(missionItem)"},{"type":"DELETE","lineNumber":100,"oldContent":"    }"},{"type":"DELETE","lineNumber":102,"oldContent":">>>>>>> Stashed changes"},{"type":"DELETE","lineNumber":103,"oldContent":""},{"type":"DELETE","lineNumber":107,"oldContent":"}"},{"type":"DELETE","lineNumber":108,"oldContent":"                    waypoints.forEachIndexed { idx, wp ->"},{"type":"DELETE","lineNumber":109,"oldContent":"                        onClick = {"},{"type":"DELETE","lineNumber":110,"oldContent":"                GcsMap(telemetryState = telemetryState, mapType = mapType)"},{"type":"DELETE","lineNumber":111,"oldContent":"                            if (waypoints.isNotEmpty()) {"},{"type":"DELETE","lineNumber":112,"oldContent":"                                waypoints.removeAt(waypoints.lastIndex)"},{"type":"DELETE","lineNumber":113,"oldContent":""},{"type":"DELETE","lineNumber":114,"oldContent":"                                points.removeAt(points.lastIndex)"},{"type":"DELETE","lineNumber":115,"oldContent":"                            }"},{"type":"DELETE","lineNumber":116,"oldContent":"                        },"},{"type":"DELETE","lineNumber":117,"oldContent":"                        .padding(start = 16.dp, top = 72.dp), // push below TopNavBar"},{"type":"DELETE","lineNumber":118,"oldContent":"                    // ✅ Map toggle button ABOVE Arm button"},{"type":"DELETE","lineNumber":119,"oldContent":"                    FloatingActionButton("},{"type":"DELETE","lineNumber":120,"oldContent":"                        Icon(Icons.Default.Delete, contentDescription = \"Delete Waypoints\")"},{"type":"DELETE","lineNumber":121,"oldContent":"                        onClick = {"},{"type":"DELETE","lineNumber":122,"oldContent":""},{"type":"DELETE","lineNumber":123,"oldContent":"                    FloatingActionButton("},{"type":"DELETE","lineNumber":124,"oldContent":"                            mapType = if (mapType == MapType.NORMAL) MapType.SATELLITE else MapType.NORMAL"},{"type":"DELETE","lineNumber":125,"oldContent":"                        onClick = { waypoints.clear(); points.clear() },"},{"type":"DELETE","lineNumber":126,"oldContent":"                        },"},{"type":"DELETE","lineNumber":127,"oldContent":"                        modifier = Modifier.size(56.dp)"},{"type":"DELETE","lineNumber":128,"oldContent":"                    ) {"},{"type":"DELETE","lineNumber":129,"oldContent":"                        Icon(Icons.Default.Map, contentDescription = \"Toggle Map Type\")"},{"type":"DELETE","lineNumber":130,"oldContent":""},{"type":"DELETE","lineNumber":131,"oldContent":"                    }"},{"type":"DELETE","lineNumber":132,"oldContent":""},{"type":"DELETE","lineNumber":133,"oldContent":"                    FloatingActionButton("},{"type":"DELETE","lineNumber":134,"oldContent":"                        Icon(Icons.Default.FlightTakeoff, contentDescription = \"Arm\")"},{"type":"DELETE","lineNumber":135,"oldContent":"                    }"},{"type":"DELETE","lineNumber":136,"oldContent":""},{"type":"DELETE","lineNumber":137,"oldContent":"                        modifier = Modifier.size(56.dp)"},{"type":"DELETE","lineNumber":138,"oldContent":"                        .padding(top = 16.dp)"},{"type":"DELETE","lineNumber":139,"oldContent":"                        Icon(Icons.Default.Build, contentDescription = \"Change Mode\")"},{"type":"DELETE","lineNumber":140,"oldContent":"                    }"},{"type":"INSERT","lineNumber":77,"content":"            modifier = Modifier"},{"type":"INSERT","lineNumber":78,"content":"                .fillMaxSize()"},{"type":"DELETE","lineNumber":142,"oldContent":"                }"},{"type":"DELETE","lineNumber":145,"oldContent":""},{"type":"DELETE","lineNumber":149,"oldContent":"            }"},{"type":"DELETE","lineNumber":151,"oldContent":"}"},{"type":"DELETE","lineNumber":153,"oldContent":"    }"},{"type":"DELETE","lineNumber":155,"oldContent":"        }"},{"type":"DELETE","lineNumber":157,"oldContent":"                }"},{"type":"DELETE","lineNumber":158,"oldContent":"<<<<<<< Updated upstream"},{"type":"DELETE","lineNumber":159,"oldContent":"                    }"},{"type":"DELETE","lineNumber":160,"oldContent":"                // ✅ Pass selected mapType to GcsMap"},{"type":"DELETE","lineNumber":161,"oldContent":"                        Text(\"#${idx + 1}: Lat=${wp.x / 1e7}, Lon=${wp.y / 1e7}, Alt=${wp.z}\")"},{"type":"DELETE","lineNumber":162,"oldContent":"                    waypoints.forEachIndexed { idx, wp ->"},{"type":"DELETE","lineNumber":163,"oldContent":"======="},{"type":"DELETE","lineNumber":164,"oldContent":"                    Text(\"Waypoints:\", style = MaterialTheme.typography.titleMedium)"},{"type":"DELETE","lineNumber":165,"oldContent":"                // Map background - pass points and onMapClick callback"},{"type":"DELETE","lineNumber":166,"oldContent":"                Column(modifier = Modifier.padding(16.dp)) {"},{"type":"DELETE","lineNumber":167,"oldContent":"                GcsMap(telemetryState = telemetryState, points = points, onMapClick = onMapClick)"},{"type":"DELETE","lineNumber":168,"oldContent":"                // Show waypoints for user feedback"},{"type":"DELETE","lineNumber":169,"oldContent":">>>>>>> Stashed changes"},{"type":"INSERT","lineNumber":89,"content":"                // Map background"},{"type":"INSERT","lineNumber":90,"content":"                GcsMap(telemetryState = telemetryState)"},{"type":"DELETE","lineNumber":171,"oldContent":"                }"},{"type":"DELETE","lineNumber":173,"oldContent":"                    Text(\"Upload Mission (${waypoints.size})\")"},{"type":"DELETE","lineNumber":175,"oldContent":"                ) {"},{"type":"DELETE","lineNumber":177,"oldContent":"                        .fillMaxWidth()"},{"type":"DELETE","lineNumber":179,"oldContent":"                        .padding(top = 16.dp)"},{"type":"DELETE","lineNumber":180,"oldContent":"                    modifier = Modifier"},{"type":"INSERT","lineNumber":96,"content":"                        .padding(start = 16.dp, top = 72.dp), // push below TopNavBar"},{"type":"DELETE","lineNumber":182,"oldContent":"                    enabled = waypoints.isNotEmpty(),"},{"type":"DELETE","lineNumber":184,"oldContent":"                    },"},{"type":"DELETE","lineNumber":185,"oldContent":"                        }"},{"type":"DELETE","lineNumber":186,"oldContent":"                            }"},{"type":"DELETE","lineNumber":187,"oldContent":"                                ).show()"},{"type":"DELETE","lineNumber":188,"oldContent":"                                    Toast.LENGTH_SHORT"},{"type":"DELETE","lineNumber":189,"oldContent":"                                    error ?: \"Mission upload failed\","},{"type":"DELETE","lineNumber":190,"oldContent":"                                    context,"},{"type":"DELETE","lineNumber":191,"oldContent":"                                Toast.makeText("},{"type":"DELETE","lineNumber":192,"oldContent":"                            } else {"},{"type":"DELETE","lineNumber":193,"oldContent":"                                }"},{"type":"DELETE","lineNumber":194,"oldContent":"                                    popUpTo(Screen.Plan.route) { inclusive = true }"},{"type":"DELETE","lineNumber":195,"oldContent":"                                navController.navigate(Screen.Main.route) {"},{"type":"INSERT","lineNumber":99,"content":"                    FloatingActionButton("},{"type":"DELETE","lineNumber":197,"oldContent":"                                    .show()"},{"type":"DELETE","lineNumber":199,"oldContent":"                                Toast.makeText(context, \"Mission uploaded\", Toast.LENGTH_SHORT)"},{"type":"DELETE","lineNumber":201,"oldContent":"                            if (success) {"},{"type":"DELETE","lineNumber":202,"oldContent":"                        telemetryViewModel.uploadMission(waypoints) { success, error ->"},{"type":"DELETE","lineNumber":203,"oldContent":"                    onClick = {"},{"type":"DELETE","lineNumber":204,"oldContent":"                Button("},{"type":"INSERT","lineNumber":103,"content":"                        Icon(Icons.Default.FlightTakeoff, contentDescription = \"Arm\")"},{"type":"INSERT","lineNumber":104,"content":"                    }"},{"type":"INSERT","lineNumber":105,"content":""},{"type":"DELETE","lineNumber":206,"oldContent":"                // Upload Mission button"},{"type":"INSERT","lineNumber":108,"content":"                        modifier = Modifier.size(56.dp)"},{"type":"INSERT","lineNumber":109,"content":"                    ) {"},{"type":"INSERT","lineNumber":110,"content":"                        Icon(Icons.Default.Build, contentDescription = \"Change Mode\")"},{"type":"INSERT","lineNumber":111,"content":"                    }"},{"type":"INSERT","lineNumber":112,"content":"                }"},{"type":"INSERT","lineNumber":113,"content":"            }"},{"type":"INSERT","lineNumber":114,"content":"        }"},{"type":"INSERT","lineNumber":115,"content":"    }"},{"type":"INSERT","lineNumber":116,"content":"}"},{"type":"INSERT","lineNumber":117,"content":""}]}]},"C:/Users/Hrushikesh/AndroidStudioProjects/SampleGCS/app/src/main/java/com/example/aerogcsclone/Telemetry/TelemetryRepository.kt":{"filePath":"C:/Users/Hrushikesh/AndroidStudioProjects/SampleGCS/app/src/main/java/com/example/aerogcsclone/Telemetry/TelemetryRepository.kt","baseContent":"package com.example.aerogcsclone.Telemetry\n\nimport android.util.Log\nimport com.divpundir.mavlink.adapters.coroutines.asCoroutine\nimport com.divpundir.mavlink.adapters.coroutines.tryConnect\nimport com.divpundir.mavlink.adapters.coroutines.trySendUnsignedV2\nimport com.divpundir.mavlink.api.wrap\nimport com.divpundir.mavlink.connection.StreamState\nimport com.divpundir.mavlink.connection.tcp.TcpClientMavConnection\nimport com.divpundir.mavlink.definitions.common.*\nimport com.divpundir.mavlink.definitions.minimal.*\nimport com.google.android.gms.maps.model.LatLng\nimport kotlinx.coroutines.delay\nimport kotlinx.coroutines.flow.*\nimport kotlinx.coroutines.isActive\nimport kotlinx.coroutines.launch\n\nclass MavlinkTelemetryRepository(\n    private val host: String,\n    private val port: Int\n) {\n    private var mission by mutableStateOf<List<LatLng>>(emptyList())\n    private val gcsSystemId: UByte = 200u\n    private val gcsComponentId: UByte = 1u\n    private val _state = MutableStateFlow(TelemetryState())\n    val state: StateFlow<TelemetryState> = _state.asStateFlow()\n\n    private var fcuSystemId: UByte = 0u\n    private var fcuComponentId: UByte = 0u\n\n    // Diagnostic info\n    private val _lastFailure = MutableStateFlow<Throwable?>(null)\n    val lastFailure: StateFlow<Throwable?> = _lastFailure.asStateFlow()\n\n    // Connection\n    private val connection = TcpClientMavConnection(host, port, CommonDialect).asCoroutine()\n\n    fun start() {\n        val scope = AppScope\n\n        suspend fun reconnect(scope: kotlinx.coroutines.CoroutineScope) {\n            while (scope.isActive) {\n                try {\n                    if (connection.tryConnect(scope)) {\n                        return // Exit on successful connection\n                    }\n                } catch (e: Exception) {\n                    Log.e(\"MavlinkRepo\", \"Connection attempt failed\", e)\n                    _lastFailure.value = e\n                }\n                delay(1000)\n            }\n        }\n\n        // Manage connection state + reconnects\n        scope.launch {\n            reconnect(this) // Initial connection attempt\n            connection.streamState.collect { st ->\n                when (st) {\n                    is StreamState.Active -> {\n                        if (!state.value.connected) {\n                            Log.i(\"MavlinkRepo\", \"Connection Active\")\n                            _state.update { it.copy(connected = true) }\n                        }\n                    }\n                    is StreamState.Inactive -> {\n                        if (state.value.connected) {\n                            Log.i(\"MavlinkRepo\", \"Connection Inactive, reconnecting...\")\n                            _state.update { it.copy(connected = false, fcuDetected = false) }\n                            reconnect(this)\n                        }\n                    }\n                }\n            }\n        }\n\n        // Send GCS heartbeat\n        scope.launch {\n            val heartbeat = Heartbeat(\n                type = MavType.GCS.wrap(),\n                autopilot = MavAutopilot.INVALID.wrap(),\n                baseMode = emptyList<MavModeFlag>().wrap(),\n                customMode = 0u,\n                mavlinkVersion = 3u\n            )\n            while (isActive) {\n                if (state.value.connected) {\n                    try {\n                        connection.trySendUnsignedV2(gcsSystemId, gcsComponentId, heartbeat)\n                    } catch (e: Exception) {\n                        Log.e(\"MavlinkRepo\", \"Failed to send heartbeat\", e)\n                        _lastFailure.value = e\n                    }\n                }\n                delay(1000)\n            }\n        }\n\n        // Shared message stream\n        val mavFrameStream = connection.mavFrame\n            .shareIn(scope, SharingStarted.Eagerly, replay = 0)\n\n        // Log raw messages\n        scope.launch {\n            mavFrameStream.collect {\n                Log.d(\"MavlinkRepo\", \"Frame: ${it.message.javaClass.simpleName} (sysId=${it.systemId}, compId=${it.componentId})\")\n            }\n        }\n\n        // Detect FCU\n        scope.launch {\n            mavFrameStream\n                .filter { it.message is Heartbeat && (it.message as Heartbeat).type != MavType.GCS.wrap() }\n                .collect {\n                    if (!state.value.fcuDetected) {\n                        fcuSystemId = it.systemId\n                        fcuComponentId = it.componentId\n                        Log.i(\"MavlinkRepo\", \"FCU detected sysId=$fcuSystemId compId=$fcuComponentId\")\n                        _state.update { it.copy(fcuDetected = true) }\n\n                        // Set message intervals\n                        launch {\n                            suspend fun setMessageRate(messageId: UInt, hz: Float) {\n                                val intervalUsec = if (hz <= 0f) 0f else (1_000_000f / hz)\n                                val cmd = CommandLong(\n                                    targetSystem = fcuSystemId,\n                                    targetComponent = fcuComponentId,\n                                    command = MavCmd.SET_MESSAGE_INTERVAL.wrap(),\n                                    confirmation = 0u,\n                                    param1 = messageId.toFloat(),\n                                    param2 = intervalUsec,\n                                    param3 = 0f,\n                                    param4 = 0f,\n                                    param5 = 0f,\n                                    param6 = 0f,\n                                    param7 = 0f\n                                )\n                                try {\n                                    connection.trySendUnsignedV2(gcsSystemId, gcsComponentId, cmd)\n                                } catch (e: Exception) {\n                                    Log.e(\"MavlinkRepo\", \"Failed to send SET_MESSAGE_INTERVAL\", e)\n                                    _lastFailure.value = e\n                                }\n                            }\n\n                            setMessageRate(1u, 1f)   // SYS_STATUS\n                            setMessageRate(24u, 1f)  // GPS_RAW_INT\n                            setMessageRate(33u, 5f)  // GLOBAL_POSITION_INT\n                            setMessageRate(74u, 5f)  // VFR_HUD\n                            setMessageRate(147u, 1f) // BATTERY_STATUS\n                        }\n                    }\n                }\n        }\n\n        // Collectors\n\n        // VFR_HUD\n        scope.launch {\n            mavFrameStream\n                .filter { state.value.fcuDetected && it.systemId == fcuSystemId }\n                .map { it.message }\n                .filterIsInstance<VfrHud>()\n                .collect { hud ->\n                    _state.update {\n                        it.copy(\n                            altitudeMsl = hud.alt,\n                            airspeed = hud.airspeed.takeIf { v -> v > 0f },\n                            groundspeed = hud.groundspeed.takeIf { v -> v > 0f }\n                        )\n                    }\n                }\n        }\n\n        // GLOBAL_POSITION_INT\n        scope.launch {\n            mavFrameStream\n                .filter { state.value.fcuDetected && it.systemId == fcuSystemId }\n                .map { it.message }\n                .filterIsInstance<GlobalPositionInt>()\n                .collect { gp ->\n                    val altAMSLm = gp.alt / 1000f\n                    val relAltM = gp.relativeAlt / 1000f\n                    val lat = gp.lat.takeIf { it != Int.MIN_VALUE }?.let { it / 10_000_000.0 }\n                    val lon = gp.lon.takeIf { it != Int.MIN_VALUE }?.let { it / 10_000_000.0 }\n                    _state.update {\n                        it.copy(\n                            altitudeMsl = altAMSLm,\n                            altitudeRelative = relAltM,\n                            latitude = lat,\n                            longitude = lon\n                        )\n                    }\n                }\n        }\n\n        // BATTERY_STATUS\n        scope.launch {\n            mavFrameStream\n                .filter { state.value.fcuDetected && it.systemId == fcuSystemId }\n                .map { it.message }\n                .filterIsInstance<BatteryStatus>()\n                .collect { b ->\n                    val currentA = if (b.currentBattery.toInt() == -1) null else b.currentBattery / 100f\n                    _state.update { it.copy(currentA = currentA) }\n                }\n        }\n        //HEARTBEAT for mode, armed, armable\n        scope.launch {\n            mavFrameStream\n                .filter{ frame-> state.value.fcuDetected && frame.systemId == fcuSystemId }\n                .map{frame -> frame.message}\n                .filterIsInstance<Heartbeat>()\n                .collect{ hb->\n                    val armed = (hb.baseMode.value and MavModeFlag.SAFETY_ARMED.value )!= 0u\n                    val mode = when (hb.customMode) {\n                        0u -> \"Stabilize\"\n                        1u -> \"Acro\"\n                        2u -> \"Alt Hold\"\n                        3u -> \"Auto\"\n                        4u -> \"Guided\"\n                        5u -> \"Loiter\"\n                        6u -> \"RTL\"\n                        7u -> \"Circle\"\n                        9u -> \"Land\"\n                        11u -> \"Drift\"\n                        13u -> \"Sport\"\n                        14u -> \"Flip\"\n                        15u -> \"AutoTune\"\n                        16u -> \"Pos Hold\"\n                        17u -> \"Brake\"\n                        18u -> \"Throw\"\n                        19u -> \"Avoid_ADSB\"\n                        20u -> \"Guided_NoGPS\"\n                        21u -> \"Smart_RTL\"\n                        22u -> \"FlowHold\"\n                        23u -> \"Follow\"\n                        24u -> \"ZigZag\"\n                        25u -> \"SystemID\"\n                        26u -> \"AutoRotate\"\n                        27u -> \"Auto_RTL\"\n                        else -> \"Unknown\"\n                    }\n                    _state.update { it.copy(armed=armed , mode = mode)}\n                }\n        }\n        // SYS_STATUS\n        scope.launch {\n            mavFrameStream\n                .filter { state.value.fcuDetected && it.systemId == fcuSystemId }\n                .map { it.message }\n                .filterIsInstance<SysStatus>()\n                .collect { s ->\n                    val vBatt = if (s.voltageBattery.toUInt() == 0xFFFFu) null else s.voltageBattery.toFloat() / 1000f\n                    val pct = if (s.batteryRemaining.toInt() == -1) null else s.batteryRemaining.toInt()\n                    val SENSOR_3D_GYRO = 1u\n                    val present = (s.onboardControlSensorsPresent.value and SENSOR_3D_GYRO) != 0u\n                    val enabled = (s.onboardControlSensorsEnabled.value and SENSOR_3D_GYRO) != 0u\n                    val healthy = (s.onboardControlSensorsHealth.value and SENSOR_3D_GYRO) != 0u\n                    val armable = present && enabled && healthy\n                    _state.update { it.copy(voltage = vBatt, batteryPercent = pct , armable = armable) }\n                }\n        }\n\n        // GPS_RAW_INT\n        scope.launch {\n            mavFrameStream\n                .filter { state.value.fcuDetected && it.systemId == fcuSystemId }\n                .map { it.message }\n                .filterIsInstance<GpsRawInt>()\n                .collect { gps ->\n                    val sats = gps.satellitesVisible.toInt().takeIf { it >= 0 }\n                    val hdop = if (gps.eph.toUInt() == 0xFFFFu) null else gps.eph.toFloat() / 100f\n                    _state.update { it.copy(sats = sats, hdop = hdop) }\n                }\n        }\n\n        // Mission handling\n        scope.launch {\n            mavFrameStream\n                .filter { state.value.fcuDetected && it.systemId == fcuSystemId }\n                .map { it.message }\n                .collect { message ->\n                    when (message) {\n                        is MissionRequest -> {\n                            val seq = message.seq.toInt()\n                            if (seq < mission.size) {\n                                val waypoint = mission[seq]\n                                val missionItem = MissionItemInt(\n                                    targetSystem = fcuSystemId,\n                                    targetComponent = fcuComponentId,\n                                    seq = seq.toUShort(),\n                                    frame = MavFrame.GLOBAL_RELATIVE_ALT.wrap(),\n                                    command = MavCmd.NAV_WAYPOINT.wrap(),\n                                    current = if (seq == 0) 1u else 0u,\n                                    autocontinue = 1u,\n                                    param1 = 0f,\n                                    param2 = 0f,\n                                    param3 = 0f,\n                                    param4 = 0f,\n                                    x = (waypoint.latitude * 1e7).toInt(),\n                                    y = (waypoint.longitude * 1e7).toInt(),\n                                    z = 100f, // Default altitude\n                                    missionType = MavMissionType.MISSION.wrap()\n                                )\n                                try {\n                                    connection.trySendUnsignedV2(gcsSystemId, gcsComponentId, missionItem)\n                                } catch (e: Exception) {\n                                    Log.e(\"MavlinkRepo\", \"Failed to send mission item\", e)\n                                    _lastFailure.value = e\n                                }\n                            }\n                        }\n                        is MissionAck -> {\n                            Log.i(\"MavlinkRepo\", \"Mission upload acknowledged with result: ${message.type.value}\")\n                            if (message.type == MavMissionResult.MAV_MISSION_ACCEPTED.wrap()) {\n                                _state.update { it.copy(missionLoaded = true) }\n                            }\n                        }\n                    }\n                }\n        }\n    }\n\n    suspend fun sendCommand(command: MavCmd, param1: Float = 0f, param2: Float = 0f, param3: Float = 0f, param4: Float = 0f, param5: Float = 0f, param6: Float = 0f, param7: Float = 0f) {\n        val commandLong = CommandLong(\n            targetSystem = fcuSystemId,\n            targetComponent = fcuComponentId,\n            command = command.wrap(),\n            confirmation = 0u,\n            param1 = param1,\n            param2 = param2,\n            param3 = param3,\n            param4 = param4,\n            param5 = param5,\n            param6 = param6,\n            param7 = param7\n        )\n        try {\n            connection.trySendUnsignedV2(\n               gcsSystemId,\n                gcsComponentId, commandLong)\n        } catch (e: Exception) {\n            Log.e(\"MavlinkRepo\", \"Failed to send command\", e)\n            _lastFailure.value = e\n        }\n    }\n\n    suspend fun arm() {\n        if (state.value.armable) {\n            sendCommand(\n                MavCmd.COMPONENT_ARM_DISARM,\n                1f\n            )\n        } else {\n            Log.w(\"MavlinkRepo\", \"Arm command rejected, vehicle not armable\")\n        }\n    }\n\n    suspend fun disarm() {\n        sendCommand(\n            MavCmd.COMPONENT_ARM_DISARM,\n            0f\n        )\n    }\n\n    suspend fun changeMode(mode: MavMode) {\n        sendCommand(\n            MavCmd.DO_SET_MODE,\n            mode.value.toFloat(),\n            0f\n        )\n    }\n\n    suspend fun takeoff(altitude: Float) {\n        sendCommand(\n            MavCmd.NAV_TAKEOFF,\n            -1f,\n            0f,\n            0f,\n            0f,\n            0f,\n            0f,\n            altitude\n        )\n    }\n\n    suspend fun land() {\n        sendCommand(MavCmd.NAV_LAND)\n    }\n\n    suspend fun loadMission(waypoints: List<LatLng>) {\n        mission = waypoints\n        val missionCount = MissionCount(\n            targetSystem = fcuSystemId,\n            targetComponent = fcuComponentId,\n            count = mission.size.toUShort(),\n            missionType = MavMissionType.MISSION.wrap()\n        )\n        try {\n            connection.trySendUnsignedV2(gcsSystemId, gcsComponentId, missionCount)\n        } catch (e: Exception) {\n            Log.e(\"MavlinkRepo\", \"Failed to send mission count\", e)\n            _lastFailure.value = e\n        }\n    }\n\n    suspend fun startMission() {\n        sendCommand(MavCmd.MISSION_START)\n    }\n}\n","baseTimestamp":1757909141732,"deltas":[{"timestamp":1757929560692,"changes":[{"type":"INSERT","lineNumber":355,"content":"    @Suppress(\"DEPRECATION\")"},{"type":"INSERT","lineNumber":367,"content":"            // Send MissionCount"},{"type":"DELETE","lineNumber":367,"oldContent":"            val missionCount = MissionCount("},{"type":"DELETE","lineNumber":426,"oldContent":"                            // Note: MissionRequest (float) is deprecated in modern MAVLink usage."},{"type":"DELETE","lineNumber":427,"oldContent":"                            // We intentionally avoid relying on MissionRequest (float) here to prevent"},{"type":"DELETE","lineNumber":428,"oldContent":"                            // compatibility issues. If the vehicle sends a float MissionRequest, we"},{"type":"DELETE","lineNumber":429,"oldContent":"                            // will log a warning and rely on the fallback path (or MissionRequestInt)"},{"type":"DELETE","lineNumber":430,"oldContent":"                            // to provide items. This removes direct use of the deprecated type."},{"type":"DELETE","lineNumber":431,"oldContent":"                                // ignore other messages here; mission read/write handled above"},{"type":"DELETE","lineNumber":432,"oldContent":"                                // ignore other messages here; mission read/write handled above"},{"type":"INSERT","lineNumber":427,"content":"                            is MissionRequest -> {"},{"type":"INSERT","lineNumber":428,"content":"                                // Vehicle requested the float MissionRequest message (deprecated in some dialects)"},{"type":"INSERT","lineNumber":429,"content":"                                // Respond with MISSION_ITEM_INT (not float) for compatibility with Mission Planner"},{"type":"INSERT","lineNumber":430,"content":"                                Log.d(\"MavlinkRepo\", \"Received MissionRequest (float) from sys=$senderSys comp=$senderComp seq=${msg.seq}\")"},{"type":"INSERT","lineNumber":431,"content":"                                firstRequestReceived = true"},{"type":"INSERT","lineNumber":432,"content":"                                val seq = msg.seq.toInt()"},{"type":"INSERT","lineNumber":433,"content":"                                if (seq < 0 || seq >= missionItems.size) {"},{"type":"INSERT","lineNumber":434,"content":"                                    Log.w(\"MavlinkRepo\", \"FC requested invalid seq=$seq (MissionRequest)\")"},{"type":"INSERT","lineNumber":435,"content":"                                    return@collect"},{"type":"INSERT","lineNumber":436,"content":"                                }"},{"type":"INSERT","lineNumber":437,"content":"                                if (sentSeqs.contains(seq)) {"},{"type":"INSERT","lineNumber":438,"content":"                                    Log.i(\"MavlinkRepo\", \"Already sent seq=$seq, ignoring\")"},{"type":"INSERT","lineNumber":439,"content":"                                    return@collect"},{"type":"INSERT","lineNumber":440,"content":"                                }"},{"type":"INSERT","lineNumber":441,"content":"                                val itemInt = missionItems[seq]"},{"type":"INSERT","lineNumber":442,"content":"                                val missionItemInt = itemInt.copy("},{"type":"INSERT","lineNumber":443,"content":"                                    targetSystem = senderSys.toUByte(),"},{"type":"INSERT","lineNumber":444,"content":"                                    targetComponent = senderComp.toUByte(),"},{"type":"INSERT","lineNumber":445,"content":"                                    seq = seq.toUShort()"},{"type":"INSERT","lineNumber":446,"content":"                                )"},{"type":"INSERT","lineNumber":447,"content":"                                try {"},{"type":"INSERT","lineNumber":448,"content":"                                    connection.trySendUnsignedV2(gcsSystemId, gcsComponentId, missionItemInt)"},{"type":"INSERT","lineNumber":449,"content":"                                    sentSeqs.add(seq)"},{"type":"INSERT","lineNumber":450,"content":"                                    Log.i(\"MavlinkRepo\", \"Sent MISSION_ITEM_INT seq=$seq to sys=$senderSys comp=$senderComp (responding to MissionRequest)\")"},{"type":"INSERT","lineNumber":451,"content":"                                } catch (e: Exception) {"},{"type":"INSERT","lineNumber":452,"content":"                                    Log.e(\"MavlinkRepo\", \"Failed to send mission item(seq=$seq) as MissionItemInt\", e)"},{"type":"INSERT","lineNumber":453,"content":"                                }"},{"type":"INSERT","lineNumber":455,"content":"                            is MissionAck -> {"},{"type":"INSERT","lineNumber":456,"content":"                                Log.i(\"MavlinkRepo\", \"Received MISSION_ACK from sys=$senderSys comp=$senderComp: ${msg.type}\")"},{"type":"INSERT","lineNumber":457,"content":"                                if (!ackDeferred.isCompleted) ackDeferred.complete(true)"},{"type":"INSERT","lineNumber":458,"content":"                                return@collect"},{"type":"INSERT","lineNumber":459,"content":"                            }"},{"type":"INSERT","lineNumber":460,"content":"                            else -> {"},{"type":"INSERT","lineNumber":461,"content":"                                // ignore other messages"},{"type":"INSERT","lineNumber":462,"content":"                            }"},{"type":"DELETE","lineNumber":476,"oldContent":"    // New helper: request mission from FCU and log items for debugging"},{"type":"DELETE","lineNumber":478,"oldContent":"    @Suppress(\"DEPRECATION\")"},{"type":"DELETE","lineNumber":480,"oldContent":"    suspend fun requestMissionAndLog(timeoutMs: Long = 5000) {"},{"type":"DELETE","lineNumber":482,"oldContent":"        if (!state.value.fcuDetected) {"},{"type":"DELETE","lineNumber":484,"oldContent":"            Log.w(\"MavlinkRepo\", \"FCU not detected; cannot request mission\")"},{"type":"DELETE","lineNumber":486,"oldContent":"            return"},{"type":"DELETE","lineNumber":488,"oldContent":"        }"},{"type":"DELETE","lineNumber":490,"oldContent":"        try {"},{"type":"DELETE","lineNumber":492,"oldContent":"            val received = mutableListOf<Pair<Int, String>>()"},{"type":"DELETE","lineNumber":494,"oldContent":"            val expectedCountDeferred = CompletableDeferred<Int?>()"},{"type":"DELETE","lineNumber":496,"oldContent":""},{"type":"DELETE","lineNumber":498,"oldContent":"            // collector"},{"type":"DELETE","lineNumber":500,"oldContent":"            val job = AppScope.launch {"},{"type":"DELETE","lineNumber":502,"oldContent":"                connection.mavFrame.collect { frame ->"},{"type":"INSERT","lineNumber":519,"content":"    // New helper: request mission from FCU and log items for debugging"},{"type":"INSERT","lineNumber":520,"content":"    @Suppress(\"DEPRECATION\")"},{"type":"INSERT","lineNumber":521,"content":"    suspend fun requestMissionAndLog(timeoutMs: Long = 5000) {"},{"type":"INSERT","lineNumber":522,"content":"        if (!state.value.fcuDetected) {"},{"type":"INSERT","lineNumber":523,"content":"            Log.w(\"MavlinkRepo\", \"FCU not detected; cannot request mission\")"},{"type":"INSERT","lineNumber":524,"content":"            return"},{"type":"INSERT","lineNumber":525,"content":"        }"},{"type":"INSERT","lineNumber":526,"content":"        try {"},{"type":"INSERT","lineNumber":527,"content":"            val received = mutableListOf<Pair<Int, String>>()"},{"type":"INSERT","lineNumber":528,"content":"            val expectedCountDeferred = CompletableDeferred<Int?>()"},{"type":"INSERT","lineNumber":529,"content":""},{"type":"INSERT","lineNumber":530,"content":"            // collector"},{"type":"INSERT","lineNumber":531,"content":"            val job = AppScope.launch {"},{"type":"INSERT","lineNumber":532,"content":"                connection.mavFrame.collect { frame ->"},{"type":"DELETE","lineNumber":516,"oldContent":"                            Log.i(\"MavlinkRepo\", \"Readback: MISSION_ITEM seq=${msg.seq} x=${msg.x} y=${msg.y} z=${msg.z}\")"},{"type":"INSERT","lineNumber":546,"content":"                            Log.i(\"MavlinkRepo\", \"Readback: MISSION_ITEM seq=${msg.seq} x=${msg.x} y=${msg.y} z=${msg.z}\")"},{"type":"DELETE","lineNumber":548,"oldContent":"    suspend fun startMission(first: Int, last: Int): Boolean {"},{"type":"INSERT","lineNumber":582,"content":"    suspend fun startMission(first: Int, last: Int): Boolean {"},{"type":"DELETE","lineNumber":557,"oldContent":"            Log.e(\"MavlinkRepo\", \"Failed to send MISSION_START\", e)"},{"type":"DELETE","lineNumber":559,"oldContent":"            _lastFailure.value = e"},{"type":"DELETE","lineNumber":560,"oldContent":"            return false"},{"type":"DELETE","lineNumber":562,"oldContent":""},{"type":"DELETE","lineNumber":563,"oldContent":"        // Wait for COMMAND_ACK for MISSION_START"},{"type":"DELETE","lineNumber":564,"oldContent":"        val ackDeferred = CompletableDeferred<Boolean>()"},{"type":"INSERT","lineNumber":591,"content":"            Log.e(\"MavlinkRepo\", \"Failed to send MISSION_START\", e)"},{"type":"INSERT","lineNumber":592,"content":"            _lastFailure.value = e"},{"type":"INSERT","lineNumber":593,"content":"            return false"},{"type":"INSERT","lineNumber":595,"content":""},{"type":"INSERT","lineNumber":596,"content":"        // Wait for COMMAND_ACK for MISSION_START"},{"type":"INSERT","lineNumber":597,"content":"        val ackDeferred = CompletableDeferred<Boolean>()"},{"type":"DELETE","lineNumber":572,"oldContent":""},{"type":"DELETE","lineNumber":574,"oldContent":"        val ack = withTimeoutOrNull(3000L) {"},{"type":"DELETE","lineNumber":576,"oldContent":"            ackDeferred.await()"},{"type":"DELETE","lineNumber":578,"oldContent":"        } ?: false"},{"type":"DELETE","lineNumber":580,"oldContent":""},{"type":"DELETE","lineNumber":582,"oldContent":"        job.cancel()"},{"type":"DELETE","lineNumber":584,"oldContent":""},{"type":"DELETE","lineNumber":586,"oldContent":"        if (ack) {"},{"type":"DELETE","lineNumber":588,"oldContent":"            Log.i(\"MavlinkRepo\", \"Mission start acknowledged by FCU\")"},{"type":"DELETE","lineNumber":590,"oldContent":"        } else {"},{"type":"DELETE","lineNumber":592,"oldContent":"            Log.e(\"MavlinkRepo\", \"Mission start not acknowledged (timeout or NACK)\")"},{"type":"DELETE","lineNumber":594,"oldContent":"        }"},{"type":"DELETE","lineNumber":596,"oldContent":"        return ack"},{"type":"DELETE","lineNumber":598,"oldContent":"    }"},{"type":"INSERT","lineNumber":615,"content":""},{"type":"INSERT","lineNumber":616,"content":"        val ack = withTimeoutOrNull(3000L) {"},{"type":"INSERT","lineNumber":617,"content":"            ackDeferred.await()"},{"type":"INSERT","lineNumber":618,"content":"        } ?: false"},{"type":"INSERT","lineNumber":619,"content":""},{"type":"INSERT","lineNumber":620,"content":"        job.cancel()"},{"type":"INSERT","lineNumber":621,"content":""},{"type":"INSERT","lineNumber":622,"content":"        if (ack) {"},{"type":"INSERT","lineNumber":623,"content":"            Log.i(\"MavlinkRepo\", \"Mission start acknowledged by FCU\")"},{"type":"INSERT","lineNumber":624,"content":"        } else {"},{"type":"INSERT","lineNumber":625,"content":"            Log.e(\"MavlinkRepo\", \"Mission start not acknowledged (timeout or NACK)\")"},{"type":"INSERT","lineNumber":626,"content":"        }"},{"type":"INSERT","lineNumber":627,"content":"        return ack"},{"type":"INSERT","lineNumber":628,"content":"    }"}]},{"timestamp":1757929752040,"changes":[{"type":"MODIFY","lineNumber":368,"content":"            val missionCount = MissionCount(","oldContent":"            val missionCount = MissionCount("},{"type":"DELETE","lineNumber":434,"oldContent":"                            }"},{"type":"DELETE","lineNumber":436,"oldContent":"                        }"},{"type":"DELETE","lineNumber":438,"oldContent":"                    }"},{"type":"DELETE","lineNumber":440,"oldContent":"            }"},{"type":"DELETE","lineNumber":442,"oldContent":""},{"type":"DELETE","lineNumber":444,"oldContent":"            // Wait a short period for first request; if none, fallback to sending all items"},{"type":"DELETE","lineNumber":446,"oldContent":"            val firstRequestTimeout = 2500L"},{"type":"DELETE","lineNumber":448,"oldContent":"            val startWait = System.currentTimeMillis()"},{"type":"DELETE","lineNumber":450,"oldContent":"            while (!firstRequestReceived && !ackDeferred.isCompleted && System.currentTimeMillis() - startWait < firstRequestTimeout) {"},{"type":"DELETE","lineNumber":452,"oldContent":"                delay(100)"},{"type":"DELETE","lineNumber":454,"oldContent":"            }"},{"type":"DELETE","lineNumber":456,"oldContent":""},{"type":"DELETE","lineNumber":458,"oldContent":"            if (!firstRequestReceived) {"},{"type":"DELETE","lineNumber":460,"oldContent":"                Log.w(\"MavlinkRepo\", \"No MissionRequest received within $firstRequestTimeout ms; falling back to send all items\")"},{"type":"DELETE","lineNumber":462,"oldContent":"                // Send all items sequentially"},{"type":"DELETE","lineNumber":464,"oldContent":"                for (seq in 0 until missionItems.size) {"},{"type":"DELETE","lineNumber":466,"oldContent":"                    if (sentSeqs.contains(seq)) continue"},{"type":"DELETE","lineNumber":468,"oldContent":"                    val item = missionItems[seq]"},{"type":"DELETE","lineNumber":470,"oldContent":"                    val missionItem = item.copy("},{"type":"DELETE","lineNumber":472,"oldContent":"                        targetSystem = fcuSystemId,"},{"type":"INSERT","lineNumber":454,"content":"                            }"},{"type":"INSERT","lineNumber":455,"content":"                            is MissionAck -> {"},{"type":"INSERT","lineNumber":456,"content":"                                Log.i(\"MavlinkRepo\", \"Received MISSION_ACK from sys=$senderSys comp=$senderComp: ${msg.type}\")"},{"type":"INSERT","lineNumber":457,"content":"                                if (!ackDeferred.isCompleted) ackDeferred.complete(true)"},{"type":"INSERT","lineNumber":458,"content":"                                return@collect"},{"type":"INSERT","lineNumber":459,"content":"                            }"},{"type":"INSERT","lineNumber":460,"content":"                            else -> {"},{"type":"INSERT","lineNumber":461,"content":"                                // ignore other messages"},{"type":"INSERT","lineNumber":462,"content":"                            }"},{"type":"INSERT","lineNumber":463,"content":"                        }"},{"type":"INSERT","lineNumber":464,"content":"                    }"},{"type":"INSERT","lineNumber":465,"content":"            }"},{"type":"INSERT","lineNumber":466,"content":""},{"type":"INSERT","lineNumber":467,"content":"            // Wait a short period for first request; if none, fallback to sending all items"},{"type":"INSERT","lineNumber":468,"content":"            val firstRequestTimeout = 2500L"},{"type":"INSERT","lineNumber":469,"content":"            val startWait = System.currentTimeMillis()"},{"type":"INSERT","lineNumber":470,"content":"            while (!firstRequestReceived && !ackDeferred.isCompleted && System.currentTimeMillis() - startWait < firstRequestTimeout) {"},{"type":"INSERT","lineNumber":471,"content":"                delay(100)"},{"type":"INSERT","lineNumber":472,"content":"            }"},{"type":"INSERT","lineNumber":473,"content":""},{"type":"INSERT","lineNumber":474,"content":"            if (!firstRequestReceived) {"},{"type":"INSERT","lineNumber":475,"content":"                Log.w(\"MavlinkRepo\", \"No MissionRequest received within $firstRequestTimeout ms; falling back to send all items\")"},{"type":"INSERT","lineNumber":476,"content":"                // Send all items sequentially"},{"type":"INSERT","lineNumber":477,"content":"                for (seq in 0 until missionItems.size) {"},{"type":"INSERT","lineNumber":478,"content":"                    if (sentSeqs.contains(seq)) continue"},{"type":"INSERT","lineNumber":479,"content":"                    val item = missionItems[seq]"},{"type":"INSERT","lineNumber":480,"content":"                    val missionItem = item.copy("},{"type":"INSERT","lineNumber":481,"content":"                        targetSystem = fcuSystemId,"},{"type":"DELETE","lineNumber":476,"oldContent":"                            is MissionAck -> {"},{"type":"DELETE","lineNumber":478,"oldContent":"                                Log.i(\"MavlinkRepo\", \"Received MISSION_ACK from sys=$senderSys comp=$senderComp: ${msg.type}\")"},{"type":"DELETE","lineNumber":480,"oldContent":"                                if (!ackDeferred.isCompleted) ackDeferred.complete(true)"},{"type":"DELETE","lineNumber":482,"oldContent":"                                return@collect"},{"type":"DELETE","lineNumber":484,"oldContent":"                            }"},{"type":"DELETE","lineNumber":486,"oldContent":"                            else -> {"},{"type":"DELETE","lineNumber":488,"oldContent":"                                // ignore other messages"},{"type":"DELETE","lineNumber":490,"oldContent":"                            }"},{"type":"INSERT","lineNumber":519,"content":"    // New helper: request mission from FCU and log items for debugging"},{"type":"INSERT","lineNumber":520,"content":"    @Suppress(\"DEPRECATION\")"},{"type":"INSERT","lineNumber":521,"content":"    suspend fun requestMissionAndLog(timeoutMs: Long = 5000) {"},{"type":"INSERT","lineNumber":522,"content":"        if (!state.value.fcuDetected) {"},{"type":"INSERT","lineNumber":523,"content":"            Log.w(\"MavlinkRepo\", \"FCU not detected; cannot request mission\")"},{"type":"INSERT","lineNumber":524,"content":"            return"},{"type":"INSERT","lineNumber":525,"content":"        }"},{"type":"INSERT","lineNumber":526,"content":"        try {"},{"type":"INSERT","lineNumber":527,"content":"            val received = mutableListOf<Pair<Int, String>>()"},{"type":"INSERT","lineNumber":528,"content":"            val expectedCountDeferred = CompletableDeferred<Int?>()"},{"type":"INSERT","lineNumber":529,"content":""},{"type":"INSERT","lineNumber":530,"content":"            // map of per-seq deferreds"},{"type":"INSERT","lineNumber":531,"content":"            val perSeqMap = mutableMapOf<Int, CompletableDeferred<Unit>>()"},{"type":"INSERT","lineNumber":532,"content":""},{"type":"INSERT","lineNumber":533,"content":"            // collector: listen for count and items and ack"},{"type":"INSERT","lineNumber":534,"content":"            val job = AppScope.launch {"},{"type":"INSERT","lineNumber":535,"content":"                connection.mavFrame.collect { frame ->"},{"type":"INSERT","lineNumber":546,"content":"                            perSeqMap[msg.seq.toInt()]?.let { d -> if (!d.isCompleted) d.complete(Unit) }"},{"type":"DELETE","lineNumber":531,"oldContent":"                            // MissionItem is deprecated; we only log for diagnostics when received"},{"type":"INSERT","lineNumber":549,"content":"                            // MissionItem is deprecated; log for diagnostics"},{"type":"INSERT","lineNumber":550,"content":"                            Log.i(\"MavlinkRepo\", \"Readback: MISSION_ITEM seq=${msg.seq} x=${msg.x} y=${msg.y} z=${msg.z}\")"},{"type":"DELETE","lineNumber":533,"oldContent":"    // New helper: request mission from FCU and log items for debugging"},{"type":"INSERT","lineNumber":552,"content":"                            perSeqMap[msg.seq.toInt()]?.let { d -> if (!d.isCompleted) d.complete(Unit) }"},{"type":"DELETE","lineNumber":535,"oldContent":"    @Suppress(\"DEPRECATION\")"},{"type":"DELETE","lineNumber":537,"oldContent":"    suspend fun requestMissionAndLog(timeoutMs: Long = 5000) {"},{"type":"DELETE","lineNumber":539,"oldContent":"        if (!state.value.fcuDetected) {"},{"type":"DELETE","lineNumber":541,"oldContent":"            Log.w(\"MavlinkRepo\", \"FCU not detected; cannot request mission\")"},{"type":"DELETE","lineNumber":543,"oldContent":"            return"},{"type":"DELETE","lineNumber":545,"oldContent":"        }"},{"type":"DELETE","lineNumber":547,"oldContent":"        try {"},{"type":"DELETE","lineNumber":549,"oldContent":"            val received = mutableListOf<Pair<Int, String>>()"},{"type":"DELETE","lineNumber":551,"oldContent":"            val expectedCountDeferred = CompletableDeferred<Int?>()"},{"type":"DELETE","lineNumber":553,"oldContent":""},{"type":"DELETE","lineNumber":555,"oldContent":"            // collector"},{"type":"DELETE","lineNumber":557,"oldContent":"            val job = AppScope.launch {"},{"type":"DELETE","lineNumber":559,"oldContent":"                connection.mavFrame.collect { frame ->"},{"type":"DELETE","lineNumber":567,"oldContent":"                null"},{"type":"INSERT","lineNumber":573,"content":"                job.cancel()"},{"type":"INSERT","lineNumber":574,"content":"                return"},{"type":"DELETE","lineNumber":570,"oldContent":"            // wait briefly for items"},{"type":"DELETE","lineNumber":571,"oldContent":"            delay(500)"},{"type":"INSERT","lineNumber":577,"content":"            Log.i(\"MavlinkRepo\", \"Expecting $expectedCount mission items - requesting each item\")"},{"type":"INSERT","lineNumber":578,"content":""},{"type":"INSERT","lineNumber":579,"content":"            // For each seq, request the item and wait for it"},{"type":"INSERT","lineNumber":580,"content":"            for (seq in 0 until expectedCount) {"},{"type":"INSERT","lineNumber":581,"content":"                val seqDeferred = CompletableDeferred<Unit>()"},{"type":"INSERT","lineNumber":582,"content":"                perSeqMap[seq] = seqDeferred"},{"type":"INSERT","lineNumber":583,"content":"                try {"},{"type":"INSERT","lineNumber":584,"content":"                    val reqItem = MissionRequestInt(targetSystem = fcuSystemId, targetComponent = fcuComponentId, seq = seq.toUShort())"},{"type":"INSERT","lineNumber":585,"content":"                    connection.trySendUnsignedV2(gcsSystemId, gcsComponentId, reqItem)"},{"type":"INSERT","lineNumber":586,"content":"                    Log.d(\"MavlinkRepo\", \"Sent MISSION_REQUEST_INT for seq=$seq\")"},{"type":"INSERT","lineNumber":587,"content":"                } catch (e: Exception) {"},{"type":"INSERT","lineNumber":588,"content":"                    Log.e(\"MavlinkRepo\", \"Failed to send MISSION_REQUEST_INT seq=$seq\", e)"},{"type":"INSERT","lineNumber":589,"content":"                }"},{"type":"INSERT","lineNumber":590,"content":""},{"type":"INSERT","lineNumber":591,"content":"                // wait up to 1500ms for the item"},{"type":"INSERT","lineNumber":592,"content":"                val got = withTimeoutOrNull(1500L) {"},{"type":"INSERT","lineNumber":593,"content":"                    seqDeferred.await()"},{"type":"INSERT","lineNumber":594,"content":"                    true"},{"type":"INSERT","lineNumber":595,"content":"                } ?: false"},{"type":"INSERT","lineNumber":596,"content":""},{"type":"INSERT","lineNumber":597,"content":"                if (!got) {"},{"type":"INSERT","lineNumber":598,"content":"                    Log.w(\"MavlinkRepo\", \"Did not receive item for seq=$seq within timeout\")"},{"type":"INSERT","lineNumber":599,"content":"                }"},{"type":"INSERT","lineNumber":600,"content":""},{"type":"INSERT","lineNumber":601,"content":"                perSeqMap.remove(seq)"},{"type":"INSERT","lineNumber":602,"content":"            }"},{"type":"INSERT","lineNumber":603,"content":""},{"type":"INSERT","lineNumber":604,"content":"            // give a moment for any remaining frames"},{"type":"INSERT","lineNumber":605,"content":"            delay(200)"},{"type":"DELETE","lineNumber":574,"oldContent":"                            Log.i(\"MavlinkRepo\", \"Readback: MISSION_ITEM seq=${msg.seq} x=${msg.x} y=${msg.y} z=${msg.z}\")"},{"type":"INSERT","lineNumber":615,"content":"    suspend fun startMission(first: Int, last: Int): Boolean {"},{"type":"INSERT","lineNumber":624,"content":"            Log.e(\"MavlinkRepo\", \"Failed to send MISSION_START\", e)"},{"type":"INSERT","lineNumber":625,"content":"            _lastFailure.value = e"},{"type":"INSERT","lineNumber":626,"content":"            return false"},{"type":"INSERT","lineNumber":628,"content":""},{"type":"INSERT","lineNumber":629,"content":"        // Wait for COMMAND_ACK for MISSION_START"},{"type":"INSERT","lineNumber":630,"content":"        val ackDeferred = CompletableDeferred<Boolean>()"},{"type":"DELETE","lineNumber":599,"oldContent":"    suspend fun startMission(first: Int, last: Int): Boolean {"},{"type":"DELETE","lineNumber":604,"oldContent":"            Log.e(\"MavlinkRepo\", \"Failed to send MISSION_START\", e)"},{"type":"DELETE","lineNumber":606,"oldContent":"            _lastFailure.value = e"},{"type":"DELETE","lineNumber":607,"oldContent":"            return false"},{"type":"DELETE","lineNumber":609,"oldContent":""},{"type":"DELETE","lineNumber":611,"oldContent":"        // Wait for COMMAND_ACK for MISSION_START"},{"type":"DELETE","lineNumber":612,"oldContent":"        val ackDeferred = CompletableDeferred<Boolean>()"},{"type":"DELETE","lineNumber":615,"oldContent":"}"},{"type":"DELETE","lineNumber":617,"oldContent":"    }"},{"type":"DELETE","lineNumber":618,"oldContent":"        return ack"},{"type":"DELETE","lineNumber":619,"oldContent":"        }"},{"type":"DELETE","lineNumber":620,"oldContent":"            Log.e(\"MavlinkRepo\", \"Mission start not acknowledged (timeout or NACK)\")"},{"type":"DELETE","lineNumber":621,"oldContent":"        } else {"},{"type":"DELETE","lineNumber":622,"oldContent":"            Log.i(\"MavlinkRepo\", \"Mission start acknowledged by FCU\")"},{"type":"DELETE","lineNumber":623,"oldContent":"        if (ack) {"},{"type":"INSERT","lineNumber":649,"content":"        val ack = withTimeoutOrNull(3000L) {"},{"type":"INSERT","lineNumber":650,"content":"            ackDeferred.await()"},{"type":"INSERT","lineNumber":651,"content":"        } ?: false"},{"type":"DELETE","lineNumber":627,"oldContent":"        } ?: false"},{"type":"DELETE","lineNumber":628,"oldContent":"            ackDeferred.await()"},{"type":"DELETE","lineNumber":629,"oldContent":"        val ack = withTimeoutOrNull(3000L) {"},{"type":"INSERT","lineNumber":655,"content":"        if (ack) {"},{"type":"INSERT","lineNumber":656,"content":"            Log.i(\"MavlinkRepo\", \"Mission start acknowledged by FCU\")"},{"type":"INSERT","lineNumber":657,"content":"        } else {"},{"type":"INSERT","lineNumber":658,"content":"            Log.e(\"MavlinkRepo\", \"Mission start not acknowledged (timeout or NACK)\")"},{"type":"INSERT","lineNumber":659,"content":"        }"},{"type":"INSERT","lineNumber":660,"content":"        return ack"},{"type":"INSERT","lineNumber":661,"content":"    }"},{"type":"INSERT","lineNumber":662,"content":"}"}]},{"timestamp":1757929934150,"changes":[{"type":"INSERT","lineNumber":41,"content":"    private val connection = TcpClientMavConnection(host, port, CommonDialect).asCoroutine()"},{"type":"DELETE","lineNumber":281,"oldContent":""},{"type":"INSERT","lineNumber":367,"content":"            // Send MissionCount"},{"type":"DELETE","lineNumber":368,"oldContent":"            val missionCount = MissionCount("},{"type":"DELETE","lineNumber":409,"oldContent":"                                if (sentSeqs.contains(seq)) {"},{"type":"DELETE","lineNumber":410,"oldContent":"                                    Log.i(\"MavlinkRepo\", \"Already sent seq=$seq, ignoring\")"},{"type":"DELETE","lineNumber":411,"oldContent":"                                    return@collect"},{"type":"DELETE","lineNumber":412,"oldContent":"                                }"},{"type":"INSERT","lineNumber":416,"content":"                                    // Always send the requested item (allow retransmits)"},{"type":"DELETE","lineNumber":437,"oldContent":"                                if (sentSeqs.contains(seq)) {"},{"type":"DELETE","lineNumber":438,"oldContent":"                                    Log.i(\"MavlinkRepo\", \"Already sent seq=$seq, ignoring\")"},{"type":"DELETE","lineNumber":439,"oldContent":"                                    return@collect"},{"type":"DELETE","lineNumber":440,"oldContent":"                                }"},{"type":"INSERT","lineNumber":437,"content":"                                    targetComponent = senderComp.toUByte(),"},{"type":"INSERT","lineNumber":438,"content":"                                    seq = seq.toUShort()"},{"type":"INSERT","lineNumber":439,"content":"                                )"},{"type":"INSERT","lineNumber":440,"content":"                                try {"},{"type":"INSERT","lineNumber":441,"content":"                                    // Always resend when requested"},{"type":"INSERT","lineNumber":442,"content":"                                    connection.trySendUnsignedV2(gcsSystemId, gcsComponentId, missionItemInt)"},{"type":"INSERT","lineNumber":443,"content":"                                    sentSeqs.add(seq)"},{"type":"INSERT","lineNumber":444,"content":"                                    Log.i(\"MavlinkRepo\", \"Sent MISSION_ITEM_INT seq=$seq to sys=$senderSys comp=$senderComp (responding to MissionRequest)\")"},{"type":"INSERT","lineNumber":445,"content":"                                } catch (e: Exception) {"},{"type":"INSERT","lineNumber":446,"content":"                                    Log.e(\"MavlinkRepo\", \"Failed to send mission item(seq=$seq) as MissionItemInt\", e)"},{"type":"INSERT","lineNumber":447,"content":"                                }"},{"type":"DELETE","lineNumber":446,"oldContent":"                                    targetComponent = senderComp.toUByte(),"},{"type":"DELETE","lineNumber":449,"oldContent":"                                    seq = seq.toUShort()"},{"type":"DELETE","lineNumber":452,"oldContent":"                                )"},{"type":"DELETE","lineNumber":455,"oldContent":"                                try {"},{"type":"DELETE","lineNumber":458,"oldContent":"                                    connection.trySendUnsignedV2(gcsSystemId, gcsComponentId, missionItemInt)"},{"type":"DELETE","lineNumber":461,"oldContent":"                                    sentSeqs.add(seq)"},{"type":"DELETE","lineNumber":464,"oldContent":"                                    Log.i(\"MavlinkRepo\", \"Sent MISSION_ITEM_INT seq=$seq to sys=$senderSys comp=$senderComp (responding to MissionRequest)\")"},{"type":"DELETE","lineNumber":467,"oldContent":"                                } catch (e: Exception) {"},{"type":"DELETE","lineNumber":470,"oldContent":"                                    Log.e(\"MavlinkRepo\", \"Failed to send mission item(seq=$seq) as MissionItemInt\", e)"},{"type":"DELETE","lineNumber":473,"oldContent":"                                }"},{"type":"DELETE","lineNumber":475,"oldContent":"                        targetComponent = fcuComponentId,"},{"type":"DELETE","lineNumber":477,"oldContent":"                        seq = seq.toUShort()"},{"type":"DELETE","lineNumber":480,"oldContent":"                    )"},{"type":"DELETE","lineNumber":483,"oldContent":"                    try {"},{"type":"INSERT","lineNumber":476,"content":"                        targetComponent = fcuComponentId,"},{"type":"INSERT","lineNumber":477,"content":"                        seq = seq.toUShort()"},{"type":"INSERT","lineNumber":478,"content":"                    )"},{"type":"INSERT","lineNumber":479,"content":"                    try {"},{"type":"DELETE","lineNumber":520,"oldContent":"                    when (val msg = frame.message) {"},{"type":"DELETE","lineNumber":522,"oldContent":"                        is MissionCount -> {"},{"type":"DELETE","lineNumber":524,"oldContent":"                            Log.i(\"MavlinkRepo\", \"Readback: MISSION_COUNT=${msg.count} from sys=${frame.systemId}\")"},{"type":"DELETE","lineNumber":526,"oldContent":"                            expectedCountDeferred.complete(msg.count.toInt())"},{"type":"DELETE","lineNumber":528,"oldContent":"                        }"},{"type":"DELETE","lineNumber":530,"oldContent":"                        is MissionItemInt -> {"},{"type":"DELETE","lineNumber":532,"oldContent":"                            val lat = msg.x / 1e7"},{"type":"DELETE","lineNumber":534,"oldContent":"                            val lon = msg.y / 1e7"},{"type":"DELETE","lineNumber":536,"oldContent":"                            Log.i(\"MavlinkRepo\", \"Readback: MISSION_ITEM_INT seq=${msg.seq} lat=$lat lon=$lon alt=${msg.z}\")"},{"type":"DELETE","lineNumber":538,"oldContent":"                            received.add(msg.seq.toInt() to \"INT: lat=$lat lon=$lon alt=${msg.z}\")"},{"type":"DELETE","lineNumber":540,"oldContent":"                        }"},{"type":"DELETE","lineNumber":542,"oldContent":"                        is MissionItem -> {"},{"type":"DELETE","lineNumber":545,"oldContent":"                            received.add(msg.seq.toInt() to \"FLT: x=${msg.x} y=${msg.y} z=${msg.z}\")"},{"type":"DELETE","lineNumber":548,"oldContent":"                        }"},{"type":"INSERT","lineNumber":530,"content":"                    when (val msg = frame.message) {"},{"type":"INSERT","lineNumber":531,"content":"                        is MissionCount -> {"},{"type":"INSERT","lineNumber":532,"content":"                            Log.i(\"MavlinkRepo\", \"Readback: MISSION_COUNT=${msg.count} from sys=${frame.systemId}\")"},{"type":"INSERT","lineNumber":533,"content":"                            expectedCountDeferred.complete(msg.count.toInt())"},{"type":"INSERT","lineNumber":534,"content":"                        }"},{"type":"INSERT","lineNumber":535,"content":"                        is MissionItemInt -> {"},{"type":"INSERT","lineNumber":536,"content":"                            val lat = msg.x / 1e7"},{"type":"INSERT","lineNumber":537,"content":"                            val lon = msg.y / 1e7"},{"type":"INSERT","lineNumber":538,"content":"                            Log.i(\"MavlinkRepo\", \"Readback: MISSION_ITEM_INT seq=${msg.seq} lat=$lat lon=$lon alt=${msg.z}\")"},{"type":"INSERT","lineNumber":539,"content":"                            received.add(msg.seq.toInt() to \"INT: lat=$lat lon=$lon alt=${msg.z}\")"},{"type":"INSERT","lineNumber":540,"content":"                            perSeqMap[msg.seq.toInt()]?.let { d -> if (!d.isCompleted) d.complete(Unit) }"},{"type":"INSERT","lineNumber":541,"content":"                        }"},{"type":"INSERT","lineNumber":542,"content":"                        is MissionItem -> {"},{"type":"INSERT","lineNumber":543,"content":"                            // MissionItem is deprecated; log for diagnostics"},{"type":"INSERT","lineNumber":544,"content":"                            Log.i(\"MavlinkRepo\", \"Readback: MISSION_ITEM seq=${msg.seq} x=${msg.x} y=${msg.y} z=${msg.z}\")"},{"type":"INSERT","lineNumber":545,"content":"                            received.add(msg.seq.toInt() to \"FLT: x=${msg.x} y=${msg.y} z=${msg.z}\")"},{"type":"INSERT","lineNumber":546,"content":"                            perSeqMap[msg.seq.toInt()]?.let { d -> if (!d.isCompleted) d.complete(Unit) }"},{"type":"INSERT","lineNumber":547,"content":"                        }"},{"type":"DELETE","lineNumber":555,"oldContent":"                            perSeqMap[msg.seq.toInt()]?.let { d -> if (!d.isCompleted) d.complete(Unit) }"},{"type":"DELETE","lineNumber":558,"oldContent":"                            // MissionItem is deprecated; log for diagnostics"},{"type":"DELETE","lineNumber":559,"oldContent":"                            Log.i(\"MavlinkRepo\", \"Readback: MISSION_ITEM seq=${msg.seq} x=${msg.x} y=${msg.y} z=${msg.z}\")"},{"type":"DELETE","lineNumber":561,"oldContent":"                            perSeqMap[msg.seq.toInt()]?.let { d -> if (!d.isCompleted) d.complete(Unit) }"},{"type":"INSERT","lineNumber":567,"content":"                job.cancel()"},{"type":"INSERT","lineNumber":568,"content":"                return"},{"type":"INSERT","lineNumber":571,"content":"            Log.i(\"MavlinkRepo\", \"Expecting $expectedCount mission items - requesting each item\")"},{"type":"INSERT","lineNumber":572,"content":""},{"type":"INSERT","lineNumber":573,"content":"            // For each seq, request the item and wait for it"},{"type":"INSERT","lineNumber":574,"content":"            for (seq in 0 until expectedCount) {"},{"type":"INSERT","lineNumber":575,"content":"                val seqDeferred = CompletableDeferred<Unit>()"},{"type":"INSERT","lineNumber":576,"content":"                perSeqMap[seq] = seqDeferred"},{"type":"INSERT","lineNumber":577,"content":"                try {"},{"type":"INSERT","lineNumber":578,"content":"                    val reqItem = MissionRequestInt(targetSystem = fcuSystemId, targetComponent = fcuComponentId, seq = seq.toUShort())"},{"type":"INSERT","lineNumber":579,"content":"                    connection.trySendUnsignedV2(gcsSystemId, gcsComponentId, reqItem)"},{"type":"INSERT","lineNumber":580,"content":"                    Log.d(\"MavlinkRepo\", \"Sent MISSION_REQUEST_INT for seq=$seq\")"},{"type":"INSERT","lineNumber":581,"content":"                } catch (e: Exception) {"},{"type":"INSERT","lineNumber":582,"content":"                    Log.e(\"MavlinkRepo\", \"Failed to send MISSION_REQUEST_INT seq=$seq\", e)"},{"type":"INSERT","lineNumber":583,"content":"                }"},{"type":"INSERT","lineNumber":584,"content":""},{"type":"INSERT","lineNumber":585,"content":"                // wait up to 1500ms for the item"},{"type":"INSERT","lineNumber":586,"content":"                val got = withTimeoutOrNull(1500L) {"},{"type":"INSERT","lineNumber":587,"content":"                    seqDeferred.await()"},{"type":"INSERT","lineNumber":588,"content":"                    true"},{"type":"INSERT","lineNumber":589,"content":"                } ?: false"},{"type":"INSERT","lineNumber":590,"content":""},{"type":"INSERT","lineNumber":591,"content":"                if (!got) {"},{"type":"INSERT","lineNumber":592,"content":"                    Log.w(\"MavlinkRepo\", \"Did not receive item for seq=$seq within timeout\")"},{"type":"INSERT","lineNumber":593,"content":"                }"},{"type":"INSERT","lineNumber":594,"content":""},{"type":"INSERT","lineNumber":595,"content":"                perSeqMap.remove(seq)"},{"type":"INSERT","lineNumber":596,"content":"            }"},{"type":"INSERT","lineNumber":597,"content":""},{"type":"INSERT","lineNumber":598,"content":"            // give a moment for any remaining frames"},{"type":"INSERT","lineNumber":599,"content":"            delay(200)"},{"type":"DELETE","lineNumber":576,"oldContent":"                job.cancel()"},{"type":"DELETE","lineNumber":578,"oldContent":"                return"},{"type":"DELETE","lineNumber":581,"oldContent":"            Log.i(\"MavlinkRepo\", \"Expecting $expectedCount mission items - requesting each item\")"},{"type":"DELETE","lineNumber":583,"oldContent":""},{"type":"DELETE","lineNumber":585,"oldContent":"            // For each seq, request the item and wait for it"},{"type":"DELETE","lineNumber":587,"oldContent":"            for (seq in 0 until expectedCount) {"},{"type":"DELETE","lineNumber":589,"oldContent":"                val seqDeferred = CompletableDeferred<Unit>()"},{"type":"DELETE","lineNumber":591,"oldContent":"                perSeqMap[seq] = seqDeferred"},{"type":"INSERT","lineNumber":609,"content":"    suspend fun startMission(first: Int, last: Int): Boolean {"},{"type":"DELETE","lineNumber":593,"oldContent":"                try {"},{"type":"DELETE","lineNumber":595,"oldContent":"                    val reqItem = MissionRequestInt(targetSystem = fcuSystemId, targetComponent = fcuComponentId, seq = seq.toUShort())"},{"type":"DELETE","lineNumber":597,"oldContent":"                    connection.trySendUnsignedV2(gcsSystemId, gcsComponentId, reqItem)"},{"type":"DELETE","lineNumber":599,"oldContent":"                    Log.d(\"MavlinkRepo\", \"Sent MISSION_REQUEST_INT for seq=$seq\")"},{"type":"DELETE","lineNumber":601,"oldContent":"                } catch (e: Exception) {"},{"type":"DELETE","lineNumber":603,"oldContent":"                    Log.e(\"MavlinkRepo\", \"Failed to send MISSION_REQUEST_INT seq=$seq\", e)"},{"type":"DELETE","lineNumber":605,"oldContent":"                }"},{"type":"DELETE","lineNumber":607,"oldContent":""},{"type":"INSERT","lineNumber":618,"content":"            Log.e(\"MavlinkRepo\", \"Failed to send MISSION_START\", e)"},{"type":"INSERT","lineNumber":619,"content":"            _lastFailure.value = e"},{"type":"INSERT","lineNumber":620,"content":"            return false"},{"type":"DELETE","lineNumber":609,"oldContent":"                // wait up to 1500ms for the item"},{"type":"INSERT","lineNumber":622,"content":""},{"type":"INSERT","lineNumber":623,"content":"        // Wait for COMMAND_ACK for MISSION_START"},{"type":"INSERT","lineNumber":624,"content":"        val ackDeferred = CompletableDeferred<Boolean>()"},{"type":"DELETE","lineNumber":611,"oldContent":"                val got = withTimeoutOrNull(1500L) {"},{"type":"DELETE","lineNumber":613,"oldContent":"                    seqDeferred.await()"},{"type":"DELETE","lineNumber":615,"oldContent":"                    true"},{"type":"DELETE","lineNumber":617,"oldContent":"                } ?: false"},{"type":"DELETE","lineNumber":619,"oldContent":""},{"type":"DELETE","lineNumber":621,"oldContent":"                if (!got) {"},{"type":"DELETE","lineNumber":623,"oldContent":"                    Log.w(\"MavlinkRepo\", \"Did not receive item for seq=$seq within timeout\")"},{"type":"DELETE","lineNumber":625,"oldContent":"                }"},{"type":"DELETE","lineNumber":626,"oldContent":""},{"type":"DELETE","lineNumber":628,"oldContent":"                perSeqMap.remove(seq)"},{"type":"DELETE","lineNumber":630,"oldContent":"            }"},{"type":"DELETE","lineNumber":632,"oldContent":""},{"type":"DELETE","lineNumber":634,"oldContent":"            // give a moment for any remaining frames"},{"type":"DELETE","lineNumber":635,"oldContent":"            delay(200)"},{"type":"DELETE","lineNumber":641,"oldContent":"    suspend fun startMission(first: Int, last: Int): Boolean {"},{"type":"MODIFY","lineNumber":643,"content":"        val ack = withTimeoutOrNull(3000L) {","oldContent":"            Log.e(\"MavlinkRepo\", \"Failed to send MISSION_START\", e)"},{"type":"INSERT","lineNumber":644,"content":"            ackDeferred.await()"},{"type":"INSERT","lineNumber":645,"content":"        } ?: false"},{"type":"DELETE","lineNumber":645,"oldContent":"            _lastFailure.value = e"},{"type":"DELETE","lineNumber":647,"oldContent":"            return false"},{"type":"DELETE","lineNumber":649,"oldContent":""},{"type":"DELETE","lineNumber":650,"oldContent":"        // Wait for COMMAND_ACK for MISSION_START"},{"type":"DELETE","lineNumber":651,"oldContent":"        val ackDeferred = CompletableDeferred<Boolean>()"},{"type":"DELETE","lineNumber":652,"oldContent":""},{"type":"DELETE","lineNumber":653,"oldContent":"}"},{"type":"DELETE","lineNumber":654,"oldContent":"    }"},{"type":"DELETE","lineNumber":655,"oldContent":"        return ack"},{"type":"DELETE","lineNumber":656,"oldContent":"        }"},{"type":"DELETE","lineNumber":657,"oldContent":"            Log.e(\"MavlinkRepo\", \"Mission start not acknowledged (timeout or NACK)\")"},{"type":"DELETE","lineNumber":658,"oldContent":"        } else {"},{"type":"DELETE","lineNumber":659,"oldContent":"            Log.i(\"MavlinkRepo\", \"Mission start acknowledged by FCU\")"},{"type":"DELETE","lineNumber":661,"oldContent":"        } ?: false"},{"type":"DELETE","lineNumber":662,"oldContent":"            ackDeferred.await()"},{"type":"DELETE","lineNumber":663,"oldContent":"        val ack = withTimeoutOrNull(3000L) {"},{"type":"INSERT","lineNumber":650,"content":"            Log.i(\"MavlinkRepo\", \"Mission start acknowledged by FCU\")"},{"type":"INSERT","lineNumber":651,"content":"        } else {"},{"type":"INSERT","lineNumber":652,"content":"            Log.e(\"MavlinkRepo\", \"Mission start not acknowledged (timeout or NACK)\")"},{"type":"INSERT","lineNumber":653,"content":"        }"},{"type":"INSERT","lineNumber":654,"content":"        return ack"},{"type":"INSERT","lineNumber":655,"content":"    }"},{"type":"INSERT","lineNumber":656,"content":"}"},{"type":"INSERT","lineNumber":657,"content":""}]},{"timestamp":1757930104019,"changes":[{"type":"INSERT","lineNumber":12,"content":"import kotlinx.coroutines.delay"},{"type":"DELETE","lineNumber":15,"oldContent":"import kotlinx.coroutines.launch"},{"type":"INSERT","lineNumber":42,"content":""},{"type":"INSERT","lineNumber":43,"content":"    fun start() {"},{"type":"DELETE","lineNumber":280,"oldContent":""},{"type":"DELETE","lineNumber":281,"oldContent":"        // Mission handling"},{"type":"DELETE","lineNumber":412,"oldContent":"                                    // Always send the requested item (allow retransmits)"},{"type":"INSERT","lineNumber":416,"content":"                                    // Always send the requested item (allow retransmits)"},{"type":"INSERT","lineNumber":434,"content":"                                val itemInt = missionItems[seq]"},{"type":"INSERT","lineNumber":435,"content":"                                val missionItemInt = itemInt.copy("},{"type":"INSERT","lineNumber":436,"content":"                                    targetSystem = senderSys.toUByte(),"},{"type":"DELETE","lineNumber":439,"oldContent":"                                val itemInt = missionItems[seq]"},{"type":"DELETE","lineNumber":441,"oldContent":"                                val missionItemInt = itemInt.copy("},{"type":"DELETE","lineNumber":443,"oldContent":"                                    targetSystem = senderSys.toUByte(),"},{"type":"DELETE","lineNumber":445,"oldContent":"                            }"},{"type":"DELETE","lineNumber":447,"oldContent":"                            is MissionAck -> {"},{"type":"INSERT","lineNumber":448,"content":"                            }"},{"type":"INSERT","lineNumber":449,"content":"                            is MissionAck -> {"},{"type":"DELETE","lineNumber":462,"oldContent":"            val firstRequestTimeout = 2500L"},{"type":"DELETE","lineNumber":463,"oldContent":"            val startWait = System.currentTimeMillis()"},{"type":"DELETE","lineNumber":464,"oldContent":"            while (!firstRequestReceived && !ackDeferred.isCompleted && System.currentTimeMillis() - startWait < firstRequestTimeout) {"},{"type":"DELETE","lineNumber":465,"oldContent":"                delay(100)"},{"type":"DELETE","lineNumber":466,"oldContent":"            }"},{"type":"DELETE","lineNumber":467,"oldContent":""},{"type":"DELETE","lineNumber":468,"oldContent":"            if (!firstRequestReceived) {"},{"type":"DELETE","lineNumber":469,"oldContent":"                        targetComponent = fcuComponentId,"},{"type":"INSERT","lineNumber":462,"content":"            val firstRequestTimeout = 5000L // increase wait to allow FC more time to request"},{"type":"INSERT","lineNumber":463,"content":"             val startWait = System.currentTimeMillis()"},{"type":"INSERT","lineNumber":464,"content":"             while (!firstRequestReceived && !ackDeferred.isCompleted && System.currentTimeMillis() - startWait < firstRequestTimeout) {"},{"type":"INSERT","lineNumber":465,"content":"                 delay(100)"},{"type":"INSERT","lineNumber":466,"content":"             }"},{"type":"INSERT","lineNumber":467,"content":" "},{"type":"INSERT","lineNumber":468,"content":"             if (!firstRequestReceived) {"},{"type":"DELETE","lineNumber":471,"oldContent":"                        seq = seq.toUShort()"},{"type":"DELETE","lineNumber":472,"oldContent":"                    )"},{"type":"DELETE","lineNumber":474,"oldContent":"                    try {"},{"type":"DELETE","lineNumber":480,"oldContent":"                        connection.trySendUnsignedV2(gcsSystemId, gcsComponentId, missionItem)"},{"type":"DELETE","lineNumber":481,"oldContent":"                        sentSeqs.add(seq)"},{"type":"DELETE","lineNumber":482,"oldContent":"                        Log.i(\"MavlinkRepo\", \"Fallback: Sent MISSION_ITEM_INT seq=$seq\")"},{"type":"DELETE","lineNumber":483,"oldContent":"                        delay(100)"},{"type":"DELETE","lineNumber":484,"oldContent":"                    } catch (e: Exception) {"},{"type":"DELETE","lineNumber":485,"oldContent":"                        Log.e(\"MavlinkRepo\", \"Fallback: Failed to send mission item seq=$seq\", e)"},{"type":"DELETE","lineNumber":486,"oldContent":"                    }"},{"type":"DELETE","lineNumber":487,"oldContent":"                }"},{"type":"DELETE","lineNumber":488,"oldContent":"            }"},{"type":"INSERT","lineNumber":476,"content":"                        targetComponent = fcuComponentId,"},{"type":"INSERT","lineNumber":477,"content":"                        seq = seq.toUShort()"},{"type":"INSERT","lineNumber":478,"content":"                    )"},{"type":"INSERT","lineNumber":479,"content":"                    try {"},{"type":"INSERT","lineNumber":480,"content":"                        // log full item contents for diagnostics"},{"type":"INSERT","lineNumber":481,"content":"                        Log.d(\"MavlinkRepo\", \"Sending fallback item seq=$seq cmd=${missionItem.command} frame=${missionItem.frame} x=${missionItem.x} y=${missionItem.y} z=${missionItem.z}\")"},{"type":"INSERT","lineNumber":482,"content":"                         connection.trySendUnsignedV2(gcsSystemId, gcsComponentId, missionItem)"},{"type":"INSERT","lineNumber":483,"content":"                         sentSeqs.add(seq)"},{"type":"INSERT","lineNumber":484,"content":"                         Log.i(\"MavlinkRepo\", \"Fallback: Sent MISSION_ITEM_INT seq=$seq\")"},{"type":"INSERT","lineNumber":485,"content":"                         // give FC a bit more time to process unsolicited item and possibly request next"},{"type":"INSERT","lineNumber":486,"content":"                         delay(300)"},{"type":"INSERT","lineNumber":487,"content":"                     } catch (e: Exception) {"},{"type":"INSERT","lineNumber":488,"content":"                         Log.e(\"MavlinkRepo\", \"Fallback: Failed to send mission item seq=$seq\", e)"},{"type":"INSERT","lineNumber":489,"content":"                     }"},{"type":"INSERT","lineNumber":490,"content":"                 }"},{"type":"INSERT","lineNumber":491,"content":"             }"},{"type":"INSERT","lineNumber":522,"content":"        }"},{"type":"INSERT","lineNumber":523,"content":"        try {"},{"type":"INSERT","lineNumber":524,"content":"            val received = mutableListOf<Pair<Int, String>>()"},{"type":"INSERT","lineNumber":525,"content":"            val expectedCountDeferred = CompletableDeferred<Int?>()"},{"type":"INSERT","lineNumber":526,"content":""},{"type":"INSERT","lineNumber":527,"content":"            // map of per-seq deferreds"},{"type":"INSERT","lineNumber":528,"content":"            val perSeqMap = mutableMapOf<Int, CompletableDeferred<Unit>>()"},{"type":"INSERT","lineNumber":529,"content":""},{"type":"INSERT","lineNumber":530,"content":"            // collector: listen for count and items and ack"},{"type":"INSERT","lineNumber":531,"content":"            val job = AppScope.launch {"},{"type":"INSERT","lineNumber":532,"content":"                connection.mavFrame.collect { frame ->"},{"type":"DELETE","lineNumber":521,"oldContent":"        }"},{"type":"DELETE","lineNumber":524,"oldContent":"        try {"},{"type":"DELETE","lineNumber":527,"oldContent":"            val received = mutableListOf<Pair<Int, String>>()"},{"type":"DELETE","lineNumber":530,"oldContent":"            val expectedCountDeferred = CompletableDeferred<Int?>()"},{"type":"DELETE","lineNumber":533,"oldContent":""},{"type":"DELETE","lineNumber":536,"oldContent":"            // map of per-seq deferreds"},{"type":"DELETE","lineNumber":539,"oldContent":"            val perSeqMap = mutableMapOf<Int, CompletableDeferred<Unit>>()"},{"type":"DELETE","lineNumber":541,"oldContent":""},{"type":"DELETE","lineNumber":544,"oldContent":"            // collector: listen for count and items and ack"},{"type":"DELETE","lineNumber":546,"oldContent":"            val job = AppScope.launch {"},{"type":"DELETE","lineNumber":547,"oldContent":"                connection.mavFrame.collect { frame ->"},{"type":"DELETE","lineNumber":561,"oldContent":"                job.cancel()"},{"type":"DELETE","lineNumber":563,"oldContent":"                return"},{"type":"DELETE","lineNumber":567,"oldContent":"            Log.i(\"MavlinkRepo\", \"Expecting $expectedCount mission items - requesting each item\")"},{"type":"DELETE","lineNumber":569,"oldContent":""},{"type":"DELETE","lineNumber":571,"oldContent":"            // For each seq, request the item and wait for it"},{"type":"INSERT","lineNumber":570,"content":"                job.cancel()"},{"type":"INSERT","lineNumber":571,"content":"                return"},{"type":"DELETE","lineNumber":573,"oldContent":"            for (seq in 0 until expectedCount) {"},{"type":"INSERT","lineNumber":574,"content":"            Log.i(\"MavlinkRepo\", \"Expecting $expectedCount mission items - requesting each item\")"},{"type":"INSERT","lineNumber":575,"content":""},{"type":"INSERT","lineNumber":576,"content":"            // For each seq, request the item and wait for it"},{"type":"INSERT","lineNumber":577,"content":"            for (seq in 0 until expectedCount) {"},{"type":"DELETE","lineNumber":576,"oldContent":"            job.cancel()"},{"type":"DELETE","lineNumber":579,"oldContent":""},{"type":"DELETE","lineNumber":582,"oldContent":"            Log.i(\"MavlinkRepo\", \"Mission readback complete: expected=$expectedCount items=${received.size}\")"},{"type":"DELETE","lineNumber":584,"oldContent":"            received.sortedBy { it.first }.forEach { (seq, desc) -> Log.i(\"MavlinkRepo\", \"Item #$seq -> $desc\") }"},{"type":"DELETE","lineNumber":587,"oldContent":"        } catch (e: Exception) {"},{"type":"DELETE","lineNumber":590,"oldContent":"            Log.e(\"MavlinkRepo\", \"Error during mission readback\", e)"},{"type":"DELETE","lineNumber":593,"oldContent":"        }"},{"type":"DELETE","lineNumber":596,"oldContent":"    }"},{"type":"DELETE","lineNumber":599,"oldContent":""},{"type":"DELETE","lineNumber":602,"oldContent":"        try {"},{"type":"DELETE","lineNumber":605,"oldContent":"            Log.i(\"MavlinkRepo\", \"Sending MISSION_START first=$first last=$last to sys=$fcuSystemId comp=$fcuComponentId\")"},{"type":"DELETE","lineNumber":608,"oldContent":"            sendCommand("},{"type":"DELETE","lineNumber":611,"oldContent":"                MavCmd.MISSION_START,"},{"type":"INSERT","lineNumber":603,"content":"            job.cancel()"},{"type":"INSERT","lineNumber":604,"content":""},{"type":"INSERT","lineNumber":605,"content":"            Log.i(\"MavlinkRepo\", \"Mission readback complete: expected=$expectedCount items=${received.size}\")"},{"type":"INSERT","lineNumber":606,"content":"            received.sortedBy { it.first }.forEach { (seq, desc) -> Log.i(\"MavlinkRepo\", \"Item #$seq -> $desc\") }"},{"type":"INSERT","lineNumber":607,"content":"        } catch (e: Exception) {"},{"type":"INSERT","lineNumber":608,"content":"            Log.e(\"MavlinkRepo\", \"Error during mission readback\", e)"},{"type":"INSERT","lineNumber":609,"content":"        }"},{"type":"INSERT","lineNumber":610,"content":"    }"},{"type":"INSERT","lineNumber":611,"content":""},{"type":"INSERT","lineNumber":612,"content":"    suspend fun startMission(first: Int, last: Int): Boolean {"},{"type":"INSERT","lineNumber":613,"content":"        try {"},{"type":"INSERT","lineNumber":614,"content":"            Log.i(\"MavlinkRepo\", \"Sending MISSION_START first=$first last=$last to sys=$fcuSystemId comp=$fcuComponentId\")"},{"type":"INSERT","lineNumber":615,"content":"            sendCommand("},{"type":"INSERT","lineNumber":616,"content":"                MavCmd.MISSION_START,"},{"type":"INSERT","lineNumber":621,"content":"            Log.e(\"MavlinkRepo\", \"Failed to send MISSION_START\", e)"},{"type":"INSERT","lineNumber":622,"content":"            _lastFailure.value = e"},{"type":"INSERT","lineNumber":623,"content":"            return false"},{"type":"DELETE","lineNumber":618,"oldContent":"    suspend fun startMission(first: Int, last: Int): Boolean {"},{"type":"INSERT","lineNumber":625,"content":""},{"type":"INSERT","lineNumber":626,"content":"        // Wait for COMMAND_ACK for MISSION_START"},{"type":"INSERT","lineNumber":627,"content":"        val ackDeferred = CompletableDeferred<Boolean>()"},{"type":"DELETE","lineNumber":623,"oldContent":"            Log.e(\"MavlinkRepo\", \"Failed to send MISSION_START\", e)"},{"type":"DELETE","lineNumber":625,"oldContent":"            _lastFailure.value = e"},{"type":"DELETE","lineNumber":626,"oldContent":"            return false"},{"type":"DELETE","lineNumber":628,"oldContent":""},{"type":"DELETE","lineNumber":630,"oldContent":"        // Wait for COMMAND_ACK for MISSION_START"},{"type":"DELETE","lineNumber":631,"oldContent":"        val ackDeferred = CompletableDeferred<Boolean>()"},{"type":"DELETE","lineNumber":645,"oldContent":""},{"type":"INSERT","lineNumber":649,"content":""},{"type":"INSERT","lineNumber":652,"content":"        if (ack) {"},{"type":"DELETE","lineNumber":657,"oldContent":"        if (ack) {"}]},{"timestamp":1757930289161,"changes":[{"type":"MODIFY","lineNumber":28,"content":"    private val gcsSystemId: UByte = 255u","oldContent":"    private val gcsSystemId: UByte = 200u"},{"type":"MODIFY","lineNumber":44,"content":"        val scope = AppScope","oldContent":"        val scope = AppScope"},{"type":"MODIFY","lineNumber":416,"content":"                                    // Always send the requested item (allow retransmits)","oldContent":"                                    // Always send the requested item (allow retransmits)"},{"type":"DELETE","lineNumber":435,"oldContent":"                                    targetComponent = senderComp.toUByte(),"},{"type":"MODIFY","lineNumber":437,"content":"                                    targetComponent = senderComp.toUByte(),","oldContent":"                                    seq = seq.toUShort()"},{"type":"INSERT","lineNumber":438,"content":"                                    seq = seq.toUShort()"},{"type":"DELETE","lineNumber":446,"oldContent":"                            }"},{"type":"MODIFY","lineNumber":448,"content":"                            }","oldContent":"                            is MissionAck -> {"},{"type":"INSERT","lineNumber":449,"content":"                            is MissionAck -> {"},{"type":"DELETE","lineNumber":472,"oldContent":"                        targetComponent = fcuComponentId,"},{"type":"DELETE","lineNumber":474,"oldContent":"                        seq = seq.toUShort()"},{"type":"DELETE","lineNumber":476,"oldContent":"                    )"},{"type":"DELETE","lineNumber":478,"oldContent":"                    try {"},{"type":"INSERT","lineNumber":476,"content":"                        targetComponent = fcuComponentId,"},{"type":"INSERT","lineNumber":477,"content":"                        seq = seq.toUShort()"},{"type":"INSERT","lineNumber":478,"content":"                    )"},{"type":"INSERT","lineNumber":479,"content":"                    try {"},{"type":"DELETE","lineNumber":490,"oldContent":""},{"type":"MODIFY","lineNumber":492,"content":"","oldContent":"            // Wait for ACK with timeout"},{"type":"INSERT","lineNumber":493,"content":"            // Wait for ACK with timeout"},{"type":"DELETE","lineNumber":522,"oldContent":"                    when (val msg = frame.message) {"},{"type":"DELETE","lineNumber":523,"oldContent":"                        is MissionCount -> {"},{"type":"DELETE","lineNumber":525,"oldContent":"                            Log.i(\"MavlinkRepo\", \"Readback: MISSION_COUNT=${msg.count} from sys=${frame.systemId}\")"},{"type":"DELETE","lineNumber":527,"oldContent":"                            expectedCountDeferred.complete(msg.count.toInt())"},{"type":"DELETE","lineNumber":530,"oldContent":"                        }"},{"type":"DELETE","lineNumber":532,"oldContent":"                        is MissionItemInt -> {"},{"type":"DELETE","lineNumber":535,"oldContent":"                            val lat = msg.x / 1e7"},{"type":"DELETE","lineNumber":537,"oldContent":"                            val lon = msg.y / 1e7"},{"type":"DELETE","lineNumber":540,"oldContent":"                            Log.i(\"MavlinkRepo\", \"Readback: MISSION_ITEM_INT seq=${msg.seq} lat=$lat lon=$lon alt=${msg.z}\")"},{"type":"INSERT","lineNumber":533,"content":"                    when (val msg = frame.message) {"},{"type":"INSERT","lineNumber":534,"content":"                        is MissionCount -> {"},{"type":"INSERT","lineNumber":535,"content":"                            Log.i(\"MavlinkRepo\", \"Readback: MISSION_COUNT=${msg.count} from sys=${frame.systemId}\")"},{"type":"INSERT","lineNumber":536,"content":"                            expectedCountDeferred.complete(msg.count.toInt())"},{"type":"INSERT","lineNumber":537,"content":"                        }"},{"type":"INSERT","lineNumber":538,"content":"                        is MissionItemInt -> {"},{"type":"INSERT","lineNumber":539,"content":"                            val lat = msg.x / 1e7"},{"type":"INSERT","lineNumber":540,"content":"                            val lon = msg.y / 1e7"},{"type":"INSERT","lineNumber":541,"content":"                            Log.i(\"MavlinkRepo\", \"Readback: MISSION_ITEM_INT seq=${msg.seq} lat=$lat lon=$lon alt=${msg.z}\")"},{"type":"MODIFY","lineNumber":570,"content":"                job.cancel()","oldContent":"                job.cancel()"},{"type":"INSERT","lineNumber":573,"content":""},{"type":"DELETE","lineNumber":575,"oldContent":""},{"type":"DELETE","lineNumber":576,"oldContent":"                val seqDeferred = CompletableDeferred<Unit>()"},{"type":"INSERT","lineNumber":578,"content":"                val seqDeferred = CompletableDeferred<Unit>()"},{"type":"DELETE","lineNumber":596,"oldContent":"            job.cancel()"},{"type":"INSERT","lineNumber":598,"content":"                perSeqMap.remove(seq)"},{"type":"INSERT","lineNumber":599,"content":"            }"},{"type":"INSERT","lineNumber":601,"content":"            // give a moment for any remaining frames"},{"type":"INSERT","lineNumber":602,"content":"            delay(200)"},{"type":"INSERT","lineNumber":603,"content":"            job.cancel()"},{"type":"INSERT","lineNumber":604,"content":""},{"type":"DELETE","lineNumber":602,"oldContent":"                perSeqMap.remove(seq)"},{"type":"DELETE","lineNumber":604,"oldContent":"            }"},{"type":"DELETE","lineNumber":607,"oldContent":""},{"type":"DELETE","lineNumber":609,"oldContent":"            // give a moment for any remaining frames"},{"type":"DELETE","lineNumber":612,"oldContent":"            delay(200)"},{"type":"DELETE","lineNumber":614,"oldContent":"                first.toFloat(),"},{"type":"DELETE","lineNumber":616,"oldContent":"                last.toFloat()"},{"type":"DELETE","lineNumber":618,"oldContent":"            )"},{"type":"INSERT","lineNumber":617,"content":"                first.toFloat(),"},{"type":"INSERT","lineNumber":618,"content":"                last.toFloat()"},{"type":"INSERT","lineNumber":619,"content":"            )"},{"type":"DELETE","lineNumber":621,"oldContent":"        }"},{"type":"DELETE","lineNumber":622,"oldContent":"        val job = AppScope.launch {"},{"type":"DELETE","lineNumber":623,"oldContent":"            connection.mavFrame.collect { frame ->"},{"type":"DELETE","lineNumber":625,"oldContent":"                val msg = frame.message"},{"type":"DELETE","lineNumber":627,"oldContent":"                if (msg is CommandAck) {"},{"type":"DELETE","lineNumber":629,"oldContent":"                    try {"},{"type":"INSERT","lineNumber":624,"content":"        }"},{"type":"INSERT","lineNumber":628,"content":"        val job = AppScope.launch {"},{"type":"INSERT","lineNumber":629,"content":"            connection.mavFrame.collect { frame ->"},{"type":"INSERT","lineNumber":630,"content":"                val msg = frame.message"},{"type":"INSERT","lineNumber":631,"content":"                if (msg is CommandAck) {"},{"type":"INSERT","lineNumber":632,"content":"                    try {"},{"type":"INSERT","lineNumber":649,"content":""},{"type":"DELETE","lineNumber":651,"oldContent":""},{"type":"INSERT","lineNumber":652,"content":"        if (ack) {"},{"type":"DELETE","lineNumber":655,"oldContent":"        if (ack) {"}]},{"timestamp":1757930419685,"changes":[{"type":"DELETE","lineNumber":13,"oldContent":"import kotlinx.coroutines.delay"},{"type":"INSERT","lineNumber":15,"content":"import kotlinx.coroutines.launch"},{"type":"MODIFY","lineNumber":17,"content":"","oldContent":"class MavlinkTelemetryRepository("},{"type":"DELETE","lineNumber":43,"oldContent":""},{"type":"DELETE","lineNumber":44,"oldContent":"        val scope = AppScope"},{"type":"INSERT","lineNumber":280,"content":"                }"},{"type":"INSERT","lineNumber":281,"content":"        }"},{"type":"MODIFY","lineNumber":285,"content":"        val commandLong = CommandLong(","oldContent":"                        is MissionRequest -> {"},{"type":"MODIFY","lineNumber":287,"content":"            targetComponent = fcuComponentId,","oldContent":"                            val seq = message.seq.toInt()"},{"type":"MODIFY","lineNumber":295,"content":"            param6 = param6,","oldContent":"                                    targetSystem = fcuSystemId,"},{"type":"MODIFY","lineNumber":300,"content":"               gcsSystemId,","oldContent":"                                    frame = MavFrame.GLOBAL_RELATIVE_ALT.wrap(),"},{"type":"DELETE","lineNumber":303,"oldContent":"                                    command = MavCmd.NAV_WAYPOINT.wrap(),"},{"type":"DELETE","lineNumber":304,"oldContent":"                                    current = if (seq == 0) 1u else 0u,"},{"type":"INSERT","lineNumber":303,"content":"            Log.e(\"MavlinkRepo\", \"Failed to send command\", e)"},{"type":"INSERT","lineNumber":304,"content":"            _lastFailure.value = e"},{"type":"DELETE","lineNumber":306,"oldContent":"                                    autocontinue = 1u,"},{"type":"DELETE","lineNumber":307,"oldContent":"                                    param1 = 0f,"},{"type":"DELETE","lineNumber":308,"oldContent":"                                    param2 = 0f,"},{"type":"DELETE","lineNumber":309,"oldContent":"                                    param3 = 0f,"},{"type":"DELETE","lineNumber":310,"oldContent":"                                    param4 = 0f,"},{"type":"DELETE","lineNumber":311,"oldContent":"                                    x = (waypoint.latitude * 1e7).toInt(),"},{"type":"DELETE","lineNumber":312,"oldContent":"                                    y = (waypoint.longitude * 1e7).toInt(),"},{"type":"DELETE","lineNumber":313,"oldContent":"                                    z = 100f, // Default altitude"},{"type":"DELETE","lineNumber":314,"oldContent":"                                    missionType = MavMissionType.MISSION.wrap()"},{"type":"DELETE","lineNumber":315,"oldContent":"                                )"},{"type":"DELETE","lineNumber":316,"oldContent":"                                try {"},{"type":"DELETE","lineNumber":317,"oldContent":"                                    connection.trySendUnsignedV2(gcsSystemId, gcsComponentId, missionItem)"},{"type":"DELETE","lineNumber":318,"oldContent":"                                    Log.e(\"MavlinkRepo\", \"Failed to send mission item\", e)"},{"type":"DELETE","lineNumber":319,"oldContent":"                                }"},{"type":"DELETE","lineNumber":320,"oldContent":"                        }"},{"type":"DELETE","lineNumber":321,"oldContent":"                            Log.i(\"MavlinkRepo\", \"Mission upload acknowledged with result: ${message.type.value}\")"},{"type":"DELETE","lineNumber":322,"oldContent":"                                _state.update { it.copy(missionLoaded = true) }"},{"type":"INSERT","lineNumber":306,"content":"    }"},{"type":"INSERT","lineNumber":307,"content":""},{"type":"INSERT","lineNumber":308,"content":"    suspend fun arm() {"},{"type":"INSERT","lineNumber":309,"content":"        if (state.value.armable) {"},{"type":"INSERT","lineNumber":310,"content":"            sendCommand("},{"type":"INSERT","lineNumber":311,"content":"                MavCmd.COMPONENT_ARM_DISARM,"},{"type":"INSERT","lineNumber":312,"content":"                1f"},{"type":"INSERT","lineNumber":313,"content":"            )"},{"type":"INSERT","lineNumber":314,"content":"        } else {"},{"type":"INSERT","lineNumber":315,"content":"            Log.w(\"MavlinkRepo\", \"Arm command rejected, vehicle not armable\")"},{"type":"INSERT","lineNumber":316,"content":"        }"},{"type":"INSERT","lineNumber":317,"content":"    }"},{"type":"INSERT","lineNumber":318,"content":""},{"type":"INSERT","lineNumber":319,"content":"    suspend fun disarm() {"},{"type":"INSERT","lineNumber":320,"content":"        sendCommand("},{"type":"INSERT","lineNumber":321,"content":"            MavCmd.COMPONENT_ARM_DISARM,"},{"type":"INSERT","lineNumber":322,"content":"            0f"},{"type":"DELETE","lineNumber":330,"oldContent":"            targetComponent = fcuComponentId,"},{"type":"DELETE","lineNumber":331,"oldContent":"            confirmation = 0u,"},{"type":"DELETE","lineNumber":332,"oldContent":"            param2 = param2,"},{"type":"DELETE","lineNumber":333,"oldContent":"            param4 = param4,"},{"type":"INSERT","lineNumber":330,"content":"            0f"},{"type":"INSERT","lineNumber":331,"content":"        )"},{"type":"INSERT","lineNumber":332,"content":"    }"},{"type":"INSERT","lineNumber":333,"content":""},{"type":"INSERT","lineNumber":415,"content":"                                try {"},{"type":"DELETE","lineNumber":416,"oldContent":"                                    // Always send the requested item (allow retransmits)"},{"type":"INSERT","lineNumber":436,"content":"                                    targetSystem = senderSys.toUByte(),"},{"type":"DELETE","lineNumber":438,"oldContent":"                                    targetSystem = senderSys.toUByte(),"},{"type":"INSERT","lineNumber":447,"content":"                                }"},{"type":"DELETE","lineNumber":449,"oldContent":"                                }"},{"type":"MODIFY","lineNumber":467,"content":"","oldContent":" "},{"type":"INSERT","lineNumber":474,"content":"                    val missionItem = item.copy("},{"type":"INSERT","lineNumber":475,"content":"                        targetSystem = fcuSystemId,"},{"type":"DELETE","lineNumber":476,"oldContent":"                    val missionItem = item.copy("},{"type":"DELETE","lineNumber":479,"oldContent":"                        targetSystem = fcuSystemId,"},{"type":"INSERT","lineNumber":491,"content":"             }"},{"type":"DELETE","lineNumber":493,"oldContent":"             }"},{"type":"DELETE","lineNumber":527,"oldContent":"                    when (val msg = frame.message) {"},{"type":"MODIFY","lineNumber":529,"content":"","oldContent":"                        is MissionCount -> {"},{"type":"INSERT","lineNumber":530,"content":"            // collector: listen for count and items and ack"},{"type":"INSERT","lineNumber":531,"content":"            val job = AppScope.launch {"},{"type":"INSERT","lineNumber":532,"content":"                connection.mavFrame.collect { frame ->"},{"type":"INSERT","lineNumber":533,"content":"                    when (val msg = frame.message) {"},{"type":"INSERT","lineNumber":534,"content":"                        is MissionCount -> {"},{"type":"DELETE","lineNumber":533,"oldContent":""},{"type":"DELETE","lineNumber":536,"oldContent":"            // collector: listen for count and items and ack"},{"type":"DELETE","lineNumber":538,"oldContent":"            val job = AppScope.launch {"},{"type":"DELETE","lineNumber":541,"oldContent":"                connection.mavFrame.collect { frame ->"},{"type":"INSERT","lineNumber":569,"content":"                Log.w(\"MavlinkRepo\", \"Did not receive MISSION_COUNT from FCU within timeout\")"},{"type":"DELETE","lineNumber":570,"oldContent":"                job.cancel()"},{"type":"MODIFY","lineNumber":578,"content":"                val seqDeferred = CompletableDeferred<Unit>()","oldContent":"                val seqDeferred = CompletableDeferred<Unit>()"},{"type":"MODIFY","lineNumber":598,"content":"                perSeqMap.remove(seq)","oldContent":"                perSeqMap.remove(seq)"},{"type":"DELETE","lineNumber":601,"oldContent":"            Log.i(\"MavlinkRepo\", \"Mission readback complete: expected=$expectedCount items=${received.size}\")"},{"type":"DELETE","lineNumber":603,"oldContent":"            received.sortedBy { it.first }.forEach { (seq, desc) -> Log.i(\"MavlinkRepo\", \"Item #$seq -> $desc\") }"},{"type":"DELETE","lineNumber":606,"oldContent":"        } catch (e: Exception) {"},{"type":"INSERT","lineNumber":605,"content":"            Log.i(\"MavlinkRepo\", \"Mission readback complete: expected=$expectedCount items=${received.size}\")"},{"type":"INSERT","lineNumber":606,"content":"            received.sortedBy { it.first }.forEach { (seq, desc) -> Log.i(\"MavlinkRepo\", \"Item #$seq -> $desc\") }"},{"type":"INSERT","lineNumber":607,"content":"        } catch (e: Exception) {"},{"type":"DELETE","lineNumber":615,"oldContent":"                first.toFloat(),"},{"type":"INSERT","lineNumber":616,"content":"                MavCmd.MISSION_START,"},{"type":"INSERT","lineNumber":617,"content":"                first.toFloat(),"},{"type":"DELETE","lineNumber":619,"oldContent":"                MavCmd.MISSION_START,"},{"type":"DELETE","lineNumber":621,"oldContent":"        }"},{"type":"MODIFY","lineNumber":624,"content":"        }","oldContent":"        val job = AppScope.launch {"},{"type":"INSERT","lineNumber":625,"content":""},{"type":"INSERT","lineNumber":626,"content":"        // Wait for COMMAND_ACK for MISSION_START"},{"type":"INSERT","lineNumber":627,"content":"        val ackDeferred = CompletableDeferred<Boolean>()"},{"type":"INSERT","lineNumber":628,"content":"        val job = AppScope.launch {"},{"type":"DELETE","lineNumber":628,"oldContent":""},{"type":"DELETE","lineNumber":630,"oldContent":"        // Wait for COMMAND_ACK for MISSION_START"},{"type":"DELETE","lineNumber":632,"oldContent":"        val ackDeferred = CompletableDeferred<Boolean>()"}]},{"timestamp":1757931119945,"changes":[{"type":"MODIFY","lineNumber":15,"content":"import kotlinx.coroutines.launch","oldContent":"import kotlinx.coroutines.launch"},{"type":"INSERT","lineNumber":161,"content":"        // Collector to log COMMAND_ACK messages for diagnostics"},{"type":"INSERT","lineNumber":162,"content":"        scope.launch {"},{"type":"INSERT","lineNumber":163,"content":"            mavFrameStream"},{"type":"INSERT","lineNumber":164,"content":"                .filter { state.value.fcuDetected && it.systemId == fcuSystemId }"},{"type":"INSERT","lineNumber":165,"content":"                .map { it.message }"},{"type":"INSERT","lineNumber":166,"content":"                .filterIsInstance<CommandAck>()"},{"type":"INSERT","lineNumber":167,"content":"                .collect { ack ->"},{"type":"INSERT","lineNumber":168,"content":"                    try {"},{"type":"INSERT","lineNumber":169,"content":"                        Log.i(\"MavlinkRepo\", \"COMMAND_ACK received: command=${ack.command} result=${ack.result} progress=${ack.progress} resultText=${ack.resultText}\")"},{"type":"INSERT","lineNumber":170,"content":"                    } catch (t: Throwable) {"},{"type":"INSERT","lineNumber":171,"content":"                        Log.i(\"MavlinkRepo\", \"COMMAND_ACK received (unable to stringify fields)\")"},{"type":"INSERT","lineNumber":172,"content":"                    }"},{"type":"INSERT","lineNumber":173,"content":"                }"},{"type":"INSERT","lineNumber":174,"content":"        }"},{"type":"INSERT","lineNumber":175,"content":""},{"type":"DELETE","lineNumber":278,"oldContent":"                }"},{"type":"DELETE","lineNumber":280,"oldContent":"        }"},{"type":"DELETE","lineNumber":282,"oldContent":"                .collect { message ->"},{"type":"DELETE","lineNumber":283,"oldContent":"                        is MissionRequest -> {"},{"type":"INSERT","lineNumber":295,"content":"                }"},{"type":"INSERT","lineNumber":296,"content":"        }"},{"type":"INSERT","lineNumber":297,"content":"    }"},{"type":"INSERT","lineNumber":298,"content":""},{"type":"INSERT","lineNumber":317,"content":"            Log.d(\"MavlinkRepo\", \"Sent COMMAND_LONG: cmd=${command} p1=$param1 p2=$param2 p3=$param3 p4=$param4 p5=$param5 p6=$param6 p7=$param7\")"},{"type":"DELETE","lineNumber":323,"oldContent":"            targetSystem = fcuSystemId,"},{"type":"INSERT","lineNumber":339,"content":"        )"},{"type":"DELETE","lineNumber":475,"oldContent":"                        targetComponent = fcuComponentId,"},{"type":"INSERT","lineNumber":492,"content":"                        targetComponent = fcuComponentId,"},{"type":"INSERT","lineNumber":544,"content":"            val perSeqMap = mutableMapOf<Int, CompletableDeferred<Unit>>()"},{"type":"DELETE","lineNumber":530,"oldContent":"            val perSeqMap = mutableMapOf<Int, CompletableDeferred<Unit>>()"},{"type":"DELETE","lineNumber":532,"oldContent":"                            Log.i(\"MavlinkRepo\", \"Readback: MISSION_COUNT=${msg.count} from sys=${frame.systemId}\")"},{"type":"DELETE","lineNumber":534,"oldContent":"                            expectedCountDeferred.complete(msg.count.toInt())"},{"type":"INSERT","lineNumber":551,"content":"                            Log.i(\"MavlinkRepo\", \"Readback: MISSION_COUNT=${msg.count} from sys=${frame.systemId}\")"},{"type":"INSERT","lineNumber":552,"content":"                            expectedCountDeferred.complete(msg.count.toInt())"},{"type":"INSERT","lineNumber":593,"content":"            for (seq in 0 until expectedCount) {"},{"type":"DELETE","lineNumber":578,"oldContent":"                val seqDeferred = CompletableDeferred<Unit>()"},{"type":"INSERT","lineNumber":613,"content":""},{"type":"DELETE","lineNumber":598,"oldContent":"                perSeqMap.remove(seq)"},{"type":"DELETE","lineNumber":603,"oldContent":"            Log.i(\"MavlinkRepo\", \"Mission readback complete: expected=$expectedCount items=${received.size}\")"},{"type":"INSERT","lineNumber":620,"content":""},{"type":"INSERT","lineNumber":621,"content":"            Log.i(\"MavlinkRepo\", \"Mission readback complete: expected=$expectedCount items=${received.size}\")"},{"type":"DELETE","lineNumber":607,"oldContent":""},{"type":"DELETE","lineNumber":613,"oldContent":"        try {"},{"type":"DELETE","lineNumber":614,"oldContent":"            Log.i(\"MavlinkRepo\", \"Sending MISSION_START first=$first last=$last to sys=$fcuSystemId comp=$fcuComponentId\")"},{"type":"DELETE","lineNumber":615,"oldContent":"                MavCmd.MISSION_START,"},{"type":"DELETE","lineNumber":616,"oldContent":"            sendCommand("},{"type":"DELETE","lineNumber":617,"oldContent":"                first.toFloat(),"},{"type":"DELETE","lineNumber":618,"oldContent":"                last.toFloat()"},{"type":"DELETE","lineNumber":619,"oldContent":"            )"},{"type":"DELETE","lineNumber":620,"oldContent":"        } catch (e: Exception) {"},{"type":"DELETE","lineNumber":621,"oldContent":"            Log.e(\"MavlinkRepo\", \"Failed to send MISSION_START\", e)"},{"type":"DELETE","lineNumber":622,"oldContent":"            _lastFailure.value = e"},{"type":"INSERT","lineNumber":629,"content":"        // Try sending MISSION_START multiple times and wait for COMMAND_ACK each attempt."},{"type":"INSERT","lineNumber":630,"content":"        if (!state.value.fcuDetected) {"},{"type":"INSERT","lineNumber":631,"content":"            Log.w(\"MavlinkRepo\", \"Cannot start mission - FCU not detected\")"},{"type":"INSERT","lineNumber":632,"content":"            return false"},{"type":"DELETE","lineNumber":625,"oldContent":"            return false"},{"type":"DELETE","lineNumber":626,"oldContent":"        // Wait for COMMAND_ACK for MISSION_START"},{"type":"DELETE","lineNumber":627,"oldContent":"            connection.mavFrame.collect { frame ->"},{"type":"DELETE","lineNumber":628,"oldContent":"        val ackDeferred = CompletableDeferred<Boolean>()"},{"type":"DELETE","lineNumber":629,"oldContent":"                val msg = frame.message"},{"type":"DELETE","lineNumber":630,"oldContent":"        val job = AppScope.launch {"},{"type":"DELETE","lineNumber":631,"oldContent":"                if (msg is CommandAck) {"},{"type":"DELETE","lineNumber":632,"oldContent":"                    try {"},{"type":"DELETE","lineNumber":633,"oldContent":"                        if (msg.command == MavCmd.MISSION_START.wrap()) {"},{"type":"DELETE","lineNumber":634,"oldContent":"                            val resultVal = msg.result.value"},{"type":"DELETE","lineNumber":635,"oldContent":"                            val ok = resultVal == 0u"},{"type":"DELETE","lineNumber":636,"oldContent":"                            Log.i(\"MavlinkRepo\", \"Received COMMAND_ACK for MISSION_START result=$resultVal\")"},{"type":"DELETE","lineNumber":637,"oldContent":"                            if (!ackDeferred.isCompleted) ackDeferred.complete(ok)"},{"type":"INSERT","lineNumber":635,"content":"        val maxAttempts = 3"},{"type":"INSERT","lineNumber":636,"content":"        val perAttemptTimeout = 1500L"},{"type":"INSERT","lineNumber":637,"content":""},{"type":"INSERT","lineNumber":638,"content":"        for (attempt in 1..maxAttempts) {"},{"type":"INSERT","lineNumber":639,"content":"            try {"},{"type":"INSERT","lineNumber":640,"content":"                Log.i(\"MavlinkRepo\", \"Attempt $attempt: Sending MISSION_START first=$first last=$last to sys=$fcuSystemId comp=$fcuComponentId\")"},{"type":"INSERT","lineNumber":641,"content":"                sendCommand(MavCmd.MISSION_START, first.toFloat(), last.toFloat())"},{"type":"INSERT","lineNumber":642,"content":"            } catch (e: Exception) {"},{"type":"INSERT","lineNumber":643,"content":"                Log.e(\"MavlinkRepo\", \"Failed to send MISSION_START on attempt $attempt\", e)"},{"type":"INSERT","lineNumber":644,"content":"            }"},{"type":"INSERT","lineNumber":645,"content":""},{"type":"INSERT","lineNumber":646,"content":"            // wait for COMMAND_ACK for MISSION_START"},{"type":"INSERT","lineNumber":647,"content":"            val ackDeferred = CompletableDeferred<UInt?>()"},{"type":"INSERT","lineNumber":648,"content":"            val job = AppScope.launch {"},{"type":"INSERT","lineNumber":649,"content":"                connection.mavFrame.collect { frame ->"},{"type":"INSERT","lineNumber":650,"content":"                    val msg = frame.message"},{"type":"INSERT","lineNumber":651,"content":"                    if (msg is CommandAck) {"},{"type":"INSERT","lineNumber":652,"content":"                        try {"},{"type":"INSERT","lineNumber":653,"content":"                            if (msg.command == MavCmd.MISSION_START.wrap()) {"},{"type":"INSERT","lineNumber":654,"content":"                                val resultVal = msg.result.value"},{"type":"INSERT","lineNumber":655,"content":"                                Log.i(\"MavlinkRepo\", \"Observed COMMAND_ACK for MISSION_START result=$resultVal on attempt $attempt\")"},{"type":"INSERT","lineNumber":656,"content":"                                if (!ackDeferred.isCompleted) ackDeferred.complete(resultVal)"},{"type":"INSERT","lineNumber":657,"content":"                            }"},{"type":"INSERT","lineNumber":658,"content":"                        } catch (t: Throwable) {"},{"type":"INSERT","lineNumber":659,"content":"                            Log.w(\"MavlinkRepo\", \"Error while processing COMMAND_ACK\", t)"},{"type":"DELETE","lineNumber":639,"oldContent":"                    } catch (t: Throwable) {"},{"type":"DELETE","lineNumber":640,"oldContent":"                        Log.w(\"MavlinkRepo\", \"Error while processing COMMAND_ACK\", t)"},{"type":"DELETE","lineNumber":644,"oldContent":"        }"},{"type":"DELETE","lineNumber":646,"oldContent":"        val ack = withTimeoutOrNull(3000L) {"},{"type":"DELETE","lineNumber":647,"oldContent":"            ackDeferred.await()"},{"type":"DELETE","lineNumber":648,"oldContent":"        } ?: false"},{"type":"INSERT","lineNumber":665,"content":"            val result = withTimeoutOrNull(perAttemptTimeout) { ackDeferred.await() }"},{"type":"INSERT","lineNumber":666,"content":"            job.cancel()"},{"type":"DELETE","lineNumber":650,"oldContent":"        job.cancel()"},{"type":"DELETE","lineNumber":651,"oldContent":""},{"type":"DELETE","lineNumber":652,"oldContent":"        if (ack) {"},{"type":"DELETE","lineNumber":653,"oldContent":"            Log.i(\"MavlinkRepo\", \"Mission start acknowledged by FCU\")"},{"type":"DELETE","lineNumber":654,"oldContent":"        } else {"},{"type":"DELETE","lineNumber":655,"oldContent":"            Log.e(\"MavlinkRepo\", \"Mission start not acknowledged (timeout or NACK)\")"},{"type":"INSERT","lineNumber":668,"content":"            if (result != null) {"},{"type":"INSERT","lineNumber":669,"content":"                if (result == 0u) {"},{"type":"INSERT","lineNumber":670,"content":"                    Log.i(\"MavlinkRepo\", \"Mission start acknowledged by FCU on attempt $attempt\")"},{"type":"INSERT","lineNumber":671,"content":"                    return true"},{"type":"INSERT","lineNumber":672,"content":"                } else {"},{"type":"INSERT","lineNumber":673,"content":"                    Log.e(\"MavlinkRepo\", \"Mission start rejected by FCU on attempt $attempt with result=$result\")"},{"type":"INSERT","lineNumber":674,"content":"                    // Don't retry on a negative ACK; break and return failure"},{"type":"INSERT","lineNumber":675,"content":"                    return false"},{"type":"INSERT","lineNumber":676,"content":"                }"},{"type":"INSERT","lineNumber":677,"content":"            } else {"},{"type":"INSERT","lineNumber":678,"content":"                Log.w(\"MavlinkRepo\", \"No COMMAND_ACK for MISSION_START on attempt $attempt (timeout)\")"},{"type":"INSERT","lineNumber":679,"content":"                // try again after short delay"},{"type":"INSERT","lineNumber":680,"content":"                delay(500L)"},{"type":"INSERT","lineNumber":681,"content":"            }"},{"type":"DELETE","lineNumber":657,"oldContent":"        return ack"},{"type":"INSERT","lineNumber":683,"content":""},{"type":"INSERT","lineNumber":684,"content":"        Log.e(\"MavlinkRepo\", \"Mission start not acknowledged after $maxAttempts attempts\")"},{"type":"INSERT","lineNumber":685,"content":"        return false"}]},{"timestamp":1757931339153,"changes":[{"type":"INSERT","lineNumber":14,"content":"import kotlinx.coroutines.isActive"},{"type":"DELETE","lineNumber":15,"oldContent":"import kotlinx.coroutines.launch"},{"type":"DELETE","lineNumber":162,"oldContent":"        // Collectors"},{"type":"DELETE","lineNumber":164,"oldContent":""},{"type":"DELETE","lineNumber":166,"oldContent":"        // VFR_HUD"},{"type":"DELETE","lineNumber":168,"oldContent":"        scope.launch {"},{"type":"DELETE","lineNumber":170,"oldContent":"            mavFrameStream"},{"type":"DELETE","lineNumber":172,"oldContent":"                .filter { state.value.fcuDetected && it.systemId == fcuSystemId }"},{"type":"DELETE","lineNumber":174,"oldContent":"                .map { it.message }"},{"type":"DELETE","lineNumber":176,"oldContent":"                .filterIsInstance<VfrHud>()"},{"type":"DELETE","lineNumber":178,"oldContent":"                .collect { hud ->"},{"type":"DELETE","lineNumber":180,"oldContent":"                    _state.update {"},{"type":"DELETE","lineNumber":182,"oldContent":"                        it.copy("},{"type":"DELETE","lineNumber":184,"oldContent":"                            altitudeMsl = hud.alt,"},{"type":"DELETE","lineNumber":186,"oldContent":"                            airspeed = hud.airspeed.takeIf { v -> v > 0f },"},{"type":"DELETE","lineNumber":188,"oldContent":"                            groundspeed = hud.groundspeed.takeIf { v -> v > 0f }"},{"type":"INSERT","lineNumber":176,"content":"        // Collectors"},{"type":"INSERT","lineNumber":177,"content":""},{"type":"INSERT","lineNumber":178,"content":"        // VFR_HUD"},{"type":"INSERT","lineNumber":179,"content":"        scope.launch {"},{"type":"INSERT","lineNumber":180,"content":"            mavFrameStream"},{"type":"INSERT","lineNumber":181,"content":"                .filter { state.value.fcuDetected && it.systemId == fcuSystemId }"},{"type":"INSERT","lineNumber":182,"content":"                .map { it.message }"},{"type":"INSERT","lineNumber":183,"content":"                .filterIsInstance<VfrHud>()"},{"type":"INSERT","lineNumber":184,"content":"                .collect { hud ->"},{"type":"INSERT","lineNumber":185,"content":"                    _state.update {"},{"type":"INSERT","lineNumber":186,"content":"                        it.copy("},{"type":"INSERT","lineNumber":187,"content":"                            altitudeMsl = hud.alt,"},{"type":"INSERT","lineNumber":188,"content":"                            airspeed = hud.airspeed.takeIf { v -> v > 0f },"},{"type":"INSERT","lineNumber":189,"content":"                            groundspeed = hud.groundspeed.takeIf { v -> v > 0f }"},{"type":"INSERT","lineNumber":295,"content":"                }"},{"type":"INSERT","lineNumber":296,"content":"        }"},{"type":"INSERT","lineNumber":297,"content":"    }"},{"type":"INSERT","lineNumber":298,"content":""},{"type":"DELETE","lineNumber":297,"oldContent":"                                val waypoint = mission[seq]"},{"type":"INSERT","lineNumber":301,"content":"            targetSystem = fcuSystemId,"},{"type":"DELETE","lineNumber":306,"oldContent":"                }"},{"type":"DELETE","lineNumber":308,"oldContent":"        }"},{"type":"DELETE","lineNumber":310,"oldContent":"    }"},{"type":"DELETE","lineNumber":312,"oldContent":""},{"type":"INSERT","lineNumber":317,"content":"            Log.d(\"MavlinkRepo\", \"Sent COMMAND_LONG: cmd=${command} p1=$param1 p2=$param2 p3=$param3 p4=$param4 p5=$param5 p6=$param6 p7=$param7\")"},{"type":"DELETE","lineNumber":332,"oldContent":"            Log.d(\"MavlinkRepo\", \"Sent COMMAND_LONG: cmd=${command} p1=$param1 p2=$param2 p3=$param3 p4=$param4 p5=$param5 p6=$param6 p7=$param7\")"},{"type":"INSERT","lineNumber":339,"content":"        )"},{"type":"DELETE","lineNumber":342,"oldContent":"            targetSystem = fcuSystemId,"},{"type":"MODIFY","lineNumber":343,"content":"        sendCommand(","oldContent":"            command = command.wrap(),"},{"type":"INSERT","lineNumber":344,"content":"            MavCmd.DO_SET_MODE,"},{"type":"INSERT","lineNumber":352,"content":"            MavCmd.NAV_TAKEOFF,"},{"type":"INSERT","lineNumber":353,"content":"            -1f,"},{"type":"INSERT","lineNumber":354,"content":"            0f,"},{"type":"INSERT","lineNumber":355,"content":"            0f,"},{"type":"INSERT","lineNumber":356,"content":"            0f,"},{"type":"INSERT","lineNumber":357,"content":"            0f,"},{"type":"INSERT","lineNumber":358,"content":"            0f,"},{"type":"INSERT","lineNumber":359,"content":"            altitude"},{"type":"DELETE","lineNumber":352,"oldContent":"        try {"},{"type":"DELETE","lineNumber":353,"oldContent":"            connection.trySendUnsignedV2("},{"type":"DELETE","lineNumber":354,"oldContent":"        )"},{"type":"DELETE","lineNumber":355,"oldContent":"               gcsSystemId,"},{"type":"DELETE","lineNumber":356,"oldContent":"                gcsComponentId, commandLong)"},{"type":"DELETE","lineNumber":357,"oldContent":"        } catch (e: Exception) {"},{"type":"DELETE","lineNumber":358,"oldContent":"            Log.e(\"MavlinkRepo\", \"Failed to send command\", e)"},{"type":"DELETE","lineNumber":359,"oldContent":"            _lastFailure.value = e"},{"type":"DELETE","lineNumber":360,"oldContent":"        }"},{"type":"INSERT","lineNumber":363,"content":"    suspend fun land() {"},{"type":"INSERT","lineNumber":364,"content":"        sendCommand(MavCmd.NAV_LAND)"},{"type":"DELETE","lineNumber":365,"oldContent":"        if (state.value.armable) {"},{"type":"DELETE","lineNumber":366,"oldContent":"            sendCommand("},{"type":"INSERT","lineNumber":492,"content":"                        targetComponent = fcuComponentId,"},{"type":"DELETE","lineNumber":507,"oldContent":"                        targetComponent = fcuComponentId,"},{"type":"INSERT","lineNumber":544,"content":"            val perSeqMap = mutableMapOf<Int, CompletableDeferred<Unit>>()"},{"type":"INSERT","lineNumber":551,"content":"                            Log.i(\"MavlinkRepo\", \"Readback: MISSION_COUNT=${msg.count} from sys=${frame.systemId}\")"},{"type":"INSERT","lineNumber":552,"content":"                            expectedCountDeferred.complete(msg.count.toInt())"},{"type":"DELETE","lineNumber":557,"oldContent":"            val perSeqMap = mutableMapOf<Int, CompletableDeferred<Unit>>()"},{"type":"DELETE","lineNumber":565,"oldContent":"                            Log.i(\"MavlinkRepo\", \"Readback: MISSION_COUNT=${msg.count} from sys=${frame.systemId}\")"},{"type":"DELETE","lineNumber":567,"oldContent":"                            expectedCountDeferred.complete(msg.count.toInt())"},{"type":"INSERT","lineNumber":593,"content":"            for (seq in 0 until expectedCount) {"},{"type":"DELETE","lineNumber":608,"oldContent":"            for (seq in 0 until expectedCount) {"},{"type":"INSERT","lineNumber":613,"content":""},{"type":"INSERT","lineNumber":620,"content":""},{"type":"INSERT","lineNumber":621,"content":"            Log.i(\"MavlinkRepo\", \"Mission readback complete: expected=$expectedCount items=${received.size}\")"},{"type":"DELETE","lineNumber":626,"oldContent":""},{"type":"DELETE","lineNumber":627,"oldContent":""},{"type":"DELETE","lineNumber":628,"oldContent":"            Log.i(\"MavlinkRepo\", \"Mission readback complete: expected=$expectedCount items=${received.size}\")"},{"type":"DELETE","lineNumber":629,"oldContent":"        }"},{"type":"DELETE","lineNumber":630,"oldContent":""},{"type":"INSERT","lineNumber":633,"content":"        }"},{"type":"INSERT","lineNumber":634,"content":""},{"type":"INSERT","lineNumber":635,"content":"        // First, tell FC which mission item to start from (some firmwares expect this)"},{"type":"INSERT","lineNumber":636,"content":"        try {"},{"type":"INSERT","lineNumber":637,"content":"            val setCurrent = MissionSetCurrent(targetSystem = fcuSystemId, targetComponent = fcuComponentId, seq = first.toUShort())"},{"type":"INSERT","lineNumber":638,"content":"            connection.trySendUnsignedV2(gcsSystemId, gcsComponentId, setCurrent)"},{"type":"INSERT","lineNumber":639,"content":"            Log.i(\"MavlinkRepo\", \"Sent MISSION_SET_CURRENT seq=$first to sys=$fcuSystemId comp=$fcuComponentId\")"},{"type":"INSERT","lineNumber":640,"content":"            // small delay to allow FC to process"},{"type":"INSERT","lineNumber":641,"content":"            delay(200)"},{"type":"INSERT","lineNumber":642,"content":"        } catch (e: Exception) {"},{"type":"INSERT","lineNumber":643,"content":"            Log.w(\"MavlinkRepo\", \"Failed to send MISSION_SET_CURRENT\", e)"},{"type":"INSERT","lineNumber":644,"content":"        }"},{"type":"INSERT","lineNumber":645,"content":""},{"type":"DELETE","lineNumber":639,"oldContent":"                        }"},{"type":"DELETE","lineNumber":643,"oldContent":"                    }"},{"type":"DELETE","lineNumber":645,"oldContent":"                }"},{"type":"DELETE","lineNumber":648,"oldContent":"            }"},{"type":"DELETE","lineNumber":650,"oldContent":""},{"type":"DELETE","lineNumber":655,"oldContent":""},{"type":"DELETE","lineNumber":663,"oldContent":"        }"},{"type":"DELETE","lineNumber":666,"oldContent":"    }"},{"type":"DELETE","lineNumber":668,"oldContent":"}"},{"type":"DELETE","lineNumber":669,"oldContent":""},{"type":"DELETE","lineNumber":670,"oldContent":"        return false"},{"type":"DELETE","lineNumber":671,"oldContent":"        Log.e(\"MavlinkRepo\", \"Mission start not acknowledged after $maxAttempts attempts\")"},{"type":"DELETE","lineNumber":672,"oldContent":""},{"type":"INSERT","lineNumber":671,"content":"                        }"},{"type":"INSERT","lineNumber":672,"content":"                    }"},{"type":"INSERT","lineNumber":673,"content":"                }"},{"type":"INSERT","lineNumber":675,"content":""},{"type":"DELETE","lineNumber":675,"oldContent":"                delay(500L)"},{"type":"DELETE","lineNumber":677,"oldContent":"                // try again after short delay"},{"type":"MODIFY","lineNumber":678,"content":"","oldContent":"                Log.w(\"MavlinkRepo\", \"No COMMAND_ACK for MISSION_START on attempt $attempt (timeout)\")"},{"type":"DELETE","lineNumber":680,"oldContent":"            } else {"},{"type":"DELETE","lineNumber":682,"oldContent":"                }"},{"type":"DELETE","lineNumber":684,"oldContent":"                    return false"},{"type":"MODIFY","lineNumber":685,"content":"                    // Don't retry on a negative ACK; break and return failure","oldContent":"                    // Don't retry on a negative ACK; break and return failure"},{"type":"INSERT","lineNumber":686,"content":"                    return false"},{"type":"INSERT","lineNumber":687,"content":"                }"},{"type":"INSERT","lineNumber":688,"content":"            } else {"},{"type":"INSERT","lineNumber":689,"content":"                Log.w(\"MavlinkRepo\", \"No COMMAND_ACK for MISSION_START on attempt $attempt (timeout)\")"},{"type":"INSERT","lineNumber":690,"content":"                // try again after short delay"},{"type":"INSERT","lineNumber":691,"content":"                delay(500L)"},{"type":"INSERT","lineNumber":692,"content":"            }"},{"type":"INSERT","lineNumber":693,"content":"        }"},{"type":"INSERT","lineNumber":694,"content":""},{"type":"INSERT","lineNumber":695,"content":"        Log.e(\"MavlinkRepo\", \"Mission start not acknowledged after $maxAttempts attempts\")"},{"type":"INSERT","lineNumber":696,"content":"        return false"},{"type":"INSERT","lineNumber":697,"content":"    }"},{"type":"INSERT","lineNumber":698,"content":"}"},{"type":"INSERT","lineNumber":699,"content":""}]},{"timestamp":1757931521168,"changes":[{"type":"INSERT","lineNumber":169,"content":"                        Log.i(\"MavlinkRepo\", \"COMMAND_ACK received: command=${ack.command} result=${ack.result} progress=${ack.progress} resultText=${ack.resultText}\")"},{"type":"INSERT","lineNumber":170,"content":"                    } catch (t: Throwable) {"},{"type":"INSERT","lineNumber":171,"content":"                        Log.i(\"MavlinkRepo\", \"COMMAND_ACK received (unable to stringify fields)\")"},{"type":"INSERT","lineNumber":172,"content":"                    }"},{"type":"INSERT","lineNumber":173,"content":"                }"},{"type":"INSERT","lineNumber":174,"content":"        }"},{"type":"INSERT","lineNumber":175,"content":""},{"type":"DELETE","lineNumber":171,"oldContent":"                        Log.i(\"MavlinkRepo\", \"COMMAND_ACK received: command=${ack.command} result=${ack.result} progress=${ack.progress} resultText=${ack.resultText}\")"},{"type":"DELETE","lineNumber":174,"oldContent":"                    } catch (t: Throwable) {"},{"type":"DELETE","lineNumber":177,"oldContent":"                        Log.i(\"MavlinkRepo\", \"COMMAND_ACK received (unable to stringify fields)\")"},{"type":"DELETE","lineNumber":180,"oldContent":"                    }"},{"type":"DELETE","lineNumber":183,"oldContent":"                }"},{"type":"DELETE","lineNumber":186,"oldContent":"        }"},{"type":"DELETE","lineNumber":189,"oldContent":""},{"type":"DELETE","lineNumber":296,"oldContent":"                            val seq = message.seq.toInt()"},{"type":"DELETE","lineNumber":298,"oldContent":"        val commandLong = CommandLong("},{"type":"INSERT","lineNumber":299,"content":"    suspend fun sendCommand(command: MavCmd, param1: Float = 0f, param2: Float = 0f, param3: Float = 0f, param4: Float = 0f, param5: Float = 0f, param6: Float = 0f, param7: Float = 0f) {"},{"type":"INSERT","lineNumber":300,"content":"        val commandLong = CommandLong("},{"type":"INSERT","lineNumber":301,"content":"            targetSystem = fcuSystemId,"},{"type":"DELETE","lineNumber":303,"oldContent":"                                    targetSystem = fcuSystemId,"},{"type":"MODIFY","lineNumber":304,"content":"            confirmation = 0u,","oldContent":"            targetSystem = fcuSystemId,"},{"type":"MODIFY","lineNumber":306,"content":"            param2 = param2,","oldContent":"                                    seq = seq.toUShort(),"},{"type":"DELETE","lineNumber":308,"oldContent":"                                    command = MavCmd.NAV_WAYPOINT.wrap(),"},{"type":"DELETE","lineNumber":309,"oldContent":"                                    autocontinue = 1u,"},{"type":"INSERT","lineNumber":308,"content":"            param4 = param4,"},{"type":"INSERT","lineNumber":309,"content":"            param5 = param5,"},{"type":"MODIFY","lineNumber":313,"content":"        try {","oldContent":"                                    x = (waypoint.latitude * 1e7).toInt(),"},{"type":"MODIFY","lineNumber":316,"content":"                gcsComponentId, commandLong)","oldContent":"                                    z = 100f, // Default altitude"},{"type":"MODIFY","lineNumber":340,"content":"    }","oldContent":"        val commandLong = CommandLong("},{"type":"DELETE","lineNumber":352,"oldContent":"        )"},{"type":"INSERT","lineNumber":360,"content":"        )"},{"type":"DELETE","lineNumber":364,"oldContent":""},{"type":"DELETE","lineNumber":366,"oldContent":"        if (state.value.armable) {"},{"type":"INSERT","lineNumber":365,"content":"    }"},{"type":"INSERT","lineNumber":366,"content":""},{"type":"DELETE","lineNumber":551,"oldContent":"                        }"},{"type":"MODIFY","lineNumber":553,"content":"                        }","oldContent":"                        is MissionItemInt -> {"},{"type":"INSERT","lineNumber":554,"content":"                        is MissionItemInt -> {"},{"type":"DELETE","lineNumber":620,"oldContent":"            received.sortedBy { it.first }.forEach { (seq, desc) -> Log.i(\"MavlinkRepo\", \"Item #$seq -> $desc\") }"},{"type":"MODIFY","lineNumber":622,"content":"            received.sortedBy { it.first }.forEach { (seq, desc) -> Log.i(\"MavlinkRepo\", \"Item #$seq -> $desc\") }","oldContent":"        } catch (e: Exception) {"},{"type":"INSERT","lineNumber":623,"content":"        } catch (e: Exception) {"},{"type":"DELETE","lineNumber":631,"oldContent":"        }"},{"type":"MODIFY","lineNumber":633,"content":"        }","oldContent":""},{"type":"INSERT","lineNumber":634,"content":""},{"type":"DELETE","lineNumber":636,"oldContent":"        val maxAttempts = 3"},{"type":"DELETE","lineNumber":638,"oldContent":"        val perAttemptTimeout = 1500L"},{"type":"DELETE","lineNumber":640,"oldContent":""},{"type":"DELETE","lineNumber":642,"oldContent":"        for (attempt in 1..maxAttempts) {"},{"type":"DELETE","lineNumber":645,"oldContent":"            try {"},{"type":"DELETE","lineNumber":647,"oldContent":"                Log.i(\"MavlinkRepo\", \"Attempt $attempt: Sending MISSION_START first=$first last=$last to sys=$fcuSystemId comp=$fcuComponentId\")"},{"type":"DELETE","lineNumber":649,"oldContent":"                sendCommand(MavCmd.MISSION_START, first.toFloat(), last.toFloat())"},{"type":"DELETE","lineNumber":652,"oldContent":"            } catch (e: Exception) {"},{"type":"INSERT","lineNumber":646,"content":"        val maxAttempts = 3"},{"type":"INSERT","lineNumber":647,"content":"        val perAttemptTimeout = 1500L"},{"type":"INSERT","lineNumber":648,"content":""},{"type":"INSERT","lineNumber":649,"content":"        for (attempt in 1..maxAttempts) {"},{"type":"INSERT","lineNumber":650,"content":"            try {"},{"type":"INSERT","lineNumber":651,"content":"                Log.i(\"MavlinkRepo\", \"Attempt $attempt: Sending MISSION_START first=$first last=$last to sys=$fcuSystemId comp=$fcuComponentId\")"},{"type":"INSERT","lineNumber":652,"content":"                sendCommand(MavCmd.MISSION_START, first.toFloat(), last.toFloat())"},{"type":"INSERT","lineNumber":653,"content":"            } catch (e: Exception) {"},{"type":"MODIFY","lineNumber":676,"content":"            val result = withTimeoutOrNull(perAttemptTimeout) { ackDeferred.await() }","oldContent":"            val result = withTimeoutOrNull(perAttemptTimeout) { ackDeferred.await() }"},{"type":"INSERT","lineNumber":682,"content":"                    return true"},{"type":"INSERT","lineNumber":683,"content":"                } else {"},{"type":"INSERT","lineNumber":684,"content":"                    Log.e(\"MavlinkRepo\", \"Mission start rejected by FCU on attempt $attempt with result=$result\")"},{"type":"DELETE","lineNumber":684,"oldContent":"                    // Don't retry on a negative ACK; break and return failure"},{"type":"DELETE","lineNumber":686,"oldContent":"                } else {"},{"type":"DELETE","lineNumber":688,"oldContent":"                    Log.e(\"MavlinkRepo\", \"Mission start rejected by FCU on attempt $attempt with result=$result\")"},{"type":"DELETE","lineNumber":690,"oldContent":""},{"type":"DELETE","lineNumber":692,"oldContent":"}"},{"type":"DELETE","lineNumber":694,"oldContent":"    }"},{"type":"DELETE","lineNumber":696,"oldContent":"        return false"},{"type":"DELETE","lineNumber":698,"oldContent":"        Log.e(\"MavlinkRepo\", \"Mission start not acknowledged after $maxAttempts attempts\")"},{"type":"INSERT","lineNumber":695,"content":"        Log.e(\"MavlinkRepo\", \"MISSION_START not acknowledged after $maxAttempts attempts - trying fallback start (set current + change mode to AUTO)\")"},{"type":"INSERT","lineNumber":696,"content":""},{"type":"INSERT","lineNumber":697,"content":"        // Fallback approach: set mission current and change mode to AUTO (many FCs start mission when switched to AUTO)"},{"type":"INSERT","lineNumber":698,"content":"        try {"},{"type":"INSERT","lineNumber":699,"content":"            val setCurrent = MissionSetCurrent(targetSystem = fcuSystemId, targetComponent = fcuComponentId, seq = first.toUShort())"},{"type":"INSERT","lineNumber":700,"content":"            connection.trySendUnsignedV2(gcsSystemId, gcsComponentId, setCurrent)"},{"type":"INSERT","lineNumber":701,"content":"            Log.i(\"MavlinkRepo\", \"Fallback: Sent MISSION_SET_CURRENT seq=$first\")"},{"type":"INSERT","lineNumber":702,"content":"        } catch (e: Exception) {"},{"type":"INSERT","lineNumber":703,"content":"            Log.w(\"MavlinkRepo\", \"Fallback: Failed to send MISSION_SET_CURRENT\", e)"},{"type":"INSERT","lineNumber":704,"content":"        }"},{"type":"INSERT","lineNumber":705,"content":""},{"type":"INSERT","lineNumber":706,"content":"        // Request mode change to AUTO using DO_SET_MODE"},{"type":"INSERT","lineNumber":707,"content":"        try {"},{"type":"INSERT","lineNumber":708,"content":"            Log.i(\"MavlinkRepo\", \"Fallback: Requesting mode change to AUTO via DO_SET_MODE\")"},{"type":"INSERT","lineNumber":709,"content":"            sendCommand(MavCmd.DO_SET_MODE, MavMode.AUTO.toFloat(), 0f)"},{"type":"INSERT","lineNumber":710,"content":"        } catch (e: Exception) {"},{"type":"INSERT","lineNumber":711,"content":"            Log.w(\"MavlinkRepo\", \"Fallback: Failed to send DO_SET_MODE\", e)"},{"type":"INSERT","lineNumber":712,"content":"        }"},{"type":"INSERT","lineNumber":713,"content":""},{"type":"INSERT","lineNumber":714,"content":"        // Wait for telemetry mode to reflect AUTO for a short period"},{"type":"INSERT","lineNumber":715,"content":"        val modeWaitMs = 5000L"},{"type":"INSERT","lineNumber":716,"content":"        val startWaitMode = System.currentTimeMillis()"},{"type":"INSERT","lineNumber":717,"content":"        while (System.currentTimeMillis() - startWaitMode < modeWaitMs) {"},{"type":"INSERT","lineNumber":718,"content":"            if (state.value.mode?.contains(\"Auto\", ignoreCase = true) == true) {"},{"type":"INSERT","lineNumber":719,"content":"                Log.i(\"MavlinkRepo\", \"Fallback: Vehicle switched to AUTO mode\")"},{"type":"INSERT","lineNumber":720,"content":"                // Give FC a moment to start the mission"},{"type":"INSERT","lineNumber":721,"content":"                delay(500)"},{"type":"INSERT","lineNumber":722,"content":"                return true"},{"type":"INSERT","lineNumber":723,"content":"            }"},{"type":"INSERT","lineNumber":724,"content":"            delay(200)"},{"type":"INSERT","lineNumber":725,"content":"        }"},{"type":"INSERT","lineNumber":726,"content":""},{"type":"INSERT","lineNumber":727,"content":"        Log.e(\"MavlinkRepo\", \"Fallback start failed: vehicle did not switch to AUTO mode\")"},{"type":"INSERT","lineNumber":728,"content":"        return false"},{"type":"INSERT","lineNumber":729,"content":"    }"},{"type":"INSERT","lineNumber":730,"content":"}"},{"type":"INSERT","lineNumber":731,"content":""}]},{"timestamp":1757931631413,"changes":[{"type":"DELETE","lineNumber":169,"oldContent":"                        Log.i(\"MavlinkRepo\", \"COMMAND_ACK received: command=${ack.command} result=${ack.result} progress=${ack.progress} resultText=${ack.resultText}\")"},{"type":"DELETE","lineNumber":170,"oldContent":"        // Collectors"},{"type":"INSERT","lineNumber":169,"content":"                        Log.i(\"MavlinkRepo\", \"COMMAND_ACK received: command=${ack.command} result=${ack.result} progress=${ack.progress} resultText=${ack.resultTLog.i(\"MavlinkRepo\", \"COMMAND_ACK received: command=${ack.command} result=${ack.result} progress=${ack.progress} resultText=${ack.resultText ?: \"\"}\")ext}\")"},{"type":"DELETE","lineNumber":172,"oldContent":""},{"type":"DELETE","lineNumber":175,"oldContent":"        // VFR_HUD"},{"type":"DELETE","lineNumber":177,"oldContent":"        scope.launch {"},{"type":"INSERT","lineNumber":176,"content":"        // Collectors"},{"type":"INSERT","lineNumber":177,"content":""},{"type":"INSERT","lineNumber":178,"content":"        // VFR_HUD"},{"type":"INSERT","lineNumber":179,"content":"        scope.launch {"},{"type":"DELETE","lineNumber":297,"oldContent":"    suspend fun sendCommand(command: MavCmd, param1: Float = 0f, param2: Float = 0f, param3: Float = 0f, param4: Float = 0f, param5: Float = 0f, param6: Float = 0f, param7: Float = 0f) {"},{"type":"MODIFY","lineNumber":299,"content":"    suspend fun sendCommand(command: MavCmd, param1: Float = 0f, param2: Float = 0f, param3: Float = 0f, param4: Float = 0f, param5: Float = 0f, param6: Float = 0f, param7: Float = 0f) {","oldContent":"        val commandLong = CommandLong("},{"type":"INSERT","lineNumber":300,"content":"        val commandLong = CommandLong("},{"type":"MODIFY","lineNumber":305,"content":"            param1 = param1,","oldContent":"                                    seq = seq.toUShort(),"},{"type":"DELETE","lineNumber":350,"oldContent":"            param6 = param6,"},{"type":"DELETE","lineNumber":351,"oldContent":"            param7 = param7"},{"type":"INSERT","lineNumber":350,"content":"    suspend fun takeoff(altitude: Float) {"},{"type":"INSERT","lineNumber":351,"content":"        sendCommand("},{"type":"MODIFY","lineNumber":360,"content":"        )","oldContent":"        )"},{"type":"MODIFY","lineNumber":365,"content":"    }","oldContent":"    }"},{"type":"INSERT","lineNumber":552,"content":"                            expectedCountDeferred.complete(msg.count.toInt())"},{"type":"DELETE","lineNumber":554,"oldContent":"                            expectedCountDeferred.complete(msg.count.toInt())"},{"type":"INSERT","lineNumber":621,"content":"            Log.i(\"MavlinkRepo\", \"Mission readback complete: expected=$expectedCount items=${received.size}\")"},{"type":"DELETE","lineNumber":623,"oldContent":"            Log.i(\"MavlinkRepo\", \"Mission readback complete: expected=$expectedCount items=${received.size}\")"},{"type":"INSERT","lineNumber":632,"content":"            return false"},{"type":"DELETE","lineNumber":634,"oldContent":"            return false"},{"type":"DELETE","lineNumber":641,"oldContent":"        val maxAttempts = 3"},{"type":"INSERT","lineNumber":642,"content":"        } catch (e: Exception) {"},{"type":"INSERT","lineNumber":643,"content":"            Log.w(\"MavlinkRepo\", \"Failed to send MISSION_SET_CURRENT\", e)"},{"type":"INSERT","lineNumber":644,"content":"        }"},{"type":"INSERT","lineNumber":645,"content":""},{"type":"INSERT","lineNumber":646,"content":"        val maxAttempts = 3"},{"type":"DELETE","lineNumber":645,"oldContent":"        } catch (e: Exception) {"},{"type":"DELETE","lineNumber":648,"oldContent":"            Log.w(\"MavlinkRepo\", \"Failed to send MISSION_SET_CURRENT\", e)"},{"type":"DELETE","lineNumber":650,"oldContent":"        }"},{"type":"DELETE","lineNumber":653,"oldContent":""},{"type":"INSERT","lineNumber":675,"content":""},{"type":"DELETE","lineNumber":676,"oldContent":"            val result = withTimeoutOrNull(perAttemptTimeout) { ackDeferred.await() }"},{"type":"DELETE","lineNumber":683,"oldContent":"                    // Don't retry on a negative ACK; break and return failure"},{"type":"MODIFY","lineNumber":685,"content":"                    // Don't retry on a negative ACK; break and return failure","oldContent":"                    return false"},{"type":"INSERT","lineNumber":686,"content":"                    return false"},{"type":"DELETE","lineNumber":692,"oldContent":"        Log.e(\"MavlinkRepo\", \"MISSION_START not acknowledged after $maxAttempts attempts - trying fallback start (set current + change mode to AUTO)\")"},{"type":"INSERT","lineNumber":693,"content":"        }"},{"type":"INSERT","lineNumber":695,"content":"        Log.e(\"MavlinkRepo\", \"MISSION_START not acknowledged after $maxAttempts attempts - trying fallback start (set current + change mode to AUTO)\")"},{"type":"INSERT","lineNumber":696,"content":""},{"type":"DELETE","lineNumber":696,"oldContent":"        }"},{"type":"DELETE","lineNumber":699,"oldContent":""},{"type":"DELETE","lineNumber":701,"oldContent":""},{"type":"DELETE","lineNumber":703,"oldContent":"}"},{"type":"DELETE","lineNumber":705,"oldContent":"    }"},{"type":"DELETE","lineNumber":707,"oldContent":"        return false"},{"type":"DELETE","lineNumber":709,"oldContent":"        Log.e(\"MavlinkRepo\", \"Fallback start failed: vehicle did not switch to AUTO mode\")"},{"type":"DELETE","lineNumber":711,"oldContent":""},{"type":"DELETE","lineNumber":713,"oldContent":"        }"},{"type":"DELETE","lineNumber":715,"oldContent":"            delay(200)"},{"type":"DELETE","lineNumber":717,"oldContent":"            }"},{"type":"DELETE","lineNumber":719,"oldContent":"                return true"},{"type":"DELETE","lineNumber":721,"oldContent":"                delay(500)"},{"type":"DELETE","lineNumber":723,"oldContent":"                // Give FC a moment to start the mission"},{"type":"DELETE","lineNumber":725,"oldContent":"                Log.i(\"MavlinkRepo\", \"Fallback: Vehicle switched to AUTO mode\")"},{"type":"DELETE","lineNumber":727,"oldContent":"            if (state.value.mode?.contains(\"Auto\", ignoreCase = true) == true) {"},{"type":"DELETE","lineNumber":729,"oldContent":"        while (System.currentTimeMillis() - startWaitMode < modeWaitMs) {"},{"type":"INSERT","lineNumber":717,"content":"        while (System.currentTimeMillis() - startWaitMode < modeWaitMs) {"},{"type":"INSERT","lineNumber":718,"content":"            if (state.value.mode?.contains(\"Auto\", ignoreCase = true) == true) {"},{"type":"INSERT","lineNumber":719,"content":"                Log.i(\"MavlinkRepo\", \"Fallback: Vehicle switched to AUTO mode\")"},{"type":"INSERT","lineNumber":720,"content":"                // Give FC a moment to start the mission"},{"type":"INSERT","lineNumber":721,"content":"                delay(500)"},{"type":"INSERT","lineNumber":722,"content":"                return true"},{"type":"INSERT","lineNumber":723,"content":"            }"},{"type":"INSERT","lineNumber":724,"content":"            delay(200)"},{"type":"INSERT","lineNumber":725,"content":"        }"},{"type":"INSERT","lineNumber":726,"content":""},{"type":"INSERT","lineNumber":727,"content":"        Log.e(\"MavlinkRepo\", \"Fallback start failed: vehicle did not switch to AUTO mode\")"},{"type":"INSERT","lineNumber":728,"content":"        return false"},{"type":"INSERT","lineNumber":729,"content":"    }"},{"type":"INSERT","lineNumber":730,"content":"}"},{"type":"INSERT","lineNumber":731,"content":""}]},{"timestamp":1757931634319,"changes":[{"type":"MODIFY","lineNumber":169,"content":"                        Log.i(\"MavlinkRepo\", \"COMMAND_ACK received: command=${ack.command} result=${ack.result} progress=${ack.progress} resultText=${ack.resultTLog.i(\"MavlinkRepo\", \"COMMAND_ACK received: command=${ack.command} result=${ack.result} progress=${ack.progress} resultText=${ack.resultText ?: \"\"}\")Log.i(\"MavlinkRepo\", \"COMMAND_ACK received: command=${ack.command} result=${ack.result} progress=${ack.progress} resultText=${ack.resultText ?: \"\"}\")ext}\")","oldContent":"                        Log.i(\"MavlinkRepo\", \"COMMAND_ACK received: command=${ack.command} result=${ack.result} progress=${ack.progress} resultText=${ack.resultTLog.i(\"MavlinkRepo\", \"COMMAND_ACK received: command=${ack.command} result=${ack.result} progress=${ack.progress} resultText=${ack.resultText ?: \"\"}\")ext}\")"},{"type":"DELETE","lineNumber":173,"oldContent":"        // Collectors"},{"type":"INSERT","lineNumber":174,"content":"        }"},{"type":"INSERT","lineNumber":176,"content":"        // Collectors"},{"type":"INSERT","lineNumber":177,"content":""},{"type":"DELETE","lineNumber":177,"oldContent":"        }"},{"type":"DELETE","lineNumber":179,"oldContent":""},{"type":"INSERT","lineNumber":298,"content":""},{"type":"DELETE","lineNumber":300,"oldContent":""},{"type":"MODIFY","lineNumber":303,"content":"            command = command.wrap(),","oldContent":"                                    targetSystem = fcuSystemId,"},{"type":"MODIFY","lineNumber":307,"content":"            param3 = param3,","oldContent":"                                    command = MavCmd.NAV_WAYPOINT.wrap(),"},{"type":"MODIFY","lineNumber":318,"content":"        } catch (e: Exception) {","oldContent":"                                    missionType = MavMissionType.MISSION.wrap()"},{"type":"MODIFY","lineNumber":321,"content":"        }","oldContent":"                                    connection.trySendUnsignedV2(gcsSystemId, gcsComponentId, missionItem)"},{"type":"INSERT","lineNumber":359,"content":"            altitude"},{"type":"DELETE","lineNumber":360,"oldContent":"        )"},{"type":"INSERT","lineNumber":364,"content":"        sendCommand(MavCmd.NAV_LAND)"},{"type":"DELETE","lineNumber":365,"oldContent":"    }"},{"type":"MODIFY","lineNumber":642,"content":"        } catch (e: Exception) {","oldContent":"        } catch (e: Exception) {"},{"type":"DELETE","lineNumber":644,"oldContent":"        val perAttemptTimeout = 1500L"},{"type":"MODIFY","lineNumber":647,"content":"        val perAttemptTimeout = 1500L","oldContent":""},{"type":"INSERT","lineNumber":648,"content":""},{"type":"INSERT","lineNumber":684,"content":"                    Log.e(\"MavlinkRepo\", \"Mission start rejected by FCU on attempt $attempt with result=$result\")"},{"type":"DELETE","lineNumber":686,"oldContent":"                    Log.e(\"MavlinkRepo\", \"Mission start rejected by FCU on attempt $attempt with result=$result\")"},{"type":"MODIFY","lineNumber":693,"content":"        }","oldContent":"        }"},{"type":"MODIFY","lineNumber":697,"content":"        // Fallback approach: set mission current and change mode to AUTO (many FCs start mission when switched to AUTO)","oldContent":"        // Fallback approach: set mission current and change mode to AUTO (many FCs start mission when switched to AUTO)"},{"type":"INSERT","lineNumber":709,"content":"            sendCommand(MavCmd.DO_SET_MODE, MavMode.AUTO.toFloat(), 0f)"},{"type":"INSERT","lineNumber":710,"content":"        } catch (e: Exception) {"},{"type":"INSERT","lineNumber":711,"content":"            Log.w(\"MavlinkRepo\", \"Fallback: Failed to send DO_SET_MODE\", e)"},{"type":"INSERT","lineNumber":712,"content":"        }"},{"type":"INSERT","lineNumber":713,"content":""},{"type":"INSERT","lineNumber":714,"content":"        // Wait for telemetry mode to reflect AUTO for a short period"},{"type":"INSERT","lineNumber":715,"content":"        val modeWaitMs = 5000L"},{"type":"INSERT","lineNumber":716,"content":"        val startWaitMode = System.currentTimeMillis()"},{"type":"DELETE","lineNumber":711,"oldContent":"            sendCommand(MavCmd.DO_SET_MODE, MavMode.AUTO.toFloat(), 0f)"},{"type":"DELETE","lineNumber":714,"oldContent":"        } catch (e: Exception) {"},{"type":"DELETE","lineNumber":717,"oldContent":"            Log.w(\"MavlinkRepo\", \"Fallback: Failed to send DO_SET_MODE\", e)"},{"type":"DELETE","lineNumber":721,"oldContent":"        }"},{"type":"DELETE","lineNumber":723,"oldContent":""},{"type":"DELETE","lineNumber":726,"oldContent":"        // Wait for telemetry mode to reflect AUTO for a short period"},{"type":"DELETE","lineNumber":729,"oldContent":"        val modeWaitMs = 5000L"},{"type":"DELETE","lineNumber":731,"oldContent":"        val startWaitMode = System.currentTimeMillis()"}]},{"timestamp":1757931677204,"changes":[{"type":"MODIFY","lineNumber":13,"content":"import kotlinx.coroutines.flow.*","oldContent":"import kotlinx.coroutines.delay"},{"type":"DELETE","lineNumber":43,"oldContent":"    private var fcuComponentId: UByte = 0u"},{"type":"DELETE","lineNumber":44,"oldContent":""},{"type":"DELETE","lineNumber":45,"oldContent":"    // Diagnostic info"},{"type":"DELETE","lineNumber":46,"oldContent":"    private val _lastFailure = MutableStateFlow<Throwable?>(null)"},{"type":"DELETE","lineNumber":47,"oldContent":"    val lastFailure: StateFlow<Throwable?> = _lastFailure.asStateFlow()"},{"type":"DELETE","lineNumber":48,"oldContent":""},{"type":"DELETE","lineNumber":49,"oldContent":"    // Connection"},{"type":"DELETE","lineNumber":50,"oldContent":"    private val connection = TcpClientMavConnection(host, port, CommonDialect).asCoroutine()"},{"type":"DELETE","lineNumber":51,"oldContent":""},{"type":"INSERT","lineNumber":152,"content":"                            setMessageRate(24u, 1f)  // GPS_RAW_INT"},{"type":"INSERT","lineNumber":153,"content":"                            setMessageRate(33u, 5f)  // GLOBAL_POSITION_INT"},{"type":"INSERT","lineNumber":154,"content":"                            setMessageRate(74u, 5f)  // VFR_HUD"},{"type":"INSERT","lineNumber":155,"content":"                            setMessageRate(147u, 1f) // BATTERY_STATUS"},{"type":"INSERT","lineNumber":156,"content":"                        }"},{"type":"INSERT","lineNumber":157,"content":"                    }"},{"type":"INSERT","lineNumber":158,"content":"                }"},{"type":"INSERT","lineNumber":159,"content":"        }"},{"type":"INSERT","lineNumber":160,"content":""},{"type":"DELETE","lineNumber":169,"oldContent":"                        Log.i(\"MavlinkRepo\", \"COMMAND_ACK received: command=${ack.command} result=${ack.result} progress=${ack.progress} resultText=${ack.resultTLog.i(\"MavlinkRepo\", \"COMMAND_ACK received: command=${ack.command} result=${ack.result} progress=${ack.progress} resultText=${ack.resultText ?: \"\"}\")Log.i(\"MavlinkRepo\", \"COMMAND_ACK received: command=${ack.command} result=${ack.result} progress=${ack.progress} resultText=${ack.resultText ?: \"\"}\")ext}\")"},{"type":"MODIFY","lineNumber":173,"content":"        }","oldContent":"        }"},{"type":"MODIFY","lineNumber":177,"content":"        // VFR_HUD","oldContent":"        // VFR_HUD"},{"type":"DELETE","lineNumber":190,"oldContent":"                .filter { state.value.fcuDetected && it.systemId == fcuSystemId }"},{"type":"DELETE","lineNumber":191,"oldContent":"                .map { it.message }"},{"type":"DELETE","lineNumber":192,"oldContent":"                .filterIsInstance<VfrHud>()"},{"type":"DELETE","lineNumber":193,"oldContent":"                .collect { hud ->"},{"type":"DELETE","lineNumber":194,"oldContent":"                    _state.update {"},{"type":"DELETE","lineNumber":195,"oldContent":"                        it.copy("},{"type":"DELETE","lineNumber":196,"oldContent":"                            altitudeMsl = hud.alt,"},{"type":"DELETE","lineNumber":197,"oldContent":"                            airspeed = hud.airspeed.takeIf { v -> v > 0f },"},{"type":"DELETE","lineNumber":198,"oldContent":"                            groundspeed = hud.groundspeed.takeIf { v -> v > 0f }"},{"type":"INSERT","lineNumber":285,"content":"        scope.launch {"},{"type":"INSERT","lineNumber":286,"content":"            mavFrameStream"},{"type":"INSERT","lineNumber":287,"content":"                .filter { state.value.fcuDetected && it.systemId == fcuSystemId }"},{"type":"INSERT","lineNumber":288,"content":"                .map { it.message }"},{"type":"INSERT","lineNumber":289,"content":"                .filterIsInstance<GpsRawInt>()"},{"type":"INSERT","lineNumber":290,"content":"                .collect { gps ->"},{"type":"INSERT","lineNumber":291,"content":"                    val sats = gps.satellitesVisible.toInt().takeIf { it >= 0 }"},{"type":"INSERT","lineNumber":292,"content":"                    val hdop = if (gps.eph.toUInt() == 0xFFFFu) null else gps.eph.toFloat() / 100f"},{"type":"INSERT","lineNumber":293,"content":"                    _state.update { it.copy(sats = sats, hdop = hdop) }"},{"type":"DELETE","lineNumber":361,"oldContent":"        )"},{"type":"DELETE","lineNumber":362,"oldContent":"        try {"},{"type":"INSERT","lineNumber":360,"content":"    }"},{"type":"INSERT","lineNumber":361,"content":""},{"type":"INSERT","lineNumber":640,"content":"            delay(200)"},{"type":"DELETE","lineNumber":642,"oldContent":"        } catch (e: Exception) {"},{"type":"INSERT","lineNumber":645,"content":"        val maxAttempts = 3"},{"type":"DELETE","lineNumber":648,"oldContent":"        val maxAttempts = 3"},{"type":"DELETE","lineNumber":674,"oldContent":"        } else {"},{"type":"INSERT","lineNumber":673,"content":"            }"},{"type":"INSERT","lineNumber":691,"content":"            }"},{"type":"DELETE","lineNumber":693,"oldContent":"        }"},{"type":"INSERT","lineNumber":695,"content":""},{"type":"DELETE","lineNumber":697,"oldContent":"        // Fallback approach: set mission current and change mode to AUTO (many FCs start mission when switched to AUTO)"},{"type":"DELETE","lineNumber":710,"oldContent":"        while (System.currentTimeMillis() - startWaitMode < modeWaitMs) {"},{"type":"DELETE","lineNumber":712,"oldContent":"            if (state.value.mode?.contains(\"Auto\", ignoreCase = true) == true) {"},{"type":"DELETE","lineNumber":715,"oldContent":"                Log.i(\"MavlinkRepo\", \"Fallback: Vehicle switched to AUTO mode\")"},{"type":"DELETE","lineNumber":717,"oldContent":"                // Give FC a moment to start the mission"},{"type":"DELETE","lineNumber":720,"oldContent":"                delay(500)"},{"type":"DELETE","lineNumber":722,"oldContent":"                return true"},{"type":"DELETE","lineNumber":723,"oldContent":"            }"},{"type":"DELETE","lineNumber":724,"oldContent":"            delay(200)"},{"type":"DELETE","lineNumber":725,"oldContent":"        }"},{"type":"DELETE","lineNumber":726,"oldContent":""},{"type":"DELETE","lineNumber":727,"oldContent":"        Log.e(\"MavlinkRepo\", \"Fallback start failed: vehicle did not switch to AUTO mode\")"},{"type":"DELETE","lineNumber":728,"oldContent":"        return false"},{"type":"DELETE","lineNumber":729,"oldContent":"    }"},{"type":"DELETE","lineNumber":730,"oldContent":"}"},{"type":"DELETE","lineNumber":731,"oldContent":""},{"type":"DELETE","lineNumber":732,"oldContent":"        val startWaitMode = System.currentTimeMillis()"},{"type":"DELETE","lineNumber":733,"oldContent":"            }"},{"type":"DELETE","lineNumber":735,"oldContent":"        } else {"},{"type":"DELETE","lineNumber":737,"oldContent":"        return ack"},{"type":"DELETE","lineNumber":739,"oldContent":""},{"type":"DELETE","lineNumber":741,"oldContent":"            Log.e(\"MavlinkRepo\", \"Mission start not acknowledged (timeout or NACK)\")"},{"type":"DELETE","lineNumber":743,"oldContent":"        Log.e(\"MavlinkRepo\", \"Mission start not acknowledged after $maxAttempts attempts\")"},{"type":"DELETE","lineNumber":745,"oldContent":""},{"type":"DELETE","lineNumber":747,"oldContent":"        return false"},{"type":"DELETE","lineNumber":750,"oldContent":"        }"},{"type":"DELETE","lineNumber":751,"oldContent":"    }"},{"type":"DELETE","lineNumber":753,"oldContent":"        return ack"},{"type":"DELETE","lineNumber":755,"oldContent":"                                    Log.e(\"MavlinkRepo\", \"Failed to send mission item(seq=$seq) as MissionItemInt\", e)"},{"type":"DELETE","lineNumber":758,"oldContent":"    }"},{"type":"DELETE","lineNumber":760,"oldContent":"}"},{"type":"DELETE","lineNumber":761,"oldContent":"}"},{"type":"DELETE","lineNumber":763,"oldContent":"            val expectedCount = withTimeoutOrNull(timeoutMs) { expectedCountDeferred.await() } ?: run {"},{"type":"DELETE","lineNumber":764,"oldContent":""},{"type":"DELETE","lineNumber":765,"oldContent":"            if (!firstRequestReceived) {"},{"type":"DELETE","lineNumber":766,"oldContent":"                Log.w(\"MavlinkRepo\", \"Did not receive MISSION_COUNT from FCU within timeout\")"},{"type":"DELETE","lineNumber":767,"oldContent":"                                }"},{"type":"DELETE","lineNumber":768,"oldContent":"                null"},{"type":"DELETE","lineNumber":769,"oldContent":""},{"type":"DELETE","lineNumber":770,"oldContent":"            }"},{"type":"DELETE","lineNumber":771,"oldContent":"                            }"},{"type":"DELETE","lineNumber":772,"oldContent":""},{"type":"DELETE","lineNumber":773,"oldContent":"            }"},{"type":"DELETE","lineNumber":774,"oldContent":"            // wait briefly for items"},{"type":"DELETE","lineNumber":775,"oldContent":"                            is MissionAck -> {"},{"type":"DELETE","lineNumber":776,"oldContent":"            delay(500)"},{"type":"DELETE","lineNumber":777,"oldContent":"                delay(100)"},{"type":"DELETE","lineNumber":778,"oldContent":"            job.cancel()"},{"type":"DELETE","lineNumber":779,"oldContent":"                                Log.i(\"MavlinkRepo\", \"Received MISSION_ACK from sys=$senderSys comp=$senderComp: ${msg.type}\")"},{"type":"DELETE","lineNumber":780,"oldContent":""},{"type":"DELETE","lineNumber":781,"oldContent":"            while (!firstRequestReceived && !ackDeferred.isCompleted && System.currentTimeMillis() - startWait < firstRequestTimeout) {"},{"type":"DELETE","lineNumber":782,"oldContent":"            Log.i(\"MavlinkRepo\", \"Mission readback complete: expected=$expectedCount items=${received.size}\")"},{"type":"DELETE","lineNumber":783,"oldContent":"                                if (!ackDeferred.isCompleted) ackDeferred.complete(true)"},{"type":"DELETE","lineNumber":784,"oldContent":"            received.sortedBy { it.first }.forEach { (seq, desc) -> Log.i(\"MavlinkRepo\", \"Item #$seq -> $desc\") }"},{"type":"DELETE","lineNumber":785,"oldContent":"            val startWait = System.currentTimeMillis()"},{"type":"DELETE","lineNumber":786,"oldContent":"                                return@collect"},{"type":"DELETE","lineNumber":787,"oldContent":"            Log.e(\"MavlinkRepo\", \"Error during mission readback\", e)"},{"type":"DELETE","lineNumber":788,"oldContent":"            val firstRequestTimeout = 2500L"},{"type":"DELETE","lineNumber":789,"oldContent":"                            }"},{"type":"DELETE","lineNumber":790,"oldContent":"            // Wait a short period for first request; if none, fallback to sending all items"},{"type":"DELETE","lineNumber":791,"oldContent":"                            else -> {"},{"type":"DELETE","lineNumber":792,"oldContent":""},{"type":"DELETE","lineNumber":793,"oldContent":"                                // ignore other messages"},{"type":"DELETE","lineNumber":794,"oldContent":"            }"},{"type":"DELETE","lineNumber":795,"oldContent":"                            }"},{"type":"DELETE","lineNumber":796,"oldContent":"                    }"},{"type":"DELETE","lineNumber":797,"oldContent":"                        }"}]},{"timestamp":1757931680990,"changes":[{"type":"MODIFY","lineNumber":11,"content":"import kotlinx.coroutines.CompletableDeferred","oldContent":"import com.google.android.gms.maps.model.LatLng"},{"type":"MODIFY","lineNumber":32,"content":"","oldContent":"    val lastFailure: StateFlow<Throwable?> = _lastFailure.asStateFlow()"},{"type":"INSERT","lineNumber":43,"content":"    fun start() {"},{"type":"INSERT","lineNumber":44,"content":"        val scope = AppScope"},{"type":"INSERT","lineNumber":45,"content":""},{"type":"INSERT","lineNumber":46,"content":"        suspend fun reconnect(scope: kotlinx.coroutines.CoroutineScope) {"},{"type":"INSERT","lineNumber":47,"content":"            while (scope.isActive) {"},{"type":"INSERT","lineNumber":48,"content":"                try {"},{"type":"INSERT","lineNumber":49,"content":"                    if (connection.tryConnect(scope)) {"},{"type":"INSERT","lineNumber":50,"content":"                        return // Exit on successful connection"},{"type":"INSERT","lineNumber":51,"content":"                    }"},{"type":"DELETE","lineNumber":144,"oldContent":"                            setMessageRate(24u, 1f)  // GPS_RAW_INT"},{"type":"DELETE","lineNumber":146,"oldContent":"                            setMessageRate(33u, 5f)  // GLOBAL_POSITION_INT"},{"type":"DELETE","lineNumber":148,"oldContent":"                            setMessageRate(74u, 5f)  // VFR_HUD"},{"type":"DELETE","lineNumber":150,"oldContent":"                            setMessageRate(147u, 1f) // BATTERY_STATUS"},{"type":"DELETE","lineNumber":152,"oldContent":"                        }"},{"type":"DELETE","lineNumber":154,"oldContent":"                    }"},{"type":"DELETE","lineNumber":156,"oldContent":"                }"},{"type":"DELETE","lineNumber":158,"oldContent":"        }"},{"type":"DELETE","lineNumber":160,"oldContent":""},{"type":"INSERT","lineNumber":169,"content":"                        Log.i(\"MavlinkRepo\", \"COMMAND_ACK received: command=${ack.command} result=${ack.result} progress=${ack.progress} resultText=${ack.resultTLog.i(\"MavlinkRepo\", \"COMMAND_ACK received: command=${ack.command} result=${ack.result} progress=${ack.progress} resultText=${ack.resultText ?: \"\"}\")Log.i(\"MavlinkRepo\", \"COMMAND_ACK received: command=${ack.command} result=${ack.result} progress=${ack.progress} resultText=${ack.resultText ?: \"\"}\")ext}\")"},{"type":"DELETE","lineNumber":172,"oldContent":"        }"},{"type":"INSERT","lineNumber":174,"content":"        }"},{"type":"DELETE","lineNumber":176,"oldContent":"        // VFR_HUD"},{"type":"INSERT","lineNumber":178,"content":"        // VFR_HUD"},{"type":"INSERT","lineNumber":190,"content":"                        )"},{"type":"INSERT","lineNumber":191,"content":"                    }"},{"type":"INSERT","lineNumber":192,"content":"                }"},{"type":"INSERT","lineNumber":193,"content":"        }"},{"type":"INSERT","lineNumber":194,"content":""},{"type":"INSERT","lineNumber":195,"content":"        // GLOBAL_POSITION_INT"},{"type":"INSERT","lineNumber":196,"content":"        scope.launch {"},{"type":"INSERT","lineNumber":197,"content":"            mavFrameStream"},{"type":"INSERT","lineNumber":198,"content":"                .filter { state.value.fcuDetected && it.systemId == fcuSystemId }"},{"type":"DELETE","lineNumber":275,"oldContent":"        scope.launch {"},{"type":"DELETE","lineNumber":277,"oldContent":"            mavFrameStream"},{"type":"DELETE","lineNumber":279,"oldContent":"                .filter { state.value.fcuDetected && it.systemId == fcuSystemId }"},{"type":"DELETE","lineNumber":281,"oldContent":"                .map { it.message }"},{"type":"DELETE","lineNumber":283,"oldContent":"                .filterIsInstance<GpsRawInt>()"},{"type":"DELETE","lineNumber":285,"oldContent":"                .collect { gps ->"},{"type":"DELETE","lineNumber":287,"oldContent":"                    val sats = gps.satellitesVisible.toInt().takeIf { it >= 0 }"},{"type":"DELETE","lineNumber":289,"oldContent":"                    val hdop = if (gps.eph.toUInt() == 0xFFFFu) null else gps.eph.toFloat() / 100f"},{"type":"DELETE","lineNumber":291,"oldContent":"                    _state.update { it.copy(sats = sats, hdop = hdop) }"},{"type":"DELETE","lineNumber":359,"oldContent":"    }"},{"type":"INSERT","lineNumber":361,"content":"    }"},{"type":"DELETE","lineNumber":509,"oldContent":"                            Log.i(\"MavlinkRepo\", \"Readback: MISSION_ITEM seq=${msg.seq} x=${msg.x} y=${msg.y} z=${msg.z}\")"},{"type":"DELETE","lineNumber":510,"oldContent":"                        is MissionItem -> {"},{"type":"DELETE","lineNumber":511,"oldContent":"                        }"},{"type":"DELETE","lineNumber":512,"oldContent":"                            received.add(msg.seq.toInt() to \"INT: lat=$lat lon=$lon alt=${msg.z}\")"},{"type":"DELETE","lineNumber":513,"oldContent":"                            Log.i(\"MavlinkRepo\", \"Readback: MISSION_ITEM_INT seq=${msg.seq} lat=$lat lon=$lon alt=${msg.z}\")"},{"type":"DELETE","lineNumber":514,"oldContent":"                            val lon = msg.y / 1e7"},{"type":"DELETE","lineNumber":515,"oldContent":"                            val lat = msg.x / 1e7"},{"type":"DELETE","lineNumber":516,"oldContent":"                        is MissionItemInt -> {"},{"type":"DELETE","lineNumber":517,"oldContent":"                        }"},{"type":"DELETE","lineNumber":518,"oldContent":"                            expectedCountDeferred.complete(msg.count.toInt())"},{"type":"DELETE","lineNumber":519,"oldContent":"                            Log.i(\"MavlinkRepo\", \"Readback: MISSION_COUNT=${msg.count} from sys=${frame.systemId}\")"},{"type":"DELETE","lineNumber":520,"oldContent":"                        is MissionCount -> {"},{"type":"DELETE","lineNumber":521,"oldContent":"                    when (val msg = frame.message) {"},{"type":"DELETE","lineNumber":522,"oldContent":"                connection.mavFrame.collect { frame ->"},{"type":"DELETE","lineNumber":523,"oldContent":"            val job = AppScope.launch {"},{"type":"DELETE","lineNumber":524,"oldContent":"            // collector"},{"type":"DELETE","lineNumber":525,"oldContent":"            val expectedCountDeferred = CompletableDeferred<Int?>()"},{"type":"DELETE","lineNumber":526,"oldContent":"            val received = mutableListOf<Pair<Int, String>>()"},{"type":"DELETE","lineNumber":527,"oldContent":"            return"},{"type":"DELETE","lineNumber":528,"oldContent":"            Log.w(\"MavlinkRepo\", \"FCU not detected; cannot request mission\")"},{"type":"DELETE","lineNumber":529,"oldContent":"    suspend fun requestMissionAndLog(timeoutMs: Long = 5000) {"},{"type":"INSERT","lineNumber":510,"content":"            val ackReceived = withTimeoutOrNull(timeoutMs) {"},{"type":"INSERT","lineNumber":511,"content":"                ackDeferred.await()"},{"type":"INSERT","lineNumber":512,"content":"            } ?: false"},{"type":"INSERT","lineNumber":513,"content":""},{"type":"INSERT","lineNumber":514,"content":"            // cancel collector and resend jobs"},{"type":"INSERT","lineNumber":515,"content":"            job.cancel()"},{"type":"INSERT","lineNumber":516,"content":"            resendJob.cancel()"},{"type":"INSERT","lineNumber":517,"content":""},{"type":"INSERT","lineNumber":518,"content":"            if (ackReceived) {"},{"type":"INSERT","lineNumber":519,"content":"                Log.i(\"MavlinkRepo\", \"Mission upload acknowledged by FCU\")"},{"type":"INSERT","lineNumber":520,"content":"                return true"},{"type":"INSERT","lineNumber":521,"content":"            } else {"},{"type":"INSERT","lineNumber":522,"content":"                Log.e(\"MavlinkRepo\", \"Mission upload timed out waiting for ACK\")"},{"type":"INSERT","lineNumber":523,"content":"                return false"},{"type":"INSERT","lineNumber":524,"content":"            }"},{"type":"INSERT","lineNumber":525,"content":"        } catch (e: Exception) {"},{"type":"INSERT","lineNumber":526,"content":"            Log.e(\"MavlinkRepo\", \"Mission upload failed\", e)"},{"type":"INSERT","lineNumber":527,"content":"            _lastFailure.value = e"},{"type":"INSERT","lineNumber":528,"content":"            return false"},{"type":"INSERT","lineNumber":529,"content":"        }"},{"type":"INSERT","lineNumber":530,"content":"    }"},{"type":"INSERT","lineNumber":531,"content":""},{"type":"DELETE","lineNumber":531,"oldContent":"    // New helper: request mission from FCU and log items for debugging"},{"type":"INSERT","lineNumber":577,"content":"                val req = MissionRequestList(targetSystem = fcuSystemId, targetComponent = fcuComponentId)"},{"type":"INSERT","lineNumber":578,"content":"                connection.trySendUnsignedV2(gcsSystemId, gcsComponentId, req)"},{"type":"INSERT","lineNumber":579,"content":"                Log.i(\"MavlinkRepo\", \"Sent MISSION_REQUEST_LIST to FCU\")"},{"type":"INSERT","lineNumber":580,"content":"            } catch (e: Exception) {"},{"type":"INSERT","lineNumber":581,"content":"                Log.e(\"MavlinkRepo\", \"Failed to send MISSION_REQUEST_LIST\", e)"},{"type":"INSERT","lineNumber":582,"content":"            }"},{"type":"DELETE","lineNumber":577,"oldContent":"}"},{"type":"DELETE","lineNumber":578,"oldContent":"        }"},{"type":"DELETE","lineNumber":579,"oldContent":"            _lastFailure.value = e"},{"type":"DELETE","lineNumber":580,"oldContent":""},{"type":"DELETE","lineNumber":581,"oldContent":"}"},{"type":"DELETE","lineNumber":582,"oldContent":"    }"},{"type":"DELETE","lineNumber":583,"oldContent":"        return ack"},{"type":"INSERT","lineNumber":584,"content":"            val expectedCount = withTimeoutOrNull(timeoutMs) { expectedCountDeferred.await() } ?: run {"},{"type":"DELETE","lineNumber":587,"oldContent":"        } else {"},{"type":"INSERT","lineNumber":588,"content":"            }"},{"type":"DELETE","lineNumber":590,"oldContent":"            Log.i(\"MavlinkRepo\", \"Mission start acknowledged by FCU\")"},{"type":"INSERT","lineNumber":591,"content":""},{"type":"DELETE","lineNumber":639,"oldContent":"            delay(200)"},{"type":"INSERT","lineNumber":641,"content":"            delay(200)"},{"type":"DELETE","lineNumber":644,"oldContent":"        val maxAttempts = 3"},{"type":"INSERT","lineNumber":646,"content":"        val maxAttempts = 3"},{"type":"MODIFY","lineNumber":655,"content":"            }","oldContent":"}"},{"type":"DELETE","lineNumber":672,"oldContent":"            }"},{"type":"INSERT","lineNumber":674,"content":"            }"},{"type":"DELETE","lineNumber":690,"oldContent":"            }"},{"type":"INSERT","lineNumber":692,"content":"            }"},{"type":"DELETE","lineNumber":694,"oldContent":""},{"type":"INSERT","lineNumber":696,"content":""},{"type":"INSERT","lineNumber":717,"content":"        while (System.currentTimeMillis() - startWaitMode < modeWaitMs) {"},{"type":"INSERT","lineNumber":718,"content":"            if (state.value.mode?.contains(\"Auto\", ignoreCase = true) == true) {"},{"type":"INSERT","lineNumber":719,"content":"                Log.i(\"MavlinkRepo\", \"Fallback: Vehicle switched to AUTO mode\")"},{"type":"INSERT","lineNumber":720,"content":"                // Give FC a moment to start the mission"},{"type":"INSERT","lineNumber":721,"content":"                delay(500)"},{"type":"INSERT","lineNumber":722,"content":"                return true"},{"type":"INSERT","lineNumber":723,"content":"            }"},{"type":"INSERT","lineNumber":724,"content":"            delay(200)"},{"type":"INSERT","lineNumber":725,"content":"        }"},{"type":"INSERT","lineNumber":726,"content":""},{"type":"INSERT","lineNumber":727,"content":"        Log.e(\"MavlinkRepo\", \"Fallback start failed: vehicle did not switch to AUTO mode\")"},{"type":"INSERT","lineNumber":728,"content":"        return false"},{"type":"INSERT","lineNumber":729,"content":"    }"},{"type":"INSERT","lineNumber":730,"content":"}"},{"type":"INSERT","lineNumber":731,"content":""}]},{"timestamp":1757931686548,"changes":[{"type":"INSERT","lineNumber":16,"content":"import kotlinx.coroutines.withTimeoutOrNull"},{"type":"DELETE","lineNumber":17,"oldContent":""},{"type":"DELETE","lineNumber":18,"oldContent":"    private val host: String,"},{"type":"DELETE","lineNumber":19,"oldContent":") {"},{"type":"DELETE","lineNumber":20,"oldContent":"    private var mission by mutableStateOf<List<LatLng>>(emptyList())"},{"type":"DELETE","lineNumber":21,"oldContent":"    private val gcsComponentId: UByte = 1u"},{"type":"INSERT","lineNumber":18,"content":"// MAVLink flight modes (ArduPilot values)"},{"type":"INSERT","lineNumber":19,"content":"object MavMode {"},{"type":"INSERT","lineNumber":20,"content":"    val AUTO: UInt = 3u"},{"type":"INSERT","lineNumber":21,"content":"    // Add other modes as needed"},{"type":"DELETE","lineNumber":44,"oldContent":"                    }"},{"type":"DELETE","lineNumber":46,"oldContent":"                } catch (e: Exception) {"},{"type":"DELETE","lineNumber":48,"oldContent":"                    Log.e(\"MavlinkRepo\", \"Connection attempt failed\", e)"},{"type":"DELETE","lineNumber":50,"oldContent":"                    _lastFailure.value = e"},{"type":"DELETE","lineNumber":52,"oldContent":"                }"},{"type":"DELETE","lineNumber":54,"oldContent":"                delay(1000)"},{"type":"DELETE","lineNumber":56,"oldContent":"            }"},{"type":"DELETE","lineNumber":58,"oldContent":"        }"},{"type":"INSERT","lineNumber":52,"content":"                } catch (e: Exception) {"},{"type":"INSERT","lineNumber":53,"content":"                    Log.e(\"MavlinkRepo\", \"Connection attempt failed\", e)"},{"type":"INSERT","lineNumber":54,"content":"                    _lastFailure.value = e"},{"type":"INSERT","lineNumber":55,"content":"                }"},{"type":"INSERT","lineNumber":56,"content":"                delay(1000)"},{"type":"INSERT","lineNumber":57,"content":"            }"},{"type":"INSERT","lineNumber":58,"content":"        }"},{"type":"INSERT","lineNumber":151,"content":"                            setMessageRate(1u, 1f)   // SYS_STATUS"},{"type":"MODIFY","lineNumber":169,"content":"                        ```kotlin","oldContent":"                        Log.i(\"MavlinkRepo\", \"COMMAND_ACK received: command=${ack.command} result=${ack.result} progress=${ack.progress} resultText=${ack.resultTLog.i(\"MavlinkRepo\", \"COMMAND_ACK received: command=${ack.command} result=${ack.result} progress=${ack.progress} resultText=${ack.resultText ?: \"\"}\")Log.i(\"MavlinkRepo\", \"COMMAND_ACK received: command=${ack.command} result=${ack.result} progress=${ack.progress} resultText=${ack.resultText ?: \"\"}\")ext}\")"},{"type":"INSERT","lineNumber":170,"content":"                        Log.i(\"MavlinkRepo\", \"COMMAND_ACK received: command=${ack.command} result=${ack.result} progress=${ack.progress} resultText=${ack.resultText ?: \"\"}\")"},{"type":"INSERT","lineNumber":171,"content":"                        ```"},{"type":"DELETE","lineNumber":190,"oldContent":"                .filter { state.value.fcuDetected && it.systemId == fcuSystemId }"},{"type":"DELETE","lineNumber":192,"oldContent":"                .map { it.message }"},{"type":"DELETE","lineNumber":194,"oldContent":"                .filterIsInstance<GlobalPositionInt>()"},{"type":"DELETE","lineNumber":196,"oldContent":"                .collect { gp ->"},{"type":"DELETE","lineNumber":198,"oldContent":"                    val altAMSLm = gp.alt / 1000f"},{"type":"DELETE","lineNumber":200,"oldContent":"                    val relAltM = gp.relativeAlt / 1000f"},{"type":"DELETE","lineNumber":202,"oldContent":"                    val lat = gp.lat.takeIf { it != Int.MIN_VALUE }?.let { it / 10_000_000.0 }"},{"type":"DELETE","lineNumber":204,"oldContent":"                    val lon = gp.lon.takeIf { it != Int.MIN_VALUE }?.let { it / 10_000_000.0 }"},{"type":"DELETE","lineNumber":206,"oldContent":"                    _state.update {"},{"type":"INSERT","lineNumber":201,"content":"                .map { it.message }"},{"type":"INSERT","lineNumber":202,"content":"                .filterIsInstance<GlobalPositionInt>()"},{"type":"INSERT","lineNumber":203,"content":"                .collect { gp ->"},{"type":"INSERT","lineNumber":204,"content":"                    val altAMSLm = gp.alt / 1000f"},{"type":"INSERT","lineNumber":205,"content":"                    val relAltM = gp.relativeAlt / 1000f"},{"type":"INSERT","lineNumber":206,"content":"                    val lat = gp.lat.takeIf { it != Int.MIN_VALUE }?.let { it / 10_000_000.0 }"},{"type":"INSERT","lineNumber":207,"content":"                    val lon = gp.lon.takeIf { it != Int.MIN_VALUE }?.let { it / 10_000_000.0 }"},{"type":"INSERT","lineNumber":208,"content":"                    _state.update {"},{"type":"INSERT","lineNumber":296,"content":"                    _state.update { it.copy(sats = sats, hdop = hdop) }"},{"type":"DELETE","lineNumber":312,"oldContent":"                                    param1 = 0f,"},{"type":"INSERT","lineNumber":314,"content":"        )"},{"type":"DELETE","lineNumber":314,"oldContent":"                                    param4 = 0f,"},{"type":"INSERT","lineNumber":316,"content":"            connection.trySendUnsignedV2("},{"type":"DELETE","lineNumber":342,"oldContent":"        val commandLong = CommandLong("},{"type":"INSERT","lineNumber":344,"content":"    suspend fun changeMode(mode: UInt) {"},{"type":"DELETE","lineNumber":345,"oldContent":"            confirmation = 0u,"},{"type":"INSERT","lineNumber":347,"content":"            mode.toFloat(),"},{"type":"DELETE","lineNumber":531,"oldContent":"            job.cancel()"},{"type":"INSERT","lineNumber":534,"content":"    // New helper: request mission from FCU and log items for debugging"},{"type":"DELETE","lineNumber":571,"oldContent":"}"},{"type":"DELETE","lineNumber":572,"oldContent":"    }"},{"type":"DELETE","lineNumber":573,"oldContent":"        return ack"},{"type":"DELETE","lineNumber":574,"oldContent":"        }"},{"type":"DELETE","lineNumber":575,"oldContent":"            Log.e(\"MavlinkRepo\", \"Mission start not acknowledged (timeout or NACK)\")"},{"type":"DELETE","lineNumber":576,"oldContent":"        } else {"},{"type":"DELETE","lineNumber":577,"oldContent":"            Log.i(\"MavlinkRepo\", \"Mission start acknowledged by FCU\")"},{"type":"INSERT","lineNumber":573,"content":"                    }"},{"type":"INSERT","lineNumber":574,"content":"                }"},{"type":"INSERT","lineNumber":575,"content":"            }"},{"type":"INSERT","lineNumber":576,"content":""},{"type":"INSERT","lineNumber":577,"content":"            // send request list"},{"type":"INSERT","lineNumber":578,"content":"            try {"},{"type":"INSERT","lineNumber":585,"content":""},{"type":"DELETE","lineNumber":655,"oldContent":"            Log.i(\"MavlinkRepo\", \"Mission start acknowledged by FCU\")"},{"type":"INSERT","lineNumber":658,"content":""},{"type":"DELETE","lineNumber":681,"oldContent":""},{"type":"INSERT","lineNumber":683,"content":"                    Log.i(\"MavlinkRepo\", \"Mission start acknowledged by FCU on attempt $attempt\")"},{"type":"DELETE","lineNumber":717,"oldContent":""},{"type":"DELETE","lineNumber":719,"oldContent":"}"},{"type":"DELETE","lineNumber":721,"oldContent":"    }"},{"type":"DELETE","lineNumber":723,"oldContent":"        return false"},{"type":"DELETE","lineNumber":725,"oldContent":"        Log.e(\"MavlinkRepo\", \"Fallback start failed: vehicle did not switch to AUTO mode\")"},{"type":"DELETE","lineNumber":727,"oldContent":""},{"type":"DELETE","lineNumber":729,"oldContent":"        }"},{"type":"INSERT","lineNumber":727,"content":"        }"},{"type":"INSERT","lineNumber":728,"content":""},{"type":"INSERT","lineNumber":729,"content":"        Log.e(\"MavlinkRepo\", \"Fallback start failed: vehicle did not switch to AUTO mode\")"},{"type":"INSERT","lineNumber":730,"content":"        return false"},{"type":"INSERT","lineNumber":731,"content":"    }"},{"type":"INSERT","lineNumber":732,"content":"}"},{"type":"INSERT","lineNumber":733,"content":""}]},{"timestamp":1757931689990,"changes":[{"type":"DELETE","lineNumber":24,"oldContent":"    private val gcsSystemId: UByte = 200u"},{"type":"DELETE","lineNumber":25,"oldContent":"    private val gcsComponentId: UByte = 1u"},{"type":"DELETE","lineNumber":26,"oldContent":"    val state: StateFlow<TelemetryState> = _state.asStateFlow()"},{"type":"INSERT","lineNumber":24,"content":"class MavlinkTelemetryRepository("},{"type":"INSERT","lineNumber":25,"content":"    private val host: String,"},{"type":"INSERT","lineNumber":26,"content":"    private val port: Int"},{"type":"INSERT","lineNumber":48,"content":"                try {"},{"type":"INSERT","lineNumber":49,"content":"                    if (connection.tryConnect(scope)) {"},{"type":"INSERT","lineNumber":50,"content":"                        return // Exit on successful connection"},{"type":"INSERT","lineNumber":51,"content":"                    }"},{"type":"DELETE","lineNumber":50,"oldContent":"                try {"},{"type":"DELETE","lineNumber":53,"oldContent":"                    if (connection.tryConnect(scope)) {"},{"type":"DELETE","lineNumber":56,"oldContent":"                        return // Exit on successful connection"},{"type":"DELETE","lineNumber":58,"oldContent":"                    }"},{"type":"MODIFY","lineNumber":151,"content":"                            setMessageRate(1u, 1f)   // SYS_STATUS","oldContent":"                            setMessageRate(1u, 1f)   // SYS_STATUS"},{"type":"MODIFY","lineNumber":169,"content":"                        ","oldContent":"                        ```kotlin"},{"type":"MODIFY","lineNumber":172,"content":"                    } catch (t: Throwable) {","oldContent":"                    } catch (t: Throwable) {"},{"type":"DELETE","lineNumber":197,"oldContent":"                .map { it.message }"},{"type":"INSERT","lineNumber":198,"content":"        scope.launch {"},{"type":"INSERT","lineNumber":199,"content":"            mavFrameStream"},{"type":"INSERT","lineNumber":200,"content":"                .filter { state.value.fcuDetected && it.systemId == fcuSystemId }"},{"type":"INSERT","lineNumber":201,"content":"                .map { it.message }"},{"type":"DELETE","lineNumber":201,"oldContent":"        scope.launch {"},{"type":"DELETE","lineNumber":204,"oldContent":"            mavFrameStream"},{"type":"DELETE","lineNumber":207,"oldContent":"                .filter { state.value.fcuDetected && it.systemId == fcuSystemId }"},{"type":"MODIFY","lineNumber":297,"content":"                }","oldContent":"                }"},{"type":"DELETE","lineNumber":314,"oldContent":"        try {"},{"type":"DELETE","lineNumber":316,"oldContent":"               gcsSystemId,"},{"type":"INSERT","lineNumber":315,"content":"        try {"},{"type":"INSERT","lineNumber":317,"content":"               gcsSystemId,"},{"type":"MODIFY","lineNumber":345,"content":"        sendCommand(","oldContent":"        sendCommand("},{"type":"MODIFY","lineNumber":348,"content":"            0f","oldContent":"            0f"},{"type":"INSERT","lineNumber":395,"content":"            val sentSeqs = mutableSetOf<Int>()"},{"type":"INSERT","lineNumber":396,"content":"            var firstRequestReceived = false"},{"type":"DELETE","lineNumber":396,"oldContent":"        sendCommand("},{"type":"DELETE","lineNumber":397,"oldContent":"            mode.value.toFloat(),"},{"type":"MODIFY","lineNumber":398,"content":"            // Resend MISSION_COUNT periodically until first request or timeout","oldContent":"        )"},{"type":"INSERT","lineNumber":399,"content":"            val resendJob = AppScope.launch {"},{"type":"INSERT","lineNumber":400,"content":"                while (isActive && !firstRequestReceived && !ackDeferred.isCompleted) {"},{"type":"INSERT","lineNumber":401,"content":"                    try {"},{"type":"INSERT","lineNumber":402,"content":"                        connection.trySendUnsignedV2(gcsSystemId, gcsComponentId, missionCount)"},{"type":"INSERT","lineNumber":403,"content":"                        Log.d(\"MavlinkRepo\", \"Resent MISSION_COUNT\")"},{"type":"INSERT","lineNumber":404,"content":"                    } catch (e: Exception) {"},{"type":"INSERT","lineNumber":405,"content":"                        Log.e(\"MavlinkRepo\", \"Failed to resend MISSION_COUNT\", e)"},{"type":"INSERT","lineNumber":406,"content":"                    }"},{"type":"INSERT","lineNumber":407,"content":"                    delay(700)"},{"type":"INSERT","lineNumber":408,"content":"                }"},{"type":"INSERT","lineNumber":409,"content":"            }"},{"type":"DELETE","lineNumber":400,"oldContent":"        sendCommand("},{"type":"DELETE","lineNumber":401,"oldContent":"            -1f,"},{"type":"DELETE","lineNumber":402,"oldContent":"            0f,"},{"type":"DELETE","lineNumber":403,"oldContent":"            0f,"},{"type":"DELETE","lineNumber":404,"oldContent":"            altitude"},{"type":"DELETE","lineNumber":405,"oldContent":"    }"},{"type":"DELETE","lineNumber":406,"oldContent":"    suspend fun land() {"},{"type":"DELETE","lineNumber":407,"oldContent":"    }"},{"type":"DELETE","lineNumber":408,"oldContent":"    suspend fun loadMission(waypoints: List<LatLng>) {"},{"type":"DELETE","lineNumber":409,"oldContent":"        mission = waypoints"},{"type":"DELETE","lineNumber":410,"oldContent":"            targetSystem = fcuSystemId,"},{"type":"DELETE","lineNumber":411,"oldContent":"            count = mission.size.toUShort(),"},{"type":"DELETE","lineNumber":412,"oldContent":"            missionType = MavMissionType.MISSION.wrap()"},{"type":"DELETE","lineNumber":413,"oldContent":"        try {"},{"type":"DELETE","lineNumber":414,"oldContent":"        } catch (e: Exception) {"},{"type":"DELETE","lineNumber":415,"oldContent":"            Log.e(\"MavlinkRepo\", \"Failed to send mission count\", e)"},{"type":"DELETE","lineNumber":416,"oldContent":"        }"},{"type":"DELETE","lineNumber":417,"oldContent":""},{"type":"DELETE","lineNumber":418,"oldContent":"    suspend fun startMission() {"},{"type":"DELETE","lineNumber":419,"oldContent":"    }"},{"type":"DELETE","lineNumber":420,"oldContent":""},{"type":"INSERT","lineNumber":411,"content":"            // Collector job"},{"type":"INSERT","lineNumber":412,"content":"            val job = AppScope.launch {"},{"type":"INSERT","lineNumber":413,"content":"                connection.mavFrame"},{"type":"INSERT","lineNumber":414,"content":"                    //.filter { it.systemId == fcuSystemId }"},{"type":"INSERT","lineNumber":415,"content":"                    .collect { frame ->"},{"type":"INSERT","lineNumber":416,"content":"                        val senderSys = frame.systemId"},{"type":"INSERT","lineNumber":417,"content":"                        val senderComp = frame.componentId"},{"type":"INSERT","lineNumber":418,"content":"                        when (val msg = frame.message) {"},{"type":"INSERT","lineNumber":419,"content":"                            is MissionRequestInt -> {"},{"type":"INSERT","lineNumber":420,"content":"                                Log.d(\"MavlinkRepo\", \"Received MissionRequestInt from sys=$senderSys comp=$senderComp seq=${msg.seq}\")"},{"type":"DELETE","lineNumber":424,"oldContent":""},{"type":"DELETE","lineNumber":425,"oldContent":"            delay(500)"},{"type":"DELETE","lineNumber":426,"oldContent":""},{"type":"DELETE","lineNumber":427,"oldContent":"                connection.trySendUnsignedV2(gcsSystemId, gcsComponentId, req)"},{"type":"DELETE","lineNumber":428,"oldContent":"            // send request list"},{"type":"DELETE","lineNumber":429,"oldContent":""},{"type":"INSERT","lineNumber":424,"content":"                                    Log.w(\"MavlinkRepo\", \"FC requested invalid seq=$seq (MissionRequestInt)\")"},{"type":"INSERT","lineNumber":425,"content":"                                    return@collect"},{"type":"INSERT","lineNumber":426,"content":"                                }"},{"type":"INSERT","lineNumber":427,"content":"                                val item = missionItems[seq]"},{"type":"INSERT","lineNumber":428,"content":"                                val missionItem = item.copy("},{"type":"INSERT","lineNumber":429,"content":"                                    targetSystem = senderSys.toUByte(),"},{"type":"MODIFY","lineNumber":535,"content":"    @Suppress(\"DEPRECATION\")","oldContent":"    @Suppress(\"DEPRECATION\")"},{"type":"MODIFY","lineNumber":586,"content":"            val expectedCount = withTimeoutOrNull(timeoutMs) { expectedCountDeferred.await() } ?: run {","oldContent":"            val expectedCount = withTimeoutOrNull(timeoutMs) { expectedCountDeferred.await() } ?: run {"},{"type":"MODIFY","lineNumber":659,"content":"            // wait for COMMAND_ACK for MISSION_START","oldContent":"            // wait for COMMAND_ACK for MISSION_START"},{"type":"MODIFY","lineNumber":684,"content":"                    return true","oldContent":"                    return true"},{"type":"INSERT","lineNumber":724,"content":"                return true"},{"type":"INSERT","lineNumber":725,"content":"            }"},{"type":"INSERT","lineNumber":726,"content":"            delay(200)"},{"type":"DELETE","lineNumber":726,"oldContent":"                return true"},{"type":"DELETE","lineNumber":729,"oldContent":"            }"},{"type":"DELETE","lineNumber":731,"oldContent":"            delay(200)"}]},{"timestamp":1757931692498,"changes":[{"type":"MODIFY","lineNumber":22,"content":"}","oldContent":"    private val gcsSystemId: UByte = 200u"},{"type":"DELETE","lineNumber":49,"oldContent":"                } catch (e: Exception) {"},{"type":"DELETE","lineNumber":51,"oldContent":"                    Log.e(\"MavlinkRepo\", \"Connection attempt failed\", e)"},{"type":"INSERT","lineNumber":52,"content":"                } catch (e: Exception) {"},{"type":"INSERT","lineNumber":53,"content":"                    Log.e(\"MavlinkRepo\", \"Connection attempt failed\", e)"},{"type":"INSERT","lineNumber":150,"content":""},{"type":"DELETE","lineNumber":151,"oldContent":"                            setMessageRate(1u, 1f)   // SYS_STATUS"},{"type":"INSERT","lineNumber":171,"content":"                     "},{"type":"DELETE","lineNumber":172,"oldContent":"                    } catch (t: Throwable) {"},{"type":"MODIFY","lineNumber":198,"content":"        scope.launch {","oldContent":"        scope.launch {"},{"type":"DELETE","lineNumber":200,"oldContent":"                .filterIsInstance<GlobalPositionInt>()"},{"type":"MODIFY","lineNumber":202,"content":"                .filterIsInstance<GlobalPositionInt>()","oldContent":"                .collect { gp ->"},{"type":"INSERT","lineNumber":203,"content":"                .collect { gp ->"},{"type":"INSERT","lineNumber":296,"content":"                    _state.update { it.copy(sats = sats, hdop = hdop) }"},{"type":"DELETE","lineNumber":297,"oldContent":"                }"},{"type":"DELETE","lineNumber":313,"oldContent":"                                    param1 = 0f,"},{"type":"DELETE","lineNumber":314,"oldContent":"        try {"},{"type":"INSERT","lineNumber":313,"content":"            param7 = param7"},{"type":"DELETE","lineNumber":316,"oldContent":"               gcsSystemId,"},{"type":"INSERT","lineNumber":315,"content":"        try {"},{"type":"INSERT","lineNumber":317,"content":"               gcsSystemId,"},{"type":"MODIFY","lineNumber":343,"content":"","oldContent":"        val commandLong = CommandLong("},{"type":"INSERT","lineNumber":344,"content":"    suspend fun changeMode(mode: UInt) {"},{"type":"DELETE","lineNumber":345,"oldContent":"        sendCommand("},{"type":"INSERT","lineNumber":347,"content":"            mode.toFloat(),"},{"type":"DELETE","lineNumber":348,"oldContent":"            0f"},{"type":"DELETE","lineNumber":369,"oldContent":"                MavCmd.COMPONENT_ARM_DISARM,"},{"type":"DELETE","lineNumber":370,"oldContent":"            )"},{"type":"DELETE","lineNumber":371,"oldContent":"            Log.w(\"MavlinkRepo\", \"Arm command rejected, vehicle not armable\")"},{"type":"DELETE","lineNumber":372,"oldContent":"    }"},{"type":"INSERT","lineNumber":369,"content":"    /**"},{"type":"INSERT","lineNumber":370,"content":"     * Uploads a mission using the MAVLink mission protocol handshake."},{"type":"INSERT","lineNumber":371,"content":"     * Returns true if ACK received, false otherwise."},{"type":"INSERT","lineNumber":372,"content":"     */"},{"type":"DELETE","lineNumber":374,"oldContent":"    suspend fun disarm() {"},{"type":"DELETE","lineNumber":375,"oldContent":"            MavCmd.COMPONENT_ARM_DISARM,"},{"type":"DELETE","lineNumber":376,"oldContent":"        )"},{"type":"DELETE","lineNumber":377,"oldContent":""},{"type":"INSERT","lineNumber":374,"content":"    suspend fun uploadMissionWithAck(missionItems: List<MissionItemInt>, timeoutMs: Long = 15000): Boolean {"},{"type":"INSERT","lineNumber":375,"content":"        if (!state.value.fcuDetected) {"},{"type":"INSERT","lineNumber":376,"content":"            Log.e(\"MavlinkRepo\", \"FCU not detected, cannot upload mission\")"},{"type":"INSERT","lineNumber":377,"content":"            throw IllegalStateException(\"FCU not detected\")"},{"type":"DELETE","lineNumber":396,"oldContent":"            MavCmd.NAV_TAKEOFF,"},{"type":"INSERT","lineNumber":397,"content":""},{"type":"DELETE","lineNumber":400,"oldContent":"            0f,"},{"type":"INSERT","lineNumber":410,"content":""},{"type":"INSERT","lineNumber":534,"content":"    // New helper: request mission from FCU and log items for debugging"},{"type":"DELETE","lineNumber":535,"oldContent":"    @Suppress(\"DEPRECATION\")"},{"type":"DELETE","lineNumber":569,"oldContent":"        val ackDeferred = CompletableDeferred<Boolean>()"},{"type":"DELETE","lineNumber":570,"oldContent":"        }"},{"type":"DELETE","lineNumber":571,"oldContent":"            _lastFailure.value = e"},{"type":"DELETE","lineNumber":572,"oldContent":"    suspend fun startMission(first: Int, last: Int): Boolean {"},{"type":"INSERT","lineNumber":569,"content":"                        is MissionAck -> {"},{"type":"INSERT","lineNumber":570,"content":"                            Log.i(\"MavlinkRepo\", \"Readback: MISSION_ACK type=${msg.type}\")"},{"type":"INSERT","lineNumber":571,"content":"                        }"},{"type":"INSERT","lineNumber":572,"content":"                        else -> {}"},{"type":"INSERT","lineNumber":585,"content":""},{"type":"DELETE","lineNumber":586,"oldContent":"            val expectedCount = withTimeoutOrNull(timeoutMs) { expectedCountDeferred.await() } ?: run {"},{"type":"INSERT","lineNumber":658,"content":""},{"type":"DELETE","lineNumber":659,"oldContent":"            // wait for COMMAND_ACK for MISSION_START"},{"type":"MODIFY","lineNumber":682,"content":"                if (result == 0u) {","oldContent":"}"},{"type":"INSERT","lineNumber":683,"content":"                    Log.i(\"MavlinkRepo\", \"Mission start acknowledged by FCU on attempt $attempt\")"},{"type":"DELETE","lineNumber":684,"oldContent":"                    return true"},{"type":"DELETE","lineNumber":692,"oldContent":""},{"type":"DELETE","lineNumber":693,"oldContent":"    }"},{"type":"INSERT","lineNumber":692,"content":"                // try again after short delay"},{"type":"INSERT","lineNumber":693,"content":"                delay(500L)"},{"type":"DELETE","lineNumber":725,"oldContent":"        }"},{"type":"MODIFY","lineNumber":727,"content":"        }","oldContent":""},{"type":"INSERT","lineNumber":728,"content":""}]},{"timestamp":1757931715671,"changes":[{"type":"INSERT","lineNumber":29,"content":"    private val gcsComponentId: UByte = 1u"},{"type":"INSERT","lineNumber":30,"content":"    private val _state = MutableStateFlow(TelemetryState())"},{"type":"INSERT","lineNumber":31,"content":"    val state: StateFlow<TelemetryState> = _state.asStateFlow()"},{"type":"DELETE","lineNumber":30,"oldContent":"    private val _lastFailure = MutableStateFlow<Throwable?>(null)"},{"type":"DELETE","lineNumber":31,"oldContent":""},{"type":"DELETE","lineNumber":32,"oldContent":""},{"type":"MODIFY","lineNumber":33,"content":"    private var fcuSystemId: UByte = 0u","oldContent":""},{"type":"DELETE","lineNumber":50,"oldContent":"                } catch (e: Exception) {"},{"type":"MODIFY","lineNumber":52,"content":"                } catch (e: Exception) {","oldContent":"                    Log.e(\"MavlinkRepo\", \"Connection attempt failed\", e)"},{"type":"INSERT","lineNumber":53,"content":"                    Log.e(\"MavlinkRepo\", \"Connection attempt failed\", e)"},{"type":"INSERT","lineNumber":59,"content":""},{"type":"INSERT","lineNumber":60,"content":"        // Manage connection state + reconnects"},{"type":"INSERT","lineNumber":61,"content":"        scope.launch {"},{"type":"INSERT","lineNumber":62,"content":"            reconnect(this) // Initial connection attempt"},{"type":"INSERT","lineNumber":63,"content":"            connection.streamState.collect { st ->"},{"type":"INSERT","lineNumber":64,"content":"                when (st) {"},{"type":"DELETE","lineNumber":150,"oldContent":""},{"type":"DELETE","lineNumber":151,"oldContent":"                            setMessageRate(1u, 1f)   // SYS_STATUS"},{"type":"DELETE","lineNumber":152,"oldContent":"                            setMessageRate(24u, 1f)  // GPS_RAW_INT"},{"type":"DELETE","lineNumber":153,"oldContent":"                            setMessageRate(33u, 5f)  // GLOBAL_POSITION_INT"},{"type":"DELETE","lineNumber":154,"oldContent":"                            setMessageRate(74u, 5f)  // VFR_HUD"},{"type":"DELETE","lineNumber":155,"oldContent":"                            setMessageRate(147u, 1f) // BATTERY_STATUS"},{"type":"DELETE","lineNumber":169,"oldContent":"                        "},{"type":"DELETE","lineNumber":170,"oldContent":"                        Log.i(\"MavlinkRepo\", \"COMMAND_ACK received: command=${ack.command} result=${ack.result} progress=${ack.progress} resultText=${ack.resultText ?: \"\"}\")"},{"type":"DELETE","lineNumber":171,"oldContent":"                     "},{"type":"INSERT","lineNumber":169,"content":""},{"type":"INSERT","lineNumber":170,"content":"                        val i = Log.i("},{"type":"INSERT","lineNumber":171,"content":"                            \"MavlinkRepo\","},{"type":"INSERT","lineNumber":172,"content":"                            \"COMMAND_ACK received: command=${ack.command} result=${ack.result} progress=${ack.progress} resultText=${ack.resultText ?: \"\"}\""},{"type":"INSERT","lineNumber":173,"content":"                        )"},{"type":"INSERT","lineNumber":174,"content":""},{"type":"INSERT","lineNumber":200,"content":"        // GLOBAL_POSITION_INT"},{"type":"DELETE","lineNumber":198,"oldContent":"        scope.launch {"},{"type":"INSERT","lineNumber":204,"content":"                .map { it.message }"},{"type":"DELETE","lineNumber":203,"oldContent":"                .map { it.message }"},{"type":"INSERT","lineNumber":212,"content":"                        it.copy("},{"type":"INSERT","lineNumber":213,"content":"                            altitudeMsl = altAMSLm,"},{"type":"INSERT","lineNumber":214,"content":"                            altitudeRelative = relAltM,"},{"type":"INSERT","lineNumber":215,"content":"                            latitude = lat,"},{"type":"INSERT","lineNumber":216,"content":"                            longitude = lon"},{"type":"INSERT","lineNumber":217,"content":"                        )"},{"type":"DELETE","lineNumber":293,"oldContent":""},{"type":"DELETE","lineNumber":294,"oldContent":"        // Mission handling"},{"type":"DELETE","lineNumber":295,"oldContent":"        scope.launch {"},{"type":"DELETE","lineNumber":296,"oldContent":"                    _state.update { it.copy(sats = sats, hdop = hdop) }"},{"type":"DELETE","lineNumber":297,"oldContent":"                }"},{"type":"DELETE","lineNumber":298,"oldContent":"        }"},{"type":"DELETE","lineNumber":314,"oldContent":"        try {"},{"type":"DELETE","lineNumber":316,"oldContent":"               gcsSystemId,"},{"type":"INSERT","lineNumber":318,"content":"        try {"},{"type":"INSERT","lineNumber":320,"content":"               gcsSystemId,"},{"type":"DELETE","lineNumber":389,"oldContent":"    suspend fun changeMode(mode: MavMode) {"},{"type":"DELETE","lineNumber":390,"oldContent":"        sendCommand("},{"type":"DELETE","lineNumber":391,"oldContent":"            mode.value.toFloat(),"},{"type":"DELETE","lineNumber":392,"oldContent":"        )"},{"type":"DELETE","lineNumber":393,"oldContent":"    }"},{"type":"DELETE","lineNumber":394,"oldContent":"    suspend fun takeoff(altitude: Float) {"},{"type":"DELETE","lineNumber":395,"oldContent":"            val sentSeqs = mutableSetOf<Int>()"},{"type":"INSERT","lineNumber":392,"content":"                count = missionItems.size.toUShort()"},{"type":"INSERT","lineNumber":393,"content":"            )"},{"type":"INSERT","lineNumber":394,"content":"            connection.trySendUnsignedV2(gcsSystemId, gcsComponentId, missionCount)"},{"type":"INSERT","lineNumber":395,"content":"            Log.i(\"MavlinkRepo\", \"Sent MISSION_COUNT=${missionItems.size}\")"},{"type":"INSERT","lineNumber":397,"content":"            val ackDeferred = CompletableDeferred<Boolean>()"},{"type":"INSERT","lineNumber":398,"content":"            val sentSeqs = mutableSetOf<Int>()"},{"type":"INSERT","lineNumber":400,"content":""},{"type":"DELETE","lineNumber":409,"oldContent":""},{"type":"INSERT","lineNumber":413,"content":""},{"type":"DELETE","lineNumber":430,"oldContent":"        }"},{"type":"DELETE","lineNumber":431,"oldContent":"            Log.e(\"MavlinkRepo\", \"Failed to send MISSION_START\", e)"},{"type":"DELETE","lineNumber":432,"oldContent":"                        }"},{"type":"INSERT","lineNumber":433,"content":"                                    targetComponent = senderComp.toUByte(),"},{"type":"INSERT","lineNumber":434,"content":"                                    seq = seq.toUShort()"},{"type":"INSERT","lineNumber":435,"content":"                                )"},{"type":"DELETE","lineNumber":435,"oldContent":"                        }"},{"type":"DELETE","lineNumber":436,"oldContent":"                            Log.i(\"MavlinkRepo\", \"Readback: MISSION_ITEM seq=${msg.seq} x=${msg.x} y=${msg.y} z=${msg.z}\")"},{"type":"DELETE","lineNumber":437,"oldContent":"                        is MissionItem -> {"},{"type":"DELETE","lineNumber":438,"oldContent":"                            received.add(msg.seq.toInt() to \"INT: lat=$lat lon=$lon alt=${msg.z}\")"},{"type":"DELETE","lineNumber":439,"oldContent":"                            Log.i(\"MavlinkRepo\", \"Readback: MISSION_ITEM_INT seq=${msg.seq} lat=$lat lon=$lon alt=${msg.z}\")"},{"type":"DELETE","lineNumber":440,"oldContent":"                            val lat = msg.x / 1e7"},{"type":"INSERT","lineNumber":438,"content":"                                    connection.trySendUnsignedV2(gcsSystemId, gcsComponentId, missionItem)"},{"type":"INSERT","lineNumber":439,"content":"                                    sentSeqs.add(seq)"},{"type":"INSERT","lineNumber":440,"content":"                                    Log.i(\"MavlinkRepo\", \"Sent MISSION_ITEM_INT seq=$seq to sys=$senderSys comp=$senderComp\")"},{"type":"INSERT","lineNumber":441,"content":"                                } catch (e: Exception) {"},{"type":"INSERT","lineNumber":442,"content":"                                    Log.e(\"MavlinkRepo\", \"Failed to send mission item seq=$seq\", e)"},{"type":"INSERT","lineNumber":443,"content":"                                }"},{"type":"DELETE","lineNumber":681,"oldContent":"}"},{"type":"INSERT","lineNumber":684,"content":"            if (result != null) {"},{"type":"DELETE","lineNumber":691,"oldContent":""},{"type":"INSERT","lineNumber":694,"content":"                Log.w(\"MavlinkRepo\", \"No COMMAND_ACK for MISSION_START on attempt $attempt (timeout)\")"},{"type":"INSERT","lineNumber":729,"content":"            delay(200)"},{"type":"DELETE","lineNumber":728,"oldContent":"            delay(200)"}]},{"timestamp":1757931823539,"changes":[{"type":"MODIFY","lineNumber":23,"content":"","oldContent":"    private val gcsComponentId: UByte = 1u"},{"type":"MODIFY","lineNumber":27,"content":") {","oldContent":"    private var fcuSystemId: UByte = 0u"},{"type":"DELETE","lineNumber":30,"oldContent":""},{"type":"INSERT","lineNumber":32,"content":""},{"type":"DELETE","lineNumber":38,"oldContent":"    fun start() {"},{"type":"DELETE","lineNumber":39,"oldContent":"        val scope = AppScope"},{"type":"DELETE","lineNumber":40,"oldContent":"        suspend fun reconnect(scope: kotlinx.coroutines.CoroutineScope) {"},{"type":"INSERT","lineNumber":38,"content":"    val lastFailure: StateFlow<Throwable?> = _lastFailure.asStateFlow()"},{"type":"INSERT","lineNumber":39,"content":""},{"type":"INSERT","lineNumber":40,"content":"    // Connection"},{"type":"INSERT","lineNumber":51,"content":"                    }"},{"type":"DELETE","lineNumber":53,"oldContent":"                    }"},{"type":"DELETE","lineNumber":60,"oldContent":"                    is StreamState.Active -> {"},{"type":"DELETE","lineNumber":62,"oldContent":"                        if (!state.value.connected) {"},{"type":"DELETE","lineNumber":64,"oldContent":"                            Log.i(\"MavlinkRepo\", \"Connection Active\")"},{"type":"DELETE","lineNumber":66,"oldContent":"                            _state.update { it.copy(connected = true) }"},{"type":"DELETE","lineNumber":68,"oldContent":"                        }"},{"type":"INSERT","lineNumber":65,"content":"                    is StreamState.Active -> {"},{"type":"INSERT","lineNumber":66,"content":"                        if (!state.value.connected) {"},{"type":"INSERT","lineNumber":67,"content":"                            Log.i(\"MavlinkRepo\", \"Connection Active\")"},{"type":"INSERT","lineNumber":68,"content":"                            _state.update { it.copy(connected = true) }"},{"type":"INSERT","lineNumber":69,"content":"                        }"},{"type":"DELETE","lineNumber":170,"oldContent":"                        val i = Log.i("},{"type":"DELETE","lineNumber":171,"oldContent":"                            \"MavlinkRepo\","},{"type":"DELETE","lineNumber":172,"oldContent":"                            \"COMMAND_ACK received: command=${ack.command} result=${ack.result} progress=${ack.progress} resultText=${ack.resultText ?: \"\"}\""},{"type":"DELETE","lineNumber":173,"oldContent":"                    } catch (t: Throwable) {"},{"type":"INSERT","lineNumber":170,"content":"                     val i = Log.i("},{"type":"INSERT","lineNumber":171,"content":"                         \"MavlinkRepo\","},{"type":"INSERT","lineNumber":172,"content":"                         \"COMMAND_ACK received: command=${ack.command} result=${ack.result} progress=${ack.progress}\""},{"type":"INSERT","lineNumber":173,"content":"                     )"},{"type":"DELETE","lineNumber":175,"oldContent":"                        Log.i(\"MavlinkRepo\", \"COMMAND_ACK received (unable to stringify fields)\")"},{"type":"INSERT","lineNumber":176,"content":"                    } catch (t: Throwable) {"},{"type":"INSERT","lineNumber":177,"content":"                        Log.i(\"MavlinkRepo\", \"COMMAND_ACK received (unable to stringify fields)\")"},{"type":"INSERT","lineNumber":201,"content":"        // GLOBAL_POSITION_INT"},{"type":"DELETE","lineNumber":202,"oldContent":"        // GLOBAL_POSITION_INT"},{"type":"INSERT","lineNumber":205,"content":"                .map { it.message }"},{"type":"DELETE","lineNumber":206,"oldContent":"                .map { it.message }"},{"type":"INSERT","lineNumber":213,"content":"                        it.copy("},{"type":"INSERT","lineNumber":214,"content":"                            altitudeMsl = altAMSLm,"},{"type":"INSERT","lineNumber":215,"content":"                            altitudeRelative = relAltM,"},{"type":"INSERT","lineNumber":216,"content":"                            latitude = lat,"},{"type":"INSERT","lineNumber":217,"content":"                            longitude = lon"},{"type":"INSERT","lineNumber":218,"content":"                        )"},{"type":"DELETE","lineNumber":215,"oldContent":"                        it.copy("},{"type":"DELETE","lineNumber":217,"oldContent":"                            altitudeMsl = altAMSLm,"},{"type":"DELETE","lineNumber":219,"oldContent":"                            altitudeRelative = relAltM,"},{"type":"DELETE","lineNumber":221,"oldContent":"                            latitude = lat,"},{"type":"DELETE","lineNumber":223,"oldContent":"                            longitude = lon"},{"type":"DELETE","lineNumber":225,"oldContent":"                        )"},{"type":"DELETE","lineNumber":318,"oldContent":"            connection.trySendUnsignedV2("},{"type":"INSERT","lineNumber":320,"content":"            connection.trySendUnsignedV2("},{"type":"INSERT","lineNumber":321,"content":"               gcsSystemId,"},{"type":"DELETE","lineNumber":322,"oldContent":"               gcsSystemId,"},{"type":"DELETE","lineNumber":382,"oldContent":"    suspend fun disarm() {"},{"type":"DELETE","lineNumber":383,"oldContent":"            MavCmd.COMPONENT_ARM_DISARM,"},{"type":"DELETE","lineNumber":384,"oldContent":"        )"},{"type":"INSERT","lineNumber":383,"content":"        if (missionItems.isEmpty()) {"},{"type":"INSERT","lineNumber":384,"content":"            Log.w(\"MavlinkRepo\", \"No mission items to upload\")"},{"type":"INSERT","lineNumber":385,"content":"            return false"},{"type":"INSERT","lineNumber":386,"content":"        }"},{"type":"DELETE","lineNumber":386,"oldContent":"    suspend fun changeMode(mode: MavMode) {"},{"type":"DELETE","lineNumber":398,"oldContent":"            var firstRequestReceived = false"},{"type":"INSERT","lineNumber":400,"content":"            var firstRequestReceived = false"},{"type":"INSERT","lineNumber":401,"content":""},{"type":"DELETE","lineNumber":402,"oldContent":""},{"type":"INSERT","lineNumber":414,"content":""},{"type":"DELETE","lineNumber":415,"oldContent":""},{"type":"DELETE","lineNumber":425,"oldContent":"            Log.e(\"MavlinkRepo\", \"Failed to send mission count\", e)"},{"type":"MODIFY","lineNumber":426,"content":"                                val seq = msg.seq.toInt()","oldContent":"            _lastFailure.value = e"},{"type":"INSERT","lineNumber":427,"content":"                                if (seq < 0 || seq >= missionItems.size) {"},{"type":"DELETE","lineNumber":434,"oldContent":"                                try {"},{"type":"DELETE","lineNumber":436,"oldContent":"                                    // Always send the requested item (allow retransmits)"},{"type":"INSERT","lineNumber":437,"content":"                                try {"},{"type":"INSERT","lineNumber":438,"content":"                                    // Always send the requested item (allow retransmits)"},{"type":"DELETE","lineNumber":442,"oldContent":"                            }"},{"type":"DELETE","lineNumber":444,"oldContent":"                            is MissionRequest -> {"},{"type":"INSERT","lineNumber":445,"content":"                            }"},{"type":"INSERT","lineNumber":446,"content":"                            is MissionRequest -> {"},{"type":"DELETE","lineNumber":674,"oldContent":""},{"type":"MODIFY","lineNumber":675,"content":"                        } catch (t: Throwable) {","oldContent":"    }"},{"type":"INSERT","lineNumber":676,"content":"                            Log.w(\"MavlinkRepo\", \"Error while processing COMMAND_ACK\", t)"},{"type":"DELETE","lineNumber":681,"oldContent":"                // try again after short delay"},{"type":"MODIFY","lineNumber":682,"content":"            val result = withTimeoutOrNull(perAttemptTimeout) { ackDeferred.await() }","oldContent":"            } else {"},{"type":"INSERT","lineNumber":683,"content":"            job.cancel()"},{"type":"INSERT","lineNumber":685,"content":"            if (result != null) {"},{"type":"DELETE","lineNumber":686,"oldContent":"            if (result != null) {"},{"type":"DELETE","lineNumber":692,"oldContent":"        }"},{"type":"MODIFY","lineNumber":693,"content":"                }","oldContent":"            }"},{"type":"INSERT","lineNumber":694,"content":"            } else {"},{"type":"INSERT","lineNumber":695,"content":"                Log.w(\"MavlinkRepo\", \"No COMMAND_ACK for MISSION_START on attempt $attempt (timeout)\")"},{"type":"DELETE","lineNumber":696,"oldContent":"                Log.w(\"MavlinkRepo\", \"No COMMAND_ACK for MISSION_START on attempt $attempt (timeout)\")"},{"type":"DELETE","lineNumber":711,"oldContent":"}"},{"type":"DELETE","lineNumber":712,"oldContent":"        return false"},{"type":"DELETE","lineNumber":713,"oldContent":""},{"type":"INSERT","lineNumber":712,"content":"        // Request mode change to AUTO using DO_SET_MODE"},{"type":"INSERT","lineNumber":713,"content":"        try {"},{"type":"INSERT","lineNumber":714,"content":"            Log.i(\"MavlinkRepo\", \"Fallback: Requesting mode change to AUTO via DO_SET_MODE\")"},{"type":"INSERT","lineNumber":730,"content":"            delay(200)"},{"type":"DELETE","lineNumber":731,"oldContent":"            delay(200)"}]},{"timestamp":1757931850084,"changes":[{"type":"MODIFY","lineNumber":32,"content":"","oldContent":""},{"type":"DELETE","lineNumber":35,"oldContent":"    // Connection"},{"type":"DELETE","lineNumber":36,"oldContent":"    private val connection = TcpClientMavConnection(host, port, CommonDialect).asCoroutine()"},{"type":"DELETE","lineNumber":37,"oldContent":"    fun start() {"},{"type":"INSERT","lineNumber":35,"content":""},{"type":"INSERT","lineNumber":36,"content":"    // Diagnostic info"},{"type":"INSERT","lineNumber":37,"content":"    private val _lastFailure = MutableStateFlow<Throwable?>(null)"},{"type":"MODIFY","lineNumber":63,"content":"            connection.streamState.collect { st ->","oldContent":"                    is StreamState.Active -> {"},{"type":"INSERT","lineNumber":64,"content":"                when (st) {"},{"type":"INSERT","lineNumber":65,"content":"                    is StreamState.Active -> {"},{"type":"DELETE","lineNumber":66,"oldContent":"            connection.streamState.collect { st ->"},{"type":"DELETE","lineNumber":69,"oldContent":"                when (st) {"},{"type":"MODIFY","lineNumber":176,"content":"                    } catch (t: Throwable) {","oldContent":"                    } catch (t: Throwable) {"},{"type":"MODIFY","lineNumber":202,"content":"        scope.launch {","oldContent":"        scope.launch {"},{"type":"MODIFY","lineNumber":206,"content":"                .filterIsInstance<GlobalPositionInt>()","oldContent":"                .filterIsInstance<GlobalPositionInt>()"},{"type":"DELETE","lineNumber":213,"oldContent":"                    }"},{"type":"DELETE","lineNumber":215,"oldContent":"                }"},{"type":"DELETE","lineNumber":217,"oldContent":"        }"},{"type":"DELETE","lineNumber":220,"oldContent":""},{"type":"INSERT","lineNumber":219,"content":"                    }"},{"type":"INSERT","lineNumber":220,"content":"                }"},{"type":"INSERT","lineNumber":221,"content":"        }"},{"type":"INSERT","lineNumber":222,"content":""},{"type":"MODIFY","lineNumber":322,"content":"                gcsComponentId, commandLong)","oldContent":"                gcsComponentId, commandLong)"},{"type":"DELETE","lineNumber":386,"oldContent":"        )"},{"type":"INSERT","lineNumber":387,"content":""},{"type":"DELETE","lineNumber":390,"oldContent":""},{"type":"DELETE","lineNumber":391,"oldContent":"    suspend fun changeMode(mode: MavMode) {"},{"type":"DELETE","lineNumber":392,"oldContent":"            MavCmd.DO_SET_MODE,"},{"type":"INSERT","lineNumber":390,"content":"            val missionCount = MissionCount("},{"type":"INSERT","lineNumber":391,"content":"                targetSystem = fcuSystemId,"},{"type":"INSERT","lineNumber":392,"content":"                targetComponent = fcuComponentId,"},{"type":"MODIFY","lineNumber":402,"content":"            // Resend MISSION_COUNT periodically until first request or timeout","oldContent":"            // Resend MISSION_COUNT periodically until first request or timeout"},{"type":"MODIFY","lineNumber":415,"content":"            // Collector job","oldContent":"            // Collector job"},{"type":"MODIFY","lineNumber":425,"content":"                                firstRequestReceived = true","oldContent":"            Log.e(\"MavlinkRepo\", \"Failed to send mission count\", e)"},{"type":"MODIFY","lineNumber":437,"content":"                                try {","oldContent":"                                try {"},{"type":"MODIFY","lineNumber":445,"content":"                            }","oldContent":"                            }"},{"type":"DELETE","lineNumber":670,"oldContent":""},{"type":"DELETE","lineNumber":671,"oldContent":"}"},{"type":"DELETE","lineNumber":672,"oldContent":"    }"},{"type":"DELETE","lineNumber":673,"oldContent":"        return false"},{"type":"DELETE","lineNumber":674,"oldContent":""},{"type":"INSERT","lineNumber":670,"content":"                            if (msg.command == MavCmd.MISSION_START.wrap()) {"},{"type":"INSERT","lineNumber":671,"content":"                                val resultVal = msg.result.value"},{"type":"INSERT","lineNumber":672,"content":"                                Log.i(\"MavlinkRepo\", \"Observed COMMAND_ACK for MISSION_START result=$resultVal on attempt $attempt\")"},{"type":"INSERT","lineNumber":673,"content":"                                if (!ackDeferred.isCompleted) ackDeferred.complete(resultVal)"},{"type":"INSERT","lineNumber":674,"content":"                            }"},{"type":"DELETE","lineNumber":684,"oldContent":"        return false"},{"type":"DELETE","lineNumber":685,"oldContent":"                if (result == 0u) {"},{"type":"INSERT","lineNumber":684,"content":""},{"type":"INSERT","lineNumber":686,"content":"                if (result == 0u) {"},{"type":"MODIFY","lineNumber":696,"content":"                // try again after short delay","oldContent":"                // try again after short delay"},{"type":"DELETE","lineNumber":710,"oldContent":"}"},{"type":"DELETE","lineNumber":711,"oldContent":"        return false"},{"type":"INSERT","lineNumber":710,"content":"        }"},{"type":"INSERT","lineNumber":711,"content":""},{"type":"DELETE","lineNumber":721,"oldContent":""},{"type":"DELETE","lineNumber":722,"oldContent":"}"},{"type":"INSERT","lineNumber":721,"content":"        val modeWaitMs = 5000L"},{"type":"INSERT","lineNumber":722,"content":"        val startWaitMode = System.currentTimeMillis()"},{"type":"MODIFY","lineNumber":731,"content":"        }","oldContent":"        }"},{"type":"INSERT","lineNumber":736,"content":"}"},{"type":"INSERT","lineNumber":737,"content":""}]},{"timestamp":1757931881553,"changes":[{"type":"INSERT","lineNumber":31,"content":"    val state: StateFlow<TelemetryState> = _state.asStateFlow()"},{"type":"DELETE","lineNumber":32,"oldContent":""},{"type":"MODIFY","lineNumber":34,"content":"    private var fcuComponentId: UByte = 0u","oldContent":"    // Connection"},{"type":"MODIFY","lineNumber":62,"content":"            reconnect(this) // Initial connection attempt","oldContent":"                    is StreamState.Active -> {"},{"type":"MODIFY","lineNumber":66,"content":"                        if (!state.value.connected) {","oldContent":"                        if (!state.value.connected) {"},{"type":"DELETE","lineNumber":170,"oldContent":"                     val i = Log.i("},{"type":"DELETE","lineNumber":171,"oldContent":"                         \"MavlinkRepo\","},{"type":"DELETE","lineNumber":172,"oldContent":"                         \"COMMAND_ACK received: command=${ack.command} result=${ack.result} progress=${ack.progress}\""},{"type":"DELETE","lineNumber":173,"oldContent":"                     )"},{"type":"DELETE","lineNumber":174,"oldContent":"                        )"},{"type":"INSERT","lineNumber":170,"content":"                   Log.i("},{"type":"INSERT","lineNumber":171,"content":"                       \"MavlinkRepo\","},{"type":"INSERT","lineNumber":172,"content":"                       \"COMMAND_ACK received: command=${ack.command} result=${ack.result} progress=${ack.progress}\""},{"type":"INSERT","lineNumber":173,"content":"                   )"},{"type":"INSERT","lineNumber":174,"content":""},{"type":"DELETE","lineNumber":176,"oldContent":"                    } catch (t: Throwable) {"},{"type":"INSERT","lineNumber":200,"content":"        // GLOBAL_POSITION_INT"},{"type":"DELETE","lineNumber":202,"oldContent":"        scope.launch {"},{"type":"INSERT","lineNumber":204,"content":"                .map { it.message }"},{"type":"DELETE","lineNumber":206,"oldContent":"                .filterIsInstance<GlobalPositionInt>()"},{"type":"MODIFY","lineNumber":216,"content":"                            longitude = lon","oldContent":"                    }"},{"type":"INSERT","lineNumber":217,"content":"                        )"},{"type":"INSERT","lineNumber":218,"content":"                    }"},{"type":"DELETE","lineNumber":220,"oldContent":"                            longitude = lon"},{"type":"DELETE","lineNumber":222,"oldContent":"                        )"},{"type":"INSERT","lineNumber":320,"content":"               gcsSystemId,"},{"type":"DELETE","lineNumber":322,"oldContent":"                gcsComponentId, commandLong)"},{"type":"DELETE","lineNumber":382,"oldContent":"    suspend fun disarm() {"},{"type":"INSERT","lineNumber":381,"content":"        }"},{"type":"DELETE","lineNumber":386,"oldContent":""},{"type":"INSERT","lineNumber":387,"content":"        try {"},{"type":"INSERT","lineNumber":400,"content":""},{"type":"DELETE","lineNumber":402,"oldContent":"            // Resend MISSION_COUNT periodically until first request or timeout"},{"type":"INSERT","lineNumber":413,"content":""},{"type":"DELETE","lineNumber":415,"oldContent":"            // Collector job"},{"type":"INSERT","lineNumber":435,"content":"                                )"},{"type":"DELETE","lineNumber":437,"oldContent":"                                try {"},{"type":"INSERT","lineNumber":443,"content":"                                }"},{"type":"DELETE","lineNumber":445,"oldContent":"                            }"},{"type":"DELETE","lineNumber":617,"oldContent":"        if (ack) {"},{"type":"DELETE","lineNumber":618,"oldContent":"        val ackDeferred = CompletableDeferred<Boolean>()"},{"type":"INSERT","lineNumber":616,"content":"                    Log.w(\"MavlinkRepo\", \"Did not receive item for seq=$seq within timeout\")"},{"type":"INSERT","lineNumber":617,"content":"                }"},{"type":"DELETE","lineNumber":622,"oldContent":"        // Wait for COMMAND_ACK for MISSION_START"},{"type":"INSERT","lineNumber":621,"content":""},{"type":"DELETE","lineNumber":669,"oldContent":""},{"type":"INSERT","lineNumber":668,"content":"                        try {"},{"type":"MODIFY","lineNumber":685,"content":"                if (result == 0u) {","oldContent":"                if (result == 0u) {"},{"type":"INSERT","lineNumber":694,"content":"                Log.w(\"MavlinkRepo\", \"No COMMAND_ACK for MISSION_START on attempt $attempt (timeout)\")"},{"type":"DELETE","lineNumber":696,"oldContent":"                // try again after short delay"},{"type":"DELETE","lineNumber":709,"oldContent":""},{"type":"INSERT","lineNumber":708,"content":"            Log.w(\"MavlinkRepo\", \"Fallback: Failed to send MISSION_SET_CURRENT\", e)"},{"type":"INSERT","lineNumber":729,"content":"            delay(200)"},{"type":"DELETE","lineNumber":731,"oldContent":"        }"}]}]},"C:/Users/Hrushikesh/AndroidStudioProjects/SampleGCS/app/src/main/java/com/example/aerogcsclone/uimain/TopNavBar.kt":{"filePath":"C:/Users/Hrushikesh/AndroidStudioProjects/SampleGCS/app/src/main/java/com/example/aerogcsclone/uimain/TopNavBar.kt","baseContent":"package com.example.aerogcsclone.uimain\n\nimport androidx.compose.foundation.background\nimport androidx.compose.foundation.clickable\nimport androidx.compose.foundation.layout.*\nimport androidx.compose.foundation.shape.CircleShape\nimport androidx.compose.material.icons.Icons\nimport androidx.compose.material.icons.filled.*\nimport androidx.compose.material3.DropdownMenu\nimport androidx.compose.material3.DropdownMenuItem\nimport androidx.compose.material3.Icon\nimport androidx.compose.material3.Text\nimport androidx.compose.runtime.*\nimport androidx.compose.ui.Alignment\nimport androidx.compose.ui.Modifier\nimport androidx.compose.ui.graphics.Brush\nimport androidx.compose.ui.graphics.Color\nimport androidx.compose.ui.graphics.vector.ImageVector\nimport androidx.compose.ui.text.font.FontWeight\nimport androidx.compose.ui.unit.dp\nimport androidx.compose.ui.unit.sp\nimport androidx.compose.ui.window.Popup\nimport androidx.navigation.NavHostController\nimport com.example.aerogcsclone.Telemetry.TelemetryState\nimport com.example.aerogcsclone.authentication.AuthViewModel\nimport com.example.aerogcsclone.navigation.Screen\n\n@Composable\nfun TopNavBar(\n    telemetryState: TelemetryState,\n    authViewModel: AuthViewModel,\n    navController: NavHostController\n) {\n    var menuExpanded by remember { mutableStateOf(false) }\n    var kebabMenuExpanded by remember { mutableStateOf(false) }\n    var selectedMode by remember { mutableStateOf<String?>(null) } // null by default\n\n    Box(\n        modifier = Modifier\n            .fillMaxWidth()\n            .height(70.dp)\n            .background(\n                brush = Brush.horizontalGradient(\n                    colors = listOf(Color(0xFF87CEEB), Color(0xFF4A90E2))\n                )\n            )\n            .padding(horizontal = 12.dp),\n        contentAlignment = Alignment.CenterStart\n    ) {\n        Row(\n            modifier = Modifier.fillMaxWidth(),\n            verticalAlignment = Alignment.CenterVertically\n        ) {\n            // Hamburger menu\n            Box {\n                Icon(\n                    Icons.Default.Menu,\n                    contentDescription = \"Menu\",\n                    tint = Color.White,\n                    modifier = Modifier.clickable { menuExpanded = true }\n                )\n                if (menuExpanded) {\n                    Popup(onDismissRequest = { menuExpanded = false }) {\n                        Column(\n                            modifier = Modifier\n                                .background(Color.Black.copy(alpha = 0.5f))\n                                .width(180.dp)\n                                .padding(vertical = 8.dp, horizontal = 16.dp)\n                        ) {\n                            Text(\n                                text = \"Automatic\",\n                                color = Color.White,\n                                fontSize = 22.sp,\n                                modifier = Modifier\n                                    .padding(16.dp)\n                                    .clickable {\n                                        selectedMode = \"Automatic\"\n                                        menuExpanded = false\n                                        navController.navigate(Screen.Plan.route)\n                                    }\n                            )\n                            Text(\n                                text = \"Manual\",\n                                color = Color.White,\n                                fontSize = 22.sp,\n                                modifier = Modifier\n                                    .padding(16.dp)\n                                    .clickable {\n                                        selectedMode = \"Manual\"\n                                        menuExpanded = false\n                                    }\n                            )\n                        }\n                    }\n                }\n            }\n\n            Spacer(modifier = Modifier.width(12.dp))\n\n            // Home icon\n            Icon(\n                Icons.Default.Home,\n                contentDescription = \"Home\",\n                tint = Color.White,\n                modifier = Modifier.clickable {\n                    navController.navigate(Screen.Connection.route)\n                }\n            )\n\n            Spacer(modifier = Modifier.width(16.dp))\n\n            // Title & Mode\n            Column(\n                verticalArrangement = Arrangement.Center,\n                horizontalAlignment = Alignment.Start\n            ) {\n                Spacer(modifier = Modifier.height(10.dp))\n                Text(\n                    text = \"Pavaman Aviation\",\n                    color = Color.White,\n                    fontWeight = FontWeight.Bold,\n                    fontSize = 25.sp\n                )\n                Spacer(modifier = Modifier.height(2.dp))\n                // Show selected mode only if not null\n                selectedMode?.let {\n                    Text(\n                        text = it,\n                        color = Color.White.copy(alpha = 0.7f),\n                        fontSize = 15.sp\n                    )\n                }\n            }\n\n            Spacer(modifier = Modifier.weight(1f))\n\n            // Status & telemetry\n            Row(verticalAlignment = Alignment.CenterVertically) {\n                ConnectionStatusWidget(isConnected = telemetryState.connected)\n                DividerBlock()\n                InfoBlock(Icons.Default.Flight, \"13%\")\n                DividerBlock()\n                InfoBlock(Icons.Default.BatteryFull, \"${telemetryState.batteryPercent ?: \"N/A\"}%\")\n                DividerBlock()\n                InfoBlock(Icons.Default.Gamepad, \"100%\")\n                DividerBlock()\n                InfoBlockGroup(\n                    Icons.Default.Bolt,\n                    listOf(\n                        \"${telemetryState.voltage ?: \"N/A\"} V\",\n                        \"${telemetryState.currentA ?: \"N/A\"} A\"\n                    )\n                )\n                DividerBlock()\n                InfoBlockGroup(\n                    Icons.Default.SatelliteAlt,\n                    listOf(\n                        \"${telemetryState.sats ?: \"N/A\"} sats\",\n                        \"${telemetryState.hdop ?: \"N/A\"} hdop\"\n                    )\n                )\n                DividerBlock()\n                InfoBlockGroup(\n                    Icons.Default.Sync,\n                    listOf(\"${telemetryState.mode}\", if (telemetryState.armed) \"Armed\" else \"Disarmed\")\n                )\n                DividerBlock()\n\n                // Kebab menu\n                Box {\n                    Icon(\n                        Icons.Default.MoreVert,\n                        contentDescription = \"More\",\n                        tint = Color.White,\n                        modifier = Modifier.clickable { kebabMenuExpanded = true }\n                    )\n                    DropdownMenu(\n                        expanded = kebabMenuExpanded,\n                        onDismissRequest = { kebabMenuExpanded = false }\n                    ) {\n                        DropdownMenuItem(\n                            text = { Text(\"Settings\") },\n                            onClick = { kebabMenuExpanded = false }\n                        )\n                        DropdownMenuItem(\n                            text = { Text(\"About App\") },\n                            onClick = { kebabMenuExpanded = false }\n                        )\n                        DropdownMenuItem(\n                            text = { Text(\"Logout\") },\n                            onClick = {\n                                kebabMenuExpanded = false\n                                authViewModel.signout()\n                                navController.navigate(Screen.Login.route) {\n                                    popUpTo(0)\n                                }\n                            }\n                        )\n                    }\n                }\n            }\n        }\n    }\n}\n\n@Composable\nfun ConnectionStatusWidget(isConnected: Boolean) {\n    val statusColor = if (isConnected) Color.Green else Color.Red\n    val statusText = if (isConnected) \"Connected\" else \"Disconnected\"\n\n    Row(verticalAlignment = Alignment.CenterVertically) {\n        Box(\n            modifier = Modifier\n                .size(10.dp)\n                .background(statusColor, shape = CircleShape)\n        )\n        Spacer(modifier = Modifier.width(4.dp))\n        Text(statusText, color = Color.White, fontSize = 12.sp)\n    }\n}\n\n@Composable\nfun DividerBlock() {\n    Box(\n        modifier = Modifier\n            .padding(horizontal = 8.dp)\n            .width(1.dp)\n            .height(30.dp)\n            .background(Color.White.copy(alpha = 0.7f))\n    )\n}\n\n@Composable\nfun InfoBlock(icon: ImageVector, value: String) {\n    Column(\n        modifier = Modifier.padding(horizontal = 6.dp),\n        horizontalAlignment = Alignment.CenterHorizontally\n    ) {\n        Icon(icon, contentDescription = null, tint = Color.White, modifier = Modifier.size(18.dp))\n        Spacer(modifier = Modifier.height(2.dp))\n        Text(value, color = Color.White, fontSize = 12.sp)\n    }\n}\n\n@Composable\nfun InfoBlockGroup(icon: ImageVector, values: List<String>) {\n    Column(\n        modifier = Modifier.padding(horizontal = 6.dp),\n        horizontalAlignment = Alignment.CenterHorizontally\n    ) {\n        Icon(icon, contentDescription = null, tint = Color.White, modifier = Modifier.size(18.dp))\n        Spacer(modifier = Modifier.height(2.dp))\n        values.forEach { value ->\n            Text(value, color = Color.White, fontSize = 12.sp)\n        }\n    }\n}\n","baseTimestamp":1757924404905},"/Dummy.lcf":{"filePath":"/Dummy.lcf","baseContent":"","baseTimestamp":1757915507465,"deltas":[{"timestamp":1757925623131,"changes":[{"type":"MODIFY","lineNumber":0,"content":"MavLinkRepo","oldContent":""}]}]}}}