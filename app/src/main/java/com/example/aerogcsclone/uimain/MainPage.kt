// Kotlin
package com.example.aerogcsclone.uimain

import androidx.compose.foundation.background
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.foundation.text.KeyboardOptions
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.*
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.text.input.KeyboardType
import androidx.compose.ui.text.style.TextAlign
import androidx.compose.ui.unit.dp
import androidx.navigation.NavHostController
//import com.example.aerogcsclone.Telemetry.SharedViewModel
import com.example.aerogcsclone.Telemetry.TelemetryState
import com.example.aerogcsclone.authentication.AuthViewModel
import com.google.maps.android.compose.MapType
import androidx.compose.ui.platform.LocalContext
import android.widget.Toast
import androidx.compose.ui.unit.sp
import com.google.maps.android.compose.rememberCameraPositionState
import com.google.android.gms.maps.CameraUpdateFactory
import com.google.android.gms.maps.model.LatLng
import androidx.compose.ui.text.font.FontWeight
import com.example.aerogcsclone.telemetry.SharedViewModel
import androidx.compose.runtime.getValue
import androidx.compose.ui.text.style.TextOverflow


@Composable
fun MainPage(
    telemetryViewModel: SharedViewModel,
    authViewModel: AuthViewModel,
    navController: NavHostController
) {
    val telemetryState by telemetryViewModel.telemetryState.collectAsState()
    val context = LocalContext.current

    // Collect area values from ViewModel
    val missionAreaFormatted by telemetryViewModel.missionAreaFormatted.collectAsState()
    val surveyAreaFormatted by telemetryViewModel.surveyAreaFormatted.collectAsState()
    val missionUploaded by telemetryViewModel.missionUploaded.collectAsState()

    // Decide which area string to show in the status panel
    val areaToDisplay = if (missionUploaded) {
        if (missionAreaFormatted.isNotBlank()) missionAreaFormatted else "N/A"
    } else {
        if (surveyAreaFormatted.isNotBlank()) surveyAreaFormatted else "N/A"
    }

    // Collect uploaded waypoints for display
    val uploadedWaypoints by telemetryViewModel.uploadedWaypoints.collectAsState()
    val surveyPolygon by telemetryViewModel.surveyPolygon.collectAsState()
    val gridLines by telemetryViewModel.gridLines.collectAsState()
    val gridWaypoints by telemetryViewModel.gridWaypoints.collectAsState()
    val geofenceEnabled by telemetryViewModel.geofenceEnabled.collectAsState()
    val geofencePolygon by telemetryViewModel.geofencePolygon.collectAsState()

    // Map camera state controlled from parent so refresh can move it
    val cameraPositionState = rememberCameraPositionState()

    // Map type state
    var mapType by remember { mutableStateOf(MapType.SATELLITE) }

    // Ensure we center the map once when MainPage opens if we have telemetry
    var centeredOnce by remember { mutableStateOf(false) }
    LaunchedEffect(telemetryState.latitude, telemetryState.longitude) {
        val lat = telemetryState.latitude
        val lon = telemetryState.longitude
        if (!centeredOnce && lat != null && lon != null) {
            cameraPositionState.move(CameraUpdateFactory.newLatLngZoom(LatLng(lat, lon), 16f))
            centeredOnce = true
        }
    }

    val notifications by telemetryViewModel.notifications.collectAsState()
    val isNotificationPanelVisible by telemetryViewModel.isNotificationPanelVisible.collectAsState()
    val splitPlanActive by telemetryViewModel.splitPlanActive.collectAsState()

    // Split plan confirmation dialog
    var showSplitPlanDialog by remember { mutableStateOf(false) }

    // Resume Mission dialog states
    var showResumeWarningDialog by remember { mutableStateOf(false) }
    var showResumeWaypointDialog by remember { mutableStateOf(false) }
    var showResumeProgressDialog by remember { mutableStateOf(false) }

    // Use mutableStateOf without remember key - let it update freely
    var resumeWaypointNumber by mutableStateOf(
        telemetryState.pausedAtWaypoint
            ?: telemetryState.currentWaypoint
            ?: 1
    )

    // Always update resumeWaypointNumber when pausedAtWaypoint or currentWaypoint changes
    LaunchedEffect(telemetryState.pausedAtWaypoint, telemetryState.currentWaypoint) {
        val newWaypoint = telemetryState.pausedAtWaypoint
            ?: telemetryState.currentWaypoint
            ?: 1
        resumeWaypointNumber = newWaypoint
        android.util.Log.i("MainPage", "Updated resumeWaypointNumber to: $resumeWaypointNumber (from pausedAt: ${telemetryState.pausedAtWaypoint}, current: ${telemetryState.currentWaypoint})")
    }

    var resumeProgressMessage by remember { mutableStateOf("Initializing...") }

    // Debug: Monitor dialog state changes
    LaunchedEffect(showResumeWarningDialog) {
        android.util.Log.i("MainPage", "showResumeWarningDialog changed to: $showResumeWarningDialog")
    }
    LaunchedEffect(showResumeWaypointDialog) {
        android.util.Log.i("MainPage", "showResumeWaypointDialog changed to: $showResumeWaypointDialog")
    }

    Column(
        modifier = Modifier
            .fillMaxSize()
            .background(MaterialTheme.colorScheme.background)
    ) {
        Box(
            modifier = Modifier
                .weight(1f)
                .fillMaxWidth()
        ) {
            // Pass uploadedWaypoints to GcsMap for blue markers/lines
            GcsMap(
                telemetryState = telemetryState,
                points = uploadedWaypoints,
                surveyPolygon = surveyPolygon,
                gridLines = gridLines.map { listOf(it.first, it.second) },
                gridWaypoints = gridWaypoints,
                mapType = mapType,
                cameraPositionState = cameraPositionState,
                autoCenter = false,
                heading = telemetryState.heading,
                geofencePolygon = geofencePolygon,
                geofenceEnabled = geofenceEnabled
            )

            StatusPanel(
                modifier = Modifier
                    .align(Alignment.BottomStart)
                    .padding(12.dp),
                telemetryState = telemetryState,
                areaFormatted = areaToDisplay
            )

            FloatingButtons(
                modifier = Modifier
                    .align(Alignment.CenterEnd)
                    .padding(12.dp),
                onToggleMapType = {
                    mapType = if (mapType == MapType.SATELLITE) MapType.NORMAL else MapType.SATELLITE
                },
                onStartMission = {
                    telemetryViewModel.startMission { success, error ->
                        if (success) {
                            Toast.makeText(context, "Mission start sent", Toast.LENGTH_SHORT).show()
                        } else {
                            Toast.makeText(context, error ?: "Failed to start mission", Toast.LENGTH_SHORT).show()
                        }
                    }
                },
                onRefresh = {
                    val lat = telemetryState.latitude
                    val lon = telemetryState.longitude
                    if (lat != null && lon != null) {
                        cameraPositionState.move(CameraUpdateFactory.newLatLngZoom(LatLng(lat, lon), 16f))
                    } else {
                        Toast.makeText(context, "No GPS location available", Toast.LENGTH_SHORT).show()
                    }
                },
                onPauseMission = {
                    telemetryViewModel.pauseMission()
                },
                onResumeMission = {
                    android.util.Log.i("MainPage", "=== RESUME CALLBACK TRIGGERED ===")
                    
                    // Log the state values for debugging
                    android.util.Log.i("MainPage", "pausedAtWaypoint: ${telemetryState.pausedAtWaypoint}")
                    android.util.Log.i("MainPage", "currentWaypoint: ${telemetryState.currentWaypoint}")
                    
                    // Get the last auto waypoint (current or paused waypoint)
                    val lastAutoWp = telemetryState.pausedAtWaypoint
                        ?: telemetryState.currentWaypoint
                        ?: 1
                    
                    android.util.Log.i("MainPage", "Resolved waypoint: $lastAutoWp")
                    resumeWaypointNumber = lastAutoWp
                    
                    showResumeWarningDialog = true
                },
                onSplitPlan = {
                    // Show split plan confirmation dialog
                    showSplitPlanDialog = true
                },
                splitPlanActive = splitPlanActive,
                currentMode = telemetryState.mode, // Pass the current flight mode
                missionPaused = telemetryState.missionPaused // Pass the mission paused state
            )

            if (isNotificationPanelVisible) {
                Box(modifier = Modifier.align(Alignment.CenterEnd)) {
                    NotificationPanel(notifications = notifications)
                }
            }

            // TopNavBar removed - it's already handled in AppNavGraph.kt
        }

        // Mission Complete Popup (must be inside the composable)
        var lastMissionTime by remember { mutableStateOf<Long?>(null) }
        var lastMissionDistance by remember { mutableStateOf<Float?>(null) }
        var prevMissionCompleted by remember { mutableStateOf(false) }
        var prevMissionElapsedSec by remember { mutableStateOf<Long?>(null) }
        var missionJustCompleted by remember { mutableStateOf(false) }
        var missionWaitingForLanding by remember { mutableStateOf(false) }

        LaunchedEffect(telemetryState.missionCompleted, telemetryState.missionElapsedSec, telemetryState.altitudeRelative) {
            // Check if mission just completed (traveling done)
            val completedNow = !prevMissionCompleted && telemetryState.missionCompleted && telemetryState.missionElapsedSec == null && prevMissionElapsedSec != null
            if (completedNow) {
                lastMissionTime = telemetryState.lastMissionElapsedSec
                lastMissionDistance = telemetryState.totalDistanceMeters
                // Don't show dialog yet, wait for altitude to reach 0
                missionWaitingForLanding = true
            }

            // Check if drone has landed (altitude is 0 or very close to 0)
            val altitude = telemetryState.altitudeRelative ?: 0f
            val isLanded = altitude <= 0.5f // Consider landed if altitude is less than or equal to 0.5 meters

            // Show dialog only when mission is waiting for landing AND altitude reaches 0
            if (missionWaitingForLanding && isLanded) {
                missionJustCompleted = true
                missionWaitingForLanding = false
            }

            prevMissionCompleted = telemetryState.missionCompleted
            prevMissionElapsedSec = telemetryState.missionElapsedSec
        }
        if (missionJustCompleted) {
            AlertDialog(
                onDismissRequest = {
                    missionJustCompleted = false
                },
                confirmButton = {
                    Button(
                        onClick = {
                            missionJustCompleted = false
                        },
                        colors = ButtonDefaults.buttonColors(containerColor = MaterialTheme.colorScheme.primary)
                    ) {
                        Text("OK", color = MaterialTheme.colorScheme.onPrimary)
                    }
                },
                title = {
                    Text("Mission completed!", style = MaterialTheme.typography.titleLarge, fontWeight = FontWeight.Bold)
                },
                text = {
                    Column(horizontalAlignment = Alignment.CenterHorizontally) {
                        val timeStr = lastMissionTime?.let { sec ->
                            val h = sec / 3600
                            val m = (sec % 3600) / 60
                            val s = sec % 60
                            if (h > 0) "%02d:%02d:%02d".format(h, m, s) else "%02d:%02d".format(m, s)
                        } ?: "N/A"
                        val distStr = lastMissionDistance?.let { dist ->
                            if (dist < 1000f) "%.0f m".format(dist)
                            else "%.2f km".format(dist / 1000f)
                        } ?: "N/A"
                        Text("Total time taken: $timeStr", style = MaterialTheme.typography.bodyLarge)
                        Spacer(modifier = Modifier.height(8.dp))
                        Text("Total distance covered: $distStr", style = MaterialTheme.typography.bodyLarge)
                    }
                }
            )
        }

        // Split Plan Confirmation Dialog
        if (showSplitPlanDialog) {
            AlertDialog(
                onDismissRequest = { showSplitPlanDialog = false },
                confirmButton = {
                    Button(
                        onClick = {
                            // Confirm split plan
                            telemetryViewModel.confirmSplitPlan()
                            showSplitPlanDialog = false
                        },
                        colors = ButtonDefaults.buttonColors(containerColor = MaterialTheme.colorScheme.primary)
                    ) {
                        Text("Yes", color = MaterialTheme.colorScheme.onPrimary)
                    }
                },
                dismissButton = {
                    Button(
                        onClick = { showSplitPlanDialog = false },
                        colors = ButtonDefaults.buttonColors(containerColor = MaterialTheme.colorScheme.secondary)
                    ) {
                        Text("No", color = MaterialTheme.colorScheme.onSecondary)
                    }
                },
                title = {
                    Text("Confirm Split Plan", style = MaterialTheme.typography.titleLarge, fontWeight = FontWeight.Bold)
                },
                text = {
                    Text("Are you sure you want to split the mission plan? This will pause the current mission and create a new split plan.", style = MaterialTheme.typography.bodyLarge)
                }
            )
        }

        // Resume Mission Warning Dialog (Step 1)
        if (showResumeWarningDialog) {
            android.util.Log.i("MainPage", "Rendering Resume Warning Dialog")
            androidx.compose.material3.AlertDialog(
                onDismissRequest = {
                    android.util.Log.i("MainPage", "Dialog dismissed")
                    showResumeWarningDialog = false
                },
                confirmButton = {
                    Button(
                        onClick = {
                            showResumeWarningDialog = false
                            showResumeWaypointDialog = true
                        },
                        colors = ButtonDefaults.buttonColors(containerColor = Color(0xFFFF9800))
                    ) {
                        Text("Continue", color = Color.White)
                    }
                },
                dismissButton = {
                    Button(
                        onClick = { showResumeWarningDialog = false },
                        colors = ButtonDefaults.buttonColors(containerColor = MaterialTheme.colorScheme.secondary)
                    ) {
                        Text("Cancel", color = MaterialTheme.colorScheme.onSecondary)
                    }
                },
                title = {
                    Row(verticalAlignment = Alignment.CenterVertically) {
                        Icon(
                            Icons.Default.Warning,
                            contentDescription = "Warning",
                            tint = Color(0xFFFF9800),
                            modifier = Modifier.size(24.dp)
                        )
                        Spacer(modifier = Modifier.width(8.dp))
                        Text("Resume Mission Warning", style = MaterialTheme.typography.titleLarge, fontWeight = FontWeight.Bold)
                    }
                },
                text = {
                    Column {
                        Text(
                            "⚠️ Warning: This will reprogram your mission, arm the vehicle, and issue a takeoff command (for copters).",
                            style = MaterialTheme.typography.bodyLarge,
                            fontWeight = FontWeight.Bold
                        )
                        Spacer(modifier = Modifier.height(8.dp))
                        Text(
                            "The mission will be filtered to skip waypoints before the resume point while preserving DO commands.",
                            style = MaterialTheme.typography.bodyMedium
                        )
                    }
                }
            )
        }

        // Resume Mission Waypoint Selection Dialog (Step 2)
        if (showResumeWaypointDialog) {
            // Use key() to force recomposition with fresh state when dialog opens
            key(showResumeWaypointDialog, telemetryState.pausedAtWaypoint, telemetryState.currentWaypoint) {
                // Get the current waypoint to resume from
                val defaultWaypoint = telemetryState.pausedAtWaypoint
                    ?: telemetryState.currentWaypoint
                    ?: 1

                var waypointInput by remember { mutableStateOf(defaultWaypoint.toString()) }

                AlertDialog(
                onDismissRequest = { showResumeWaypointDialog = false },
                confirmButton = {
                    Button(
                        onClick = {
                            val waypointNum = waypointInput.toIntOrNull() ?: defaultWaypoint
                            showResumeWaypointDialog = false
                            showResumeProgressDialog = true

                            // Start resume mission process
                            telemetryViewModel.resumeMissionComplete(
                                resumeWaypointNumber = waypointNum,
                                resetHomeCoords = false,
                                onProgress = { progress ->
                                    resumeProgressMessage = progress
                                },
                                onResult = { success, error ->
                                    showResumeProgressDialog = false
                                    if (!success) {
                                        Toast.makeText(
                                            context,
                                            "Resume failed: ${error ?: "Unknown error"}",
                                            Toast.LENGTH_LONG
                                        ).show()
                                    }
                                }
                            )
                        },
                        colors = ButtonDefaults.buttonColors(containerColor = MaterialTheme.colorScheme.primary)
                    ) {
                        Text("Resume", color = MaterialTheme.colorScheme.onPrimary)
                    }
                },
                dismissButton = {
                    Button(
                        onClick = { showResumeWaypointDialog = false },
                        colors = ButtonDefaults.buttonColors(containerColor = MaterialTheme.colorScheme.secondary)
                    ) {
                        Text("Cancel", color = MaterialTheme.colorScheme.onSecondary)
                    }
                },
                title = {
                    Text("Resume Mission At", style = MaterialTheme.typography.titleLarge, fontWeight = FontWeight.Bold)
                },
                text = {
                    Column {
                        Text(
                            "Enter the waypoint number to resume from:",
                            style = MaterialTheme.typography.bodyLarge
                        )
                        Spacer(modifier = Modifier.height(12.dp))
                        OutlinedTextField(
                            value = waypointInput,
                            onValueChange = { waypointInput = it },
                            label = { Text("Waypoint #") },
                            keyboardOptions = KeyboardOptions(keyboardType = KeyboardType.Number),
                            singleLine = true,
                            modifier = Modifier.fillMaxWidth()
                        )
                        Spacer(modifier = Modifier.height(8.dp))
                        Text(
                            "Default: Waypoint $defaultWaypoint (last auto waypoint)",
                            style = MaterialTheme.typography.bodySmall,
                            color = MaterialTheme.colorScheme.onSurfaceVariant
                        )
                    }
                }
            )
            }
        }

        // Resume Mission Progress Dialog (Step 3)
        if (showResumeProgressDialog) {
            AlertDialog(
                onDismissRequest = { /* Cannot dismiss during operation */ },
                confirmButton = { },
                title = {
                    Text("Resuming Mission...", style = MaterialTheme.typography.titleLarge, fontWeight = FontWeight.Bold)
                },
                text = {
                    Column(
                        horizontalAlignment = Alignment.CenterHorizontally,
                        modifier = Modifier.fillMaxWidth()
                    ) {
                        CircularProgressIndicator(
                            modifier = Modifier.size(48.dp),
                            color = MaterialTheme.colorScheme.primary
                        )
                        Spacer(modifier = Modifier.height(16.dp))
                        Text(
                            resumeProgressMessage,
                            style = MaterialTheme.typography.bodyLarge,
                            textAlign = TextAlign.Center
                        )
                    }
                }
            )
        }
    }
}


@Composable
fun StatusPanel(
    modifier: Modifier = Modifier,
    telemetryState: TelemetryState,
    areaFormatted: String
) {
    Surface(
        modifier = modifier
            // Slightly larger but still compact: increase min/max width and height a bit
            .widthIn(min = 140.dp, max = 380.dp)
            .heightIn(min = 48.dp, max = 74.dp),
        // Set 78% transparency (i.e., 78% transparent => 22% opacity)
        color = Color.Black.copy(alpha = 0.22f),
        shape = RoundedCornerShape(10.dp)
    ) {
        Column(
            modifier = Modifier.padding(6.dp),
            verticalArrangement = Arrangement.spacedBy(2.dp)
        ) {
            Row(
                horizontalArrangement = Arrangement.SpaceBetween,
                modifier = Modifier.fillMaxWidth()
            ) {
                Text(
                    "Alt: ${telemetryState.altitudeRelative ?: "N/A"}",
                    color = Color.White,
                    fontSize = 11.sp,
                    modifier = Modifier.weight(0.95f),
                    maxLines = 1,
                    overflow = TextOverflow.Ellipsis
                )
                Text(
                    "Speed: ${telemetryState.formattedGroundspeed ?: "N/A"}",
                    color = Color.White,
                    fontSize = 11.sp,
                    modifier = Modifier.weight(0.95f),
                    maxLines = 1,
                    overflow = TextOverflow.Ellipsis
                )
                Text(
                    "Area: ${areaFormatted}",
                    color = Color.White,
                    fontSize = 11.sp,
                    modifier = Modifier.weight(1.05f),
                    maxLines = 1,
                    overflow = TextOverflow.Ellipsis
                )
                Text(
                    "Flow: ${telemetryState.sprayTelemetry.formattedFlowRate ?: "N/A"}",
                    color = Color.White,
                    fontSize = 11.sp,
                    modifier = Modifier.weight(0.7f),
                    maxLines = 1,
                    overflow = TextOverflow.Ellipsis
                )
            }
            Spacer(modifier = Modifier.height(2.dp))
            Row(
                horizontalArrangement = Arrangement.SpaceBetween,
                modifier = Modifier.fillMaxWidth()
            ) {
                // Show waypoint info - display pause state or current waypoint
                val waypointText = if (telemetryState.missionPaused) {
                    "⏸ WP ${telemetryState.pausedAtWaypoint ?: "?"}"
                } else if (telemetryState.currentWaypoint != null) {
                    "WP: ${telemetryState.currentWaypoint}"
                } else {
                    "WP: N/A"
                }
                Text(
                    waypointText,
                    color = if (telemetryState.missionPaused) Color.Yellow else Color.White,
                    fontSize = 11.sp,
                    fontWeight = if (telemetryState.missionPaused) FontWeight.Bold else FontWeight.Normal,
                    modifier = Modifier.weight(0.95f),
                    maxLines = 1,
                    overflow = TextOverflow.Ellipsis
                )
                // Format mission timer
                val timeStr = telemetryState.missionElapsedSec?.let { sec ->
                    val m = (sec % 3600) / 60
                    val s = sec % 60
                    "%02d:%02d".format(m, s)
                } ?: "N/A"
                Text(
                    "Time: $timeStr",
                    color = Color.White,
                    fontSize = 11.sp,
                    modifier = Modifier.weight(0.95f),
                    maxLines = 1,
                    overflow = TextOverflow.Ellipsis
                )
                // Format total distance
                val distStr = telemetryState.totalDistanceMeters?.let { dist ->
                    if (dist < 1000f) "%.0f m".format(dist)
                    else "%.2f km".format(dist / 1000f)
                } ?: "N/A"
                Text(
                    "Distance: $distStr",
                    color = Color.White,
                    fontSize = 11.sp,
                    modifier = Modifier.weight(1.05f),
                    maxLines = 1,
                    overflow = TextOverflow.Ellipsis
                )
                Text(
                    "Consumed: ${telemetryState.sprayTelemetry.formattedConsumed ?: "N/A"}",
                    color = Color.White,
                    fontSize = 11.sp,
                    modifier = Modifier.weight(0.7f),
                    maxLines = 1,
                    overflow = TextOverflow.Ellipsis
                )
            }
        }
    }
}

@Composable
fun FloatingButtons(
    modifier: Modifier = Modifier,
    onToggleMapType: () -> Unit,
    onStartMission: () -> Unit,
    onRefresh: () -> Unit,
    onPauseMission: () -> Unit,
    onResumeMission: () -> Unit,
    onSplitPlan: () -> Unit,
    splitPlanActive: Boolean,
    currentMode: String?,
    missionPaused: Boolean = false
) {
    // Check if mission is running in AUTO mode
    val isMissionRunning = currentMode?.contains("Auto", ignoreCase = true) == true

    Column(
        modifier = modifier,
        verticalArrangement = Arrangement.spacedBy(8.dp),
        horizontalAlignment = Alignment.CenterHorizontally
    ) {
        // Start Mission Button
        FloatingActionButton(
            onClick = { onStartMission() },
            containerColor = Color.Black.copy(alpha = 0.7f),
            modifier = Modifier.size(width = 70.dp, height = 56.dp)
        ) {
            Column(
                horizontalAlignment = Alignment.CenterHorizontally,
                verticalArrangement = Arrangement.Center
            ) {
                Icon(
                    Icons.Default.PlayArrow,
                    contentDescription = "Start Mission",
                    tint = Color.White,
                    modifier = Modifier.size(20.dp)
                )
                Spacer(modifier = Modifier.height(2.dp))
                Text(
                    text = "Start",
                    color = Color.White,
                    fontSize = 9.sp,
                    fontWeight = FontWeight.Medium
                )
            }
        }

        // Pause Button (only active when mission is running)
        FloatingActionButton(
            onClick = {
                if (isMissionRunning) {
                    onPauseMission()
                }
            },
            containerColor = Color.Black.copy(alpha = 0.7f),
            modifier = Modifier.size(width = 70.dp, height = 56.dp)
        ) {
            Column(
                horizontalAlignment = Alignment.CenterHorizontally,
                verticalArrangement = Arrangement.Center
            ) {
                Icon(
                    Icons.Default.Pause,
                    contentDescription = "Pause Mission",
                    tint = Color.White,
                    modifier = Modifier.size(20.dp)
                )
                Spacer(modifier = Modifier.height(2.dp))
                Text(
                    text = "Pause",
                    color = Color.White,
                    fontSize = 9.sp,
                    fontWeight = FontWeight.Medium
                )
            }
        }

        // Resume Button (orange when mission is paused)
        FloatingActionButton(
            onClick = {
                android.util.Log.i("MainPage", "Resume button clicked! missionPaused=$missionPaused")
                if (missionPaused) {
                    onResumeMission()
                } else {
                    // For testing: allow resume even when not paused
                    android.util.Log.w("MainPage", "Resume clicked but mission not paused - allowing anyway for testing")
                    onResumeMission()
                }
            },
            containerColor = if (missionPaused)
                Color(0xFFFFA500).copy(alpha = 0.7f) // Orange when paused
            else
                Color.Black.copy(alpha = 0.7f), // Black when not paused
            modifier = Modifier.size(width = 70.dp, height = 56.dp)
        ) {
            Column(
                horizontalAlignment = Alignment.CenterHorizontally,
                verticalArrangement = Arrangement.Center
            ) {
                Icon(
                    Icons.Default.PlayArrow,
                    contentDescription = "Resume Mission",
                    tint = Color.White,
                    modifier = Modifier.size(20.dp)
                )
                Spacer(modifier = Modifier.height(2.dp))
                Text(
                    text = "Resume",
                    color = Color.White,
                    fontSize = 9.sp,
                    fontWeight = FontWeight.Medium
                )
            }
        }

        // Split Plan Button
        FloatingActionButton(
            onClick = { onSplitPlan() },
            containerColor = if (splitPlanActive) Color(0xFFFF9800).copy(alpha = 0.7f) else Color.Black.copy(alpha = 0.7f),
            modifier = Modifier.size(width = 70.dp, height = 56.dp)
        ) {
            Column(
                horizontalAlignment = Alignment.CenterHorizontally,
                verticalArrangement = Arrangement.Center
            ) {
                Icon(
                    Icons.Default.CallSplit,
                    contentDescription = "Split Plan",
                    tint = Color.White,
                    modifier = Modifier.size(20.dp)
                )
                Spacer(modifier = Modifier.height(2.dp))
                Text(
                    text = if (splitPlanActive) "Resume" else "Split",
                    color = Color.White,
                    fontSize = 9.sp,
                    fontWeight = FontWeight.Medium
                )
            }
        }

        // Recenter Button
        FloatingActionButton(
            onClick = { onRefresh() },
            containerColor = Color.Black.copy(alpha = 0.7f),
            modifier = Modifier.size(width = 70.dp, height = 56.dp)
        ) {
            Column(
                horizontalAlignment = Alignment.CenterHorizontally,
                verticalArrangement = Arrangement.Center
            ) {
                Icon(
                    Icons.Default.Refresh,
                    contentDescription = "Recenter",
                    tint = Color.White,
                    modifier = Modifier.size(20.dp)
                )
                Spacer(modifier = Modifier.height(2.dp))
                Text(
                    text = "Recenter",
                    color = Color.White,
                    fontSize = 9.sp,
                    fontWeight = FontWeight.Medium
                )
            }
        }

        // Toggle Map Type Button
        FloatingActionButton(
            onClick = { onToggleMapType() },
            containerColor = Color.Black.copy(alpha = 0.7f),
            modifier = Modifier.size(width = 70.dp, height = 56.dp)
        ) {
            Column(
                horizontalAlignment = Alignment.CenterHorizontally,
                verticalArrangement = Arrangement.Center
            ) {
                Icon(
                    Icons.Default.Map,
                    contentDescription = "Toggle Map",
                    tint = Color.White,
                    modifier = Modifier.size(20.dp)
                )
                Spacer(modifier = Modifier.height(2.dp))
                Text(
                    text = "Map Type",
                    color = Color.White,
                    fontSize = 9.sp,
                    fontWeight = FontWeight.Medium
                )
            }
        }
    }
}
